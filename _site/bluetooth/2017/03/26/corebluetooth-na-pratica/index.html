<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog de tecnologia e desenvolvimento ‚Äî artigos, tutoriais e opini√£o.">

    <title>CoreBluetooth na Pr√°tica - A odisseia do puto</title>

    <link rel="canonical" href="http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/odisseia.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="A odisseia do puto" />

    

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A odisseia do puto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="intro-header-overlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>CoreBluetooth na Pr√°tica</h1>
                        
                        <h2 class="subheading">Entendendo o CoreBluetooth framework e aplicando a exemplo real.</h2>
                        
                        <span class="meta">Postado por Leonardo Cardoso em 26/03/2017</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=CoreBluetooth na Pr√°tica&url=http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>

				<blockquote>
  <p>Leonardo Cardoso (<a href="https://twitter.com/leocardz" target="_blank">@leocardz</a>) come√ßou a trabalhar com mobile desde 2010 com a plataforma do robozinho verde, mas veio para a ma√ß√£ em 2014, atualmente lidera o time iOS da <a href="https://1aim.com" target="_blank">1aim</a>, em Berlim. √â tamb√©m um entusiasta open source e desenvolveu alguns projetos que podem ser acessados no seu perfil do <a href="https://github.com/leonardocardoso" target="_blank">GitHub</a>.</p>
</blockquote>

<h1 id="intro">Intro</h1>

<p>√â muito comum hoje estarmos em contato com dispositivos sem fio no nosso dia-a-dia. Seja um <em>headphone</em>, um <em>mouse</em>, um teclado, ou o famigerado <em>Apple Watch</em>. A lista √© extensa‚Ä¶ Todos eles, por√©m, utilizam basicamente uma mesma tecnologia que os torna de fato <em>wireless</em>: <strong>Bluetooth¬Æ</strong>.</p>

<p>Aqui vamos aprender brevemente os papeis executados e propriedades difundidas numa conex√£o via <em>Bluetooth</em>, e os modos de execu√ß√£o desses papeis utilizando o <em>framework</em> <strong>Core Bluetooth</strong>, que nos d√° o suporte √† vers√£o 4.0 (<em>a.k.a smart, a.k.a. low-energy</em>).</p>

<p>Primeiramente vamos aos modos de execu√ß√£o.</p>

<h1 id="modos-de-execu√ß√£o">Modos de Execu√ß√£o</h1>

<p>O <strong>Core Bluetooth</strong>, ou CB, nos proporciona dois modos de execu√ß√£o, <em>Foreground</em> e <em>Background</em>. Assim, podemos definir bem se queremos nossos <em>apps</em> ‚Äúconect√°veis‚Äù apenas quando o usu√°rio estiver interagindo com ele ou n√£o. Alguns aspectos definem bem esses modos, s√£o eles:</p>

<h2 id="foreground">Foreground</h2>

<p>Se o app √© minimizado ou outro app se torna o principal utilizado pelo usu√°rio, nosso suporte <em>Bluetooth</em> vai junto. Assim, no estado suspenso, seu <em>app</em> n√£o √© capaz de realizar tarefas relacionadas a <em>Bluetooth</em>, nem fica ciente de eventos relacionados a <em>Bluetooth</em>. Por√©m a lista de eventos recebidos enquanto o <em>app</em> estava em <em>background</em> √© empilhada e esses eventos s√£o entregues quando o usu√°rio resumir o <em>app</em>, tornando-o ativo novamente.</p>

<p>Explicaremos mais abaixo a diferen√ßa entre os papeis e as propriedades, mas nesse modo caso o aplicativo n√£o esteja ativo, o perif√©rico n√£o consegue enviar propagandas (<em>advertising</em>) e a central n√£o consegue difundir seu sinal (<em>scanning</em>), por√©m a execu√ß√£o de <em>advertising</em> e <em>scanning</em> s√£o respondidas sob demanda, praticamente sem atrasos.</p>

<p>A vantagem de usarmos em <em>Foreground</em> √© que temos o todos os recursos do sistema ao nosso alcance, como por exemplo, atualiza√ß√£o de <em>views</em> e tarefas sem tempo limite de execu√ß√£o. Ainda nesse modo, nossa <em>stack</em> de dispositivos √© bem distrinchada, inclusive tendo a op√ß√£o de escolher se queremos escanear o mesmo perif√©rico por alguma raz√£o espec√≠fica. Isso √© feito atrav√©s de uma propriedade <code class="language-plaintext highlighter-rouge">CBCentralManagerScanOptionAllowDuplicatesKey</code>, o que no modo <em>Background</em> √© ignorada, assim como outras propriedades s√£o tratadas diferentes quando executadas em modos <em>Foreground</em> e <em>Background</em> e elas podem ser achadas nas <a href="#referncias">Refer√™ncias</a>.</p>

<h2 id="background">Background</h2>

<p>Aqui j√° come√ßamos dizendo que os recursos de sistemas s√£o limitados. Temos tamb√©m <em>10 segundos</em> no m√°ximo para executar uma tarefa nesse modo. Mas creio que isso √© mais do que suficiente. O intervalo de execu√ß√£o de <em>advertising</em> e <em>scanning</em> pode ser mais demorado. Isso √© feito em prol de economizar bateria do seu dispositivo. Aqui, eventos do mesmo dispositivo s√£o combinados num √∫nico evento com seus <em>servi√ßos e caracter√≠sticas</em>, ou seja, a op√ß√£o de escanear o mesmo dispositivo mais de uma vez √© descartada.</p>

<p>A vantagem desse modo √© permitir que nosso <em>app</em> n√£o precisa estar ativo para trocarmos dados entre centrais e perif√©ricos. Ent√£o, s√≥ para esclarecer, o sistema acorda nosso <em>app</em> de um estado suspenso, permitindo ler, escrever, inscrever em caracter√≠sticas, escutar eventos. Tudo em <em>background</em>. Mas mesmo que tenhamos permiss√£o de rodar em <em>background</em>, nosso <em>app</em> n√£o vai rodar sempre. Isso pode acontecer porque eventualmente o sistema pode finalizar nosso <em>app</em> para liberar mem√≥ria para o <em>app</em> que est√° no estado ativo. A partir do <em>iOS7</em>, √© permitido salvar os estados dos dispositivos, conex√µes pendentes, etc., antes de uma interrup√ß√£o e ent√£o restaur√°-los depois.</p>

<p>Como um exemplo para essa restaura√ß√£o de estados, vamos imaginar que voc√™ tenha desenvolvido um dispositivo de seguran√ßa que se comunica com uma fechadura eletr√¥nica equipada com <em>Bluetooth</em>. O <em>app</em> e a fechadura podem interagir para que a fechadura se tranque automaticamente quando o usu√°rio saia da casa e destranque quando o usu√°rio voltar. Tudo isso com o <em>iPhone</em> no bolso. Quando o usu√°rio sair de casa, o <em>iPhone</em> pode eventualmente sair do alcance da fechadura e, ent√£o, perder conex√£o. Nesse caso, o usu√°rio pode simplesmente chamar a fun√ß√£o para conectar o dispositivo, mesmo n√£o estando no raio de alcance e, assim, a conex√£o ser√° refeita quando eles estiverem de novo ao alcance. Isso acontece porque a requisi√ß√£o de conex√£o de dispositivos n√£o expira.</p>

<p>Agora imagina que o usu√°rio est√° fora de casa em uma viagem. Se o <em>app</em> √© finalizado pelo sistema enquanto o usu√°rio est√° fora, o <em>app</em> n√£o vai ser capaz de se reconectar com a fechadura quando o usu√°rio retornar. Assim, a fechadura n√£o vai destrancar. Para apps como estes, √© definitivamente necess√°rio usar a op√ß√£o de salvamento e restaura√ß√£o de estados.</p>

<p>Observa√ß√£o: <em>macOS</em> e <em>iOS</em> funcionam um pouco diferente nos papeis de perif√©rico e central. Por exemplo, <em>macOS</em> n√£o aceita a <em>flag</em> <code class="language-plaintext highlighter-rouge">CBCentralManagerOptionRestoreIdentifierKey</code>, porque o <em>background</em> do <em>macOS</em> n√£o finaliza <em>apps</em> como o <em>iOS</em> faz, em teoria.</p>

<p>Para usar o modo <em>Background</em>, precisamos ainda definir <em>flags</em> no <code class="language-plaintext highlighter-rouge">Info.plist</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">bluetooth-peripheral</code>: Se quisermos usar um perif√©rico em <em>background</em></li>
  <li><code class="language-plaintext highlighter-rouge">bluetooth-central</code>: Se quisermos usar uma central em <em>background</em></li>
</ul>

<p>Se adicionarmos o suporte via <code class="language-plaintext highlighter-rouge">Target &gt; Capabilities &gt; Background Modes</code>, selecionando <code class="language-plaintext highlighter-rouge">Uses Bluetooth LE accessories (central)</code> e/ou <code class="language-plaintext highlighter-rouge">Act as Bluetooth LE accessory (peripheral)</code>, elas s√£o adicionadas automaticamente no <code class="language-plaintext highlighter-rouge">Info.plist</code>.</p>

<p><strong>Importante</strong>: N√£o esque√ßa de adicionar a <em>flag</em> <code class="language-plaintext highlighter-rouge">Privacy - Bluetooth Peripheral Usage Description</code> para que o usu√°rio permita que esteja utilizando o dispositivo como perif√©rico, assim como fazemos quando queremos utilizar a c√¢mera ou localiza√ß√£o.</p>

<h1 id="papeis">Papeis</h1>

<p>Nesse jogo de conex√µes <em>Bluetooth</em>, n√≥s temos dois papeis distintos e bem especificados que funcionam como uma abordagem <strong>Client-Server</strong>. S√£o eles: <strong>Perif√©rico</strong> e <strong>Central</strong>.</p>

<h2 id="perif√©rico">Perif√©rico</h2>

<p>Um perif√©rico √© o dispositivo que compartilha seus dados para a central. Nesse modo, o sistema acorda nosso app para processar tarefas de leitura, escrita, inscri√ß√µes de eventos vindos da central. √â o dispositivo que funciona como <em>Server</em>, ou seja, tem os dados que se desejam.</p>

<p>Quando um perif√©rico est√° sendo executado em <em>Background</em>, seus servi√ßos s√£o realocados para uma √°rea de ‚Äú<em>overflow</em>‚Äù especial, ou seja, todos os <em>UUIDs</em> dos servi√ßos contidos na valor da propriedade <code class="language-plaintext highlighter-rouge">CBAdvertisementDataServiceUUIDsKey</code>. Sendo assim, ele s√≥ pode ser descoberto por um dispositivo que esteja explicitamente escaneando por ele, procurando por alguma de sua caracter√≠stica, basicamente seu indentificador.</p>

<h2 id="central">Central</h2>

<p>Uma central √© o dispositivo que requer informa√ß√µes de dispositivos perif√©ricos. Nesse caso, ela escaneia, connecta, obt√©m dados e envia dados, os explora. O <em>Client</em>.</p>

<p>O sistema acorda nossa central quando eventos de mudan√ßa de estado ocorrem com o perif√©rico, tais como conex√£o estabelecida ou cortada com o perif√©rico, quando perif√©rico atualiza informa√ß√µes de suas caract√©risticas, ou ainda quando nossa central est√° perto de ser finalizada e tamb√©m restaurada.</p>

<h3 id="exemplo">Exemplo</h3>

<p>Imagina o funcionamento de um medidor de batimento card√≠aco de praticantes de esportes. Nesse caso, o perif√©rico seria o dispositivo medidor que est√° alocado abaixo do peito do corredor. E um <em>app</em> no <em>iPhone</em> poderia ler esse valor e mostrar para o usu√°rio em tempo real, fazendo o <em>iPhone</em> funcionar como central, numa a√ß√£o em <em>Foreground</em>. Agora imagina que o corredor n√£o vai querer ficar olhando para seu <em>iPhone</em> todo o tempo, ent√£o, no modo <em>Background</em>, o <em>iPhone</em> captura dados dos batimentos e guarda num <em>log</em> no qual o usu√°rio pode checar as varia√ß√µes quando terminar seu exerc√≠cio.</p>

<p><img src="/img/leonardocardoso/communication.png" /></p>

<h1 id="conex√£o">Conex√£o</h1>

<p>A conex√£o entre uma central e um perif√©rico √© feita atrav√©s de escaneamento e propaganda. Basicamente esse √© o fluxo:</p>

<ul>
  <li>Um perif√©rico difunde um sinal que pode ser conectado usando pacotes de propaganda;</li>
  <li>Enquanto a central difunde um sinal que est√° procurando por perif√©rico;</li>
  <li>Quando uma central encontra um perif√©rico, ele pode explorar primeiro requisitar a conex√£o, o que pode ser rejeitada pelo perif√©rico ou n√£o. Essa conex√£o pode ser encriptada com a encripta√ß√£o nativa que o <em>Core Bluetooth</em> nos prov√™. Se a conex√£o encriptada for desejada, ent√£o um c√≥digo aparece num dos dispositivos para ser digitado no outro e assim criar pares de criptografia administrados pelo pr√≥prio sistema, tornando-os dispositivos confi√°veis. Se nenhuma criptografia for requerida, ent√£o a conex√£o √© feita autom√°tica;</li>
  <li>Ap√≥s a conex√£o ser feita, a central pode ent√£o ordenar que o perif√©rico descubra servi√ßos, basicamente a central est√° explorando os servi√ßos do perif√©rico;</li>
  <li>Ap√≥s servi√ßos descobertos, a central pode ent√£o ordenar que o perif√©rico descubra caracter√≠sticas, basicamente a central est√° explorando as caracter√≠sticas de cada servi√ßo do perif√©rico;</li>
  <li>Descobertas as caracter√≠sticas, a central pode ent√£o ler valores das caracter√≠sticas estaticamente ou se increver naquela caracter√≠stica e caso o perif√©rico atualize o valor dela, a central ser√° notificada com o novo valor.</li>
  <li>A conex√£o pode ser finalizada, se for o caso.</li>
</ul>

<p><img src="/img/leonardocardoso/advertisingdiscovery.png" /></p>

<h1 id="servi√ßos-e-caracter√≠sticas">Servi√ßos e Caracter√≠sticas</h1>

<p>As trocas de dados feitas por dispositivos conectados s√£o atrav√©s de propriedades e elas s√£o servi√ßos e caracter√≠sticas j√° comentadas em algumas partes anteriormente.</p>

<p>Um servi√ßo √© uma cole√ß√£o de dados e comportamentos associados para completar uma tarefa ou uma fun√ß√£o de um disposito, ou partes de um dispositivo. Esses comportamentos s√£o chamados de caracter√≠sticas. Uma caracter√≠stica prov√™ mais detalhes sobre um servi√ßo de um perif√©rico. Parece basicamente uma descri√ß√£o daqueles verbetes que voc√™ procura em um dicion√°rio. Uma defini√ß√£o te leva pra outra e voc√™ fica num eterno <em>loop</em>. Mas vamos tentar explicar melhor mais abaixo.</p>

<p>Servi√ßos podem ter outros servi√ßos relacionados, como depend√™ncias, apontando para <em>UUIDs</em> de outros servi√ßos. Cada caracter√≠stica tamb√©m tem <em>UUID</em> que a possa indentificar.</p>

<p><img src="/img/leonardocardoso/servicescharacterisctics.png" /></p>

<p>Ent√£o nesse exemplo n√≥s temos dois sensores que funcionam diferentes um do outro mas juntos eles produzem um servi√ßo, que √© o Batimento Card√≠aco. Para que ele funcione corretamente, o sensor card√≠aco deve estar posicionado no local ideal.</p>

<p>Ainda utilizando o nosso exemplo anterior, suponha que no dispositivo de batimento card√≠aco poder√≠amos ter dois servi√ßos, um com duas caracter√≠cticas e outro com apenas uma:</p>

<ul>
  <li>Servi√ßo 1: Batimentos Card√≠acos
    <ul>
      <li>Caracter√≠stica 1: Medi√ß√£o dos Batimentos Card√≠acos</li>
      <li>Caracter√≠stica 2: Localiza√ß√£o Adequada do Dispositivo</li>
    </ul>
  </li>
  <li>Servi√ßo 2: Status
    <ul>
      <li>Caracter√≠stica 1: N√≠vel de Bateria</li>
    </ul>
  </li>
</ul>

<p>Mas um perif√©rico √© nada se n√£o estiver enviando propagandas. Um pacote de propaganda √© relativamente um pequeno agrupamento de dados que tem informa√ß√µes sobre o que o dispositivo perif√©rico para um reconhecimento inicial. Dados como nome do dispositivo, <em>UUID</em> e <em>RSSI</em>, que √© uma informa√ß√£o de qu√£o forte √© o sinal do perif√©rico.</p>

<h1 id="pra-onde-vamos-n√≥s">Pra onde vamos n√≥s?</h1>

<p>N√≥s vamos exemplificar aqui o seguinte:</p>

<ul>
  <li>Papeis
    <ul>
      <li><em>iOS</em> como Perif√©rico</li>
      <li><em>macOS</em> como Central</li>
    </ul>
  </li>
  <li>Modos
    <ul>
      <li><em>Foreground</em></li>
    </ul>
  </li>
</ul>

<p>Para conferir o modo <em>background</em>, confira no <a href="https://github.com/LeonardoCardoso/BLE{:target=&quot;_blank&quot;}">reposit√≥rio desse projeto no GitHub</a>, no <em>branch</em> <code class="language-plaintext highlighter-rouge">background</code>.</p>

<h1 id="code-snippets">Code Snippets</h1>

<p>Devemos primeiro ligar nosso app com o <code class="language-plaintext highlighter-rouge">CoreBluetooth</code>. Ent√£o, v√° <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Targets</code> -&gt; <code class="language-plaintext highlighter-rouge">Build Phases</code> -&gt; <code class="language-plaintext highlighter-rouge">Link Binary with Libraries</code> -&gt; Procura por <code class="language-plaintext highlighter-rouge">CoreBluetooth.framework</code> e ent√£o o adiciona.</p>

<h2 id="foreground-1">Foreground</h2>

<p>Primeiro, vamos criar um protocolor para receber os eventos escutados do <code class="language-plaintext highlighter-rouge">BluetoothManager</code> e atualizar as views dos nossos <code class="language-plaintext highlighter-rouge">ViewController</code>s. Vamos cham√°-lo de <code class="language-plaintext highlighter-rouge">BlueEar</code>. E tem uma vers√£o para a <code class="language-plaintext highlighter-rouge">Central</code> e outra pro <code class="language-plaintext highlighter-rouge">Peripheral</code>. Assim como o <code class="language-plaintext highlighter-rouge">BlueEar</code>, teremos uma classe que ser√° a administradora da nossa conex√£o <em>Bluetooth</em> e √© a <code class="language-plaintext highlighter-rouge">BluetoothManager</code>.</p>

<h3 id="ios">iOS</h3>

<h4 id="blueear">BlueEar</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">protocol</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didStartAdvertising</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="bluetoothmanager">BluetoothManager</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">let</span> <span class="nv">peripheralId</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"62443cc7-15bc-4136-bf5d-0ad80c459215"</span>
    <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"0cdbe648-eed0-11e6-bc64-92361f002671"</span>
    <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"199ab74c-eed0-11E6-BC64-92361F002672"</span>
    <span class="k">let</span> <span class="nv">localName</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"Peripheral - iOS"</span>

    <span class="k">let</span> <span class="nv">properties</span><span class="p">:</span> <span class="kt">CBCharacteristicProperties</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="o">.</span><span class="n">notify</span><span class="p">,</span> <span class="o">.</span><span class="n">writeWithoutResponse</span><span class="p">,</span> <span class="o">.</span><span class="n">write</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">permissions</span><span class="p">:</span> <span class="kt">CBAttributePermissions</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="n">readable</span><span class="p">,</span> <span class="o">.</span><span class="n">writeable</span><span class="p">]</span>

    <span class="k">var</span> <span class="nv">bluetoothMessaging</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">peripheralManager</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBMutableService</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBMutableCharacteristic</span><span class="p">?</span>

    <span class="c1">// MARK: - Initializers</span>
    <span class="kd">convenience</span> <span class="nf">init</span> <span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span> <span class="o">=</span> <span class="n">delegate</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?,</span>
            <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">serviceUUID</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">characteristicUUID</span><span class="p">)</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Configuring service</span>
        <span class="k">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="kt">CBMutableService</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">serviceCBUUID</span><span class="p">,</span> <span class="nv">primary</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>

        <span class="c1">// Configuring characteristic</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="o">=</span> <span class="kt">CBMutableCharacteristic</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">characteristicCBUUID</span><span class="p">,</span> <span class="nv">properties</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">permissions</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Add characterisct to service</span>
        <span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="p">?</span><span class="o">.</span><span class="n">characteristics</span> <span class="o">=</span> <span class="p">[</span><span class="n">characterisctic</span><span class="p">]</span>

        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartConfiguration</span><span class="p">()</span>

        <span class="c1">// Initiate peripheral and start advertising</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span> <span class="o">=</span> <span class="kt">CBPeripheralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbperipheralmanagerdelegate">CBPeripheralManagerDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBPeripheralManagerDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBPeripheralManagerDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">peripheralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerDidUpdateState"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBMutableService</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">service</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">removeAllServices</span><span class="p">()</span>
            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didAdd</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didAdd service"</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">advertisingData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kt">CBAdvertisementDataServiceUUIDsKey</span><span class="p">:</span> <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="p">?</span><span class="o">.</span><span class="n">uuid</span><span class="p">],</span>
            <span class="kt">CBAdvertisementDataLocalNameKey</span><span class="p">:</span> <span class="s">"Peripheral - iOS"</span>
        <span class="p">]</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">stopAdvertising</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">startAdvertising</span><span class="p">(</span><span class="n">advertisingData</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralManagerDidStartAdvertising</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerDidStartAdvertising"</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartAdvertising</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="c1">// Listen to dynamic values</span>
    <span class="c1">// Called when CBPeripheral .setNotifyValue(true, for: characteristic) is called from the central</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentral</span><span class="p">,</span> <span class="n">didSubscribeTo</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didSubscribeTo characteristic"</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBMutableCharacteristic</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">do</span> <span class="p">{</span>

            <span class="c1">// Writing data to characteristics</span>
            <span class="k">let</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Hello"</span><span class="p">:</span> <span class="s">"Darkness"</span><span class="p">]</span>
            <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">fromPropertyList</span><span class="p">:</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">updateValue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characterisctic</span><span class="p">,</span> <span class="nv">onSubscribedCentrals</span><span class="p">:</span> <span class="p">[</span><span class="n">central</span><span class="p">])</span>
            <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didSendData</span><span class="p">()</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="c1">// Read static values</span>
    <span class="c1">// Called when CBPeripheral .readValue(for: characteristic) is called from the central</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didReceiveRead</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">CBATTRequest</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didReceiveRead request"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">uuid</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span><span class="p">?</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">characteristic</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uuid</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"Match characteristic for static reading"</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="c1">// Called when receiving writing from Central.</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didReceiveWrite</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBATTRequest</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didReceiveWrite requests"</span><span class="p">)</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">CBATTRequest</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">characteristic</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">characteristicCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Send response to central if this writing request asks for response [.withResponse]</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Sending response: Success"</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="nv">withResult</span><span class="p">:</span> <span class="o">.</span><span class="n">success</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"Match characteristic for writing"</span><span class="p">)</span>

        <span class="k">do</span> <span class="p">{</span>

            <span class="k">if</span> <span class="k">let</span> <span class="nv">receivedData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">propertyList</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">format</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="p">{</span>

                <span class="nf">print</span><span class="p">(</span><span class="s">"Written value is: </span><span class="se">\(</span><span class="n">receivedData</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveData</span><span class="p">()</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="k">return</span>

            <span class="p">}</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentral</span><span class="p">,</span> <span class="n">didUnsubscribeFrom</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUnsubscribeFrom characteristic"</span><span class="p">)</span>
        
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">willRestoreState</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"willRestoreState"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManagerIsReady</span><span class="p">(</span><span class="n">toUpdateSubscribers</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerIsReady"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="viewcontroller">ViewController</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="c1">// MARK: - IBOutlet</span>
    <span class="kd">@IBOutlet</span> <span class="k">var</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>

    <span class="c1">// MARK: - Lifecyle</span>
    <span class="k">override</span> <span class="k">var</span> <span class="nv">preferredStatusBarStyle</span><span class="p">:</span> <span class="kt">UIStatusBarStyle</span> <span class="p">{</span> <span class="k">return</span> <span class="o">.</span><span class="n">lightContent</span> <span class="p">}</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">var</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">BluetoothManager</span><span class="p">?</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="kt">BluetoothManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// MARK: - BlueEar</span>
<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Start configuration üéõ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didStartAdvertising</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Start advertising üìª"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Did send data ‚¨ÜÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Did received data ‚¨áÔ∏è"</span> <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="view">View</h4>

<p><img src="/img/leonardocardoso/iOS.png" /></p>

<h4 id="notas">Notas:</h4>

<ul>
  <li>No nosso exemplo, o Perif√©rico vai come√ßar a fazer propaganda quando iniciar o <code class="language-plaintext highlighter-rouge">app</code>.</li>
  <li>Voc√™ s√≥ pode fazer alguma coisa com o perif√©rico quando a fun√ß√£o <code class="language-plaintext highlighter-rouge">peripheralManagerDidUpdateState(: CBPeripheralManager)</code> for chamada e o estado do perif√©rico estiver <code class="language-plaintext highlighter-rouge">.poweredOn</code>.</li>
  <li>Leituras de valores din√¢micos pela Central usando a fun√ß√£o <code class="language-plaintext highlighter-rouge">.setNotifyValue(true, for: characteristic)</code> disparam a fun√ß√£o <code class="language-plaintext highlighter-rouge">peripheralManager(_: CBPeripheralManager, : CBCentral, : CBCharacteristic)</code> do perif√©rico, j√° leituras de valores est√°ticos usando a fun√ß√£o <code class="language-plaintext highlighter-rouge">.readValue(for: characteristic)</code> pela Central, disparam <code class="language-plaintext highlighter-rouge">peripheralManager(_: CBPeripheralManager, :CBATTRequest)</code> do perif√©rico.</li>
</ul>

<h3 id="macos">macOS</h3>

<h4 id="blueear-1">BlueEar</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">protocol</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didStartScanningPeripherals</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>
    <span class="kd">func</span> <span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didFailConnection</span><span class="p">()</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="bluetoothmanager-1">BluetoothManager</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"0cdbe648-eed0-11e6-bc64-92361f002671"</span>
    <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"199ab74c-eed0-11e6-bc64-92361f002672"</span>

    <span class="k">var</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">blueEar</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">centralManager</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">discoveredPeripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">?</span>

    <span class="c1">// MARK: - Initializers</span>
    <span class="kd">convenience</span> <span class="nf">init</span> <span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span> <span class="o">=</span> <span class="n">delegate</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?,</span>
            <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">serviceUUID</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">characteristicUUID</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="c1">// MARK: - Functions</span>
    <span class="kd">func</span> <span class="nf">scan</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span> <span class="o">=</span> <span class="kt">CBCentralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbcentralmanagerdelegate">CBCentralManagerDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBCentralManagerDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBCentralManagerDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">centralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">centralManagerDidUpdateState </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">central</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartScanningPeripherals</span><span class="p">()</span>
            <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">scanForPeripherals</span><span class="p">(</span><span class="nv">withServices</span><span class="p">:</span> <span class="p">[</span><span class="n">serviceCBUUID</span><span class="p">],</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didDiscover</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">advertisementData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">],</span> <span class="n">rssi</span> <span class="kt">RSSI</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// We must keep a reference to the new discovered peripheral, which means we must retain it.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscover:"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">discoveredPeripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">discoveredPeripheral</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didConnect</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didConnect"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">discoverServices</span><span class="p">([</span><span class="n">serviceCBUUID</span><span class="p">])</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">willRestoreState</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"willRestoreState"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didRetrievePeripherals</span> <span class="nv">peripherals</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBPeripheral</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didRetrievePeripherals"</span><span class="p">)</span>


    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didFailToConnect</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didFailToConnect"</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didFailConnection</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didRetrieveConnectedPeripherals</span> <span class="nv">peripherals</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBPeripheral</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didRetrieveConnectedPeripherals"</span><span class="p">)</span>


    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didDisconnectPeripheral</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDisconnectPeripheral"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbperipheraldelegate">CBPeripheralDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBPeripheralDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBPeripheralDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverServices</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverServices"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">services</span><span class="p">?</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">discoverCharacteristics</span><span class="p">([</span><span class="n">characteristicCBUUID</span><span class="p">],</span> <span class="nv">for</span><span class="p">:</span> <span class="n">service</span><span class="p">)</span>

        <span class="p">}</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didWriteValueFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didWriteValueFor </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="c1">// After we write data on peripheral, we disconnect it.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">cancelPeripheralConnection</span><span class="p">(</span><span class="n">peripheral</span><span class="p">)</span>

        <span class="c1">// We stop scanning.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">stopScan</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverCharacteristicsFor</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverCharacteristicsFor"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">characteristics</span><span class="p">?</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"Matching characteristic"</span><span class="p">)</span>

            <span class="c1">// To listen and read dynamic values</span>
            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">setNotifyValue</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characteristic</span><span class="p">)</span>

            <span class="c1">// To read static values</span>
            <span class="c1">// self.discoveredPeripheral?.readValue(for: characteristic)</span>
            
        <span class="p">}</span>
        
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateValueFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateValueFor"</span><span class="p">)</span>

        <span class="c1">// We read</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">value</span> <span class="p">{</span>

            <span class="k">do</span> <span class="p">{</span>

                <span class="k">let</span> <span class="nv">receivedData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">propertyList</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">format</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">as!</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span>

                <span class="nf">print</span><span class="p">(</span><span class="s">"Value read is: </span><span class="se">\(</span><span class="n">receivedData</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveData</span><span class="p">()</span>

            <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

            <span class="p">}</span>

        <span class="p">}</span>

        <span class="c1">// We write</span>
        <span class="k">do</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Writing on peripheral."</span><span class="p">)</span>

            <span class="k">let</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Yo"</span><span class="p">:</span> <span class="s">"Lo"</span><span class="p">]</span>
            <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">fromPropertyList</span><span class="p">:</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">writeValue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characteristic</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="o">.</span><span class="n">withResponse</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didSendData</span><span class="p">()</span>
            
        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            
        <span class="p">}</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralDidUpdateRSSI</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">peripheralDidUpdateRSSI"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">rssi</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralDidUpdateName</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">peripheralDidUpdateName"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didWriteValueFor</span> <span class="nv">descriptor</span><span class="p">:</span> <span class="kt">CBDescriptor</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didWriteValueFor"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didModifyServices</span> <span class="nv">invalidatedServices</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBService</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didModifyServices"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateValueFor</span> <span class="nv">descriptor</span><span class="p">:</span> <span class="kt">CBDescriptor</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateValueFor"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverIncludedServicesFor</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverIncludedServicesFor"</span><span class="p">)</span>

    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverDescriptorsFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverDescriptorsFor"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateNotificationStateFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateNotificationStateFor"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="viewcontroller-1">ViewController</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Cocoa</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">NSViewController</span> <span class="p">{</span>

    <span class="c1">// MARK: - IBOutlet</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">NSTextField</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">button</span><span class="p">:</span> <span class="kt">NSButton</span><span class="o">!</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">var</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">BluetoothManager</span><span class="p">?</span>

    <span class="c1">// MARK: - Lifecyle</span>
    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">discover</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="kt">BluetoothManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">manager</span><span class="p">?</span><span class="o">.</span><span class="nf">scan</span><span class="p">()</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// MARK: - BlueEar</span>
<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Start configuration üéõ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didStartScanningPeripherals</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Start scanning peripherals üëÄ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did connect to: </span><span class="se">\(</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s"> ü§úüèΩü§õüèΩ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did disconnect: </span><span class="se">\(</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s"> ü§úüèΩü§öüèΩ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did send data ‚¨ÜÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did received data ‚¨áÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didFailConnection</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Connection failed ü§∑üèΩ‚Äç‚ôÇÔ∏è"</span> <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="view-1">View</h4>

<p><img src="/img/leonardocardoso/macOS.png" /></p>

<h4 id="notas-1">Notas:</h4>

<ul>
  <li>No nosso exemplo, a Central vai come√ßar a escanear por perif√©ricos quando clicarmor num bot√£o chamado <code class="language-plaintext highlighter-rouge">Tap</code>.</li>
  <li>Voc√™ s√≥ pode fazer alguma coisa com a central quando a fun√ß√£o <code class="language-plaintext highlighter-rouge">centralManagerDidUpdateState(: CBCentralManager)</code> for chamada e o estado do perif√©rico estiver <code class="language-plaintext highlighter-rouge">.poweredOn</code>.</li>
  <li>Note que o <code class="language-plaintext highlighter-rouge">CBPeripheralDelegate</code> √© diferente do <code class="language-plaintext highlighter-rouge">CBPeripheralManagerDelegate</code> usado no perif√©rico. Ambos s√£o relacionados ao perif√©rico, por√©m o <code class="language-plaintext highlighter-rouge">CBPeripheralDelegate</code> permite que a central escute eventos sobre o perif√©rico.</li>
  <li>Ao optar por ler resultados din√¢micos, a central se inscreve em caracter√≠sticas do perif√©rico, assim sendo alertada por meio de notifica√ß√µes se o perif√©rico alterar seu valor no qual ela esteja inscrita.</li>
  <li>Quando a central descobre um perif√©rico, devemos manter uma refer√™ncia para ele, ou seja, devemos ret√™-lo fazendo com que uma vari√°vel dentro do nosso c√≥digo o receba.</li>
  <li>Os dados s√£o trasmitidos em formato de <code class="language-plaintext highlighter-rouge">Data</code>, ent√£o voc√™ deve transformar o que quer transmitir neste tipo de dados para poder ser recebido corretamente no outro lado.</li>
</ul>

<h3 id="resultado">Resultado</h3>

<p>Na imagem, temos o respectivo: <em>Log</em> do perif√©rico, <em>iOS</em>, <em>macOS</em>, <em>Log</em> da central.</p>

<p><a href="/img/leonardocardoso/result.mp4" alt="Click to see a video smoother than this GIF" target="_blank">
<img src="/img/leonardocardoso/result.gif" />
</a></p>

<hr />

<h3 id="refer√™ncias">Refer√™ncias</h3>

<ul>
  <li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html" target="_blank">CoreBlueetooth</a></li>
</ul>

<hr />

<h3 id="agradecimentos">Agradecimentos</h3>

<p>Um agradecimento pra galera do <a href="http://iosdevbr.slack.com" target="_blank">Slack iOS Devs BR</a> pela oportunidade.</p>

<p>Um abra√ßo, e at√© pr√≥xima.</p>

<p>Leo</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/ios/2017/03/26/integracao-continua-com-travis-ci/" data-toggle="tooltip" data-placement="top" title="Integra√ß√£o Cont√≠nua com Travis-CI">&larr; Post Anterior</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/continuidade/2017/03/27/adotando-handoff/" data-toggle="tooltip" data-placement="top" title="Adotando Handoff em iOS e macOS">Pr√≥ximo Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */

                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//equinocios.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">A odisseia do puto ‚Äî Raimundo Pessoa & Frederico Do</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
