<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog de tecnologia e desenvolvimento — artigos, tutoriais e opinião.">

    <title>Desmistificando o Core Animation - A odisseia do puto</title>

    <link rel="canonical" href="http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/odisseia.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="A odisseia do puto" />

    

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A odisseia do puto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="intro-header-overlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Desmistificando o Core Animation</h1>
                        
                        <h2 class="subheading">Uma introdução para perder o medo desse framework como o Core Animation pode ser útil ao elaborar suas animações</h2>
                        
                        <span class="meta">Postado por Renato Sarro Matos em 19/03/2017</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=Desmistificando o Core Animation&url=http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>

				<p>Fala galera! Bem vindos a mais uma rodada do EquinociOS! Espero que estejam aproveitando e absorvendo tudo =D</p>

<p>Bem, o artigo de hoje introduz um assunto que eu particularmente sempre corri dele e tentei ao máximo evitá-lo. Até que chegou o dia em que eu não tive como escapar e precisei encarar o “bixo”: <code class="language-plaintext highlighter-rouge">CORE Animation</code>.
Vou falar que foi uma das batalhas mais satisfatórias que eu já enfrentei nesse mundo de desenvolvimento mobile, pois além de eu conseguir trabalhar minhas animações de uma forma muito melhor, abriu minha mente para detalhes que sempre passaram desapercebidos e que mudou muito a minha forma de encarar uma - até então - simples estrutura de tela/layout.</p>

<h3 id="lets-talk">LETS TALK!</h3>

<p>–</p>

<h1 id="core-animation">Core Animation</h1>

<p>Infraestrutura de renderização gráfica e animação, disponível para iOS e OS X, que você utiliza para animar as views e outros elementos visuais de sua aplicação.
(Sim, copiei do guide da Apple).
A propósito, vou pular esta parte introdutória (chata) que todo mundo está cansado de ver e pular pra parte “cool” da bagaça hehehe.</p>

<blockquote>
  <p>Sempre leiam o guide da Apple ;) (https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html)</p>
</blockquote>

<p>Certo, acredito que todos vocês em algum momento já se depararam com uns métodos de classe chamados:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">animate</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="nf">animateKeyframes</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">animateWith</span><span class="p">...</span>
<span class="n">animateKeyframesWith</span><span class="p">...</span>
</code></pre></div></div>

<p>Estes, são métodos, ou melhor, <code class="language-plaintext highlighter-rouge">big helpers</code> que encapsulam todo o processo de criação de um <code class="language-plaintext highlighter-rouge">CABasicAnimation</code> ou de um <code class="language-plaintext highlighter-rouge">CAKeyframeAnimation</code> por exemplo. Estes métodos são muito úteis, desde que usados com moderação e um certo bom senso, mas após nossa introdução você vai notar que pode ter um resultado mais apropriado utilizando o <code class="language-plaintext highlighter-rouge">Core Animation</code>, dependendo da complexidade de suas animações.</p>

<p>Antes de começar a ver como as animações acontecem na tela, precisamos entender um elemento bem importante: O <code class="language-plaintext highlighter-rouge">CALayer</code>, que é de fato, onde as animações acontecem.</p>

<p>Certo, vamos voltar mais um passo e entender um pouco do comportamento de uma <code class="language-plaintext highlighter-rouge">UIView</code> em relação à animação.
Uma <code class="language-plaintext highlighter-rouge">instância do UIView</code> modifica sua layer para delegar a renderização à estrutura de animação principal. Entretanto, as animações, quando adicionadas a uma layer, não modificam suas propriedades. A animação principal, mantém duas <code class="language-plaintext highlighter-rouge">hierarquias</code> de layers: <code class="language-plaintext highlighter-rouge">model</code> e <code class="language-plaintext highlighter-rouge">presentation layers</code>.
Por exemplo, considerando uma animação de fade out, se em qualquer momento da animação você verificar o valor da opacidade da camada (<code class="language-plaintext highlighter-rouge">model layer</code>), este valor será diferente do valor que está sendo apresentado na tela (<code class="language-plaintext highlighter-rouge">presentation layer</code>).</p>

<p>Como falado anteriormente, não é possível definir as propriedades na presentation layer, mas você pode utilizar os valores para criar novas animações, ou interagir com outras camadas enquanto a animação acontece.</p>

<p>É possível acessar qualquer uma dessas camadas utilizando os métodos <code class="language-plaintext highlighter-rouge">[CALayer presentationLayer]</code> e <code class="language-plaintext highlighter-rouge">[CALayer modelLayer]</code>.</p>

<blockquote>
  <p>Certo, vamos ver como tudo isso acontece na prática.</p>
</blockquote>

<h2 id="cabasicanimation">CABasicAnimation</h2>

<p>Vamos pensar em uma animação bem básica. A primeira que vem à minha mente é deslocar um quadrado de um lado para outro. Logicamente, quando eu configurar meu <code class="language-plaintext highlighter-rouge">CABasicAnimation</code>, vou passar para ele a propriedade que eu quero alterar, o valor inicial, o valor final e a duração:</p>

<script src="https://gist.github.com/renatosarro/4753b9eb2dd7e22aa1383000514c4c1a.js"></script>

<p><code class="language-plaintext highlighter-rouge">keyPath</code>: KVC (Key value code) “position.x”, contém um membro CGPoint armazenada na propriedade position :)</p>

<p><code class="language-plaintext highlighter-rouge">fromValue</code>: Posição Inicial</p>

<p><code class="language-plaintext highlighter-rouge">toValue</code>: Posição Final</p>

<p><code class="language-plaintext highlighter-rouge">duration</code>: Duração da animação</p>

<blockquote>
  <p>Ao rodar a animação, observamos que ao terminar a animação, nosso quadrado pula da posição final para a posição inicial. Isto ocorre, pois como falado anteriormente, as animações não modificam as propriedades na presentation layer. Então, ao terminar a animação, a posição padrão continua sendo a inicial.
Podemos contornar isso, modificando a propriedade position, diretamente na layer:</p>
</blockquote>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">view</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="o">:</span> <span class="s">"basicAnimation"</span><span class="p">)</span>

<span class="n">view</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">CGPoint</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="mi">320</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p>Desta forma, ao terminar a animação, a posição do elemento (<code class="language-plaintext highlighter-rouge">presentation layer</code>) será correspondente à posição final da animação (<code class="language-plaintext highlighter-rouge">model layer</code>).</p>

<p>Uma outra abordagem é configurar duas propriedades do <code class="language-plaintext highlighter-rouge">CABasicAnimation</code>.</p>

<p>Este objeto possui uma propriedade chamada <code class="language-plaintext highlighter-rouge">fillMode</code> que determina o que vai acontecer ao final da animação. Vamos configurar esta propriedade com a string <code class="language-plaintext highlighter-rouge">kCAFillModeForwards</code> que vai dizer para a animação permanecer em seu estado final.
Vamos também configurar a propriedade <code class="language-plaintext highlighter-rouge">isRemovedOnCompletion</code> com o boolean false. Isto vai garantir que o objeto não seja removido automaticamente. Desta forma, nosso código ficará assim:</p>

<script src="https://gist.github.com/renatosarro/396251ef6307475353b2ce3f718a58ee.js"></script>

<blockquote>
  <p>Utilize estas duas propriedades com muita parcimônia e as modifique apenas se houver uma real necessidade, pois quando trabalhamos com animações, é de estrema importância que as layers model e presentation estejam sincronizadas.
É importante ressaltar também, que o objeto da animação criada é copiado assim que adicionamos a alguma layer. Isto é bem interessante, pois podemos reutilizar o objeto em outras layers como por exemplo:</p>
</blockquote>

<script src="https://gist.github.com/renatosarro/c5d8881d055ad76b546e26ece695bec8.js"></script>

<p>Observe que, como a animação foi copiada para a layer da primeira view, ao configurarmos a propriedade beginTime para começar meio segundo depois, apenas a animação da layer da <code class="language-plaintext highlighter-rouge">view2</code> é afetada, pois como falado, ao adicionar a animação à layer, é gerado uma cópia dela.</p>

<p>PS: Podemos gastar mais um artigo inteiro falando só sobre como gerenciar o tempo de nossas animações. Acredite, estamos apenas começando e o <code class="language-plaintext highlighter-rouge">Core Animation</code> possui uma infinidade de possibilidades para trabalhar as animações. Com certeza mais posts virão =D</p>

<p>–</p>

<h3 id="agora-como-seria-esta-mesma-animação-sem-o-uso-do-core-animation">Agora, como seria esta mesma animação sem o uso do Core Animation?</h3>

<script src="https://gist.github.com/renatosarro/dcc083ec91dfee76c46b5c48c56fd048.js"></script>

<blockquote>

  <ul>
    <li>Desta forma, a animação impacta diretamente na posição real do elemento (<code class="language-plaintext highlighter-rouge">presentation layer</code>);</li>
    <li>Vale ressaltar que se tratando de animações, o mais indicado é trabalhar sempre na model layer. Alterações na presentation layer precisam ser feitas com muito cuidado para evitar memory leak e uma animação não muito fluída.</li>
    <li>Estaríamos limitados a animações simples, como um fade out. Mas vamos pensar em um cenário onde nosso elemento passe por vários estados até chegar em sua posição final. Utilizar essa abstração oferecida pela <code class="language-plaintext highlighter-rouge">UIView</code> já não seria muito indicado.</li>
  </ul>
</blockquote>

<p>Já que falamos sobre vários estados, vou aproveitar o gancho para puxar um outro elemento bem bacana presente no Core <code class="language-plaintext highlighter-rouge">Animation</code>:</p>

<h1 id="cakeyframeanimation">CAKeyframeAnimation</h1>

<p>Não sei quantos vieram desta época, mas minha primeira experiência como desenvolvedor foi com Action Script. Era o boom do Flash. Fantástico, brilhante, inovador, perfeito para ter experiências mais interativas e claro, animadas.</p>

<p>Bem, o conceito básico para qualquer animação é pensar nela em forma de <code class="language-plaintext highlighter-rouge">Key frames</code>. Já ouviram falar de Folioscópio, ou Flipbook?</p>

<p>É exatamente assim que uma animação funciona. Cada quadro (frame) possui o elemento em um estado diferente, onde colocando todos os quadros para passar de forma contínua, forma um desenho animado.</p>

<p>Sim, posso <code class="language-plaintext highlighter-rouge">e devo</code> utilizar o mesmo conceito ao elaborar minha animação.</p>

<p>Imagine que nossa view em vez de apenas se deslocar para a direta, ela vá até o centro, volte para o início e depois vá para o fim da tela.</p>

<p>O primeiro passo, é fazer um array de valores.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">320</span><span class="p">]</span>
</code></pre></div></div>

<p>Depois disso, vamos criar um array de <code class="language-plaintext highlighter-rouge">timming</code>, que vai ser relativo aos itens de estado. Ou seja, para cada posição, teremos um tempo que irá dizer quanto vai levar para a nossa view estar naquela posição.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">times</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<p>Perceba que esta lista diz que minha view começa na posição 20. Após 0,5 segundo, ela estará na posição 160. Após 1 segundo, na posição 20 e após 2 segundos, na posição 320. Ou seja, minha animação terá a duração de 2 segundos.</p>

<p>Vamos então criar nosso objeto <code class="language-plaintext highlighter-rouge">CAKeyframeAnimation</code>.</p>

<script src="https://gist.github.com/renatosarro/7dd14ca9892d894653f8f185d18f6409.js"></script>

<p>Podemos notar uma propriedade nova. A <code class="language-plaintext highlighter-rouge">isAdditive</code>. Configurando esta propriedade como verdadeiro, significa que o valor especificado pela animação, será adicionado à árvore de renderização atual. Isso nos permite reutilizar a mesma animação para qualquer elemento que precise ter o mesmo comportamento.</p>

<p>–</p>

<p>Olhando assim, o Core Animation não parece tão monstruoso hehe… Na verdade ele pode e vai auxiliar muito quando precisar trabalhar mais com o lado animado da coisa =D</p>

<p>Claro, esta, é apenas uma introdução. Com isso podemos ir brincando com keyPahts, keyFrames e ver o que podemos fazer de mais complexo exercitando muito estas propriedades básicas, mas tão importantes se tratando de animação.</p>

<p>Há uma infinidade de possibilidades quando falamos de animações e com certeza falaremos mais sobre isso.</p>

<h1 id="carry-on">Carry on!</h1>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/server/2017/03/18/server-side-caracteristicas-de-um-servidor/" data-toggle="tooltip" data-placement="top" title="Server-side: características de um servidor">&larr; Post Anterior</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/tutorial/2017/03/22/swift-machine-learning/" data-toggle="tooltip" data-placement="top" title="Swift & Machine Learning">Próximo Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */

                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//equinocios.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">A odisseia do puto — Raimundo Pessoa & Frederico Do</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
