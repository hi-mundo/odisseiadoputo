<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog de tecnologia e desenvolvimento ‚Äî artigos, tutoriais e opini√£o.">

    <title>Sincroniza√ß√£o de dados com CloudKit - A odisseia do puto</title>

    <link rel="canonical" href="http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/odisseia.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="A odisseia do puto" />

    

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A odisseia do puto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="intro-header-overlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Sincroniza√ß√£o de dados com CloudKit</h1>
                        
                        <h2 class="subheading">Colocando seu app na nuvem</h2>
                        
                        <span class="meta">Postado por Guilherme Rambo em 24/03/2017</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=Sincroniza√ß√£o de dados com CloudKit&url=http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>

				<blockquote>
  <p>Guilherme Rambo (<a href="https://twitter.com/_inside" target="_blank">@_inside</a>) √© desenvolvedor iOS na <a href="https://peixeurbano.com" target="_blank">Peixe Urbano</a>, criador do <a href="https://getbrowserfreedom.com">BrowserFreedom</a>, <a href="https://itunes.apple.com/app/chibistudio/id1135307199">ChibiStudio</a> e criador de diversos projetos open-source, incluindo o <a href="https://github.com/insidegui/WWDC">app da WWDC para macOS</a>.</p>
</blockquote>

<p>O CloudKit foi lan√ßado pela Apple em 2014 e desde ent√£o recebeu diversas melhorias, como a possibilidade de utiliz√°-lo fora das plataformas da Apple, a libera√ß√£o do seu uso em apps fora da App Store no macOS e a disponibilidade do framework no watchOS, completando o c√≠rculo de plataformas da Apple suportadas.</p>

<p>Acredito que a tecnologia ainda n√£o esteja sendo explorada em todo o seu potencial pelos desenvolvedores nas plataformas da Apple, seja por medo ou desconhecimento. Pretendo ajudar a mudar isso com este artigo.</p>

<h1 id="posso-usar-cloudkit">Posso usar CloudKit?</h1>

<p>Infelizmente, a primeira pergunta que todos se fazem quando juntamos as palavras ‚ÄúApple‚Äù e ‚Äúnuvem‚Äù na mesma frase √©: ‚Äúd√° pra usar sem medo?‚Äù. De fato, a Apple n√£o tem um hist√≥rico muito bom quando o assunto √© servi√ßos na nuvem, desde <a href="http://gizmodo.com/5033442/steve-jobss-entire-mobileme-is-fail-email">o fiasco do Mobile.me</a> at√© <a href="http://www.imore.com/debug-12-icloud-core-data-sync">o problema do iCloud Core Data</a>.</p>

<p>A boa not√≠cia √© que em se tratando de CloudKit, a coisa √© bem diferente. Eu arrisco afirmar que talvez seja a tecnologia da Apple na nuvem mais confi√°vel de todas. Mas como eu sei que apenas minhas palavras n√£o ser√£o o suficiente para convenc√™-lo de que uma tecnologia da Apple na nuvem √© confi√°vel, vou deixar que voc√™ mesmo decida. Se voc√™ usa o aplicativo Notas da Apple, saiba que ele usa CloudKit. Outros exemplos de uso do CloudKit pela pr√≥pria Apple s√£o o compartilhamento de atividades no Apple Watch, o app Fotos e o iCloud Drive.</p>

<p>Se os apps citados acima funcionam bem pra voc√™, ent√£o pode ficar tranquilo e usar o CloudKit sem medo. Se eles n√£o funcionam bem pra voc√™, eu n√£o vou conseguir convenc√™-lo de que a tecnologia √© confi√°vel üòÖ</p>

<p>Um detalhe importante a ser colocado √© que a confiabilidade do CloudKit tamb√©m depende muito da implementa√ß√£o. Como a API n√£o automatiza muita coisa, cabe a cada desenvolvedor us√°-la da melhor maneira para criar uma experi√™ncia agrad√°vel e confi√°vel ao usu√°rio, o que nos leva ao pr√≥ximo ponto:</p>

<h1 id="devo-usar-cloudkit">Devo usar CloudKit?</h1>

<p>Mesmo que voc√™ esteja convencido de que pode usar o CloudKit sem medo, isso n√£o significa que voc√™ deva us√°-lo, afinal existem aplica√ß√µes para as quais ele √© mais indicado e outras para as quais existem ferramentas melhores, n√£o estamos falando aqui de uma bala de prata.</p>

<h2 id="onde-usar-cloudkit">Onde usar CloudKit</h2>

<p>Estas s√£o as situa√ß√µes para as quais o CloudKit √© altamente indicado:</p>

<h3 id="sincronizar-dados-privados-dos-usu√°rios-entre-v√°rios-dispositivos">Sincronizar dados privados dos usu√°rios entre v√°rios dispositivos</h3>

<p>Este talvez seja o uso mais √≥bvio, que √© a sincroniza√ß√£o dos dados privados de um usu√°rio entre os v√°rios dispositivos daquele usu√°rio.</p>

<p><strong>Exemplo:</strong> um aplicativo de notas ou todo list onde o usu√°rio pode criar e ler notas em qualquer dispositivo que possua associado √† sua conta do iCloud (Mac, iPhone, iPad, Apple Watch, etc) ou at√© mesmo numa interface web.</p>

<p><em>Alternativas: Realm Mobile Platform, Firebase, iCloud KVS ou iCloud Documents (dependendo do caso)</em></p>

<h3 id="armazenar-configura√ß√µes-remotas-do-aplicativo">Armazenar configura√ß√µes remotas do aplicativo</h3>

<p>Utilizando o banco de dados p√∫blico do seu container √© poss√≠vel armazenar dados que s√£o compartilhados por todas as inst√¢ncias do seu app, por todos os usu√°rios, mesmo que n√£o estejam autenticados com uma conta do iCloud.</p>

<p><strong>Exemplo:</strong> um aplicativo que em √©pocas festivas (Carnaval, Natal, etc) muda as cores do seu tema poderia armazenar os c√≥digos das cores no banco de dados p√∫blico do CloudKit. Desta maneira, as cores poderiam ser alteradas remotamente sem a necessidade de um servidor pr√≥prio ou atualiza√ß√£o do app.</p>

<p><em>Alternativas: Realm Mobile Platform, Firebase ou servidor pr√≥prio</em></p>

<h3 id="sincronizar-dados-entre-v√°rios-apps-do-mesmo-desenvolvedor">Sincronizar dados entre v√°rios apps do mesmo desenvolvedor</h3>

<p>Se voc√™ tem uma fam√≠lia de apps e quer que os dados dos seus usu√°rios sejam acess√≠veis em todos os seus apps, √© poss√≠vel utilizar um container compartilhado entre todos os apps desta fam√≠lia de modo que os usu√°rios tenham acesso aos mesmos dados em todos os apps. Isto tamb√©m se aplica a configura√ß√µes (item acima), poderiam ser compartilhadas por todos os apps que utilizam o mesmo container.</p>

<p><em>Alternativas: servidor pr√≥prio (devem existir outros servi√ßos que suportem isto, mas n√£o tenho conhecimento para indicar algum)</em></p>

<h3 id="utilizar-a-conta-do-icloud-do-usu√°rio-como-forma-de-autentica√ß√£o">Utilizar a conta do iCloud do usu√°rio como forma de autentica√ß√£o</h3>

<p>Voc√™ pode utilizar a conta do iCloud do usu√°rio apenas como meio de autentica√ß√£o para algum outro app ou servi√ßo</p>

<h3 id="enviar-notifica√ß√µes">Enviar notifica√ß√µes</h3>

<p>Sim, √© poss√≠vel enviar notifica√ß√µes usando o CloudKit, eliminando a necessidade de utilizar um servi√ßo terceirizado ou um servidor pr√≥prio para este fim.</p>

<p><em>Alternativas: Firebase ou servidor pr√≥prio</em></p>

<h2 id="onde-n√£o-usar-cloudkit">Onde N√ÉO usar CloudKit</h2>

<p>Agora que j√° vimos alguns exemplos de onde o CloudKit √© extremamente indicado, vamos a dois exemplos de onde ele √© altamente contra-indicado:</p>

<h3 id="n√£o-armazenamento-e-sincroniza√ß√£o-de-documentos">N√ÉO: Armazenamento e sincroniza√ß√£o de documentos</h3>

<p>Se o seu app trabalha primariamente com documentos, o CloudKit n√£o √© a ferramenta mais indicada para armazenamento e sincroniza√ß√£o dos mesmos. Neste caso o ideal seria usar iCloud Drive, Dropbox ou outros servi√ßos similares. √â poss√≠vel armazenar arquivos grandes como fotos e v√≠deos no CloudKit, mas ele pode n√£o ser a melhor solu√ß√£o se a fun√ß√£o principal do seu app √© lidar com documentos.</p>

<p><strong>Exemplo:</strong> editores de texto estilo Pages, editores de imagens estilo Pixelmator, Sketch, etc</p>

<h3 id="n√£o-sincroniza√ß√£o-de-prefer√™ncias-do-usu√°rio">N√ÉO: Sincroniza√ß√£o de prefer√™ncias do usu√°rio</h3>

<p>Para armazenar simples prefer√™ncias do usu√°rio ou quantidades muito pequenas de informa√ß√£o, utilize <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/iCloudDesignGuide/Chapters/DesigningForKey-ValueDataIniCloud.html">iCloud KVS</a> (<code class="language-plaintext highlighter-rouge">NSUbiquitousKeyValueStore</code>).</p>

<p><strong>Exemplo:</strong> seu app tem uma op√ß√£o para mostrar ou esconder uma barra de ferramentas e voc√™ quer que esta configura√ß√£o seja propagada para todos os dispositivos do usu√°rio</p>

<h2 id="por-que-n√£o-usar-alguma-alternativa">Por que n√£o usar alguma alternativa?</h2>

<p>O CloudKit √© uma tecnologia da pr√≥pria Apple que j√° vem instalada em todos os dispositivos, n√£o requer uma autentica√ß√£o al√©m da conta do iCloud que os usu√°rios j√° possuem, tem funcionalidades muito poderosas e tem uma grande chance de continuar existindo por um bom tempo. Estes s√£o os principais motivos que me fazem preferir o CloudKit em vez de solu√ß√µes de terceiros.</p>

<h1 id="quanto-custa">Quanto custa?</h1>

<p><img src="/img/insidegui/cloudkit/free-with-limits.gif" /></p>

<p>Esta √© uma d√∫vida comum quando estamos falando de servi√ßos de sincroniza√ß√£o e com o CloudKit n√£o √© diferente. Esta quest√£o do pre√ßo √© comumente confundida pelos desenvolvedores, ent√£o vou explicar aqui da forma mais simples poss√≠vel.</p>

<p><a href="https://www.youtube.com/watch?v=w87fOAG8fjk&amp;t=1h36m36s">Como disse Craig Federighi na introdu√ß√£o do CloudKit</a>:</p>

<blockquote>
  <p>O CloudKit √© gr√°tis‚Ä¶ (cof cof) com limites (cof cof) üôä</p>
</blockquote>

<p>Mas o que isso significa?</p>

<p>Colocando de forma simples: <strong>O CLOUDKIT √â GR√ÅTIS, PONTO</strong></p>

<p>O que a Apple fez foi criar um sistema que previna abusos, dessa forma, se voc√™ fizer um uso ‚Äònormal‚Äô do servi√ßo, ele ser√° sempre gr√°tis.</p>

<p>Conforme foi dito na session 231 da WWDC de 2014 (tradu√ß√£o livre):</p>

<blockquote>
  <p>N√≥s n√£o queremos previnir uso leg√≠timo</p>

  <p>N√≥s s√≥ queremos evitar que algu√©m abuse do CloudKit</p>

  <p>Os n√∫meros que n√≥s informamos aqui aumentam com o n√∫mero de usu√°rios que voc√™ tem</p>
</blockquote>

<p>E tem mais: se voc√™ utiliza apenas o <strong>banco de dados privado</strong> do CloudKit (que √© o uso mais comum), o uso dele conta para a cota do usu√°rio, ou seja, quem paga √© o usu√°rio e n√£o voc√™.</p>

<p>Os limites para uso do banco de dados p√∫blico do CloudKit aumentam com o n√∫mero de usu√°rios do seu app, conforme pode ser visto na simula√ß√£o abaixo que fiz no site da Apple:</p>

<p><img src="/img/insidegui/cloudkit/quota.png" /></p>

<p>Lembrando que estes limites s√£o para o banco de dados p√∫blico, que √© compartilhado por todos os usu√°rios do seu app, o uso do banco de dados privado de cada usu√°rio conta para a cota daquele usu√°rio no iCloud, ou seja, jamais ter√° custo algum para voc√™.</p>

<h1 id="m√£o-na-massa">M√£o na massa</h1>

<p>Passada esta introdu√ß√£o, hora de colocarmos a m√£o na massa. Vou explicar v√°rios conceitos sobre o CloudKit e ao mesmo tempo apresentar pequenos exemplos de como s√£o usados na pr√°tica üòâ</p>

<h2 style="color:#C86D6C">Ativando o CloudKit no seu projeto</h2>

<p>O primeiro passo para usarmos o CloudKit √© habilitar ele no painel Capabilities do Xcode.</p>

<p><img src="/img/insidegui/cloudkit/cloudkit-enable.gif" /></p>

<p>Ao habilitarmos o CloudKit no projeto, o Xcode se comunica com os servidores da Apple para atualizar o nosso provisioning profile e tamb√©m para criar o container padr√£o para o app.</p>

<p>Perceba que ao ativar o CloudKit, o Xcode ativou automaticamente Push Notifications, porque as subscriptions do CloudKit utilizam push notifications (falarei mais sobre isso depois).</p>

<h2 id="container">Container</h2>

<p>Um container nada mais √© do que uma caixinha onde voc√™ coloca os dados dos seus usu√°rios. O container √© o pai de todos os dados e geralmente ser√° diferente para cada aplicativo seu, embora seja poss√≠vel compartilhar um container entre v√°rios apps. Por padr√£o, quando voc√™ habilita CloudKit no seu projeto, o Xcode cria um container com o bundle identifier do seu app. Outro detalhe a ser apontado √© que um √∫nico app pode acessar v√°rios containers.</p>

<p>Containers s√£o representados por objetos do tipo <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 style="color:#C86D6C">Acessando o container padr√£o</h3>

<p>Acessar o container padr√£o do app √© bem f√°cil: basta utilizar o m√©todo <code class="language-plaintext highlighter-rouge">default</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="o">.</span><span class="nf">default</span><span class="p">()</span>
</code></pre></div></div>

<h3 style="color:#C86D6C">Criando e acessando um container personalizado</h3>

<p>Se voc√™ pretende compartilhar dados no CloudKit com outros apps desenvolvidos por voc√™ ou por vers√µes para diferentes plataformas do mesmo app (ex: entre macOS e iOS), voc√™ deve criar um container pr√≥prio para isso.</p>

<p>O nome do container deve seguir o mesmo esquema dos bundle identifiers: DNS reverso. No meu caso, criei um container chamado <code class="language-plaintext highlighter-rouge">iCloud.br.com.guilhermerambo.KitchenContainer</code>.</p>

<p><img src="/img/insidegui/cloudkit/custom-container.gif" /></p>

<p>Com o container criado, basta usar o inicializador de <code class="language-plaintext highlighter-rouge">CKContainer</code> que aceita um <code class="language-plaintext highlighter-rouge">identifier</code> como par√¢metro e passar o nome que demos ao nosso container.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">containerIdentifier</span> <span class="o">=</span> <span class="s">"iCloud.br.com.guilhermerambo.KitchenContainer"</span>
<span class="k">let</span> <span class="nv">secondContainer</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="n">containerIdentifier</span><span class="p">)</span>
</code></pre></div></div>

<p>Se voc√™ for usar somente o container padr√£o do app, basta usar <code class="language-plaintext highlighter-rouge">CKContainer.default()</code>, nos demais exemplos deste artigo utilizarei o container default para que o c√≥digo fique mais breve.</p>

<h2 id="database">Database</h2>

<p>Database √© o banco de dados onde voc√™ ir√° armazenar os registros que seu app usa. Bancos de dados s√£o representados  por objetos do tipo <code class="language-plaintext highlighter-rouge">CKDatabase</code>.</p>

<p>Todo container do CloudKit cont√©m tr√™s bancos de dados:</p>

<h3 id="private-database">Private database</h3>

<p>Este √© o banco de dados privado, onde os dados privados dos seus usu√°rios ficar√£o armazenados. Somente um dispositivo do usu√°rio autenticado na conta do iCloud consegue ter acesso aos registros armazenados neste banco de dados.</p>

<p>Sendo assim, voc√™ como desenvolvedor do app n√£o consegue ver os dados dos seus usu√°rios. O dashboard do CloudKit apenas informa o n√∫mero de registros para cada tipo e voc√™ consegue ver os dados da sua pr√≥pria conta, mas n√£o dos outros.</p>

<p>Para acessar o banco de dados privado do usu√°rio, utilizamos a propriedade <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 id="public-database">Public database</h3>

<p>Este √© o banco de dados p√∫blico, onde voc√™ pode armazenar dados globais do seu app ou dados criados pelos usu√°rios que devem ser acess√≠veis pelos outros usu√°rios.</p>

<p>Apesar do banco de dados ser p√∫blico, √© poss√≠vel restringir quem tem acesso aos registros armazenados nele utilizando Security Roles, mas n√£o falarei sobre elas neste artigo.</p>

<p>Para acessar o banco de dados p√∫blico, utilizamos a propriedade <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 id="shared-database">Shared database</h3>

<p>Este √© o banco de dados de compartilhamento. Com o lan√ßamento do iOS 10 e do macOS Sierra a Apple liberou tamb√©m a fun√ß√£o de compartilhamento do CloudKit, pela qual usu√°rios podem compartilhar registros espec√≠ficos nos seus bancos de dados privados com contatos, permitindo com que ambos vejam e editem os registros simultaneamente. O banco de dados compartilhado √© usado para armazenar esses registros, mas seu app n√£o ir√° lidar com ele diretamente.</p>

<h2 id="zone">Zone</h2>

<p>Uma zona dentro do CloudKit √© como se fosse uma pasta onde voc√™ salva seus registros. Todo banco de dados do CloudKit tem uma zona padr√£o, a <code class="language-plaintext highlighter-rouge">Default Zone</code>. Voc√™ pode utilizar a zona padr√£o ou criar zonas novas para organizar seus registros. S√≥ √© poss√≠vel criar zonas no banco de dados privado, o banco de dados p√∫blico s√≥ permite o uso da zona padr√£o.</p>

<p>Algumas funcionalidades do CloudKit s√≥ s√£o poss√≠veis em zonas customizadas. Se voc√™ quiser salvar v√°rios objetos relacionados ao mesmo tempo e precisa que a opera√ß√£o falhe caso algum deles n√£o possa ser salvo, precisa usar uma zona customizada. O novo recurso de compartilhamento tamb√©m requer a utiliza√ß√£o de uma zona customizada.</p>

<p>Zonas s√£o representadas por objetos do tipo <code class="language-plaintext highlighter-rouge">CKZone</code>.</p>

<h3 style="color:#C86D6C">Obtendo uma lista de zonas</h3>

<p>Para listar a zonas dispon√≠veis em um banco de dados, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">fetchAllRecordZones</code> de <code class="language-plaintext highlighter-rouge">CKDatabase</code>.</p>

<script src="https://gist.github.com/insidegui/f27e48e6eda5bf53d993e67d3fbfaa92.js"></script>

<h2 id="record">Record</h2>

<p>Records s√£o os registros que est√£o salvos no banco de dados do CloudKit. Registros s√£o representados por objetos do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code>, que s√£o basicamente dicion√°rios onde podemos adicionar as chaves que quisermos, que se tornar√£o campos nas ‚Äútabelas‚Äù do servidor.</p>

<p>√â importante ressaltar que, apesar do banco de dados do CloudKit ser schemaless (voc√™ n√£o precisa definir os campos previamente), isso s√≥ √© verdade no ambiente de desenvolvimento, ap√≥s colocar seu app em produ√ß√£o voc√™ ter√° que fazer altera√ß√µes no seu schema no dashboard ou atrav√©s do seu app em ambiente de desenvolvimento e depois exportar essas altera√ß√µes para o ambiente de produ√ß√£o.</p>

<h3 id="tipos-de-dados-aceitos">Tipos de dados aceitos</h3>

<p>Embora <code class="language-plaintext highlighter-rouge">CKRecord</code> seja basicamente um dicion√°rio, n√£o significa que possamos salvar qualquer tipo de dado no CloudKit. Estes s√£o os tipos de dados que podemos colocar nas chaves de um <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">String</code>: a Apple recomenda <code class="language-plaintext highlighter-rouge">String</code> para pequenas quantidades de texto</li>
  <li><code class="language-plaintext highlighter-rouge">NSNumber</code>: tipos num√©ricos do Swift s√£o convertidos automaticamente</li>
  <li><code class="language-plaintext highlighter-rouge">Data</code>: um exemplo de uso para um campo tipo <code class="language-plaintext highlighter-rouge">Data</code> seria armazenar objetos pr√≥prios, codificados usando <code class="language-plaintext highlighter-rouge">NSCoding</code></li>
  <li><code class="language-plaintext highlighter-rouge">Date</code>: datas e horas podem ser armazenadas diretamente no CloudKit</li>
  <li><code class="language-plaintext highlighter-rouge">CLLocation</code>: muito √∫til para apps que trabalham com localiza√ß√£o, at√© porque √© poss√≠vel fazer queries com base em localiza√ß√£o (mais sobre isso depois)</li>
  <li><code class="language-plaintext highlighter-rouge">CKAsset</code>: este objeto do CloudKit representa um arquivo que pode conter uma grande quantidade de dados (fotos e v√≠deos, por exemplo)</li>
  <li><code class="language-plaintext highlighter-rouge">CKReference</code>: este objeto do CloudKit representa uma refer√™ncia que aponta para outro <code class="language-plaintext highlighter-rouge">CKRecord</code> no banco de dados</li>
</ul>

<p>Al√©m de poder utilizar os tipos citados acima por si s√≥, qualquer chave em um <code class="language-plaintext highlighter-rouge">CKRecord</code> pode conter tamb√©m um array desses tipos, desde que o array contenha objetos de um √∫nico tipo.</p>

<h3 style="color:#C86D6C">Criando um registro</h3>

<p>Vamos supor que estamos criando um aplicativo onde usu√°rios podem cadastrar filmes, provavelmente ter√≠amos um registro chamado <code class="language-plaintext highlighter-rouge">Movie</code>. Neste caso, <code class="language-plaintext highlighter-rouge">Movie</code> √© o nosso <code class="language-plaintext highlighter-rouge">recordType</code>.</p>

<p>Para criar um registro de um filme, inicializamos um <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">record</span> <span class="o">=</span> <span class="kt">CKRecord</span><span class="p">(</span><span class="nv">recordType</span><span class="p">:</span> <span class="s">"Movie"</span><span class="p">)</span>
</code></pre></div></div>

<p>Com o objeto criado, basta come√ßar a setar as propriedades. Dentro do view controller do app onde o usu√°rio entra com os dados do filme, poder√≠amos atualizar o record na action de um <code class="language-plaintext highlighter-rouge">UITextField</code>, por exemplo:</p>

<script src="https://gist.github.com/insidegui/399eb8f10315b8c87ee1926e3ccd9807.js"></script>

<p>Agora voc√™ deve estar se perguntando: ‚Äúo que diabos √© <code class="language-plaintext highlighter-rouge">CKRecordValue</code>? ü§î‚Äù.</p>

<p><code class="language-plaintext highlighter-rouge">CKRecordValue</code> √© um protocolo adotado por objetos suportados pelo CloudKit. O problema √© que, usando Swift, o compilador n√£o compreende que <code class="language-plaintext highlighter-rouge">String</code> adota <code class="language-plaintext highlighter-rouge">CKRecordValue</code> e por isso temos que fazer esse casting feio.</p>

<h3 style="color:#C86D6C">Melhorando nosso c√≥digo: custom subscript</h3>

<p>Para melhorar essa situa√ß√£o, sempre que trabalho com CloudKit eu crio enums com os campos dos meus registros e adiciono uma extens√£o em <code class="language-plaintext highlighter-rouge">CKRecord</code> com um custom subscript que aceita esse enum. Explicando assim parece complicado, mas no c√≥digo √© bem simples.</p>

<p>Primeiro, o enum dos campos do nosso registro:</p>

<script src="https://gist.github.com/insidegui/a66fd48d4e27a737718e9ddcd3b10fb9.js"></script>

<p>Agora podemos criar a extens√£o em <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<script src="https://gist.github.com/insidegui/7c862fa6226d8ecac72a4f137f699c46.js"></script>

<p>Agora, para modificar os valores dos nossos registros, nosso c√≥digo fica bem mais limpo, podemos fazer simplesmente assim:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
<span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">releaseDate</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">rating</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating</span>
<span class="c1">// e assim por diante...</span>
</code></pre></div></div>

<p>Vale ressaltar que com este subscript customizado, continuamos s√≥ podendo colocar no nosso registro valores suportados pelo CloudKit. Se tentarmos colocar algum valor n√£o suportado, o campo ficar√° nulo.</p>

<p>Outro detalhe importante: <code class="language-plaintext highlighter-rouge">CKRecord</code> <strong>n√£o</strong> √© um value type, ent√£o quando voc√™ passa objetos do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code> voc√™ est√° passando uma refer√™ncia e, caso tenha <code class="language-plaintext highlighter-rouge">didSet</code> em propriedades do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code>, o <code class="language-plaintext highlighter-rouge">didSet</code> n√£o ser√° chamado quando algum campo do registro for alterado üòâ</p>

<p>Na ‚Äúvida real‚Äù, voc√™ deve utilizar seus pr√≥prios models (provavelmente value types) e convert√™-los de/para <code class="language-plaintext highlighter-rouge">CKRecord</code> quando estiver lidando com o CloudKit.</p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/SimpleRecordTableViewController.swift">arquivo SimpleRecordTableViewController.swift do projeto de exemplo</a>.</p>

<h2 id="cloudkit-dashboard">CloudKit Dashboard</h2>

<p>Agora que j√° sabemos como criar registros no CloudKit, seria interessante termos uma forma de ver o que est√° acontecendo no servidor quando salvamos nossos registros.</p>

<p>A Apple criou uma ferramenta para isto, o CloudKit Dashboard. No dashboard n√≥s temos acesso a todos os nossos containers, bancos de dados, tipos de registros e muito mais.</p>

<p>Primeiramente, usando o app de exemplo, vamos criar um registro:</p>

<p><img src="/img/insidegui/cloudkit/simple-record.gif" /></p>

<p>Agora que temos um registro criado, vamos acessar o dashboard. O primeiro passo √© selecionar no menu do canto superior esquerdo com qual container queremos trabalhar.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-container-menu.png" /></p>

<p>Com o container selecionado, vemos inicialmente uma lista dos tipos de registro que temos. Todo banco de dados do CloudKit j√° vem por padr√£o com um tipo <code class="language-plaintext highlighter-rouge">User</code>, que armazena informa√ß√µes sobre usu√°rios.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-record-types.png" /></p>

<p>Para visualizarmos o registro salvo no banco de dados p√∫blico, selecionamos a op√ß√£o ‚ÄúDefault Zone‚Äù em ‚ÄúPublic Data‚Äù. Se tiv√©ssemos outras zonas, elas apareceriam nesta mesma lista.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-records.png" /></p>

<p>Agora o dashboard est√° nos avisando que ele precisa de um index no ID do registro para fazer uma listagem deles. Basta clicar em ‚ÄúAdd Record ID Query Index‚Äù e o dashboard ir√° ent√£o mostrar o registro que criamos usando o app.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-records-2.png" /></p>

<p>Note que, al√©m dos dados que n√≥s inserimos, o registro cont√©m alguns metadados que o CloudKit adiciona automaticamente:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Record Name</code>: este √© o ID √∫nico do registro, usado para localizar registros no banco de dados. N√≥s podemos definir este ID ou deixar que o CloudKit defina um automaticamente, neste caso ele usa um <code class="language-plaintext highlighter-rouge">UUID</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Created</code>: a data de cria√ß√£o do registro. Pode ser acessada atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">creationDate</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Created By</code>: o ID do usu√°rio que criou o registro. Pode ser acessado atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">creatorUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Modified</code>: a data da √∫ltima altera√ß√£o do registro. Pode ser acessada atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">modificationDate</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Modified By</code>: o ID do usu√°rio que realizou a √∫ltima altera√ß√£o no registro. Pode ser acessado atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">lastModifiedUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
</ul>

<h2 id="user-records">User Records</h2>

<p>Como vimos na se√ß√£o sobre o dashboard, o CloudKit cria automaticamente registros para os usu√°rios do nosso app. Esses registros s√£o do tipo <code class="language-plaintext highlighter-rouge">User</code> e cont√©m por padr√£o somente um identificador √∫nico do usu√°rio. Esse identificador √© √∫nico por container, quer dizer que um usu√°rio ter√° o mesmo identificador √∫nico em todos os bancos de dados e zonas dentro do seu container, mas se voc√™ utilizar mais de um container, ver√° IDs diferentes para o mesmo usu√°rio em cada um deles.</p>

<p>O CloudKit nos permite fazer diversas coisas com o registro do usu√°rio:</p>

<ul>
  <li>Descobrir se o usu√°rio est√° logado no iCloud ou n√£o</li>
  <li>Obter o registro do usu√°rio no container</li>
  <li>Obter o nome completo do usu√°rio</li>
  <li>Obter os identificadores dos contatos do usu√°rio que possuem registros correspondentes no mesmo container</li>
  <li>Atualizar o registro com dados √∫teis para o nosso app</li>
  <li>Ser notificado de mudan√ßas no status da conta do iCloud</li>
</ul>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">Todos os exemplos desta parte voc√™ encontra na √≠ntegra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/UserViewController.swift">arquivo UserViewController.swift do projeto de exemplo</a>.</p>

<h3 style="color:#C86D6C">Descobrindo se o usu√°rio est√° logado</h3>

<p>Em muitos casos √© importante sabermos se o usu√°rio est√° logado no iCloud no dispositivo atual para decidirmos se ativamos determinada funcionalidade do app ou at√© mesmo para impedir que o usu√°rio utilize o app at√© que esteja logado.</p>

<p><strong>Importante:</strong> caso voc√™ decida n√£o permitir com que o usu√°rio utilize o app sem estar logado no iCloud, lembre-se que poder√° ter que prestar esclarecimentos para o time de review da Apple, afinal eles n√£o gostam de apps que exigem algum tipo de login sem uma boa justificativa. Seu app precisa ter um bom motivo para exigir o login, do contr√°rio poder√° ser rejeitado.</p>

<p>Para obter o status da conta do iCloud, usamos o m√©todo <code class="language-plaintext highlighter-rouge">accountStatus</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/5523796b377133a637855e837acfbb7d.js"></script>

<h3 style="color:#C86D6C">Obtendo o ID do registro do usu√°rio</h3>

<p>Para obter o registro do usu√°rio do CloudKit, primeiro precisamos saber o ID dele. Para isso, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">fetchUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/f0140a3255a6a033d84cf4417998b6f9.js"></script>

<p><a name="user-record-fetch"></a>
Agora que n√≥s temos um <code class="language-plaintext highlighter-rouge">CKRecordID</code> referente ao registro do usu√°rio, podemos usar o m√©todo <code class="language-plaintext highlighter-rouge">fetch</code> de <code class="language-plaintext highlighter-rouge">CKDatabase</code> no banco de dados p√∫blico para baixar o registro completo do usu√°rio.</p>

<script src="https://gist.github.com/insidegui/42787a138c7213dd18e23b0ad633150c.js"></script>

<p>No exemplo eu estou usando <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code>, mas poderia usar <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code>. Qual banco de dados usar aqui vai depender da sua aplica√ß√£o, como o app de exemplo usa somente o banco de dados p√∫blico, optei por usar este.</p>

<p>√â poss√≠vel ter dois registros diferentes para o mesmo usu√°rio: um no banco de dados p√∫blico e outro no banco de dados privado, embora ambos tenham o mesmo identificador, os dados contidos em cada um deles podem ser diferentes. Voc√™ pode por exemplo utilizar o registro do usu√°rio no banco de dados p√∫blico para salvar informa√ß√µes como avatar e apelido e usar o registro no banco de dados privado para e-mail, endere√ßo e outros dados sigilosos.</p>

<h3 style="color:#C86D6C">Obtendo o nome completo do usu√°rio</h3>

<p>Podemos obter o nome completo do usu√°rio autenticado, mas isso requer a permiss√£o do mesmo.</p>

<p>Para solicitar essa permiss√£o, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">requestApplicationPermission</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>, passando o par√¢metro <code class="language-plaintext highlighter-rouge">.userDiscoverability</code>. Aparecer√° um alert para o usu√°rio solicitando permiss√£o.</p>

<p>Ap√≥s obtermos permiss√£o, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">discoverUserIdentity</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code> para obter a identidade do usu√°rio, que cont√©m o seu nome completo na forma de <code class="language-plaintext highlighter-rouge">PersonNameComponents</code> que podemos formatar atrav√©s de um <code class="language-plaintext highlighter-rouge">PersonNameComponentsFormatter</code>.</p>

<script src="https://gist.github.com/insidegui/4a282db0d8843b1503087f85fe8c3039.js"></script>

<h3 style="color:#C86D6C">Descobrindo contatos do usu√°rio que utilizam o mesmo app</h3>

<p>Para obter uma lista de registros dos amigos do usu√°rio que utilizam o app, ou seja, que tem registro no mesmo container, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">discoverAllIdentities</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/63ad1684f37b2dc3701029d17d625313.js"></script>

<h3 style="color:#C86D6C">Inserindo dados adicionais no registro do usu√°rio</h3>

<p>No nosso app de exemplo, vamos supor que n√≥s queremos listar os filmes cadastrados e junto ao filme exibir o nome e avatar do usu√°rio que cadastrou aquele filme. Infelizmente a Apple n√£o fornece uma op√ß√£o para obter o avatar do usu√°rio do iCloud, mas n√≥s podemos oferecer esta funcionalidade no nosso pr√≥prio app, utilizando um campo no user record.</p>

<p>Para isto, vamos aprender tamb√©m sobre uma nova classe: <code class="language-plaintext highlighter-rouge">CKAsset</code>.</p>

<p><code class="language-plaintext highlighter-rouge">CKAsset</code> √© um objeto usado para armazenar arquivos grandes no CloudKit. A Apple recomenda que qualquer campo que seja maior do que alguns kilobytes seja armazenado usando <code class="language-plaintext highlighter-rouge">CKAsset</code>.</p>

<p>Trabalhar com <code class="language-plaintext highlighter-rouge">CKAsset</code> √© muito simples: basta inicializ√°-lo com a URL para um arquivo que queremos armazenar no CloudKit e apontar um campo de um <code class="language-plaintext highlighter-rouge">CKRecord</code> para o <code class="language-plaintext highlighter-rouge">CKAsset</code> criado.</p>

<p>Quando o registro for salvo, o CloudKit cuidar√° de enviar o arquivo junto dele. No caso do nosso app estamos enviando imagens para serem usadas como avatar, no meu c√≥digo de exemplo n√£o h√° nenhum tipo de tratamento quanto ao tipo de imagem ou tamanho do arquivo, mas se fosse um app real eu provavelmente iria validar e redimensionar a imagem para evitar desperd√≠cio de espa√ßo no iCloud e consumo de banda desnecess√°rio.</p>

<p>Eu adicionei um bot√£o na interface que abre um <code class="language-plaintext highlighter-rouge">UIImagePickerController</code> para que o usu√°rio possa selecionar uma foto da biblioteca para servir de avatar. O exemplo abaixo mostra a implementa√ß√£o do que acontece ap√≥s o usu√°rio selecionar uma imagem:</p>

<script src="https://gist.github.com/insidegui/8c960b15f65aa123fe9e20fe2ee07226.js"></script>

<p>No exemplo acima, <code class="language-plaintext highlighter-rouge">imageURL</code> √© uma <code class="language-plaintext highlighter-rouge">URL</code> para um arquivo salvo localmente, se voc√™ tentar inicializar um <code class="language-plaintext highlighter-rouge">CKAsset</code> com algum outro tipo de <code class="language-plaintext highlighter-rouge">URL</code> haver√° uma exception e seu app ir√° travar.</p>

<p>O m√©todo <code class="language-plaintext highlighter-rouge">save</code> √© usado tanto para criar quanto para atualizar registros. Ao passar um registro com um ID que j√° existe no servidor, o CloudKit ir√° atualizar por padr√£o apenas os campos que foram alterados desde o √∫ltimo salvamento.</p>

<p>Como podem ver, √© muito simples adicionar um campo personalizado ao registro do usu√°rio e enviar arquivos para o CloudKit.</p>

<p><img src="/img/insidegui/cloudkit/avatar.gif" /></p>

<h3 style="color:#C86D6C">Observando mudan√ßas no status da conta do iCloud</h3>

<p>Algo que pode acontecer enquanto seu app est√° rodando √© que o usu√°rio pode abrir as prefer√™ncias do iCloud e trocar de conta, n√£o estar logado e ent√£o logar ou estar logado e fazer logoff.</p>

<p>Em qualquer um desses casos, se o seu app varia de acordo com a conta do iCloud ativa, voc√™ precisa atualizar o estado do app para refletir esta mudan√ßa.</p>

<p>Para ser notificado de mudan√ßas na conta do iCloud, basta registrar um observer para a notifica√ß√£o <code class="language-plaintext highlighter-rouge">.CKAccountChanged</code>:</p>

<script src="https://gist.github.com/insidegui/0868e826fb781a07958963802c069e44.js"></script>

<p>No meu exemplo, ao receber esta notifica√ß√£o, estou chamando o m√©todo do view controller que faz o processo de descoberta de todos os dados do usu√°rio. Assim, a interface ficar√° sempre em sincronia com o status do iCloud no dispositivo.</p>

<p><img src="/img/insidegui/cloudkit/account.gif" /></p>

<h2 id="queries">Queries</h2>

<p>Agora que j√° vimos como salvar informa√ß√µes no CloudKit, vamos ver como fazemos para buscar essas informa√ß√µes. A forma mais simples de obter um registro do CloudKit √© atrav√©s de uma simples busca com base em um ID, <a href="#user-record-fetch">como j√° vimos antes</a>.</p>

<p>Se quisermos fazer buscas mais avan√ßadas, filtradas com base em outros campos do registro, precisaremos utilizar a classe <code class="language-plaintext highlighter-rouge">CKQuery</code>. Com ela, podemos especificar um predicate que ir√° definir um filtro para a busca.</p>

<p>Se voc√™ n√£o tem familiaridade com <code class="language-plaintext highlighter-rouge">NSPredicate</code>, recomendo que <a href="https://developer.apple.com/reference/foundation/nspredicate">d√™ uma lida na documenta√ß√£o</a>, pois trata-se de uma classe muito poderosa e que √© usada em diversas APIs da Apple.</p>

<p>Para rodarmos uma query no CloudKit, iremos utilizar uma <code class="language-plaintext highlighter-rouge">CKQueryOperation</code>. Realizar queries √© apenas uma dentre muitas funcionalidades do CloudKit que s√£o expostas na forma de operations.</p>

<h3 style="color:#C86D6C">Obtendo todos os registros de um determinado tipo</h3>

<p>Este √© o exemplo mais simples. Vamos executar uma query para obter todos os filmes que temos registrados no nosso banco de dados p√∫blico. O primeiro passo √© construir uma query com um tipo de registro e um predicate, como queremos todos os registros, basta criarmos uma query especificando o tipo <code class="language-plaintext highlighter-rouge">Movie</code> e um predicate com o valor <code class="language-plaintext highlighter-rouge">true</code>:</p>

<script src="https://gist.github.com/insidegui/839813b1754e31b648aaf47c50ae636a.js"></script>

<p>Agora que temos uma opera√ß√£o, antes de execut√°-la, precisamos definir os callbacks que ser√£o chamados para que sejamos informados de novos resultados e poss√≠veis erros na opera√ß√£o:</p>

<script src="https://gist.github.com/insidegui/c3338649c87ae8535294dfa710532928.js"></script>

<p><code class="language-plaintext highlighter-rouge">CKQueryOperation</code> tem dois callbacks: um que √© chamado para cada registro obtido do CloudKit e outro que √© chamado no final da opera√ß√£o, ap√≥s todos os registros terem sido baixados.</p>

<p>H√° dois par√¢metros neste √∫ltimo callback que merecem coment√°rio: <code class="language-plaintext highlighter-rouge">cursor</code> √© um objeto do tipo <code class="language-plaintext highlighter-rouge">CKCursor</code> que poder√° estar presente ao final da opera√ß√£o caso haja mais resultados a serem obtidos. Se sua query for retornar uma quantidade muito grande de registros, voc√™ ter√° que executar v√°rias <code class="language-plaintext highlighter-rouge">CKQueryOperation</code>s para conseguir obter todos eles, passando o <code class="language-plaintext highlighter-rouge">cursor</code> nas queries subsequentes.</p>

<p>O par√¢metro <code class="language-plaintext highlighter-rouge">error</code> tamb√©m √© important√≠ssimo, a partir dele √© poss√≠vel saber se houve um erro na opera√ß√£o e qual a natureza do erro. Alguns erros no CloudKit s√£o recuper√°veis, isso significa que n√£o basta simplesmente exibir um alerta ao usu√°rio no primeiro erro encontrado, voc√™ precisa lidar com o erro. Dependendo de qual foi o erro, o CloudKit ir√° informar at√© mesmo em quantos segundos √© recomendado que a opera√ß√£o seja tentada novamente (e voc√™ deve definitivamente seguir essa recomenda√ß√£o).</p>

<p>Finalmente, ap√≥s configurarmos nossa opera√ß√£o, basta execut√°-la, adicionando-a ao banco de dados:</p>

<script src="https://gist.github.com/insidegui/e2834c0cb17d19a405a538ef2829683b.js"></script>

<p>Se quis√©ssemos executar a opera√ß√£o no banco de dados privado, bastaria substituir <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code> por <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code>. Existem algumas outras opera√ß√µes do CloudKit que s√£o executadas no n√≠vel do container, nesses casos voc√™ chamaria o m√©todo <code class="language-plaintext highlighter-rouge">add</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 style="color:#C86D6C">Realizando uma busca textual</h3>

<p>Outro tipo de query muito comum de se fazer √© a busca textual. No nosso exemplo, usu√°rios podem querer buscar filmes pelo t√≠tulo. Felizmente o CloudKit sabe lidar muito bem com isso e podemos construir um predicate simples que d√° conta do recado:</p>

<script src="https://gist.github.com/insidegui/5806c2078648de7425b1e59d6d2c49fb.js"></script>

<p>O predicate <code class="language-plaintext highlighter-rouge">self contains %@</code> significa ‚Äúbusque este valor em todos os par√¢metros do registro que contenham texto‚Äù.</p>

<h3 style="color:#C86D6C">Realizando uma busca por localiza√ß√£o geogr√°fica</h3>

<p>Parece mesmo que a Apple pensou em tudo, afinal podemos fazer at√© mesmo queries baseadas em localiza√ß√£o usando o CloudKit. No meu exemplo utilizei a localiza√ß√£o atual do dispositivo para buscar filmes que tenham sido gravados em loca√ß√µes num raio de 500km.</p>

<p>Para fazermos uma query baseada em localiza√ß√£o, o predicate fica desta forma:</p>

<script src="https://gist.github.com/insidegui/23d254910cc315d70143db0f8dfd232d.js"></script>

<p>Onde <code class="language-plaintext highlighter-rouge">location</code> dentro da string se refere √† chave no nosso registro, <code class="language-plaintext highlighter-rouge">currentLocation</code> √© um objeto <code class="language-plaintext highlighter-rouge">CLLocation</code> com a localiza√ß√£o atual e <code class="language-plaintext highlighter-rouge">radius</code> √© um <code class="language-plaintext highlighter-rouge">Float</code> contendo o tamanho do raio inclu√≠do na pesquisa (em quil√¥metros).</p>

<p>Aqui est√° uma demonstra√ß√£o dos tr√™s tipos de query explicados acima:</p>

<p><img src="/img/insidegui/cloudkit/queries.gif" /></p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/QueryTableViewController.swift">arquivo QueryTableViewController.swift do projeto de exemplo</a>.</p>

<p>Fazer queries no banco de dados nos d√° total flexibilidade para obtermos apenas as informa√ß√µes mais relevantes ao contexto do nosso app, mas o CloudKit tem algo ainda mais legal que isso. Com ele n√≥s podemos criar queries persistentes, executadas a cada altera√ß√£o no banco de dados e que notificam nosso app via push. Essas queries persistentes s√£o chamadas de subscriptions.</p>

<h2 id="subscriptions">Subscriptions</h2>

<p>Lembram que eu falei anteriormente sobre enviar notifica√ß√µes usando o CloudKit? √â exatamente isso que subscriptions nos permitem fazer.</p>

<p>Atrav√©s de subscriptions, n√≥s registramos o interesse de um determinado dispositivo ser notificado toda vez que alguma altera√ß√£o ocorrer no banco de dados. Ent√£o, se um novo registro for inserido, o CloudKit ir√° enviar uma notifica√ß√£o para aquele dispositivo. Essas notifica√ß√µes podem ser apenas de <code class="language-plaintext highlighter-rouge">content-available</code> (silenciosas), ou notifica√ß√µes normais que mostram um alerta no dispositivo e/ou colocam n√∫meros no badge do app.</p>

<p>Atrav√©s de notifica√ß√µes silenciosas, podemos garantir um update imediato em todos os dispositivos do usu√°rio sempre que o mesmo fizer alguma altera√ß√£o em outro dispositivo, afinal este tipo de notifica√ß√£o d√° ao nosso app a oportunidade de efetuar um background fetch.</p>

<h3 style="color:#C86D6C">Criando subscription para envio de notifica√ß√µes</h3>

<p>Para criar uma subscription que envia notifica√ß√µes, primeiro precisamos obter permiss√£o do usu√°rio para que ele receba as notifica√ß√µes do nosso app e dizer para o sistema que queremos utilizar notifica√ß√µes remotas.</p>

<script src="https://gist.github.com/insidegui/d9510bb2b567b3f01552bfd303fa0a04.js"></script>

<p>Se voc√™ for usar somente notifica√ß√µes silenciosas (<code class="language-plaintext highlighter-rouge">content-available</code>), s√≥ precisa fazer a √∫ltima chamada (<code class="language-plaintext highlighter-rouge">registerForRemoteNotifications</code>). No app de exemplo estamos usando notifica√ß√µes de alerta com som, por isso precisamos solicitar permiss√£o atrav√©s do <code class="language-plaintext highlighter-rouge">UNUserNotificationCenter</code>.</p>

<p>Tendo permiss√£o do usu√°rio para enviar notifica√ß√µes, podemos criar nossa subscription com o CloudKit. A subscription √© um objeto <code class="language-plaintext highlighter-rouge">CKSubscription</code>, que criamos desta forma:</p>

<script src="https://gist.github.com/insidegui/3228e3d30cd257f3cc2b27dfc824016d.js"></script>

<p>Vamos ver o que cada coisa significa:</p>

<h4 id="recordtype"><code class="language-plaintext highlighter-rouge">recordType</code></h4>

<p>O tipo de registro para o qual queremos receber notifica√ß√µes.</p>

<h4 id="predicate"><code class="language-plaintext highlighter-rouge">predicate</code></h4>

<p>Qual query ser√° executada para determinar se uma notifica√ß√£o ser√° disparada ou n√£o (neste exemplo, qualquer registro). Como mencionei na parte anterior, subscriptions s√£o como queries persistentes que ficam rodando no servidor a cada altera√ß√£o no banco de dados, √© atrav√©s deste par√¢metro que n√≥s determinamos que query ser√° essa.</p>

<p>Lembram da query com localiza√ß√£o que fizemos no exemplo anterior? Poder√≠amos registrar uma subscription com aquela query, fazendo com que o usu√°rio seja notificado sempre que um filme gravado perto da sua cidade for registrado no sistema.</p>

<h4 id="options"><code class="language-plaintext highlighter-rouge">options</code></h4>

<p>Uma lista definindo em quais circunst√¢ncias a notifica√ß√£o ser√° disparada. Podemos pedir para que a notifica√ß√£o seja disparada quando um novo registro for criado, um registro existente for alterado ou exclu√≠do (ou as tr√™s op√ß√µes ao mesmo tempo).</p>

<h4 style="color:#C86D6C">Definindo como ser√° a notifica√ß√£o</h4>

<p>Com nossa subscription criada, precisamos definir como ser√° a notifica√ß√£o que essa subscription ir√° gerar. Para isso, vamos criar um objeto <code class="language-plaintext highlighter-rouge">CKNotificationInfo</code>:</p>

<script src="https://gist.github.com/insidegui/d607ab29d2c60ddb6b297d51bbfa1265.js"></script>

<h4 id="alertlocalizationkey"><code class="language-plaintext highlighter-rouge">alertLocalizationKey</code></h4>

<p>Este par√¢metro √© uma chave no nosso <code class="language-plaintext highlighter-rouge">Localizable.strings</code> que ser√° o formato do alerta. √â necess√°rio usar este par√¢metro quando voc√™ precisa incluir dados do registro no texto do alerta. No meu caso eu estou incluindo o t√≠tulo do filme que foi criado:</p>

<p><code class="language-plaintext highlighter-rouge">"movie_registered_alert" = "%@ has been registered, check it out!";</code></p>

<h4 id="alertlocalizationargs"><code class="language-plaintext highlighter-rouge">alertLocalizationArgs</code></h4>

<p>As chaves do registro que ser√£o usadas para popular os placeholders no texto do alerta. No exemplo estou usando a chave <code class="language-plaintext highlighter-rouge">title</code>, que √© o t√≠tulo do filme.</p>

<h4 id="desiredkeys"><code class="language-plaintext highlighter-rouge">desiredKeys</code></h4>

<p>As chaves do registro que ser√£o enviadas junto da notifica√ß√£o, que podemos usar no app para fazer uma query e localizar o registro.</p>

<h4 style="color:#C86D6C">Salvando a subscription</h4>

<p>Agora que criamos a subscription e definimos como ser√£o as notifica√ß√µes, basta salv√°-la como se fosse um registro qualquer:</p>

<script src="https://gist.github.com/insidegui/84c92632f108899c84e1de8d56df9654.js"></script>

<p>Lembrando que a subscription dever√° ser salva no banco de dados para o qual voc√™ deseja ser notificado. Como o app de exemplo usa o banco de dados p√∫blico, estou usando <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code>.</p>

<p>Com a configura√ß√£o acima, ao criar um registro em outro dispositivo, meu iPhone e meu Apple Watch receberam a seguinte notifica√ß√£o:</p>

<p><img src="/img/insidegui/cloudkit/notification_watch.png" /></p>

<p><img src="/img/insidegui/cloudkit/notification_phone.png" /></p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/SubscriptionViewController.swift">arquivo SubscriptionViewController.swift do projeto de exemplo</a>.</p>

<h1 id="arquitetura-para-sincroniza√ß√£o">Arquitetura para sincroniza√ß√£o</h1>

<p>O que n√≥s vimos at√© agora no artigo foram apenas os conceitos b√°sicos de como utilizar as funcionalidades do CloudKit. Para criar um app que sincroniza de forma eficiente e correta os dados do usu√°rio, h√° muito mais a ser feito.</p>

<p>Para tentar ajudar quem precisa dessa funcionalidade, criei um simples app para cria√ß√£o de notas (estilo Notes da Apple) que usa uma arquitetura offline-first para sincroniza√ß√£o.</p>

<p>O fluxo do app √© mais ou menos assim:</p>

<p><img src="/img/insidegui/cloudkit/sync_flow.gif" /></p>

<p>As notas s√£o salvas localmente num banco de dados <a href="https://realm.io">Realm</a>. Atrav√©s de <a href="https://realm.io/docs/swift/latest/#notifications">Realm Notifications</a>, o motor de sincroniza√ß√£o sabe sempre que uma nota √© adicionada, alterada ou removida no banco de dados local. Essas altera√ß√µes s√£o reconhecidas pelo motor de sincroniza√ß√£o, que transforma os models em <code class="language-plaintext highlighter-rouge">CKRecord</code>s e envia para o CloudKit.</p>

<p>O mesmo processo acontece inverso quando a altera√ß√£o ocorre no CloudKit: o app recebe uma notifica√ß√£o remota, pega as informa√ß√µes sobre quais registros foram adicionados/alterados/removidos e replica essas altera√ß√µes no banco de dados local. A altera√ß√£o no banco de dados local causa um update na interface.</p>

<p>Um cuidado que precisa ser tomado neste caso √© no sentido de evitar loops de sincroniza√ß√£o. Se uma altera√ß√£o no Realm provoca um salvamento no CloudKit e uma altera√ß√£o no CloudKit provoca um download e altera√ß√£o no Realm, temos um loop. Para evitar este problema, o motor de sincroniza√ß√£o registra um notification token com o Realm para que as altera√ß√µes provocadas por ele n√£o fa√ßam com que as notifica√ß√µes sejam enviadas para ele mesmo.</p>

<h2 id="tratamento-de-erros">Tratamento de erros</h2>

<p>√â muito importante observar a ocorr√™ncia de erros nas opera√ß√µes do CloudKit e tentar lidar com eles da melhor forma poss√≠vel. Muitos desenvolvedores est√£o acostumados a simplesmente colocar um <code class="language-plaintext highlighter-rouge">print</code> quando ocorre um erro ou mostrar um alerta para o usu√°rio, mas nem sempre esta √© a melhor alternativa.</p>

<p>A primeira coisa que voc√™ deve fazer √© verificar se o erro √© recuper√°vel. Existem dois casos muito comuns que causam erros recuper√°veis quando estamos trabalhando com CloudKit:</p>

<h3 id="erro-tempor√°rio--timeout--internet-ruim--rate-limit">Erro tempor√°rio / timeout / internet ruim / rate limit</h3>

<p>√Äs vezes pode ocorrer um pequeno <em>glitch</em> na conex√£o ou nos servidores da Apple que causa um erro tempor√°rio. Tamb√©m pode acontecer do seu app estar chamando o CloudKit com muita frequ√™ncia, neste caso o servidor ir√° recusar alguns requests para aliviar o excesso de carga. Nesses casos, o <code class="language-plaintext highlighter-rouge">error</code> retornado no callback da opera√ß√£o ser√° do tipo <code class="language-plaintext highlighter-rouge">CKError</code>, que cont√©m uma propriedade <code class="language-plaintext highlighter-rouge">retryAfterSeconds</code>. Se esta propriedade n√£o for <code class="language-plaintext highlighter-rouge">nil</code>, use o valor contido nela como um delay para tentar novamente a opera√ß√£o que falhou.</p>

<p>Nos meus projetos com CloudKit eu sempre tenho uma fun√ß√£o mais ou menos assim:</p>

<script src="https://gist.github.com/insidegui/8c726b4b705ddfe2fe01f24672c9a792.js"></script>

<p>Esta fun√ß√£o facilita o tratamento de erros recuper√°veis do CloudKit. Ela recebe um erro retornado de uma opera√ß√£o do CloudKit, um bloco a ser executado caso o erro seja recuper√°vel e retorna um erro caso a opera√ß√£o n√£o possa ser tentada novamente.</p>

<h3 id="conflitos">Conflitos</h3>

<p>Outro caso que pode acontecer √© um conflito entre duas altera√ß√µes no banco de dados. O usu√°rio pode ter modificado um registro em um dispositivo enquanto o mesmo estava offline e depois fez uma altera√ß√£o diferente em outro dispositivo. Neste caso, o salvamento ir√° falhar e o CloudKit ir√° retornar um erro do tipo <code class="language-plaintext highlighter-rouge">server‚ÄãRecord‚ÄãChanged</code>.</p>

<p>O <code class="language-plaintext highlighter-rouge">userInfo</code> desse erro ir√° conter o registro original antes da modifica√ß√£o, o registro atual no servidor e o registro atual no cliente. Com estas informa√ß√µes, cabe ao seu app decidir o que fazer para solucionar o conflito. Alguns apps exibem um painel para que o usu√°rio decida o que fazer, outros fazem um merge do conte√∫do automaticamente e outros apenas salvam o registro que foi modificado mais recentemente.</p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/NoteTaker">projeto NoteTaker, no meu Github</a>.</p>

<h1 id="conclus√£o">Conclus√£o</h1>

<p>Com isto, chegamos ao fim deste <strike>pequeno</strike> artigo sobre CloudKit. Espero que este artigo tenha te ajudado a entender melhor o que √© o CloudKit e tenha te dado ideias de como poder√° utiliz√°-lo em seus projetos.</p>

<h1 id="sugest√µes-de-estudo">Sugest√µes de estudo</h1>

<ul>
  <li><a href="https://developer.apple.com/reference/cloudkit">Documenta√ß√£o da Apple sobre o CloudKit</a></li>
  <li><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/iCloudDesignGuide/DesigningforCloudKit/DesigningforCloudKit.html">Designing for CloudKit</a></li>
  <li><a href="https://medium.com/@kwylez/cloudkit-sharing-series-creating-the-ckshare-40e420b94ee8#.7snggpqs1">CloudKit Sharing</a></li>
  <li><a href="https://developer.apple.com/search/?type=Videos&amp;q=CloudKit">Todas as sessions da WWDC sobre CloudKit</a></li>
</ul>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/tutorial/2017/03/22/swift-machine-learning/" data-toggle="tooltip" data-placement="top" title="Swift & Machine Learning">&larr; Post Anterior</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/subscription/2017/03/25/Gerenciando-subscriptions-com-In-App-Purchases/" data-toggle="tooltip" data-placement="top" title="Gerenciando subscriptions com In-App Purchases">Pr√≥ximo Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */

                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//equinocios.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">A odisseia do puto ‚Äî Raimundo Pessoa & Frederico Do</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
