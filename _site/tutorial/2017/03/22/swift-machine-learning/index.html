<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog de tecnologia e desenvolvimento ‚Äî artigos, tutoriais e opini√£o.">

    <title>Swift & Machine Learning - A odisseia do puto</title>

    <link rel="canonical" href="http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/odisseia.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="A odisseia do puto" />

    

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A odisseia do puto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="intro-header-overlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Swift & Machine Learning</h1>
                        
                        <h2 class="subheading">Sobre Recursos Humanos e Florestas Aleat√≥rias</h2>
                        
                        <span class="meta">Postado por Lucas Farris em 22/03/2017</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=Swift & Machine Learning&url=http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>

				<blockquote>
  <p>Geralmente, quando se fala em aprendizado de m√°quina para mobile, √© mais comum ver c√≥digos escritos em Python ou R, rodando do lado do servidor. No entanto, h√° casos em que compensa mais fazer o processamento localmente (por poder ser feito offline, e n√£o sobrecarregar o server). Por isso o uso de Swift √© justific√°vel. Uns 4 anos atr√°s, eu falaria pra usar o OpenCV rodando nativo em C++, mas os tempos s√£o outros.</p>

  <p>Se voc√™, caro leitor, nunca teve contato com intelig√™ncia artificial, n√£o tema; este artigo n√£o assume que voc√™ conhe√ßa previamente nada sobre.</p>
</blockquote>

<ol>
  <li>
    <h3 id="resumo">Resumo</h3>

    <p>Vamos juntos, neste artigo, estudar a base de dados sobre Recursos Humanos do <em>Kaggle</em>, e criar uma nova implementa√ß√£o do algoritmo Random Forest na linguagem <em>Swift</em>. Em termos da linguagem <em>Swift</em>, discutiremos <em>generics</em>, ponteiros e paraleliza√ß√£o. De Aprendizado de M√°quina, vamos falar de engenharia de features, dados, par√¢metros e valida√ß√£o. Sobre engenharia de algoritmos, vamos ver complexidade, otimiza√ß√£o e estruturas de dados.</p>
  </li>
  <li>
    <h3 id="introdu√ß√£o">Introdu√ß√£o</h3>

    <p>Em termos de frameworks para ML (<em>machine learning</em>), o Swift n√£o est√° muito bem. Existem <a href="https://github.com/josephmisiti/awesome-machine-learning#swift-general-purpose">alguns projetos</a> isolados, mas todos s√£o promessas inacabadas, e nenhum tinha o algoritmo que eu queria usar (<em>Random Forest</em>). Logo, como eu n√£o queria incentivar o <em>black-box</em> <a href="http://www.ic.unicamp.br/~rocha/pub/papers/2010-sibgrapi-ml-black-boxes.pdf">que j√° rola na √°rea</a>, surgiu este artigo: escrever o algoritmo. Eu n√£o tenho como ressaltar isso o suficiente:</p>

    <blockquote>
      <p>E S C R E V A      S E U S      A L G O R I T M O S</p>
    </blockquote>

    <p>Pra quem quer se aprofundar na √°rea, recomento o livro cl√°ssico <a href="http://aima.cs.berkeley.edu/">Intelig√™ncia Artificial: uma abordagem moderna</a> e o <a href="https://www.coursera.org/learn/machine-learning">curso de Stanford</a> (os dois rolavam soltos em pendrives quando eu cursei essa disciplina na universidade).</p>

    <p>Neste artigo, vamos falar sobre Recursos Humanos, e como identificar funcion√°rios que v√£o pedir demiss√£o.</p>
  </li>
  <li>
    <h3 id="sobre-homens-e-dados">Sobre homens e dados</h3>

    <p>Primeiramente, vamos falar dos nossos dados. A <a href="https://www.kaggle.com/ludobenistant/hr-analytics">base de recursos humanos</a> √© atualmente (Fev. 2017) a terceira mais votada no Kaggle. Ela tem um sutil <em>disclaimer</em>: <code class="language-plaintext highlighter-rouge">This dataset is simulated</code>. Logo, qualquer informa√ß√£o que tirarmos daqui n√£o deve ser levada muito a s√©rio.</p>

    <p>Antes de qualquer coisa, vamos dar uma limpada na base de dados, uma <em>engenharia de features</em>. Isso geralmente consiste em descartar dados menos relevantes, e realizar opera√ß√µes nos dados restantes.</p>

    <blockquote>
      <p>Um exemplo maravilhoso de engenharia de <em>features</em> est√° <a href="https://www.kaggle.com/c/titanic">nos dados dos passageiros do Titanic</a>. Ao correlacionar as entradas com a sa√≠da, o fator <code class="language-plaintext highlighter-rouge">sobreviveu? Sim ou n√£o</code>, vemos que as tr√™s informa√ß√µes claramente mais importantes s√£o [Idade, Sexo, Classe]. Mulhers com mais de trinta anos, meninos com menos de dez anos, e passageiros da primeira classe, tem muito mais chances de sobreviver. Todavia, olhando cuidadosamente os nomes dos passageiros, podemos extrair o t√≠tulo dele (ex: Mr., Miss., Mrs.) que se torna uma feature poderos√≠ssima.</p>
    </blockquote>

    <p>Escrevi um pequeno trecho de c√≥digo em <code class="language-plaintext highlighter-rouge">Python</code> pra fazer esse trabalho por n√≥s:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'HR.csv'</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c1">#kill uninteresting rows
</span><span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">().</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'database.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>As colunas <code class="language-plaintext highlighter-rouge">[Satisfa√ß√£o do funcion√°rio, acidentes no trabalho, se foram promovidos recentemente, departamento, sal√°rio]</code> cont√©m os dados menos <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.corr.html">correlacionados</a> com a sa√≠da dos funcion√°rios. Isso nos deixa com os seguintes:</p>

    <table>
      <thead>
        <tr>
          <th>Vari√°vel</th>
          <th>Correla√ß√£o com Y</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Anos na empresa</td>
          <td>0.144822</td>
        </tr>
        <tr>
          <td>M√©dia de horas por m√™s</td>
          <td>0.071287</td>
        </tr>
        <tr>
          <td>N√∫mero de projetos realizados</td>
          <td>0.023787</td>
        </tr>
        <tr>
          <td>√öltima avalia√ß√£o do funcion√°rio pela empresa</td>
          <td>0.006567</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <h3 id="florestal-rand√¥mico">‚ÄòFlorestal Rand√¥mico‚Äô</h3>

    <p>O algoritmo <em>Random Forest</em>, ou como eu o apelido carinhosamente, <em>Mata Atl√¢ntica</em>, √© um classificador supervisionado. Em outras palavras, ele divide dados em classes, e precisa saber previamente a classe dos seus dados para aprender a classificar outros. <em>Classe</em> √© o tipo do dado, no nosso caso, se o funcion√°rio pediu ou n√£o demiss√£o.</p>

    <p>Em termos simples, ele cria m√∫ltiplas <a href="https://en.wikipedia.org/wiki/Decision_tree">√°rvores de decis√£o</a>, s√≥ que cada √°rvore usa um subconjunto aleat√≥rio de <em>features</em>, e depois usamos <em><a href="https://en.wikipedia.org/wiki/Bootstrap_aggregating">BAgging</a></em> para decidir entre as √°rvores. Uma verdadeira sacada (<em>migu√©</em>) que performa, pasme, impressionantemente bem e r√°pido. Na nossa implementa√ß√£o, vamos dar suporte aos seguintes par√¢metros:</p>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Tipo</th>
          <th>Descri√ß√£o</th>
          <th>Padr√£o</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Profundidade M√°xima</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code> (1,‚àû)</td>
          <td>Altura m√°xima de cada √°rvore, ou seja, m√°xima dist√¢ncia entre a raiz e as folhas. Aumentar esse n√∫mero deixa o algoritmo mais r√°pido e menos preciso</td>
          <td><code class="language-plaintext highlighter-rouge">10</code></td>
        </tr>
        <tr>
          <td>Tamanho M√≠nimo do N√≥</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code> (1,‚àû)</td>
          <td>Tamanho m√≠nimo do subconjunto do <code class="language-plaintext highlighter-rouge">dataset</code> no qual cada n√≥ √© dividido. Aumentar esse n√∫mero deixa o algoritmo mais r√°pido e menos preciso</td>
          <td><code class="language-plaintext highlighter-rouge">50</code></td>
        </tr>
        <tr>
          <td>Tamanho de <code class="language-plaintext highlighter-rouge">Sample</code></td>
          <td><code class="language-plaintext highlighter-rouge">Double</code>(0,1)</td>
          <td>Porcentagem do <code class="language-plaintext highlighter-rouge">dataset</code> a ser <em>‚Äúsampleada‚Äù</em> em cada √°rvore. Ajuda a deixar cada √°rvore diferente entre si</td>
          <td><code class="language-plaintext highlighter-rouge">0.1</code></td>
        </tr>
        <tr>
          <td>N√∫mero de √Årvores</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code>(1,‚àû)</td>
          <td>N√∫mero de √°rvores constru√≠das</td>
          <td><code class="language-plaintext highlighter-rouge">10</code></td>
        </tr>
        <tr>
          <td><em>Seed</em></td>
          <td><code class="language-plaintext highlighter-rouge">String</code></td>
          <td>Semente do gerador de n√∫meros aleat√≥rios</td>
          <td><code class="language-plaintext highlighter-rouge">"Seed"</code></td>
        </tr>
        <tr>
          <td>Tipo de Split</td>
          <td><code class="language-plaintext highlighter-rouge">[All, Sqrt, Log2]</code></td>
          <td>N√∫mero de features usado em cada split. Ajuda a deixar cada √°rvore diferente entre si</td>
          <td><code class="language-plaintext highlighter-rouge">Sqrt</code></td>
        </tr>
      </tbody>
    </table>

    <p>√Årvores diferentes entre si s√£o o charme do <code class="language-plaintext highlighter-rouge">Random Forest</code>. Vamos entender isso logo. Eis o pseudo-c√≥digo que vamos implementar:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>randomForest:
  Seja D o nosso dataset
  Para cada √°rvore a ser constru√≠da:
      seja S um subconjunto de D
      seja A(S) uma raiz de √°rvore
      A.M = obterSplit ( A )
      split ( A )

obterSplit ( Raiz de √°rvore A ):
	seja M o melhor split encontrado at√© o momento
	para cada feature F do split:
		para cada F[N] a feature de cada linha N de A.S:
			seja D,E subconjuntos de A.S
			para cada G[N] a feature de cada linha N de A.S:
				se G[N]&gt;F[N] adicione G[N] a D
				caso contr√°rio adicione a E
			se M'(D,E) for um split melhor que M, M recebe M'(D,E)
	retorna M

split  ( N√≥ de √°rvore A ):
	Se a direita, ou esqurerda do split de A for vazia, retorne n√≥ folha (A.M)
	Se chegamos na profundidade m√°xima da √°rvore, retorne n√≥ folha (A.M)
	Se a esquerda do split for menor que o tamanho m√≠nimo:
		A.N√≥_Esquerda = n√≥ folha (A.M.E)
	Caso contr√°rio:
		A.N√≥_Esquerda = obterSplit(A.M.E)
		split (A.N√≥_Esquerda)
	Se a direita do split for menor que o tamanho m√≠nimo:
		A.N√≥_Direita = n√≥ folha (A.M.D)
	Caso contr√°rio:
		A.N√≥_Direita = obterSplit(A.M.D)
		split (A.N√≥_Direita)
</code></pre></div>    </div>

    <p>Qual √© a complexidade deste algoritmo? Digamos que <code class="language-plaintext highlighter-rouge">L</code> √© o n√∫mero de linhas do dataset, <code class="language-plaintext highlighter-rouge">C</code> o total de <em>features</em>, <code class="language-plaintext highlighter-rouge">K</code> o n√∫mero de classes diferentes, e  <code class="language-plaintext highlighter-rouge">T</code> o total de √°rvores constru√≠das. Supondo que para determinar se um <em>Split</em> √© melhor do que outro, usamos o <a href="https://en.wikipedia.org/wiki/Gini_coefficient"><em>coeficiente Gini</em></a>, que tem complexidade <code class="language-plaintext highlighter-rouge">O(L * K)</code>, a complexidade do algoritmo seria:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compl. de construir a √°rvore: N log( N )
Compl. de cada n√≥: C * L * ( L + L * K ) ‚âÉ C * L¬≤ * K
Resultado: O(CL¬≤K log( CL¬≤K ))
</code></pre></div>    </div>

    <p>Note que estamos olhando de maneira quadr√°tica pro <em>dataset</em>.</p>
  </li>
  <li>
    <h3 id="implementa√ß√£o-em-swift">Implementa√ß√£o em Swift</h3>

    <h4 id="51-arrays-vs-ponteiros">5.1 Arrays vs Ponteiros</h4>

    <p>A estrutura de dados <code class="language-plaintext highlighter-rouge">Array</code>, em Swift √© muito conveniente, mas muito lenta. Vamos fazer um <em>benchmark</em>?</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let bm = BenchmarkTest.init(count: 1000000)
bm.begin()
</code></pre></div>    </div>

    <p>Vamos conferir os n√∫meros de acesso:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Array Access: 			0.0430499911308289 s
NSMutableArray Access: 	0.519761979579926 s
Pointer Access: 		0.0407860279083252 s
</code></pre></div>    </div>

    <p>E os tempos de <em>alloc/dealloc</em>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Array Alloc: 				0.01119 s
NSMutableArray Alloc: 		2.32907 s
UnsafeMutablePointer Alloc: 0.00043 s
</code></pre></div>    </div>

    <p>Claro que usando ponteiros INSEGUROS, temos que tomar conta da nossa pr√≥pria mem√≥ria. Mas o ganho de desempenho deve compensar esse pre√ßo. Como usar arrays de ponteiros? Vamos ver:</p>

    <pre><code class="language-Swift">// Em vez disso
let a:Array&lt;Int&gt; = Array(repeating:Int(0), count:10)
// faremos isso
let b:UnsafeMutablePointer&lt;Int&gt; = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 10 * MemoryLayout&lt;Int&gt;.size)
// e para mudar o tamanho do array
b = realloc(b, 20*MemoryLayout&lt;Int&gt;.size).assumingMemoryBound(to: Int.self)
// e depois de usar
b.deallocate(capacity: 10 * MemoryLayout&lt;Int&gt;.size)

// Para pegar referencias de structs sem copiar valores nativos, em vez disso
let a_copy = test
// Faremos isso
let b_copy = UnsafeRawPointer(Unmanaged.passUnretained(test).toOpaque())
// E para acessar
Unmanaged&lt;Int&gt;.fromOpaque(b_copy).takeUnretainedValue()
</code></pre>

    <p>Lembre-se que <code class="language-plaintext highlighter-rouge">realloc</code> √© uma opera√ß√£o cara. A implementa√ß√£o de <code class="language-plaintext highlighter-rouge">Array</code>, por exemplo, dobra o tamanho quando chegamos no limite. A regra de ouro √© sempre que poss√≠vel fazer um <code class="language-plaintext highlighter-rouge">loop</code> e calcular o tamanho novo do array, em vez de realocar a cada novo <em>append</em>.</p>

    <h4 id="52-tipos-gen√©ricos">5.2 Tipos gen√©ricos</h4>

    <p>Outro detalhe importante quando trabalhamos com dados √© o tipo. Como o Random Forest n√£o √© um cara de grandes opera√ß√µes matem√°ticas, isso n√£o vai importar muito pro nosso caso, e podemos usar <code class="language-plaintext highlighter-rouge">Double</code> sem dor no peito. De qualquer modo, √© muito interessante que implementa√ß√µes de estruturas de dados para Aprendizado de M√°quina sejam gen√©ricas. <a href="http://stackoverflow.com/questions/42696579/">Apanhei um pouco</a> pra deixar tudo gen√©rico, mas considero que o resultado ficou bem interessante. Veja exemplos das declara√ß√µes:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Numeric</span><span class="p">:</span><span class="kt">Hashable</span><span class="p">,</span> <span class="kt">Comparable</span>
<span class="kd">class</span> <span class="kt">Matrix</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span>
<span class="kd">class</span> <span class="kt">TreeNode</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span>
<span class="kd">protocol</span> <span class="kt">ClassifierAlgorithm</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">NumericType</span><span class="p">:</span><span class="kt">Numeric</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">RandomForest</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">ClassifierAlgorithm</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">NumericType</span> <span class="o">=</span> <span class="kt">T</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">CrossValidation</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="p">,</span> <span class="kt">U</span><span class="p">:</span><span class="kt">ClassifierAlgorithm</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="k">where</span> <span class="kt">U</span><span class="o">.</span><span class="kt">NumericType</span> <span class="o">==</span> <span class="kt">T</span>
</code></pre></div>    </div>

    <h4 id="53-opera√ß√µes-paralelas-com-operation">5.3 Opera√ß√µes paralelas com <code class="language-plaintext highlighter-rouge">Operation</code></h4>

    <p>No nosso algoritmo, nada impede que as √°rvores sejam constru√≠das paralelamente. Em termos de performance, com testes rasos usando <code class="language-plaintext highlighter-rouge">Operation</code>, o tempo de construir nove √°rvores de tr√™s em tr√™s √© um ter√ßo de construir de uma em uma. Pois, vamos ao que interessa, come√ßamos com um gerenciador de oper√°rios, tamb√©m conhecido como sindicato üòÇ:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">PendingOperations</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">queueName</span><span class="p">:</span><span class="kt">String</span>
    <span class="k">var</span> <span class="nv">concurrentOperations</span><span class="p">:</span><span class="kt">Int</span>
    <span class="nf">init</span> <span class="p">(</span><span class="nv">queueName</span><span class="p">:</span><span class="kt">String</span><span class="p">,</span> <span class="nv">concurrentOperations</span><span class="p">:</span><span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="n">queueName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">concurrentOperations</span> <span class="o">=</span> <span class="n">concurrentOperations</span>
    <span class="p">}</span>
    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">buildsInProgress</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSIndexPath</span><span class="p">:</span><span class="kt">Operation</span><span class="p">]()</span>
    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">buildQueue</span><span class="p">:</span><span class="kt">OperationQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">OperationQueue</span><span class="p">()</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">queueName</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">concurrentOperations</span>
        <span class="k">return</span> <span class="n">queue</span>
    <span class="p">}()</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>Uma classe oper√°ria oprimida pelo sistema:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TreeBuilder</span><span class="p">:</span><span class="kt">Operation</span> <span class="p">{</span>    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
		<span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>E para convocar uma greve:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for _ in 0..&lt;self.treesCount {
	let treeBuilder = TreeBuilder.init()
	treeBuilder.completionBlock = {...}
	self.pendingOperations.buildQueue.addOperation(treeBuilder)
}
</code></pre></div>    </div>
  </li>
  <li>
    <h3 id="valida√ß√£o-cruzada-e-overfitting">Valida√ß√£o Cruzada e <em>Overfitting</em></h3>

    <p>Como validar o nosso modelo na pr√°tica? √â comum ver em artigos da √°rea frases como <code class="language-plaintext highlighter-rouge">to evaluate our accuracy we used 10-fold cross-validation [...] </code>. Vamos explicar:</p>

    <p><strong>Acur√°cia</strong> √© uma m√©trica comum para algoritmos de ML, basicamente, previs√µes corretas/n√∫mero de testes. Entenda:</p>

    <pre><code class="language-Swift">private func accuracy(actual:Array&lt;T&gt;, predicted:Array&lt;T&gt;) -&gt; Double {
	let correct = zip(actual, predicted).reduce(0){ (a: Int, element) in
		var accumulator = a
		if element.0 == element.1 { accumulator += 1 }
		return accumulator
	}
	return Double(correct)/Double(actual.count)
}
</code></pre>

    <p><strong>Overfitting</strong> √© o fen√¥meno que ocorre quando um modelo performa muito bem para para os dados de treino, e muito mal para os dados de teste. Veja um exemplo na seguinte imagem:</p>

    <p><img src="/img/farris/2017/overfitting.jpg" alt="" /></p>

    <p>A linha verde √© a fun√ß√£o que gerou os dados. A linha azul √© uma fun√ß√£o criada por uma regress√£o. Dado um novo ponto da linha verde, ser√° que o modelo azul vai predizer corretamente? <em>N√£o</em>.</p>

    <p>A criptonita do <em>overfitting</em> √© ter muitos dados. Quanto mais dados, melhor. <em>Sempre</em>.</p>

    <p><strong>Valida√ß√£o Cruzada (K-fold Cross Validation)</strong> √© o conceito de dividir aleatoriamente o dataset em K subconjuntos de tamanho igual, e para cada subconjunto, usar ele de valida√ß√£o e os demais como teste. Entenda:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">dataset</span><span class="p">:</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nf">getDataset</span><span class="p">(),</span> <span class="n">foldCount</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">let</span> <span class="nv">folds</span><span class="p">:</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nf">crossValidationSplit</span><span class="p">(</span><span class="nv">dataset</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span> <span class="nv">folds</span><span class="p">:</span> <span class="n">foldCount</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fold</span> <span class="k">in</span> <span class="n">folds</span> <span class="p">{</span>
	<span class="k">let</span> <span class="nv">trainData</span> <span class="o">=</span> <span class="nf">datasetByRemovingFold</span><span class="p">(</span><span class="n">fold</span><span class="p">)</span>
	<span class="k">let</span> <span class="nv">testData</span> <span class="o">=</span> <span class="n">fold</span>
	<span class="n">algorithm</span><span class="o">.</span><span class="nf">runClassifier</span><span class="p">(</span><span class="n">trainData</span><span class="p">,</span><span class="n">testData</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>Valida√ß√£o cruzada ajuda tamb√©m a reduzir um fantasma chamado <em>overfitting</em>.</p>

    <p>Vamos avaliar nosso algoritmo? Usando os par√¢metros padr√£o, com 10 <em>folds</em>, temos:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Fold 0 had accuracy 0.887876025524157
Fold 1 had accuracy 0.906107566089335
Fold 2 had accuracy 0.880583409298086
Fold 3 had accuracy 0.86873290793072
Fold 4 had accuracy 0.886052871467639
Fold 5 had accuracy 0.896991795806746
Fold 6 had accuracy 0.886052871467639
Fold 7 had accuracy 0.864175022789426
Fold 8 had accuracy 0.877848678213309
Fold 9 had accuracy 0.88514129443938
</code></pre></div>    </div>

    <p>A acur√°cia m√©dia √© <code class="language-plaintext highlighter-rouge">0,883</code>. Ou seja, estamos predizento,em m√©dia, corretamente se 88% dos funcion√°rios se demitiram ou n√£o. Interessante n√©? Vamos olhar uma √°rvore constru√≠da:</p>

    <p><img src="/img/farris/2017/tree.png" alt="" /></p>

    <p>Vamos olhar mais de perto nossa classifica√ß√£o:</p>

    <table>
      <thead>
        <tr>
          <th>¬†</th>
          <th>N√£o se demitiu</th>
          <th>Demitiu</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Achamos que n√£o se demitiu</td>
          <td>85%</td>
          <td>12%</td>
        </tr>
        <tr>
          <td>Achamos que se demitiu</td>
          <td>0%</td>
          <td>3%</td>
        </tr>
      </tbody>
    </table>

    <p><em>Opa</em>. Parece que nosso classificador tem um vi√©s. Isso est√° acontecendo porque o dataset √© muito desbalanceado, ou seja, apenas 15% dos dados s√£o de funcion√°rios que pediram demiss√£o. Vamos mudar nosso sampling para usar mais esta classe (<em>subsampling</em>), ponderar as vari√°veis na hora de calcular o √≠ndice gini e na hora de predizer com o bagging, e mudar nossa m√©trica pra um indicador que lide melhor com os dados desbalanceados (<a href="https://en.wikipedia.org/wiki/Cohen%27s_kappa">kappa</a>), como sugerido <a href="http://statistics.berkeley.edu/sites/default/files/tech-reports/666.pdf">no famoso artigo 666 de Berkeley</a>:</p>

    <blockquote>
      <p>For each iteration in random forest, draw a bootstrap sample from the minority class. Randomly draw
the same number of cases, with replacement, from the majority class [‚Ä¶] Since the RF classifier tends to be biased towards the majority class, we shall place a heavier penalty on misclassifying the minority class. We assign a weight to each class, with the minority class given larger weight</p>
    </blockquote>
  </li>
  <li>
    <h3 id="conclus√£o">Conclus√£o</h3>

    <p>Nessa nossa breve jornada juntos, implementamos um classificador altamente pr√°tico, com um desempenho aceit√°vel. Entendemos como lidar com dados, e a avaliar nossos modelos. Vimos como usar ponteiros, generics, e paralelizar opera√ß√µes em Swift 3. Descobrimos o poss√≠vel perfil de quem pede demiss√£o. Aprendemos como examinar o resultado do classificador.
Obrigado pela leitura. At√© a pr√≥xima!
O c√≥digo deste artigo pode ser encontrado <a href="https://github.com/luksfarris/SwiftRandomForest">neste reposit√≥rio</a>.</p>
  </li>
</ol>

<blockquote>
  <p>Lucas Farris come√ßou com programa√ß√£o em 2006, entrou no mercado mobile em 2011, em 2014 se formou em Ci√™ncia da Computa√ß√£o na Unicamp. Atualmente trabalha na Pol√¥nia, onde cuida de uma planta robo chamada <em>–°–∞—à–∞</em>.</p>
</blockquote>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/animations/2017/03/19/desmistificando-o-core-animator/" data-toggle="tooltip" data-placement="top" title="Desmistificando o Core Animation">&larr; Post Anterior</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" data-toggle="tooltip" data-placement="top" title="Sincroniza√ß√£o de dados com CloudKit">Pr√≥ximo Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */

                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//equinocios.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">A odisseia do puto ‚Äî Raimundo Pessoa & Frederico Do</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
