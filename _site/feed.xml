<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2026-02-17T19:05:05-03:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">A odisseia do puto</title><subtitle>Blog de tecnologia e desenvolvimento ‚Äî artigos, tutoriais e opini√£o.</subtitle><entry><title type="html">Persist√™ncia de dados usando Core Data</title><link href="http://localhost:4000/banco%20de%20dados/2017/03/30/persistencia-de-dados-usando-core-data/" rel="alternate" type="text/html" title="Persist√™ncia de dados usando Core Data" /><published>2017-03-30T09:00:00-03:00</published><updated>2017-03-30T09:00:00-03:00</updated><id>http://localhost:4000/banco%20de%20dados/2017/03/30/persistencia-de-dados-usando-core-data</id><content type="html" xml:base="http://localhost:4000/banco%20de%20dados/2017/03/30/persistencia-de-dados-usando-core-data/"><![CDATA[<blockquote>
  <p>Ol√° pessoal, esse √© meu primeiro artigo aqui no EquinociOS e ent√£o farei uma breve apresenta√ß√£o.
 Me chamo <a href="https://twitter.com/bluesprogrammer">Douglas Taquary</a> sou desenvolvedor iOS um pouco mais de 3 anos, fundador e l√≠der do Cocoaheads Teresina desde de 2015, nasci e me criei dentro da eletr√¥nica do meu <a href="https://www.facebook.com/profile.php?id=100009371490482&amp;fref=ts">Pai</a> üì∫üîåüîß por isso a paix√£o tamb√©m por IoT, eletr√¥nica e seus derivados. Sou <a href="https://www.youtube.com/watch?v=J0imW0Xu6nY">guitarrista</a> (apesar de n√£o estar mais na atividade j√° algum tempo, somente vez ou outra), sou f√£ de blues, Jimi Hendrix,  e gosto de beber cerva e cozinhar ao mesmo tempo.
Feita essa introdu√ß√£o, vamos nessa: <strong>Core Data</strong>!</p>
</blockquote>

<h2 id="motiva√ß√£o">Motiva√ß√£o</h2>

<p>H√° uns dois meses me deparei com uma situa√ß√£o em que precisaria persistir dados em um aplicativo. Eu nunca fui muito f√£ de trabalhar com banco de dados, talvez por experi√™ncias anteriores ou por causa de v√°rias configura√ß√µes chatas que voc√™ tem que fazer pra deixar tudo funcionando.
Acredito que em determinadas tecnologias, n√£o era eu ou voc√™ quem deveria estar fazendo esse tipo de configura√ß√£o(<em>o framework ou qualquer outra coisa que voc√™ esteja usando</em>) tem que deixar tudo pronto somente para voc√™ ir l√° e usar. Devo me preocupar com minha l√≥gica de neg√≥cios, que no momento √© o mais importante.</p>

<p>Bom, mas o jeito foi engolir o choro. ¬Ø\_(„ÉÑ)_/¬Ø</p>

<h2 id="o-que-√©-o-core-data">O que √© o Core Data</h2>

<p>O <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html?utm_source=iosstash.io">CoreData</a> √© um framework nativo como qualquer outro da <strong>Apple</strong>: <em>UIKit, Foundation</em> e alguns outros. Ele √© usado para persistir, manipular dados no iOS/OSX e usa o <code class="language-plaintext highlighter-rouge">SQLite</code> por baixo dos panos, mas voc√™ n√£o precisar saber <code class="language-plaintext highlighter-rouge">SQL</code> para us√°-lo, ele interage com o <em>sql</em> sem voc√™ ver ou precisar saber o que est√° acontecendo.
Usamos o esquema de <em>key/value</em> para acessar nossos objetos persistidos.</p>

<p>Algumas de v√°rias caracter√≠sticas que esse framework possui:</p>

<ul>
  <li>Gerenciamento e manipula√ß√£o de objetos(CRUD)</li>
  <li>Buscas sofisticadas. Em vez de escrever SQL, voc√™ pode criar consultas complexas associando um objeto <em>NSPredicate</em> a uma solicita√ß√£o de busca.</li>
  <li>Ferramentas de migra√ß√£o de esquema</li>
  <li>Filtragem e gerenciamento de dados na mem√≥ria e na interface de usu√°rio</li>
  <li>Controle de vers√£o</li>
</ul>

<p>E v√°rias outras que voc√™ pode conferir <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html?utm_source=iosstash.io">aqui</a>.</p>

<p>Sei que existem outras tecnologias <em>open source</em> como o <code class="language-plaintext highlighter-rouge">Realm</code>, que tamb√©m podem ser usadas para persistir dados no iOS e que podem ser adicionadas em seu projeto atrav√©s do <code class="language-plaintext highlighter-rouge">CocoaPods</code> ou via <code class="language-plaintext highlighter-rouge">m√≥dulo</code>. Mas n√£o √© o intuito desse artigo falar sobre pr√≥s e contras de tecnologias. Cabe a voc√™ escolher a tecnologia que faz sentido no seu projeto.</p>

<p>Bl√°, bl√°, bl√°‚Ä¶ ent√£o vamos l√°. üéâ</p>

<h2 id="explicando">Explicando</h2>

<p>H√° um tempo atr√°s, como eu falei, eu criei um <a href="https://github.com/douglastaquary/mymovies">app</a> para estudar o <strong>Core Data</strong>.</p>

<p><img src="/img/douglastaquary/mymovies.png" alt="" /></p>

<blockquote>
  <p>O c√≥digo do app ainda pode melhorar com algumas <em>refactors</em> .</p>
</blockquote>

<p>No app voc√™ pode inserir nomes de filmes favoritos, e pesquisar por eles atrav√©s de uma <em>API</em> chamada <a href="http://www.omdbapi.com">Open Movie Database</a>. A ideia √© salvar as informa√ß√µes sobre os filmes e poder v√™-las offline, aqui que o <em>framework entra em a√ß√£o</em>. Nosso foco √© somente o <em>Core Data</em>. ;)</p>

<h2 id="vamos-l√°">Vamos l√°</h2>

<p>Para poder usar o <em>Core Data</em> no seu projeto, √© necess√°rio habilit√°-lo no Xcode no momento que voc√™ esta criando um novo projeto, mas ele pode ser adicionado tamb√©m depois do projeto criado. Al√©m disso, basta fazer <code class="language-plaintext highlighter-rouge">import CoreData</code> do m√≥dulo nas suas classes e pronto. Isso ser√° uma das poucas configura√ß√µes que voc√™ precisar√° fazer para sair usando.</p>

<p><img src="/img/douglastaquary/start_coredata.png" alt="" /></p>

<p>Olha que maravilha?! Mais uma vez o <em>teorema do taquary</em> agindo: nosso trabalho n√£o √© configurar, √© usar, criar.. e bl√°, bl√°..</p>

<p>Com projeto criado, abrindo a sua class <code class="language-plaintext highlighter-rouge">AppDelegate.swift</code>, l√° no final do arquivo tem uma vari√°vel chamada <code class="language-plaintext highlighter-rouge">var persistentContainer: NSPersistentContainer</code>.
O Xcode cria essa implementa√ß√£o automaticamente. Ela √© basicamente o meio de acesso ao seu banco de dados dentro do Core Data. Ele retorna um <code class="language-plaintext highlighter-rouge">container</code> se seu banco de dados existe, caso contr√°rio ele retornar√° um erro, o seu app <code class="language-plaintext highlighter-rouge">crasha</code> e o Xcode imprime um <code class="language-plaintext highlighter-rouge">log</code> no console.</p>

<p>Somente isso que precisamos para criarmos nossas <code class="language-plaintext highlighter-rouge">queries</code>.</p>

<p>Com a chegada do <a href="">Swift 3</a> as coisas ficaram bem mais f√°ceis para se trabalhar com o <em>Core Data</em>. Menos c√≥digo e mais efici√™ncia. Como eu disse, deixa o framework cuidar de configura√ß√µes dele mesmo.</p>

<p>Para mostrar o quanto se trabalhar com <code class="language-plaintext highlighter-rouge">Core Data</code> depois do <code class="language-plaintext highlighter-rouge">Swift 3</code> melhorou eu tenho dois arquivos aqui que o <em>Xcode</em> gera no <code class="language-plaintext highlighter-rouge">AppDelegate</code>.</p>

<p>O primeiro com <strong>Swift 2</strong>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">applicationDocumentsDirectory</span><span class="p">:</span> <span class="kt">NSURL</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">urls</span> <span class="o">=</span> <span class="kt">NSFileManager</span><span class="o">.</span><span class="nf">defaultManager</span><span class="p">()</span><span class="o">.</span><span class="kt">URLsForDirectory</span><span class="p">(</span><span class="o">.</span><span class="kt">DocumentDirectory</span><span class="p">,</span> <span class="nv">inDomains</span><span class="p">:</span> <span class="o">.</span><span class="kt">UserDomainMask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urls</span><span class="p">[</span><span class="n">urls</span><span class="o">.</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">}()</span>

    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">managedObjectModel</span><span class="p">:</span> <span class="kt">NSManagedObjectModel</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">modelURL</span> <span class="o">=</span> <span class="kt">NSBundle</span><span class="o">.</span><span class="nf">mainBundle</span><span class="p">()</span><span class="o">.</span><span class="kt">URLForResource</span><span class="p">(</span><span class="s">"DATAMODELNAME"</span><span class="p">,</span> <span class="nv">withExtension</span><span class="p">:</span> <span class="s">"momd"</span><span class="p">)</span><span class="o">!</span>
        <span class="k">return</span> <span class="kt">NSManagedObjectModel</span><span class="p">(</span><span class="nv">contentsOfURL</span><span class="p">:</span> <span class="n">modelURL</span><span class="p">)</span><span class="o">!</span>
    <span class="p">}()</span>
        <span class="c1">// Create the coordinator and store</span>
        <span class="k">let</span> <span class="nv">coordinator</span> <span class="o">=</span> <span class="kt">NSPersistentStoreCoordinator</span><span class="p">(</span><span class="nv">managedObjectModel</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">managedObjectModel</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">applicationDocumentsDirectory</span><span class="o">.</span><span class="kt">URLByAppendingPathComponent</span><span class="p">(</span><span class="s">"PROJECTNAME.sqlite"</span><span class="p">)</span>
        <span class="k">var</span> <span class="nv">failureReason</span> <span class="o">=</span> <span class="s">"There was an error creating or loading the application's saved data."</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">coordinator</span><span class="o">.</span><span class="nf">addPersistentStoreWithType</span><span class="p">(</span><span class="kt">NSSQLiteStoreType</span><span class="p">,</span> <span class="nv">configuration</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="kt">URL</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="c1">// Report any error we got.</span>
            <span class="k">var</span> <span class="nv">dict</span> <span class="o">=</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]()</span>
            <span class="n">dict</span><span class="p">[</span><span class="kt">NSLocalizedDescriptionKey</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Failed to initialize the application's saved data"</span>
            <span class="n">dict</span><span class="p">[</span><span class="kt">NSLocalizedFailureReasonErrorKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">failureReason</span>

            <span class="n">dict</span><span class="p">[</span><span class="kt">NSUnderlyingErrorKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as</span> <span class="kt">NSError</span>
            <span class="k">let</span> <span class="nv">wrappedError</span> <span class="o">=</span> <span class="kt">NSError</span><span class="p">(</span><span class="nv">domain</span><span class="p">:</span> <span class="s">"YOUR_ERROR_DOMAIN"</span><span class="p">,</span> <span class="nv">code</span><span class="p">:</span> <span class="mi">9999</span><span class="p">,</span> <span class="nv">userInfo</span><span class="p">:</span> <span class="n">dict</span><span class="p">)</span>
            <span class="kt">NSLog</span><span class="p">(</span><span class="s">"Unresolved error </span><span class="se">\(</span><span class="n">wrappedError</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="n">wrappedError</span><span class="o">.</span><span class="n">userInfo</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">abort</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">coordinator</span>
    <span class="p">}()</span>

    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">managedObjectContext</span><span class="p">:</span> <span class="kt">NSManagedObjectContext</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// Returns the managed object context for the application (which is already bound to the persistent store coordinator for the application.) This property is optional since there are legitimate error conditions that could cause the creation of the context to fail.</span>
        <span class="k">let</span> <span class="nv">coordinator</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">persistentStoreCoordinator</span>
        <span class="k">var</span> <span class="nv">managedObjectContext</span> <span class="o">=</span> <span class="kt">NSManagedObjectContext</span><span class="p">(</span><span class="nv">concurrencyType</span><span class="p">:</span> <span class="o">.</span><span class="kt">MainQueueConcurrencyType</span><span class="p">)</span>
        <span class="n">managedObjectContext</span><span class="o">.</span><span class="n">persistentStoreCoordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
        <span class="k">return</span> <span class="n">managedObjectContext</span>
    <span class="p">}()</span>
</code></pre></div></div>

<p>Com <strong>Swift 3</strong>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">persistentContainer</span><span class="p">:</span> <span class="kt">NSPersistentContainer</span> <span class="o">=</span> <span class="p">{</span>

        <span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">NSPersistentContainer</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"CoreData_app"</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="nf">loadPersistentStores</span><span class="p">(</span><span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">storeDescription</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as</span> <span class="kt">NSError</span><span class="p">?</span> <span class="p">{</span>
                <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unresolved error </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">userInfo</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">container</span>
    <span class="p">}()</span>
</code></pre></div></div>

<p>Que diferen√ßa hein?! Pois √©‚Ä¶ imagina isso em Objective C?! üôèüèº</p>

<h2 id="criando-modelos">Criando modelos</h2>

<p>Outra coisa que podemos observar no nosso projeto, √© que temos um arquivo com extens√£o <code class="language-plaintext highlighter-rouge">.xcdatamodel</code> que no nosso caso, √© chamado <code class="language-plaintext highlighter-rouge">CoreData_app.xcdatamodel</code>.</p>

<p><img src="/img/douglastaquary/tree2x.png" alt="" /></p>

<p>Vamos analisar esse arquivo gerado, aqui criamos e gerenciamos nossas tabelas usando uma interface bem f√°cil e que poupa muito trabalho. Sem contar que quando voc√™ criar uma nova tabela <code class="language-plaintext highlighter-rouge">+ Add Entity</code> e popular com seus atributos, assim que voc√™ <code class="language-plaintext highlighter-rouge">buildar</code> seu projeto, o Xcode magicamente gera as classes referentes √† <em>estrutura/esquema/modelo</em> da sua tabela de dados criada. Olha que beleza 2! üèÑüèª</p>

<p><strong>Aqui os f√£s de geradores de c√≥digo piram</strong> üòÖ</p>

<blockquote>
  <p>O <em>Xcode</em> agora suporta a gera√ß√£o autom√°tica de subclasses de <code class="language-plaintext highlighter-rouge">NSManagedObject</code> na ferramenta de modelagem.</p>
</blockquote>

<p>Inspetor de entidade:</p>

<p><img src="/img/douglastaquary/coredata_panel.png" alt="" /></p>

<h2 id="o-mito-do-app-delegate">O Mito do App Delegate</h2>

<p>J√° √© de costume os <code class="language-plaintext highlighter-rouge">devs</code> deixarem esse c√≥digo onde Xcode o cria. Algo como: eu n√£o vou nem tocar para n√£o quebrar‚Ä¶ Isso √© <strong>MITO</strong>!!üòÖ
O melhor que voc√™ faz √© tirar essa implementa√ß√£o do <code class="language-plaintext highlighter-rouge">AppDelegate</code> e criar algo como <code class="language-plaintext highlighter-rouge">DataManager.swift</code> e colar ele l√°.</p>

<h2 id="nsmanagedobject">NSManagedObject</h2>

<p>O <code class="language-plaintext highlighter-rouge">NSManagedObject</code> √© uma classe gen√©rica que implementa todo o comportamento b√°sico para um objeto no modelo que o Core Data espera. N√£o √© poss√≠vel usar inst√¢ncias de subclasses diretas de <code class="language-plaintext highlighter-rouge">NSObject</code> (ou qualquer outra classe que n√£o herde de <code class="language-plaintext highlighter-rouge">NSManagedObject</code>) com um contexto de um objeto gerenciado.
Voc√™ pode criar subclasses customizadas do <code class="language-plaintext highlighter-rouge">NSManagedObject</code>, embora isso nem sempre seja necess√°rio, como eu falei o framework ‚Äú<em>gera</em>‚Äù as classes refente as suas tabelas e propriedades.üç∫</p>

<h2 id="adicionar-dados">Adicionar Dados</h2>

<p>No app temos um tela para inserir t√≠tulos de filmes. Ent√£o, precisamos persistir um atributo <em>name</em> do tipo <code class="language-plaintext highlighter-rouge">String</code> na tabela <code class="language-plaintext highlighter-rouge">Title</code>. Para eu inserir essa informa√ß√£o, eu simplesmente carrego meu <code class="language-plaintext highlighter-rouge">persistentContainer</code> atrav√©s da minha classe <code class="language-plaintext highlighter-rouge">DataManager</code> no meu <code class="language-plaintext highlighter-rouge">ViewController</code></p>

<p><code class="language-plaintext highlighter-rouge">var dataManager = DataManager()</code></p>

<p>e implemento minha fun√ß√£o para inserir dados:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">func</span> <span class="nf">saveNameOfMovie</span><span class="p">(</span><span class="n">with</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">managedContext</span> <span class="o">=</span> <span class="n">dataManager</span><span class="o">.</span><span class="n">persistentContainer</span><span class="o">.</span><span class="n">viewContext</span>
        <span class="k">let</span> <span class="nv">entity</span> <span class="o">=</span> <span class="kt">NSEntityDescription</span><span class="o">.</span><span class="nf">entity</span><span class="p">(</span><span class="nv">forEntityName</span><span class="p">:</span> <span class="s">"Title"</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="n">managedContext</span><span class="p">)</span><span class="o">!</span>
        <span class="k">let</span> <span class="nv">movie</span> <span class="o">=</span> <span class="kt">NSManagedObject</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span> <span class="nv">insertInto</span><span class="p">:</span> <span class="n">managedContext</span><span class="p">)</span>
        
        <span class="n">movie</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span>
        
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">managedContext</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
            <span class="nf">didEnd</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="k">as</span> <span class="kt">NSError</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Could not save. </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">userInfo</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>Aqui n√≥s instanciamos nosso container usando o <code class="language-plaintext highlighter-rouge">managedContext</code>, depois pegamos a refer√™ncia da tabela(<em>voc√™ pode ter v√°rias tabelas</em>) com <code class="language-plaintext highlighter-rouge">entity</code> e criamos o objeto que ser√° persistido:</p>

<p><code class="language-plaintext highlighter-rouge">let name = NSManagedObject(entity: entity, insertInto: managedContext)</code></p>

<p>E a√≠ eu salvo de fato meu dado usando a func√£o <code class="language-plaintext highlighter-rouge">save()</code> padr√£o do framework.</p>

<p><code class="language-plaintext highlighter-rouge">try managedContext.save()</code></p>

<p>Tranquilo demais!</p>

<h2 id="nsfetchrequest">NSFetchRequest</h2>

<p><code class="language-plaintext highlighter-rouge">NSFetchRequest</code> √© um <em>tipo parametrizado</em> baseado no novo protocolo <code class="language-plaintext highlighter-rouge">NSFetchRequestResult</code> adicionado no <em>Swift 3</em>. As principais <em>APIs do Core Data</em> agora se referem a <code class="language-plaintext highlighter-rouge">NSFetchRequest</code> <em>parametrizado</em> no <code class="language-plaintext highlighter-rouge">Objective C</code> e no <code class="language-plaintext highlighter-rouge">Swift</code>.</p>

<p>Al√©m disso, no <code class="language-plaintext highlighter-rouge">Swift</code>, <code class="language-plaintext highlighter-rouge">NSManagedObjectContext</code> oferece variantes parametrizadas de <code class="language-plaintext highlighter-rouge">fetch(:)</code>, que antes do Swift 3 era chamado de <code class="language-plaintext highlighter-rouge">executeFetchRequest: error:</code>, e <code class="language-plaintext highlighter-rouge">count(:)</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">func</span> <span class="n">fetch</span><span class="o">&lt;</span><span class="kt">T</span> <span class="p">:</span> <span class="kt">NSFetchRequestResult</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">NSFetchRequest</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">T</span><span class="p">]</span>

<span class="kd">public</span> <span class="kd">func</span> <span class="n">count</span><span class="o">&lt;</span><span class="kt">T</span> <span class="p">:</span> <span class="kt">NSFetchRequestResult</span><span class="o">&gt;</span><span class="p">(</span><span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">NSFetchRequest</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span>

</code></pre></div></div>

<p>√â com ele que vamos recuperar nossos dados. üç∑</p>

<h2 id="listar-nossos-dados">Listar nossos dados</h2>

<p>Para a minha <code class="language-plaintext highlighter-rouge">tableview</code> mostrar meus registros de filmes favoritos √© mais simples ainda.</p>

<p>Para recuperar os dados persistidos, n√≥s usamos a inst√¢ncia de  <code class="language-plaintext highlighter-rouge">NSFetchRequest</code>, onde temos que passar o nome da tabela.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">loadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">fetchRequest</span> <span class="o">=</span> <span class="kt">NSFetchRequest</span><span class="o">&lt;</span><span class="kt">NSFetchRequestResult</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">entityName</span><span class="p">:</span> <span class="s">"Title"</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="n">dataManager</span><span class="o">.</span><span class="n">persistentContainer</span><span class="o">.</span><span class="n">viewContext</span>
        <span class="k">do</span><span class="p">{</span>
            <span class="k">let</span> <span class="nv">results</span> <span class="o">=</span> <span class="k">try</span> <span class="n">context</span><span class="o">.</span><span class="nf">fetch</span><span class="p">(</span><span class="n">fetchRequest</span><span class="p">)</span>
            <span class="n">namesOfMovies</span> <span class="o">=</span> <span class="n">results</span> <span class="k">as!</span> <span class="p">[</span><span class="kt">NSManagedObject</span><span class="p">]</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Error is retriving titles items"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Depois eu chamo a func√£o <code class="language-plaintext highlighter-rouge">fetch()</code> usando o <code class="language-plaintext highlighter-rouge">context</code> e passando o <code class="language-plaintext highlighter-rouge">fetchRequest</code> como par√¢metro.</p>

<p>Dai √© s√≥ transformar o resultado da sua busca em uma <code class="language-plaintext highlighter-rouge">array</code> de <code class="language-plaintext highlighter-rouge">[NSManagedObject]</code>, nesse caso, atribu√≠do √† <em>vari√°vel</em> <code class="language-plaintext highlighter-rouge">namesOfMovies</code> e dar reload na <code class="language-plaintext highlighter-rouge">tableview</code>.</p>

<p>Ent√£o l√° na fun√ß√£o <code class="language-plaintext highlighter-rouge">cellForRowAt</code> da <code class="language-plaintext highlighter-rouge">tableView</code> eu consigo fazer isso:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cell</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">nameOfMovie</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="s">"title"</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">String</span>
</code></pre></div></div>
<p>e listar meus objetos persistidos, moleza hein?!</p>

<p>Bom, ent√£o √© isso, essa foi uma breve introdu√ß√£o.</p>

<p>Existem muito mais opera√ß√µes que podem ser feitas com esse poderoso framework nativo que est√° ali, s√≥ no ponto pra voc√™ usar. Espero que esse artigo tenha ajudado voc√™ a entender melhor o <code class="language-plaintext highlighter-rouge">Core Data</code> e algumas de suas estruturas.
Quem sabe em um pr√≥ximo podemos ir mais a fundo e brincar um pouco mais com ele.</p>

<p><em>Quer saber mais</em>:</p>

<p><a href="https://developer.apple.com/reference/coredata">Core Data documentation</a></p>

<p><a href="https://developer.apple.com/library/content/releasenotes/General/WhatNewCoreData2016/ReleaseNotes.html">What`s New In Core Data</a></p>

<p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html?utm_source=iosstash.io">What Is Core Data?</a></p>]]></content><author><name>Douglas Taquary</name></author><category term="Banco de Dados" /><summary type="html"><![CDATA[Ol√° pessoal, esse √© meu primeiro artigo aqui no EquinociOS e ent√£o farei uma breve apresenta√ß√£o. Me chamo Douglas Taquary sou desenvolvedor iOS um pouco mais de 3 anos, fundador e l√≠der do Cocoaheads Teresina desde de 2015, nasci e me criei dentro da eletr√¥nica do meu Pai üì∫üîåüîß por isso a paix√£o tamb√©m por IoT, eletr√¥nica e seus derivados. Sou guitarrista (apesar de n√£o estar mais na atividade j√° algum tempo, somente vez ou outra), sou f√£ de blues, Jimi Hendrix, e gosto de beber cerva e cozinhar ao mesmo tempo. Feita essa introdu√ß√£o, vamos nessa: Core Data!]]></summary></entry><entry><title type="html">Interfaces ass√≠ncronas com AsyncDisplayKit</title><link href="http://localhost:4000/ui/2017/03/29/introducao-ao-asyncdisplaykit-construa-interfaces-asyncronas-no-iOS/" rel="alternate" type="text/html" title="Interfaces ass√≠ncronas com AsyncDisplayKit" /><published>2017-03-29T09:00:00-03:00</published><updated>2017-03-29T09:00:00-03:00</updated><id>http://localhost:4000/ui/2017/03/29/introducao%20ao%20asyncdisplaykit%20-%20construa%20interfaces%20asyncronas%20no%20iOS</id><content type="html" xml:base="http://localhost:4000/ui/2017/03/29/introducao-ao-asyncdisplaykit-construa-interfaces-asyncronas-no-iOS/"><![CDATA[<blockquote>
  <p>Sou o Guga Oliveira (<a href="https://twitter.com/gugaoliveira" target="_blank">@gugaoliveira</a>), empreendedor, cursei engenharia eletr√¥nica mas sempre trabalhei com softwares e programa√ß√£o. Abri uma empresa de desenvolvimento Web em Juiz de Fora no in√≠cio de 2000, e em 2007 fundamos a <a href="http://www.handcom.com.br" target="_blank">Handcom</a> focada em mobilidade. Trabalhamos com iOS desde o in√≠cio, e criamos aplicativos em sua maioria focados no varejo e com foco empresarial. Em 2014 fundamos a startup <a href="http://www.microlocation.com.br" target="_blank">Microlocation</a> que foi acelerada pelo Seed-MG e hoje faz parte de nossa solu√ß√£o para o varejo <a href="http://www.smartretail.com.br" target="_blank">Smart-Retail</a>, atualmente estou estudando Swift e An√°lise de Dados, e participando bastante do desenvolvimento dos ecossistemas de Minas Gerais com o MGTI em BH e o Zer040 em Juiz de Fora.</p>
</blockquote>

<h2 id="interface-ass√≠ncrona-sem-interface-builder">interface ass√≠ncrona? sem Interface Builder?</h2>

<p>Fui apresentado ao <a href="http://asyncdisplaykit.org/">AsyncDisplayKit</a> pelo Heberti Almeida, excelente dev iOS que conheci na WWDC de 2013. Ele estava usando o <code class="language-plaintext highlighter-rouge">ASDK</code> no desenvolvimento do novo app da <a href="https://postbeyond.com" target="_blank">PostBeyond</a>, startup em que ele trabalha. No come√ßo achei complicado apostar em uma biblioteca de terceiros para substituir as bibliotecas pr√≥prias do iOS como <code class="language-plaintext highlighter-rouge">UIKit</code>, XIBs e Storyboards.</p>

<p>Mas na WWDC 2016, o Heberti me convidou para ir no evento do <a href="http://www.pinterest.com" target="_blank">Pinterest</a> que acontecia em volta da WWDC. O evento foi promovido pelo Scott Goodsom <a href="https://twitter.com/ScottGoodson" target="_blank">@ScottGoodson</a>, que √© Head of Core Experience no Pinterest, e que idealizou a <em>AsyncDisplayKit</em> para desenvolver o <em>Paper</em> para o <em>Facebook</em>.</p>

<p><a href="https://www.youtube.com/watch?v=8ngXakpE2x8" target="_blank"><img src="https://img.youtube.com/vi/8ngXakpE2x8/0.jpg" alt="WWDC 2016 AsyncDisplayKit event " /></a><br />
<em>WWDC 2016 AsyncDisplayKit event</em></p>

<p>O que vi no evento me surpreendeu bastante, engenheiros de apps famosos utilizando intensamente a biblioteca, com foco total em performance visual. O <em>Pinterest</em> utiliza o <em>AsyncDisplayKit</em> e possui engenheiros trabalhando de forma obsessiva na engenharia de renderiza√ß√£o das telas para que fiquem extremamente responsivas, com o m√≠nimo <em>drop</em> de <em>frames</em> poss√≠vel.</p>

<p>Como nosso aplicativo possui uma tela com muitas imagens de produtos e um fluxo quase infinito, como em uma timeline de produtos, resolvemos apostar na re-escrita com o AsyncDisplayKit nas pr√≥ximas vers√µes, al√©m de quebrar um grande paradigma na empresa, que √© o uso de Storyboard e Interface Builder.</p>

<p>Como √© um framework complexo, e n√£o por isso dif√≠cil de usar, este artigo pretende ser introdut√≥rio ao AsyncDisplayKit, tentarei complementar com assuntos mais avan√ßados em breve.</p>

<h2 id="asyncdisplaykit">AsyncDisplayKit</h2>

<p>O <a href="https://github.com/facebook/AsyncDisplayKit" target="_blank">AsyncDisplayKit</a> √© uma framework Open Source iOS feito no topo do UIKit com o objetivo de deixar at√© as interfaces visuais mais complexas com fluxo suave e responsivo. O Framework √© <em>Open Source</em> e est√° dispon√≠vel via CocoaPods ou Carthage.</p>

<p>O <code class="language-plaintext highlighter-rouge">UIKit</code> √© um dos frameworks mais maduros do iOS, e foi desenvolvido quando os iPhones tinham recursos restritos de sistema, no in√≠cio nem existia possibilidade de utilizar c√≥digos ass√≠ncronos concorrentes. O problema √© que mesmo atualmente o <code class="language-plaintext highlighter-rouge">UIKit</code> roda em uma √∫nica <em>thread</em> e s√≥ funciona na <em>main queue</em>. Na maior parte dos casos funciona bem, mas quando envolve interfaces mais complexas ou necessita-se de mais recursos, a interface acaba n√£o sendo t√£o responsiva. Para estes casos, trabalhar de forma ass√≠ncrona √© extremamente necess√°rio para criar uma interface lisa e responsiva com o usu√°rio.</p>

<p>O iOS renderiza a interface com o usu√°rio em 60 frames por segundo, o que nos d√° apenas 16 milisegundos de CPU por frame, e caso voc√™ ultrapasse este m√≠nimo intervalo de tempo o sistema operacional vai come√ßar a liberar drop de frames imediatamente, tornando nossa interface muito menos responsiva e suave, principalmente agora que muitos apps utilizam de anima√ß√µes e efeitos para obter a aten√ß√£o do usu√°rio.</p>

<p>E nos tempos de autolayout e anima√ß√µes, existem v√°rias tarefas para a <em>main thread</em> realizar e consumir o pequeno tempo de frame que temos, como calcular a dimens√£o autom√°tica de cada c√©lula, resolver os <em>constraints</em> dos conte√∫dos das views, renderizar e decodificar imagens, criar sombras e contornos, efeitos como blur e shadow, redimensionamento de imagens para exibi√ß√£o e cria√ß√£o e manipula√ß√£o de objetos do sistema.</p>

<p>O <code class="language-plaintext highlighter-rouge">ASDK</code> (<em>AsyncDisplayKit</em>) chegou para resolver esses problemas, ele move o m√°ximo de trabalho de <code class="language-plaintext highlighter-rouge">UI</code> para ser executado em <em>background</em>. Por default ele permite que todas os c√°lculos de medidas, estrutura√ß√µes layout e renderiza√ß√µes sejam feitas de forma ass√≠ncrona, sem muitas otimiza√ß√µes um app pode experimentar uma grande redu√ß√£o do trabalho realizado na <em>main thread</em>.</p>

<p>O <code class="language-plaintext highlighter-rouge">ASDK</code> √© incompat√≠vel com <strong><em>Interface Builder</em></strong> e <strong><em>Auto Layout</em></strong>, a biblioteca foi escrita em <em>Objective-C</em>, mas o <code class="language-plaintext highlighter-rouge">ASDK</code> suporta completamente o <em>Swift</em> .</p>

<h3 id="come√ßando">Come√ßando</h3>

<p>A unidade fundamental do <code class="language-plaintext highlighter-rouge">ASDK</code> √© o <code class="language-plaintext highlighter-rouge">node</code> ou <code class="language-plaintext highlighter-rouge">ASDisplayNode</code>, ele √© uma abstra√ß√£o da <code class="language-plaintext highlighter-rouge">UIView</code>, que por conseguinte √© uma abstra√ß√£o da <code class="language-plaintext highlighter-rouge">CALayer</code>. A <code class="language-plaintext highlighter-rouge">UIView</code> s√≥ pode ser manipulada na <em>main thread</em>, mas os <code class="language-plaintext highlighter-rouge">nodes</code> s√£o <em>thread safe</em> e podem ser instanciados e ter toda sua hierarquia configurada em <em>background</em> .</p>

<p><img src="/img/gugaoliveira/node-view-layer.png" alt="Node - View - Layer" /></p>

<p>A id√©ia b√°sica do <code class="language-plaintext highlighter-rouge">ASDK</code> √© que voc√™ possa trabalhar com os <code class="language-plaintext highlighter-rouge">nodes</code> da mesma forma como j√° trabalha com as <code class="language-plaintext highlighter-rouge">views</code>, a grande maioria dos m√©todos e par√¢metros da <code class="language-plaintext highlighter-rouge">UIView</code> e da <code class="language-plaintext highlighter-rouge">CALayer</code> possuem equivalentes nos <code class="language-plaintext highlighter-rouge">nodes</code>.</p>

<p>Tudo o que aparece na tela do iOS √© renderizado por um objeto <code class="language-plaintext highlighter-rouge">CALayer</code>, a <code class="language-plaintext highlighter-rouge">UIView</code> cria e mant√©m a refer√™ncia do objeto <code class="language-plaintext highlighter-rouge">CALayer</code>, e os <code class="language-plaintext highlighter-rouge">nodes</code> extendem a <code class="language-plaintext highlighter-rouge">UIView</code> da mesma forma, como na imagem acima. Voc√™ pode acessar a <em>view</em> e o <em>layer</em> que est√£o abaixo diretamente com <code class="language-plaintext highlighter-rouge">node.view</code> e <code class="language-plaintext highlighter-rouge">node.layer</code>, desde que esteja na <em>main thread</em>.</p>

<h4 id="containers-de-nodes">Containers de nodes</h4>

<p>Os <code class="language-plaintext highlighter-rouge">nodes</code> do <code class="language-plaintext highlighter-rouge">ASDK</code> devem ser usados dentro de <em>containers</em> de <code class="language-plaintext highlighter-rouge">nodes</code>, o <code class="language-plaintext highlighter-rouge">ASDK</code> oferece alguns <em>containers</em>  que tem similares com classes do <code class="language-plaintext highlighter-rouge">UIKit</code> que estamos acostumados a trabalhar. Um <code class="language-plaintext highlighter-rouge">node</code> n√£o deve ser adicionado diretamente a uma hirerarquia de <code class="language-plaintext highlighter-rouge">view</code> (se fizer isso √© quase certo de voc√™ obter piscadas de tela). Um <code class="language-plaintext highlighter-rouge">node</code> deve ser adicionado como subnode de um <em>container</em> de nodes. Esses <em>containers</em> possuem a tarefa de gerenciar os subnodes para inform√°-los se est√° tudo pronto para renderizar na tela de forma mais eficiente poss√≠vel.</p>

<p>Uma vantagem do uso dos <em>containers</em>  de <code class="language-plaintext highlighter-rouge">nodes</code> √© que o <em>container</em> automaticamente gerencia o pre-loading inteligente (<em>Inteligent Preloading</em>) dos <code class="language-plaintext highlighter-rouge">nodes</code> (<code class="language-plaintext highlighter-rouge">views</code>), que significa que toda tarefa de medi√ß√£o do layout, de carregamento de dados, decodifica√ß√£o e renderiza√ß√£o ser√£o feitos de forma ass√≠ncrona automaticamente.</p>

<p>Os principais containers est√£o abaixo com os equivalentes no <code class="language-plaintext highlighter-rouge">UIKit</code>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Container <code class="language-plaintext highlighter-rouge">ASDK</code></th>
      <th style="text-align: center">Equivalente <code class="language-plaintext highlighter-rouge">UIKit</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><a href="http://asyncdisplaykit.org/docs/containers-asviewcontroller.html" target="_blank"><code class="language-plaintext highlighter-rouge">ASViewController</code></a></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UIViewController</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="http://asyncdisplaykit.org/docs/containers-astablenode.html" target="_blank"><code class="language-plaintext highlighter-rouge">ASTableNode</code></a></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UITableView</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="http://asyncdisplaykit.org/docs/containers-ascollectionnode.html" target="_blank"><code class="language-plaintext highlighter-rouge">ASCollectionNode</code></a></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UICollectionView</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><a href="http://asyncdisplaykit.org/docs/containers-aspagernode.html" target="_blank"> <code class="language-plaintext highlighter-rouge">ASPagerNode</code></a></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UIPageViewController</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">ASNavigationController</code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UINavigationController</code></td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">ASTabBarController </code></td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">UITabBarController </code></td>
    </tr>
  </tbody>
</table>

<h3 id="layout-engine">Layout Engine</h3>

<p>A <strong><em>Layout Engine</em></strong> do <code class="language-plaintext highlighter-rouge">ASDK</code> √© muito poderosa e oferece recursos √∫nicos, ela √© baseada no <code class="language-plaintext highlighter-rouge">CSS Box Model</code>, e fornece formas de declarar e especificar o tamanho e posi√ß√£o dos <code class="language-plaintext highlighter-rouge">subnodes</code>. Os <code class="language-plaintext highlighter-rouge">nodes</code> (<code class="language-plaintext highlighter-rouge">views</code>) s√£o renderizados de forma concorrente por default, mas os c√°lculos de medidas e posi√ß√£o s√£o executados de forma ass√≠ncrona ao se usar um <code class="language-plaintext highlighter-rouge">ASLayoutSpec</code> para cada <code class="language-plaintext highlighter-rouge">node</code>. Aqui est√° a maior diferen√ßa entre o <code class="language-plaintext highlighter-rouge">ASDK</code> e o <code class="language-plaintext highlighter-rouge">UIKit</code>, no <code class="language-plaintext highlighter-rouge">ASDK</code> o layout √© declarativo e no <code class="language-plaintext highlighter-rouge">UIKit</code> √© baseado em <em>constraint</em> com o <code class="language-plaintext highlighter-rouge">Auto Layout</code>.</p>

<p>A <strong><em>Layout Engine</em></strong> ser√° assunto de um segundo artigo que sair√° em breve, no entanto no fim do artigo deixarei refer√™ncias.</p>

<h3 id="instalando">Instalando</h3>

<p>O <code class="language-plaintext highlighter-rouge">ASDK</code> pode ser adicionado ao seu projeto via CocoaPods ou Carthage.</p>

<h4 id="cocoapods">CocoaPods</h4>
<p>Adicione o seguinte comando no seu <code class="language-plaintext highlighter-rouge">Podfile</code>:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>target 'MyApp' do
	pod "AsyncDisplayKit"
end
</code></pre></div></div>

<p>Saia do <code class="language-plaintext highlighter-rouge">XCode</code>, rode o comando dentro do diret√≥rio do projeto no Terminal:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; pod install
</code></pre></div></div>

<p>Para atualizar a vers√£o do <code class="language-plaintext highlighter-rouge">ASDK</code>, rode o comando dentro do diret√≥rio do projeto no Terminal:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; pod update AsyncDisplayKit
</code></pre></div></div>

<h4 id="carthage">Carthage</h4>
<p>Adicione o seguinte comando no seu <code class="language-plaintext highlighter-rouge">Cartfile</code> para usar a <strong><em>√∫ltima vers√£o</em></strong> do <code class="language-plaintext highlighter-rouge">ASDK</code>:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>github "facebook/AsyncDisplayKit"
</code></pre></div></div>

<p>Ou para usar a branch <strong><em>master</em></strong>:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>github "facebook/AsyncDisplayKit" "master"
</code></pre></div></div>

<p>No terminal rode:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; carthage update
</code></pre></div></div>

<p>Verifique no terminal se <code class="language-plaintext highlighter-rouge">AsyncDisplayKit</code>, <code class="language-plaintext highlighter-rouge">PINRemoteImage</code> and <code class="language-plaintext highlighter-rouge">PINCache</code> foram carregadas e compiladas.</p>

<h3 id="importando-o-framework">importando o framework</h3>

<p>Importe o header do framework para us√°-lo</p>

<pre><code class="language-objective-c">#import &lt;AsyncDisplayKit/AsyncDisplayKit.h&gt;
</code></pre>

<p>Para usar com <code class="language-plaintext highlighter-rouge">swift</code> deve-se criar um <a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/BuildingCocoaApps/MixandMatch.html" target="_blank"><em>bridge header</em></a>.</p>

<h2 id="m√£o-na-massa">M√£o na massa</h2>

<p>A melhor maneira para iniciar √© explorar os projetos de exemplo existentes no <a href="https://github.com/facebook/AsyncDisplayKit" target="_blank">GitHub</a> do <code class="language-plaintext highlighter-rouge">ASDK</code>. A pasta <strong><em>examples</em></strong> possui diversos exemplos, inclusive um simulando o Instagram chamado ASDKgram.</p>

<p>Vamos usar o exemplo ASViewController em Objective-c para nosso exemplo:</p>

<p align="center"><img style="border-radius: 3px;" src="/img/gugaoliveira/ASViewController.png" /></p>

<p>Para criar uma equivalente de <code class="language-plaintext highlighter-rouge">ViewController</code> vamos usar o container <code class="language-plaintext highlighter-rouge">ASViewController</code></p>

<pre><code class="language-objective-c">@interface ViewController : ASViewController
</code></pre>

<p>Nossa <code class="language-plaintext highlighter-rouge">ViewController</code> contem uma <code class="language-plaintext highlighter-rouge">TableView</code> que ir√° exibir as categorias de Imagens dispon√≠veis para visualiza√ß√£o, vamos ent√£o implementar a <code class="language-plaintext highlighter-rouge">TableView</code> usando o <code class="language-plaintext highlighter-rouge">ASTableNode</code>.</p>

<p>Declarando o array que contem os nomes da categoria e o <code class="language-plaintext highlighter-rouge">node</code> que reprensenta a <code class="language-plaintext highlighter-rouge">TableView</code>:</p>

<pre><code class="language-objective-c">@property (nonatomic, copy) NSArray *imageCategories;
@property (nonatomic, strong, readonly) ASTableNode *tableNode;
</code></pre>

<p>Vamos configurar a <code class="language-plaintext highlighter-rouge">ViewController</code>, iniciando a <code class="language-plaintext highlighter-rouge">TableNode</code> e o <code class="language-plaintext highlighter-rouge">array</code> usando o <code class="language-plaintext highlighter-rouge">initWithNode</code>:</p>

<pre><code class="language-objective-c">- (instancetype)init
{
    self = [super initWithNode:[ASTableNode new]];
    if (self == nil) { return self; }
    
    _imageCategories = @[@"abstract", @"animals", @"business", @"cats", @"city", @"food", @"nightlife", @"fashion", @"people", @"nature", @"sports", @"technics", @"transport"];
    
    return self;
}
</code></pre>

<p>Assim como na <code class="language-plaintext highlighter-rouge">TableView</code> para usar o <code class="language-plaintext highlighter-rouge">ASTableNode</code> deveremos nos conformar ao <code class="language-plaintext highlighter-rouge">delegate</code> e ao <code class="language-plaintext highlighter-rouge">datasource</code> da <em>TableNode</em></p>

<pre><code class="language-objective-c">....

@interface ViewController () &lt;ASTableDataSource, ASTableDelegate&gt;

.....

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    ...
    
    self.node.delegate = self;
    self.node.dataSource = self;
}

....
- (void)dealloc
{
    self.node.delegate = nil;
    self.node.dataSource = nil;
}
</code></pre>

<p>Agora vamos implementar os <code class="language-plaintext highlighter-rouge">delegates</code> e <code class="language-plaintext highlighter-rouge">datasource</code> da <code class="language-plaintext highlighter-rouge">TableNode</code></p>

<pre><code class="language-Objective-c">- (NSInteger)tableNode:(ASTableNode *)tableNode numberOfRowsInSection:(NSInteger)section
{
    return self.imageCategories.count;
}

- (ASCellNodeBlock)tableNode:(ASTableNode *)tableNode nodeBlockForRowAtIndexPath:(NSIndexPath *)indexPath
{
    // Como o bloco √© executado em outra thread em background temos que armazenar a imageCategory fora do bloco 
    NSString *imageCategory = self.imageCategories[indexPath.row];
    return ^{
        ASTextCellNode *textCellNode = [ASTextCellNode new];
        textCellNode.text = [imageCategory capitalizedString];
        return textCellNode;
    };
}

- (void)tableNode:(ASTableNode *)tableNode didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    NSString *imageCategory = self.imageCategories[indexPath.row];
    DetailRootNode *detailRootNode = [[DetailRootNode alloc] initWithImageCategory:imageCategory];
    DetailViewController *detailViewController = [[DetailViewController alloc] initWithNode:detailRootNode];
    detailViewController.title = [imageCategory capitalizedString];
    [self.navigationController pushViewController:detailViewController animated:YES];
}
</code></pre>

<p>Reparem que os m√©todos s√£o bem similares aos da <code class="language-plaintext highlighter-rouge">UITableView</code>, a <code class="language-plaintext highlighter-rouge">ASTextCellNode</code> √© uma subclasse de <code class="language-plaintext highlighter-rouge">ASCellNode</code>, que √© o equivalente do <code class="language-plaintext highlighter-rouge">ASDK</code> a <code class="language-plaintext highlighter-rouge">UITableViewCell</code> ou <code class="language-plaintext highlighter-rouge">UICollectionViewCell</code>. No caso a <code class="language-plaintext highlighter-rouge">ASTextCellNode</code> possui um label simples para exibi√ß√£o de texto. Mas existe uma diferen√ßa no m√©todo de exibi√ß√£o da c√©lula.</p>

<pre><code class="language-Objective-C">
//UITableView
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath

//ASTableNode
- (ASCellNodeBlock)tableNode:(ASTableNode *)tableNode nodeBlockForRowAtIndexPath:(NSIndexPath *)indexPath
</code></pre>

<p>A diferen√ßa aqui √© que o retorno √© um bloco de c√≥digo que pode ser executado em background pelo <code class="language-plaintext highlighter-rouge">ASDK</code>, neste caso a vari√°vel <code class="language-plaintext highlighter-rouge">indexPath</code> n√£o pode ser usada dentro do bloco, pois os dados podem mudar antes do bloco ser executado. N√£o √© necess√°rio reusar as celulas, o <code class="language-plaintext highlighter-rouge">ASDK</code> faz o trabalho para voc√™, basta iniciar o <code class="language-plaintext highlighter-rouge">ASCellNode</code> e retorn√°-lo ao fim do bloco.</p>

<p>Ao se selecionar uma linha da <code class="language-plaintext highlighter-rouge">TableNode</code> instanciamos a classe <strong><em>DetailRootNode</em></strong>, que √© uma subclasse de <code class="language-plaintext highlighter-rouge">ASDisplayNode</code> (o node fundamental do <code class="language-plaintext highlighter-rouge">ASDK</code>), com o inicializador que recebe o nome da categoria de imagens, depois instanciamos a <strong><em>DetailViewController</em></strong> que √© uma subclasse de <code class="language-plaintext highlighter-rouge">ASViewController</code> com o <code class="language-plaintext highlighter-rouge">node</code> <strong><em>DetailRootControler</em></strong></p>

<p>Na <strong><em>DetailRootNode</em></strong> temos uma inst√¢ncia de <code class="language-plaintext highlighter-rouge">ASCollectionNode</code> o <em>container</em> de <code class="language-plaintext highlighter-rouge">nodes</code> que √© equivalente a <code class="language-plaintext highlighter-rouge">UIViewController</code>. Aqui vamos usar a capacidade de um <code class="language-plaintext highlighter-rouge">node</code> gerenciar os <code class="language-plaintext highlighter-rouge">subnodes</code>, automaticamente o <code class="language-plaintext highlighter-rouge">ASDK</code> ir√° adicionar a <code class="language-plaintext highlighter-rouge">CollectionView</code> √† view <strong><em>DetailRootNode</em></strong> que √© adicionada √† DetailViewController.</p>

<pre><code class="language-Objective-C">// DetailRootNode √© um ASDisplayNode
@interface DetailRootNode : ASDisplayNode

//o ASDisplayNode possui uma ASCollectionNode (equivalente UIViewCollection)
@property (nonatomic, strong, readonly) ASCollectionNode *collectionNode;

....

// conforma-se os delegates e datasource da ASCollectionView

@interface DetailRootNode () &lt;ASCollectionDataSource, ASCollectionDelegate&gt;

....

- (instancetype)initWithImageCategory:(NSString *)imageCategory
{
    self = [super init];
    if (self) {
        // Habilita o gerenciamento automatico dos subnodes todos os nodes que 
        // estiverem referenciados no metodo layoutSpecThatFits: ser√£o adicionados automaticamente
        self.automaticallyManagesSubnodes = YES;
        
        _imageCategory = imageCategory;

        // Cria a ASCollectionView. N√£o √© necess√°rio adicionar como subnode explicitamente por que iremos configurar o parametro usesImplicitHierarchyManagement para YES
        UICollectionViewFlowLayout *layout = [[UICollectionViewFlowLayout alloc] init];
        _collectionNode = [[ASCollectionNode alloc] initWithCollectionViewLayout:layout];
        _collectionNode.delegate = self;
        _collectionNode.dataSource = self;
        _collectionNode.backgroundColor = [UIColor whiteColor];
    }
    
    return self;
}

... 

// adiciona e calcula automaticamente as dimensoes do DisplayNode com a CollectionView
- (ASLayoutSpec *)layoutSpecThatFits:(ASSizeRange)constrainedSize
{
    return [ASWrapperLayoutSpec wrapperWithLayoutElement:self.collectionNode];
}

...

#pragma mark - ASCollectionDataSource

- (NSInteger)collectionNode:(ASCollectionNode *)collectionNode numberOfItemsInSection:(NSInteger)section
{
    return 10;
}

- (ASCellNodeBlock)collectionNode:(ASCollectionNode *)collectionNode nodeBlockForItemAtIndexPath:(NSIndexPath *)indexPath
{
    NSString *imageCategory = self.imageCategory;
    return ^{
        DetailCellNode *node = [[DetailCellNode alloc] init];
        node.row = indexPath.row;
        node.imageCategory = imageCategory;
        return node;
    };
}

- (ASSizeRange)collectionNode:(ASCollectionNode *)collectionNode constrainedSizeForItemAtIndexPath:(NSIndexPath *)indexPath
{
    CGSize imageSize = CGSizeMake(CGRectGetWidth(collectionNode.view.frame), kImageHeight);
    return ASSizeRangeMake(imageSize, imageSize);
}

</code></pre>

<p>Como podem perceber a <code class="language-plaintext highlighter-rouge">ViewController</code> <strong><em>DetailViewController</em></strong> √© criada com uma view que contem uma <code class="language-plaintext highlighter-rouge">CollectionView</code>, esta carrega 10 imagens de uma api em cada c√©lula. A <strong><em>DetailCellNode</em></strong> √© uma CollectionViewCell que √© configurada em um bloco carregado em background pelo <code class="language-plaintext highlighter-rouge">ASDK</code> ap√≥s as imagens serem carregadas. A <code class="language-plaintext highlighter-rouge">UI</code> em nenhum momento deixa de ser respons√≠vel ou fluida.</p>

<h2 id="terminando">Terminando</h2>

<p>Este √© um exemplo simples que demonstra como √© intuitivo e f√°cil trabalhar com o <code class="language-plaintext highlighter-rouge">ASDK</code>, existem muitos t√≥picos avan√ßados de como melhorar ainda mais a performance. Neste artigo n√£o pudemos falar sobre Layout, Inteligent Preloading e outras conveni√™ncias. Ele serve como um start para a avalia√ß√£o da biblioteca como substituta do UIKit para criar interfaces mais fluidas e responsivas.</p>

<p>Agrade√ßo a leitura e fico aberto a sugest√µes e cr√≠ticas, este foi o meu primeiro artigo de desenvolvimento, e pretendo escrever mais.</p>

<p>Seguem meus contatos:</p>

<ul>
  <li><a href="https://twitter.com/gugaoliveira" target="_blank">Twitter (@gugaoliveira)</a></li>
  <li>Slack do <a href="http://iosdevbr.herokuapp.com/" target="_blank">iOSDevBR</a> (@gugaoliveira).</li>
</ul>

<p>Agradecimentos especiais ao <a href="https://twitter.com/hebertialmeida" target="_blank">Heberti Almeida</a>, que j√° utiliza o <code class="language-plaintext highlighter-rouge">ASDK</code> h√° bastante tempo e me apresentou esta biblioteca fant√°stica e tamb√©m seus criadores, foi realmente bacana poder conversar com os criadores e ter uma canal de comunica√ß√£o direta.</p>

<hr />

<h2 id="refer√™ncias">Refer√™ncias</h2>

<ul>
  <li><a href="http://asyncdisplaykit.org/docs/getting-started.html" target="_blank">AsyncDisplayKit Getting Starded</a></li>
  <li><a href="http://www.appcoda.com/introduction-asyncdisplaykit-2-0/" target="_blank">Using AsyncDisplayKit to Develop Responsive UIs in iOS</a> <strong><em>[Ziad Tamim, 29/12/2016]</em></strong></li>
  <li><a href="https://www.raywenderlich.com/124311/asyncdisplaykit-2-0-tutorial-getting-started" target="_blank">AsyncDisplayKit 2.0 Tutorial: Getting Started</a> <strong><em>[Luke Parham, 5/12/2016]</em></strong></li>
  <li><a href="http://asyncdisplaykit.org/slack.html" target="_blank">Slack do AsyncDisplayKit</a></li>
</ul>

<h3 id="refer√™ncias-de-layout">Refer√™ncias de Layout</h3>
<ul>
  <li><a href="https://www.raywenderlich.com/124696/asyncdisplaykit-2-0-tutorial-automatic-layout" target="_blank">AsyncDisplayKit 2.0 Tutorial: Automatic Layout</a> <strong><em>[Luke Parham, 19/12/2016]</em></strong></li>
  <li><a href="https://www.youtube.com/watch?v=sqkinHYXTuc" target="_blank">Layout at Scale with AsyncDisplayKit 2.0</a> <strong><em>[NSMeetup 2016]</em></strong></li>
  <li><a href="http://huytnguyen.me/froggy-asdk-layout/" target="_blank">ASStackLayout Game</a></li>
</ul>]]></content><author><name>‚ÄúGuga Oliveira‚Äú</name></author><category term="UI" /><summary type="html"><![CDATA[Sou o Guga Oliveira (@gugaoliveira), empreendedor, cursei engenharia eletr√¥nica mas sempre trabalhei com softwares e programa√ß√£o. Abri uma empresa de desenvolvimento Web em Juiz de Fora no in√≠cio de 2000, e em 2007 fundamos a Handcom focada em mobilidade. Trabalhamos com iOS desde o in√≠cio, e criamos aplicativos em sua maioria focados no varejo e com foco empresarial. Em 2014 fundamos a startup Microlocation que foi acelerada pelo Seed-MG e hoje faz parte de nossa solu√ß√£o para o varejo Smart-Retail, atualmente estou estudando Swift e An√°lise de Dados, e participando bastante do desenvolvimento dos ecossistemas de Minas Gerais com o MGTI em BH e o Zer040 em Juiz de Fora.]]></summary></entry><entry><title type="html">Adotando Handoff em iOS e macOS</title><link href="http://localhost:4000/continuidade/2017/03/27/adotando-handoff/" rel="alternate" type="text/html" title="Adotando Handoff em iOS e macOS" /><published>2017-03-27T21:00:00-03:00</published><updated>2017-03-27T21:00:00-03:00</updated><id>http://localhost:4000/continuidade/2017/03/27/adotando-handoff</id><content type="html" xml:base="http://localhost:4000/continuidade/2017/03/27/adotando-handoff/"><![CDATA[<blockquote>
  <p>Rafael Nobre (<a href="https://twitter.com/nobre84" target="_blank">@nobre84</a>) √© desenvolvedor iOS desde 2009 e trabalha na <a href="https://prodoctor.net" target="_blank">ProDoctor Software</a>. Odiava o Swift no lan√ßamento, mas foi rapidamente conquistado pela abordagem <em>Swifty</em> de resolver problemas.</p>
</blockquote>

<h1 id="continuidade">Continuidade</h1>
<p>Handoff faz parte de um conjunto de funcionalidades chamadas coletivamente pela Apple de <strong>Continuidade</strong>. Seu objetivo √© fazer com que diversos dispositivos compat√≠veis possam se comunicar para que o usu√°rio obtenha mais produtividade ou comodidade. S√£o estes recursos que permitem, por exemplo, atender chamadas recebidas no iPhone pelo Mac, enviar e receber mensagens de texto pelo Messages, desbloquear o Mac pelo Apple Watch ou transferir arquivos via AirDrop, entre outros.</p>

<h1 id="handoff">Handoff</h1>
<p>A fun√ß√£o do Handoff √© simples: permitir a continua√ß√£o de uma <em>atividade</em> iniciada em um device por outro, desde que esteja <em>pr√≥ximo</em> e vinculado √† mesma conta iCloud. Essas restri√ß√µes conferem <em>seguran√ßa</em> e <em>contexto</em>, impedindo que algu√©m com acesso f√≠sico a um de seus aparelhos possa visualizar ou continuar uma de suas atividades.</p>

<h2 id="como-come√ßar">Como come√ßar</h2>
<p>Para adotar o Handoff, o primeiro passo √© mapear quais <em>atividades</em> de seu app ser√£o expostas para continuidade, ou seja, identifique fun√ß√µes de alto n√≠vel em seu aplicativo cujo estado seria relevante compartilhar com um segundo aparelho de forma transparente. Como exemplos, o Safari permite que uma p√°gina visualizada inicialmente no celular seja lida no Mac e vice-versa, assim como o Mail permite que uma mensagem iniciada em um aparelho possa ser alterada e enviada em outro.</p>

<h2 id="como-funciona">Como funciona</h2>
<p>O <strong>Bluetooth LE</strong> √© um dos elementos chave do Handoff: √© ele quem confere ao recurso o fator <em>proximidade</em>. Quando uma <em>atividade</em> √© declarada pelo desenvolvedor como eleg√≠vel ao Handoff, √© feito um <em>broadcast</em> pelo sistema para que dispositivos pr√≥ximos - e conectados √† mesma conta do iCloud - possam continuar a atividade atual.</p>

<p>O interessante √© que at√© este momento, nenhuma informa√ß√£o foi de fato trafegada, apenas o pequeno pacote de <em>advertising</em> do Bluetooth. Somente quando uma aplica√ß√£o eleg√≠vel - isto √©, que tenha sido assinada pelo mesmo <em>Team ID</em> - for acionada pelo usu√°rio para continuar a <em>atividade</em> √© que inicia a transfer√™ncia de dados, via <em>WiFi</em>, para o dispositivo de destino.</p>

<h1 id="colocando-a-m√£o-na-massa">Colocando a m√£o na massa</h1>

<h3 id="primeiro-passo-declarar-atividades">Primeiro passo: declarar atividades</h3>
<p>Basta uma entrada no <code class="language-plaintext highlighter-rouge">Info.plist</code> do projeto indicando a lista de tipos que o app sabe lidar (recomenda-se nomenclatura estilo DNS reverso para evitar colis√µes).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;key&gt;</span>NSUserActivityTypes<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;array&gt;</span>
	<span class="nt">&lt;string&gt;</span>com.equinocios.Handoff.sample<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/array&gt;</span>
</code></pre></div></div>

<h3 id="segundo-passo-publicar-uma-atividade">Segundo passo: publicar uma atividade</h3>
<p>Agora √© preciso encapsular o estado da aplica√ß√£o em um objeto <code class="language-plaintext highlighter-rouge">NSUserActivity</code>, que ser√° transferido para um segundo app para dar continuidade √† tarefa. Este app pode ser macOS, iOS, ou ainda um browser (para ativar este recurso utiliza-se o atributo <code class="language-plaintext highlighter-rouge">webpageURL</code>).</p>

<p>O exemplo abaixo √© o <em>bare bones</em> da implementa√ß√£o em um <code class="language-plaintext highlighter-rouge">UIViewController</code>, no iOS.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">userActivity</span> <span class="o">=</span> <span class="kt">NSUserActivity</span><span class="p">(</span><span class="nv">activityType</span><span class="p">:</span> <span class="s">"com.equinocios.Handoff.sample"</span><span class="p">)</span>
<span class="n">userActivity</span><span class="o">.</span><span class="n">isEligibleForHandoff</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">userActivity</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">"Novo artigo"</span>
<span class="n">userActivity</span><span class="o">.</span><span class="n">userInfo</span> <span class="o">=</span> <span class="p">[</span><span class="s">"user"</span><span class="p">:</span> <span class="s">"nobre84"</span><span class="p">,</span> <span class="s">"title"</span><span class="p">:</span> <span class="s">"Adotando Handoff em iOS e macOS"</span><span class="p">,</span> <span class="s">"body"</span><span class="p">:</span> <span class="s">"# Continuidade</span><span class="se">\n</span><span class="s">Handoff faz parte de ..."</span><span class="p">,</span> <span class="s">"cursorPosition"</span><span class="p">:</span> <span class="mi">110</span> <span class="p">]</span>
<span class="n">userActivity</span><span class="o">.</span><span class="n">webpageURL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"http://equinocios.com/continuidade/2017/03/28/adotando-handoff"</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">userActivity</span> <span class="o">=</span> <span class="n">userActivity</span>
</code></pre></div></div>

<p>O <code class="language-plaintext highlighter-rouge">userInfo</code> √© o principal mecanismo utilizado para trafegar o estado da aplica√ß√£o. Nele voc√™ dever√° incluir tudo que for necess√°rio para recriar o estado exato da <em>atividade</em> do usu√°rio em um dado momento. Um bom candidato para se encarregar disto √© o seu <code class="language-plaintext highlighter-rouge">view model</code> ou outra forma de separa√ß√£o de responsabilidades, uma vez que √© interessante que o <em>boilerplate</em> que lida com a cria√ß√£o da <code class="language-plaintext highlighter-rouge">NSUserActivity</code> n√£o conhe√ßa o estado de suas <em>views</em>. Al√©m disso, este n√£o √© o √∫nico local onde estas informa√ß√µes se far√£o necess√°rias, como veremos mais adiante.</p>

<h3 id="terceiro-passo-continuar-uma-atividade">Terceiro passo: continuar uma atividade</h3>
<p>Para concluir o processo √© preciso implementar o m√©todo <code class="language-plaintext highlighter-rouge">application(_:‚Äãcontinue:‚Äãrestoration‚ÄãHandler:‚Äã)</code> no <em>App Delegate</em> da aplica√ß√£o macOS ou iOS. √â o mesmo m√©todo utilizado para receber informa√ß√µes a respeito de buscas utilizando a API de Spotlight ou Intents do Siri.<br />
Baseado no <code class="language-plaintext highlighter-rouge">activityType</code> da <code class="language-plaintext highlighter-rouge">userActivity</code>, voc√™ deve definir a tela a qual seu app ser√° redirecionado, e seu conte√∫do atrav√©s do <code class="language-plaintext highlighter-rouge">userInfo</code>. Isto pode ser feito repassando a <code class="language-plaintext highlighter-rouge">userActivity</code> para os <em>childs</em> desde o <code class="language-plaintext highlighter-rouge">rootViewController</code> usando o m√©todo <code class="language-plaintext highlighter-rouge">restoreUserActivityState</code>, sobrescrevendo-o em cada ponto da hierarquia e passando-a adiante, at√© alcan√ßar o <em>controller</em> relevante para atualizar seu estado; ou recriar a hierarquia de views do zero para atender o <em>atividade</em> - o que na minha opini√£o faz mais sentido.
Para gerenciar este fluxo pode ser utilizado algum mecanismo de roteamento, que desacople do app delegate de forma flex√≠vel (e test√°vel!) essa complexa l√≥gica de <strong>qual</strong> <em>view controller</em> exibir dado uma <code class="language-plaintext highlighter-rouge">NSUserActivity</code>. Dica: essa l√≥gica pode ser similar √† utilizada para definir o <code class="language-plaintext highlighter-rouge">rootViewController</code> da sua <code class="language-plaintext highlighter-rouge">Window</code> no <code class="language-plaintext highlighter-rouge">application(_:didFinishLaunchingWithOptions:)</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="k">continue</span> <span class="nv">userActivity</span><span class="p">:</span> <span class="kt">NSUserActivity</span><span class="p">,</span> <span class="nv">restorationHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">([</span><span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>

	<span class="c1">// Repassando a userActivity, cada um dos controllers na hierarquia deve sobrescrever o m√©todo abaixo e empurrando a userActivity para o pr√≥ximo child</span>
	<span class="k">self</span><span class="o">.</span><span class="n">window</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">restoreUserActivityState</span><span class="p">(</span><span class="n">userActivity</span><span class="p">)</span>

	<span class="c1">// Ou recriando toda a hierarquia para atender ao Handoff</span>
	<span class="k">if</span> <span class="k">let</span> <span class="nv">router</span> <span class="o">=</span> <span class="kt">Router</span><span class="p">(</span><span class="nv">activity</span><span class="p">:</span> <span class="n">userActivity</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Obt√©m uma pilha de controllers que represente o estado correto do app</span>
		<span class="k">let</span> <span class="nv">hierarchy</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="nf">buildHierarchy</span><span class="p">()</span>
		<span class="c1">// Substitui o rootViewController da Window e empilha os demais</span>
		<span class="n">router</span><span class="o">.</span><span class="nf">appendHierarchy</span><span class="p">(</span><span class="nv">window</span><span class="p">:</span> <span class="n">window</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">true</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">willContinueUserActivityWithType</span> <span class="nv">userActivityType</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
	<span class="c1">// Sabe-se que ir√° ocorrer um Handoff, mas o userInfo ainda n√£o foi transmitido.</span>
	<span class="c1">// Pode ser utilizado para exibir feedback ao usu√°rio e/ou exibir um overlay para uma transi√ß√£o suave</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didFailToContinueUserActivityWithType</span> <span class="nv">userActivityType</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Pode-se exibir feedback de que um problema ocorreu e/ou desfazer um overlay apresentado no willContinueUserActivityWithType</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="the-good">The Good</h1>
<p>Pronto! Agora nossos apps s√£o capazes de publicar uma atividade e continu√°-la em outro device! Isto √© realmente incr√≠vel, um r√°pido rascunho pode ser finalizado em um poderoso Mac √† noite em casa, assim como um importante e-mail iniciado em casa pode ser enviado no meio do tr√¢nsito. A Apple vai te olhar com bons olhos, quem sabe at√© d√™ um feature pro seu app! A API √© simples, e voc√™ j√° tem praticamente metade do esfor√ßo necess√°rio para tamb√©m adicionar suporte a Spotlight Searching pro seu app ao usar <code class="language-plaintext highlighter-rouge">NSUserActivity</code>‚Äôs. Mas, nem tudo s√£o flores!</p>

<h1 id="the-bad">The Bad</h1>
<p>A API, apesar de simples, possui algumas <em>idiossincrasias</em>. Lembra do exemplo <em>bare bones</em> que dei l√° em cima? Ele n√£o funciona. Faltaram alguns detalhes importantes, os quais a documenta√ß√£o n√£o √© muito clara a respeito. 
O ciclo de vida de uma <code class="language-plaintext highlighter-rouge">NSUserActivity</code> √© atrelado a um <code class="language-plaintext highlighter-rouge">delegate</code>, que <em>UIKit/AppKit</em> j√° cuidam para n√≥s atrav√©s de extens√µes de <code class="language-plaintext highlighter-rouge">UIResponder</code> - o pr√≥prio <em>controller</em>, bastando setar a propriedade <code class="language-plaintext highlighter-rouge">userActivity</code> do mesmo.
Ao setar a <code class="language-plaintext highlighter-rouge">userActivity</code> de um <em>controller</em> no iOS, a mesma est√° ativa e fazendo <em>broadcast</em> da <em>atividade</em>, mesmo que ela n√£o seja mais relevante no seu app (o usu√°rio navegou para outro <em>controller</em> por exemplo). √â necess√°rio ent√£o cuidar do ciclo de vida - normalmente acompanhando o do pr√≥prio <em>controller</em>. J√° o <em>macOS</em> faz a coisa certa neste caso.<br />
Ambas plataformas, por√©m, proveem uma forma de manter o estado do <code class="language-plaintext highlighter-rouge">userInfo</code> de uma <code class="language-plaintext highlighter-rouge">NSUserActivity</code> o mais atualizado poss√≠vel, atrav√©s do m√©todo <code class="language-plaintext highlighter-rouge">updateUserActivityState(_:)</code>, onde voc√™ ter√° a chance de atualizar o <code class="language-plaintext highlighter-rouge">userInfo</code> instantes antes de sua <em>atividade</em> ser transferida para outro dispositivo ou caso voc√™ sete manualmente a flag <code class="language-plaintext highlighter-rouge">needsSave</code> para <code class="language-plaintext highlighter-rouge">true</code>. Plaus√≠vel, n√£o √© mesmo? O inesperado √© que, parte da implementa√ß√£o deste m√©todo simplesmente <strong>esvazia</strong> todo o conte√∫do do <code class="language-plaintext highlighter-rouge">userInfo</code>! Ou seja, se voc√™ n√£o fizer <em>override</em> deste m√©todo, nada funciona!<br />
Existe tamb√©m uma propriedade chamada <code class="language-plaintext highlighter-rouge">requiredUserInfoKeys</code> que, digamos, indica que tudo que voc√™ adicionar ao <code class="language-plaintext highlighter-rouge">userInfo</code> e n√£o adicionar aqui, ser√° jogado fora! Astuto, n√£o!? Tem uma pequena nota documentando este comportamento, mas at√© hoje n√£o consigo ver o sentido. 
Corrigindo ent√£o nossa implementa√ß√£o ing√™nua para algo mais pr√≥ximo da realidade:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
    <span class="nf">startUserActivity</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
    <span class="nf">stopUserActivity</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">override</span> <span class="kd">func</span> <span class="nf">updateUserActivityState</span><span class="p">(</span><span class="n">_</span> <span class="nv">userActivity</span><span class="p">:</span> <span class="kt">NSUserActivity</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">userActivity</span><span class="o">.</span><span class="nf">addUserInfoEntries</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="nf">uiStateDictionary</span><span class="p">())</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">updateUserActivityState</span><span class="p">(</span><span class="n">userActivity</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">startUserActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">userActivity</span> <span class="o">=</span> <span class="kt">NSUserActivity</span><span class="p">(</span><span class="nv">activityType</span><span class="p">:</span> <span class="s">"com.equinocios.Handoff.sample"</span><span class="p">)</span>
    <span class="n">userActivity</span><span class="o">.</span><span class="n">isEligibleForHandoff</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">userActivity</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">"Novo artigo"</span>
    <span class="n">userActivity</span><span class="o">.</span><span class="n">userInfo</span> <span class="o">=</span> <span class="nf">uiStateDictionary</span><span class="p">()</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">keys</span> <span class="o">=</span> <span class="n">userActivity</span><span class="o">.</span><span class="n">userInfo</span><span class="p">?</span><span class="o">.</span><span class="n">keys</span> <span class="p">{</span>
        <span class="n">userActivity</span><span class="o">.</span><span class="n">requiredUserInfoKeys</span> <span class="o">=</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">})</span>
    <span class="p">}</span>
    <span class="n">userActivity</span><span class="o">.</span><span class="n">webpageURL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"http://equinocios.com/continuidade/2017/03/28/adotando-handoff"</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">userActivity</span> <span class="o">=</span> <span class="n">userActivity</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">stopUserActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">userActivity</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidate</span><span class="p">()</span>
    <span class="k">self</span><span class="o">.</span><span class="n">userActivity</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">uiStateDictionary</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span> <span class="kt">AnyHashable</span><span class="p">:</span> <span class="kt">Any</span> <span class="p">]</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">"user"</span><span class="p">:</span> <span class="s">"nobre84"</span><span class="p">,</span> <span class="s">"title"</span><span class="p">:</span> <span class="s">"Adotando Handoff em iOS e macOS"</span><span class="p">,</span> <span class="s">"body"</span><span class="p">:</span> <span class="s">"# Continuidade</span><span class="se">\n</span><span class="s">Handoff faz parte de ..."</span><span class="p">,</span> <span class="s">"cursorPosition"</span><span class="p">:</span> <span class="mi">110</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Outro aspecto documentado, mas que pode peg√°-lo de surpresa, agora ao continuar a <em>atividade</em>, √© que se por algum motivo o seu m√©todo <code class="language-plaintext highlighter-rouge">application(_:didFinishLaunchingWithOptions:)</code> retornar <code class="language-plaintext highlighter-rouge">false</code>, o sistema jamais chamar√° o m√©todo <code class="language-plaintext highlighter-rouge">application(_:‚Äãcontinue:‚Äãrestoration‚ÄãHandler:‚Äã)</code> e voc√™ n√£o poder√° concluir o processo. Logo, caso voc√™ manipule o retorno do primeiro m√©todo, ter√° de identificar se o app foi aberto por conta de uma <em>atividade</em> inspecionando o dicion√°rio <code class="language-plaintext highlighter-rouge">launchOptions</code> quanto √† presen√ßa da chave <code class="language-plaintext highlighter-rouge">user‚ÄãActivity‚ÄãDictionary</code>, retornando <code class="language-plaintext highlighter-rouge">true</code> neste caso.</p>

<h1 id="the-ugly">The Ugly</h1>
<p>O Handoff apresenta em algumas ocasi√µes falhas que podem te deixar louco. Em muitos casos basta tentar novamente e tudo d√° certo, por√©m n√£o √© incomum ter que deslogar e logar novamente no iCloud vezes para corrigir algum problema inexplic√°vel, sobretudo quando se est√° utilizando vers√µes diferentes do iOS (o recurso est√° dispon√≠vel desde o iOS 8).<br />
Entretanto, a coroa vai pra um bug que pouca ou nenhuma informa√ß√£o encontrei a respeito na Web (<a href="http://stackoverflow.com/questions/38462031/cant-handoff-from-mac-to-ios-even-though-handoff-from-ios-to-mac-works-fine?noredirect=1#comment72785636_38462031">1</a>, <a href="http://stackoverflow.com/questions/41720356/native-mac-app-fails-to-handoff-to-native-ios-app">2</a>, <a href="https://forums.developer.apple.com/search.jspa?q=handoff">3</a>), e que tenho um <em>DTS</em> da Apple em aberto at√© hoje (reproduziram o problema mas n√£o possuem solu√ß√£o), √© o fato de que (ao menos em ambiente de desenvolvimento) um Handoff iniciado no Mac n√£o aparece em outros dispositivos, enquanto do iOS para iOS ou iOS para Mac funciona normalmente. Nosso colega <a href="https://twitter.com/reprotector" target="_blank">Renan Protector</a> utiliza Handoff no <a href="https://getblogo.com" target="_blank">Blogo</a> e segundo ele, em produ√ß√£o tudo funciona. Espero compartilhar da mesma experi√™ncia em breve!</p>

<h1 id="conclus√£o">Conclus√£o</h1>
<p>Fora os pequenos grilos, √© uma tecnologia muito interessante e √∫til para se adotar! A experi√™ncia do usu√°rio √© a privilegiada, mesmo que a custo de alguns cabelos brancos!<br />
D√∫vidas, cr√≠ticas e sugest√µes, enviem pelos coment√°rios abaixo, ou diretamente no <a href="http://iosdevbr.herokuapp.com">Slack iOS Dev BR</a> - <code class="language-plaintext highlighter-rouge">@nobre84</code>. At√© a pr√≥xima!</p>

<h1 id="refer√™ncia-oficial">Refer√™ncia oficial:</h1>
<ul>
  <li><a href="https://developer.apple.com/library/content/documentation/UserExperience/Conceptual/Handoff/HandoffFundamentals/HandoffFundamentals.html#//apple_ref/doc/uid/TP40014338-CH3-SW1">Handoff Programming Guide</a></li>
</ul>]]></content><author><name>Rafael Nobre</name></author><category term="continuidade" /><summary type="html"><![CDATA[Rafael Nobre (@nobre84) √© desenvolvedor iOS desde 2009 e trabalha na ProDoctor Software. Odiava o Swift no lan√ßamento, mas foi rapidamente conquistado pela abordagem Swifty de resolver problemas.]]></summary></entry><entry><title type="html">CoreBluetooth na Pr√°tica</title><link href="http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/" rel="alternate" type="text/html" title="CoreBluetooth na Pr√°tica" /><published>2017-03-26T21:00:00-03:00</published><updated>2017-03-26T21:00:00-03:00</updated><id>http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica</id><content type="html" xml:base="http://localhost:4000/bluetooth/2017/03/26/corebluetooth-na-pratica/"><![CDATA[<blockquote>
  <p>Leonardo Cardoso (<a href="https://twitter.com/leocardz" target="_blank">@leocardz</a>) come√ßou a trabalhar com mobile desde 2010 com a plataforma do robozinho verde, mas veio para a ma√ß√£ em 2014, atualmente lidera o time iOS da <a href="https://1aim.com" target="_blank">1aim</a>, em Berlim. √â tamb√©m um entusiasta open source e desenvolveu alguns projetos que podem ser acessados no seu perfil do <a href="https://github.com/leonardocardoso" target="_blank">GitHub</a>.</p>
</blockquote>

<h1 id="intro">Intro</h1>

<p>√â muito comum hoje estarmos em contato com dispositivos sem fio no nosso dia-a-dia. Seja um <em>headphone</em>, um <em>mouse</em>, um teclado, ou o famigerado <em>Apple Watch</em>. A lista √© extensa‚Ä¶ Todos eles, por√©m, utilizam basicamente uma mesma tecnologia que os torna de fato <em>wireless</em>: <strong>Bluetooth¬Æ</strong>.</p>

<p>Aqui vamos aprender brevemente os papeis executados e propriedades difundidas numa conex√£o via <em>Bluetooth</em>, e os modos de execu√ß√£o desses papeis utilizando o <em>framework</em> <strong>Core Bluetooth</strong>, que nos d√° o suporte √† vers√£o 4.0 (<em>a.k.a smart, a.k.a. low-energy</em>).</p>

<p>Primeiramente vamos aos modos de execu√ß√£o.</p>

<h1 id="modos-de-execu√ß√£o">Modos de Execu√ß√£o</h1>

<p>O <strong>Core Bluetooth</strong>, ou CB, nos proporciona dois modos de execu√ß√£o, <em>Foreground</em> e <em>Background</em>. Assim, podemos definir bem se queremos nossos <em>apps</em> ‚Äúconect√°veis‚Äù apenas quando o usu√°rio estiver interagindo com ele ou n√£o. Alguns aspectos definem bem esses modos, s√£o eles:</p>

<h2 id="foreground">Foreground</h2>

<p>Se o app √© minimizado ou outro app se torna o principal utilizado pelo usu√°rio, nosso suporte <em>Bluetooth</em> vai junto. Assim, no estado suspenso, seu <em>app</em> n√£o √© capaz de realizar tarefas relacionadas a <em>Bluetooth</em>, nem fica ciente de eventos relacionados a <em>Bluetooth</em>. Por√©m a lista de eventos recebidos enquanto o <em>app</em> estava em <em>background</em> √© empilhada e esses eventos s√£o entregues quando o usu√°rio resumir o <em>app</em>, tornando-o ativo novamente.</p>

<p>Explicaremos mais abaixo a diferen√ßa entre os papeis e as propriedades, mas nesse modo caso o aplicativo n√£o esteja ativo, o perif√©rico n√£o consegue enviar propagandas (<em>advertising</em>) e a central n√£o consegue difundir seu sinal (<em>scanning</em>), por√©m a execu√ß√£o de <em>advertising</em> e <em>scanning</em> s√£o respondidas sob demanda, praticamente sem atrasos.</p>

<p>A vantagem de usarmos em <em>Foreground</em> √© que temos o todos os recursos do sistema ao nosso alcance, como por exemplo, atualiza√ß√£o de <em>views</em> e tarefas sem tempo limite de execu√ß√£o. Ainda nesse modo, nossa <em>stack</em> de dispositivos √© bem distrinchada, inclusive tendo a op√ß√£o de escolher se queremos escanear o mesmo perif√©rico por alguma raz√£o espec√≠fica. Isso √© feito atrav√©s de uma propriedade <code class="language-plaintext highlighter-rouge">CBCentralManagerScanOptionAllowDuplicatesKey</code>, o que no modo <em>Background</em> √© ignorada, assim como outras propriedades s√£o tratadas diferentes quando executadas em modos <em>Foreground</em> e <em>Background</em> e elas podem ser achadas nas <a href="#referncias">Refer√™ncias</a>.</p>

<h2 id="background">Background</h2>

<p>Aqui j√° come√ßamos dizendo que os recursos de sistemas s√£o limitados. Temos tamb√©m <em>10 segundos</em> no m√°ximo para executar uma tarefa nesse modo. Mas creio que isso √© mais do que suficiente. O intervalo de execu√ß√£o de <em>advertising</em> e <em>scanning</em> pode ser mais demorado. Isso √© feito em prol de economizar bateria do seu dispositivo. Aqui, eventos do mesmo dispositivo s√£o combinados num √∫nico evento com seus <em>servi√ßos e caracter√≠sticas</em>, ou seja, a op√ß√£o de escanear o mesmo dispositivo mais de uma vez √© descartada.</p>

<p>A vantagem desse modo √© permitir que nosso <em>app</em> n√£o precisa estar ativo para trocarmos dados entre centrais e perif√©ricos. Ent√£o, s√≥ para esclarecer, o sistema acorda nosso <em>app</em> de um estado suspenso, permitindo ler, escrever, inscrever em caracter√≠sticas, escutar eventos. Tudo em <em>background</em>. Mas mesmo que tenhamos permiss√£o de rodar em <em>background</em>, nosso <em>app</em> n√£o vai rodar sempre. Isso pode acontecer porque eventualmente o sistema pode finalizar nosso <em>app</em> para liberar mem√≥ria para o <em>app</em> que est√° no estado ativo. A partir do <em>iOS7</em>, √© permitido salvar os estados dos dispositivos, conex√µes pendentes, etc., antes de uma interrup√ß√£o e ent√£o restaur√°-los depois.</p>

<p>Como um exemplo para essa restaura√ß√£o de estados, vamos imaginar que voc√™ tenha desenvolvido um dispositivo de seguran√ßa que se comunica com uma fechadura eletr√¥nica equipada com <em>Bluetooth</em>. O <em>app</em> e a fechadura podem interagir para que a fechadura se tranque automaticamente quando o usu√°rio saia da casa e destranque quando o usu√°rio voltar. Tudo isso com o <em>iPhone</em> no bolso. Quando o usu√°rio sair de casa, o <em>iPhone</em> pode eventualmente sair do alcance da fechadura e, ent√£o, perder conex√£o. Nesse caso, o usu√°rio pode simplesmente chamar a fun√ß√£o para conectar o dispositivo, mesmo n√£o estando no raio de alcance e, assim, a conex√£o ser√° refeita quando eles estiverem de novo ao alcance. Isso acontece porque a requisi√ß√£o de conex√£o de dispositivos n√£o expira.</p>

<p>Agora imagina que o usu√°rio est√° fora de casa em uma viagem. Se o <em>app</em> √© finalizado pelo sistema enquanto o usu√°rio est√° fora, o <em>app</em> n√£o vai ser capaz de se reconectar com a fechadura quando o usu√°rio retornar. Assim, a fechadura n√£o vai destrancar. Para apps como estes, √© definitivamente necess√°rio usar a op√ß√£o de salvamento e restaura√ß√£o de estados.</p>

<p>Observa√ß√£o: <em>macOS</em> e <em>iOS</em> funcionam um pouco diferente nos papeis de perif√©rico e central. Por exemplo, <em>macOS</em> n√£o aceita a <em>flag</em> <code class="language-plaintext highlighter-rouge">CBCentralManagerOptionRestoreIdentifierKey</code>, porque o <em>background</em> do <em>macOS</em> n√£o finaliza <em>apps</em> como o <em>iOS</em> faz, em teoria.</p>

<p>Para usar o modo <em>Background</em>, precisamos ainda definir <em>flags</em> no <code class="language-plaintext highlighter-rouge">Info.plist</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">bluetooth-peripheral</code>: Se quisermos usar um perif√©rico em <em>background</em></li>
  <li><code class="language-plaintext highlighter-rouge">bluetooth-central</code>: Se quisermos usar uma central em <em>background</em></li>
</ul>

<p>Se adicionarmos o suporte via <code class="language-plaintext highlighter-rouge">Target &gt; Capabilities &gt; Background Modes</code>, selecionando <code class="language-plaintext highlighter-rouge">Uses Bluetooth LE accessories (central)</code> e/ou <code class="language-plaintext highlighter-rouge">Act as Bluetooth LE accessory (peripheral)</code>, elas s√£o adicionadas automaticamente no <code class="language-plaintext highlighter-rouge">Info.plist</code>.</p>

<p><strong>Importante</strong>: N√£o esque√ßa de adicionar a <em>flag</em> <code class="language-plaintext highlighter-rouge">Privacy - Bluetooth Peripheral Usage Description</code> para que o usu√°rio permita que esteja utilizando o dispositivo como perif√©rico, assim como fazemos quando queremos utilizar a c√¢mera ou localiza√ß√£o.</p>

<h1 id="papeis">Papeis</h1>

<p>Nesse jogo de conex√µes <em>Bluetooth</em>, n√≥s temos dois papeis distintos e bem especificados que funcionam como uma abordagem <strong>Client-Server</strong>. S√£o eles: <strong>Perif√©rico</strong> e <strong>Central</strong>.</p>

<h2 id="perif√©rico">Perif√©rico</h2>

<p>Um perif√©rico √© o dispositivo que compartilha seus dados para a central. Nesse modo, o sistema acorda nosso app para processar tarefas de leitura, escrita, inscri√ß√µes de eventos vindos da central. √â o dispositivo que funciona como <em>Server</em>, ou seja, tem os dados que se desejam.</p>

<p>Quando um perif√©rico est√° sendo executado em <em>Background</em>, seus servi√ßos s√£o realocados para uma √°rea de ‚Äú<em>overflow</em>‚Äù especial, ou seja, todos os <em>UUIDs</em> dos servi√ßos contidos na valor da propriedade <code class="language-plaintext highlighter-rouge">CBAdvertisementDataServiceUUIDsKey</code>. Sendo assim, ele s√≥ pode ser descoberto por um dispositivo que esteja explicitamente escaneando por ele, procurando por alguma de sua caracter√≠stica, basicamente seu indentificador.</p>

<h2 id="central">Central</h2>

<p>Uma central √© o dispositivo que requer informa√ß√µes de dispositivos perif√©ricos. Nesse caso, ela escaneia, connecta, obt√©m dados e envia dados, os explora. O <em>Client</em>.</p>

<p>O sistema acorda nossa central quando eventos de mudan√ßa de estado ocorrem com o perif√©rico, tais como conex√£o estabelecida ou cortada com o perif√©rico, quando perif√©rico atualiza informa√ß√µes de suas caract√©risticas, ou ainda quando nossa central est√° perto de ser finalizada e tamb√©m restaurada.</p>

<h3 id="exemplo">Exemplo</h3>

<p>Imagina o funcionamento de um medidor de batimento card√≠aco de praticantes de esportes. Nesse caso, o perif√©rico seria o dispositivo medidor que est√° alocado abaixo do peito do corredor. E um <em>app</em> no <em>iPhone</em> poderia ler esse valor e mostrar para o usu√°rio em tempo real, fazendo o <em>iPhone</em> funcionar como central, numa a√ß√£o em <em>Foreground</em>. Agora imagina que o corredor n√£o vai querer ficar olhando para seu <em>iPhone</em> todo o tempo, ent√£o, no modo <em>Background</em>, o <em>iPhone</em> captura dados dos batimentos e guarda num <em>log</em> no qual o usu√°rio pode checar as varia√ß√µes quando terminar seu exerc√≠cio.</p>

<p><img src="/img/leonardocardoso/communication.png" /></p>

<h1 id="conex√£o">Conex√£o</h1>

<p>A conex√£o entre uma central e um perif√©rico √© feita atrav√©s de escaneamento e propaganda. Basicamente esse √© o fluxo:</p>

<ul>
  <li>Um perif√©rico difunde um sinal que pode ser conectado usando pacotes de propaganda;</li>
  <li>Enquanto a central difunde um sinal que est√° procurando por perif√©rico;</li>
  <li>Quando uma central encontra um perif√©rico, ele pode explorar primeiro requisitar a conex√£o, o que pode ser rejeitada pelo perif√©rico ou n√£o. Essa conex√£o pode ser encriptada com a encripta√ß√£o nativa que o <em>Core Bluetooth</em> nos prov√™. Se a conex√£o encriptada for desejada, ent√£o um c√≥digo aparece num dos dispositivos para ser digitado no outro e assim criar pares de criptografia administrados pelo pr√≥prio sistema, tornando-os dispositivos confi√°veis. Se nenhuma criptografia for requerida, ent√£o a conex√£o √© feita autom√°tica;</li>
  <li>Ap√≥s a conex√£o ser feita, a central pode ent√£o ordenar que o perif√©rico descubra servi√ßos, basicamente a central est√° explorando os servi√ßos do perif√©rico;</li>
  <li>Ap√≥s servi√ßos descobertos, a central pode ent√£o ordenar que o perif√©rico descubra caracter√≠sticas, basicamente a central est√° explorando as caracter√≠sticas de cada servi√ßo do perif√©rico;</li>
  <li>Descobertas as caracter√≠sticas, a central pode ent√£o ler valores das caracter√≠sticas estaticamente ou se increver naquela caracter√≠stica e caso o perif√©rico atualize o valor dela, a central ser√° notificada com o novo valor.</li>
  <li>A conex√£o pode ser finalizada, se for o caso.</li>
</ul>

<p><img src="/img/leonardocardoso/advertisingdiscovery.png" /></p>

<h1 id="servi√ßos-e-caracter√≠sticas">Servi√ßos e Caracter√≠sticas</h1>

<p>As trocas de dados feitas por dispositivos conectados s√£o atrav√©s de propriedades e elas s√£o servi√ßos e caracter√≠sticas j√° comentadas em algumas partes anteriormente.</p>

<p>Um servi√ßo √© uma cole√ß√£o de dados e comportamentos associados para completar uma tarefa ou uma fun√ß√£o de um disposito, ou partes de um dispositivo. Esses comportamentos s√£o chamados de caracter√≠sticas. Uma caracter√≠stica prov√™ mais detalhes sobre um servi√ßo de um perif√©rico. Parece basicamente uma descri√ß√£o daqueles verbetes que voc√™ procura em um dicion√°rio. Uma defini√ß√£o te leva pra outra e voc√™ fica num eterno <em>loop</em>. Mas vamos tentar explicar melhor mais abaixo.</p>

<p>Servi√ßos podem ter outros servi√ßos relacionados, como depend√™ncias, apontando para <em>UUIDs</em> de outros servi√ßos. Cada caracter√≠stica tamb√©m tem <em>UUID</em> que a possa indentificar.</p>

<p><img src="/img/leonardocardoso/servicescharacterisctics.png" /></p>

<p>Ent√£o nesse exemplo n√≥s temos dois sensores que funcionam diferentes um do outro mas juntos eles produzem um servi√ßo, que √© o Batimento Card√≠aco. Para que ele funcione corretamente, o sensor card√≠aco deve estar posicionado no local ideal.</p>

<p>Ainda utilizando o nosso exemplo anterior, suponha que no dispositivo de batimento card√≠aco poder√≠amos ter dois servi√ßos, um com duas caracter√≠cticas e outro com apenas uma:</p>

<ul>
  <li>Servi√ßo 1: Batimentos Card√≠acos
    <ul>
      <li>Caracter√≠stica 1: Medi√ß√£o dos Batimentos Card√≠acos</li>
      <li>Caracter√≠stica 2: Localiza√ß√£o Adequada do Dispositivo</li>
    </ul>
  </li>
  <li>Servi√ßo 2: Status
    <ul>
      <li>Caracter√≠stica 1: N√≠vel de Bateria</li>
    </ul>
  </li>
</ul>

<p>Mas um perif√©rico √© nada se n√£o estiver enviando propagandas. Um pacote de propaganda √© relativamente um pequeno agrupamento de dados que tem informa√ß√µes sobre o que o dispositivo perif√©rico para um reconhecimento inicial. Dados como nome do dispositivo, <em>UUID</em> e <em>RSSI</em>, que √© uma informa√ß√£o de qu√£o forte √© o sinal do perif√©rico.</p>

<h1 id="pra-onde-vamos-n√≥s">Pra onde vamos n√≥s?</h1>

<p>N√≥s vamos exemplificar aqui o seguinte:</p>

<ul>
  <li>Papeis
    <ul>
      <li><em>iOS</em> como Perif√©rico</li>
      <li><em>macOS</em> como Central</li>
    </ul>
  </li>
  <li>Modos
    <ul>
      <li><em>Foreground</em></li>
    </ul>
  </li>
</ul>

<p>Para conferir o modo <em>background</em>, confira no <a href="https://github.com/LeonardoCardoso/BLE{:target=&quot;_blank&quot;}">reposit√≥rio desse projeto no GitHub</a>, no <em>branch</em> <code class="language-plaintext highlighter-rouge">background</code>.</p>

<h1 id="code-snippets">Code Snippets</h1>

<p>Devemos primeiro ligar nosso app com o <code class="language-plaintext highlighter-rouge">CoreBluetooth</code>. Ent√£o, v√° <code class="language-plaintext highlighter-rouge">Project</code> -&gt; <code class="language-plaintext highlighter-rouge">Targets</code> -&gt; <code class="language-plaintext highlighter-rouge">Build Phases</code> -&gt; <code class="language-plaintext highlighter-rouge">Link Binary with Libraries</code> -&gt; Procura por <code class="language-plaintext highlighter-rouge">CoreBluetooth.framework</code> e ent√£o o adiciona.</p>

<h2 id="foreground-1">Foreground</h2>

<p>Primeiro, vamos criar um protocolor para receber os eventos escutados do <code class="language-plaintext highlighter-rouge">BluetoothManager</code> e atualizar as views dos nossos <code class="language-plaintext highlighter-rouge">ViewController</code>s. Vamos cham√°-lo de <code class="language-plaintext highlighter-rouge">BlueEar</code>. E tem uma vers√£o para a <code class="language-plaintext highlighter-rouge">Central</code> e outra pro <code class="language-plaintext highlighter-rouge">Peripheral</code>. Assim como o <code class="language-plaintext highlighter-rouge">BlueEar</code>, teremos uma classe que ser√° a administradora da nossa conex√£o <em>Bluetooth</em> e √© a <code class="language-plaintext highlighter-rouge">BluetoothManager</code>.</p>

<h3 id="ios">iOS</h3>

<h4 id="blueear">BlueEar</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">protocol</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didStartAdvertising</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="bluetoothmanager">BluetoothManager</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">let</span> <span class="nv">peripheralId</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"62443cc7-15bc-4136-bf5d-0ad80c459215"</span>
    <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"0cdbe648-eed0-11e6-bc64-92361f002671"</span>
    <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"199ab74c-eed0-11E6-BC64-92361F002672"</span>
    <span class="k">let</span> <span class="nv">localName</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"Peripheral - iOS"</span>

    <span class="k">let</span> <span class="nv">properties</span><span class="p">:</span> <span class="kt">CBCharacteristicProperties</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="o">.</span><span class="n">notify</span><span class="p">,</span> <span class="o">.</span><span class="n">writeWithoutResponse</span><span class="p">,</span> <span class="o">.</span><span class="n">write</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">permissions</span><span class="p">:</span> <span class="kt">CBAttributePermissions</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="n">readable</span><span class="p">,</span> <span class="o">.</span><span class="n">writeable</span><span class="p">]</span>

    <span class="k">var</span> <span class="nv">bluetoothMessaging</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">peripheralManager</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBMutableService</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBMutableCharacteristic</span><span class="p">?</span>

    <span class="c1">// MARK: - Initializers</span>
    <span class="kd">convenience</span> <span class="nf">init</span> <span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span> <span class="o">=</span> <span class="n">delegate</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?,</span>
            <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">serviceUUID</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">characteristicUUID</span><span class="p">)</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Configuring service</span>
        <span class="k">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="kt">CBMutableService</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">serviceCBUUID</span><span class="p">,</span> <span class="nv">primary</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>

        <span class="c1">// Configuring characteristic</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="o">=</span> <span class="kt">CBMutableCharacteristic</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="n">characteristicCBUUID</span><span class="p">,</span> <span class="nv">properties</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">permissions</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Add characterisct to service</span>
        <span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="p">?</span><span class="o">.</span><span class="n">characteristics</span> <span class="o">=</span> <span class="p">[</span><span class="n">characterisctic</span><span class="p">]</span>

        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartConfiguration</span><span class="p">()</span>

        <span class="c1">// Initiate peripheral and start advertising</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span> <span class="o">=</span> <span class="kt">CBPeripheralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbperipheralmanagerdelegate">CBPeripheralManagerDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBPeripheralManagerDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBPeripheralManagerDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">peripheralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerDidUpdateState"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBMutableService</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">service</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">removeAllServices</span><span class="p">()</span>
            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didAdd</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didAdd service"</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">advertisingData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kt">CBAdvertisementDataServiceUUIDsKey</span><span class="p">:</span> <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="p">?</span><span class="o">.</span><span class="n">uuid</span><span class="p">],</span>
            <span class="kt">CBAdvertisementDataLocalNameKey</span><span class="p">:</span> <span class="s">"Peripheral - iOS"</span>
        <span class="p">]</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">stopAdvertising</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">startAdvertising</span><span class="p">(</span><span class="n">advertisingData</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralManagerDidStartAdvertising</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerDidStartAdvertising"</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartAdvertising</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="c1">// Listen to dynamic values</span>
    <span class="c1">// Called when CBPeripheral .setNotifyValue(true, for: characteristic) is called from the central</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentral</span><span class="p">,</span> <span class="n">didSubscribeTo</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didSubscribeTo characteristic"</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">characterisctic</span><span class="p">:</span> <span class="kt">CBMutableCharacteristic</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">do</span> <span class="p">{</span>

            <span class="c1">// Writing data to characteristics</span>
            <span class="k">let</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Hello"</span><span class="p">:</span> <span class="s">"Darkness"</span><span class="p">]</span>
            <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">fromPropertyList</span><span class="p">:</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">updateValue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characterisctic</span><span class="p">,</span> <span class="nv">onSubscribedCentrals</span><span class="p">:</span> <span class="p">[</span><span class="n">central</span><span class="p">])</span>
            <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didSendData</span><span class="p">()</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="c1">// Read static values</span>
    <span class="c1">// Called when CBPeripheral .readValue(for: characteristic) is called from the central</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didReceiveRead</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">CBATTRequest</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didReceiveRead request"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">uuid</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characterisctic</span><span class="p">?</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">characteristic</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uuid</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"Match characteristic for static reading"</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="c1">// Called when receiving writing from Central.</span>
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">didReceiveWrite</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBATTRequest</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didReceiveWrite requests"</span><span class="p">)</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">CBATTRequest</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">characteristic</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">characteristicCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span><span class="p">,</span>
            <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// Send response to central if this writing request asks for response [.withResponse]</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Sending response: Success"</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="nv">withResult</span><span class="p">:</span> <span class="o">.</span><span class="n">success</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"Match characteristic for writing"</span><span class="p">)</span>

        <span class="k">do</span> <span class="p">{</span>

            <span class="k">if</span> <span class="k">let</span> <span class="nv">receivedData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">propertyList</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">format</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="p">{</span>

                <span class="nf">print</span><span class="p">(</span><span class="s">"Written value is: </span><span class="se">\(</span><span class="n">receivedData</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">bluetoothMessaging</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveData</span><span class="p">()</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="k">return</span>

            <span class="p">}</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentral</span><span class="p">,</span> <span class="n">didUnsubscribeFrom</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUnsubscribeFrom characteristic"</span><span class="p">)</span>
        
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">,</span> <span class="n">willRestoreState</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"willRestoreState"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheralManagerIsReady</span><span class="p">(</span><span class="n">toUpdateSubscribers</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"peripheralManagerIsReady"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="viewcontroller">ViewController</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="c1">// MARK: - IBOutlet</span>
    <span class="kd">@IBOutlet</span> <span class="k">var</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>

    <span class="c1">// MARK: - Lifecyle</span>
    <span class="k">override</span> <span class="k">var</span> <span class="nv">preferredStatusBarStyle</span><span class="p">:</span> <span class="kt">UIStatusBarStyle</span> <span class="p">{</span> <span class="k">return</span> <span class="o">.</span><span class="n">lightContent</span> <span class="p">}</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">var</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">BluetoothManager</span><span class="p">?</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="kt">BluetoothManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// MARK: - BlueEar</span>
<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Start configuration üéõ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didStartAdvertising</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Start advertising üìª"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Did send data ‚¨ÜÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Did received data ‚¨áÔ∏è"</span> <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="view">View</h4>

<p><img src="/img/leonardocardoso/iOS.png" /></p>

<h4 id="notas">Notas:</h4>

<ul>
  <li>No nosso exemplo, o Perif√©rico vai come√ßar a fazer propaganda quando iniciar o <code class="language-plaintext highlighter-rouge">app</code>.</li>
  <li>Voc√™ s√≥ pode fazer alguma coisa com o perif√©rico quando a fun√ß√£o <code class="language-plaintext highlighter-rouge">peripheralManagerDidUpdateState(: CBPeripheralManager)</code> for chamada e o estado do perif√©rico estiver <code class="language-plaintext highlighter-rouge">.poweredOn</code>.</li>
  <li>Leituras de valores din√¢micos pela Central usando a fun√ß√£o <code class="language-plaintext highlighter-rouge">.setNotifyValue(true, for: characteristic)</code> disparam a fun√ß√£o <code class="language-plaintext highlighter-rouge">peripheralManager(_: CBPeripheralManager, : CBCentral, : CBCharacteristic)</code> do perif√©rico, j√° leituras de valores est√°ticos usando a fun√ß√£o <code class="language-plaintext highlighter-rouge">.readValue(for: characteristic)</code> pela Central, disparam <code class="language-plaintext highlighter-rouge">peripheralManager(_: CBPeripheralManager, :CBATTRequest)</code> do perif√©rico.</li>
</ul>

<h3 id="macos">macOS</h3>

<h4 id="blueear-1">BlueEar</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">protocol</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didStartScanningPeripherals</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>
    <span class="kd">func</span> <span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">didFailConnection</span><span class="p">()</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="bluetoothmanager-1">BluetoothManager</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"0cdbe648-eed0-11e6-bc64-92361f002671"</span>
    <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"199ab74c-eed0-11e6-bc64-92361f002672"</span>

    <span class="k">var</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">blueEar</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">centralManager</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">?</span>

    <span class="k">var</span> <span class="nv">discoveredPeripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">?</span>

    <span class="c1">// MARK: - Initializers</span>
    <span class="kd">convenience</span> <span class="nf">init</span> <span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="kt">BlueEar</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span> <span class="o">=</span> <span class="n">delegate</span>

        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">serviceUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?,</span>
            <span class="k">let</span> <span class="nv">characteristicUUID</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">NSUUID</span><span class="p">(</span><span class="nv">uuidString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicUUID</span><span class="p">)</span> <span class="k">as</span> <span class="kt">UUID</span><span class="p">?</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">serviceUUID</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">nsuuid</span><span class="p">:</span> <span class="n">characteristicUUID</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="c1">// MARK: - Functions</span>
    <span class="kd">func</span> <span class="nf">scan</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span> <span class="o">=</span> <span class="kt">CBCentralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartConfiguration</span><span class="p">()</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbcentralmanagerdelegate">CBCentralManagerDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBCentralManagerDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBCentralManagerDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">centralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">centralManagerDidUpdateState </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">central</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didStartScanningPeripherals</span><span class="p">()</span>
            <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">scanForPeripherals</span><span class="p">(</span><span class="nv">withServices</span><span class="p">:</span> <span class="p">[</span><span class="n">serviceCBUUID</span><span class="p">],</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

        <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didDiscover</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">advertisementData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">],</span> <span class="n">rssi</span> <span class="kt">RSSI</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// We must keep a reference to the new discovered peripheral, which means we must retain it.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscover:"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">discoveredPeripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">discoveredPeripheral</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didConnect</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didConnect"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">let</span> <span class="nv">serviceCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">discoverServices</span><span class="p">([</span><span class="n">serviceCBUUID</span><span class="p">])</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">willRestoreState</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"willRestoreState"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didRetrievePeripherals</span> <span class="nv">peripherals</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBPeripheral</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didRetrievePeripherals"</span><span class="p">)</span>


    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didFailToConnect</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didFailToConnect"</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didFailConnection</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didRetrieveConnectedPeripherals</span> <span class="nv">peripherals</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBPeripheral</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didRetrieveConnectedPeripherals"</span><span class="p">)</span>


    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didDisconnectPeripheral</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDisconnectPeripheral"</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="cbperipheraldelegate">CBPeripheralDelegate</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// MARK: - CBPeripheralDelegate</span>
<span class="kd">extension</span> <span class="kt">BluetoothManager</span><span class="p">:</span> <span class="kt">CBPeripheralDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverServices</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverServices"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">services</span><span class="p">?</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="k">self</span><span class="o">.</span><span class="n">serviceCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>

            <span class="k">guard</span> <span class="k">let</span> <span class="nv">characteristicCBUUID</span><span class="p">:</span> <span class="kt">CBUUID</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">discoverCharacteristics</span><span class="p">([</span><span class="n">characteristicCBUUID</span><span class="p">],</span> <span class="nv">for</span><span class="p">:</span> <span class="n">service</span><span class="p">)</span>

        <span class="p">}</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didWriteValueFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didWriteValueFor </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="c1">// After we write data on peripheral, we disconnect it.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">cancelPeripheralConnection</span><span class="p">(</span><span class="n">peripheral</span><span class="p">)</span>

        <span class="c1">// We stop scanning.</span>
        <span class="k">self</span><span class="o">.</span><span class="n">centralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">stopScan</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverCharacteristicsFor</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverCharacteristicsFor"</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">characteristics</span><span class="p">?</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="k">self</span><span class="o">.</span><span class="n">characteristicCBUUID</span> <span class="p">})</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"Matching characteristic"</span><span class="p">)</span>

            <span class="c1">// To listen and read dynamic values</span>
            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">setNotifyValue</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characteristic</span><span class="p">)</span>

            <span class="c1">// To read static values</span>
            <span class="c1">// self.discoveredPeripheral?.readValue(for: characteristic)</span>
            
        <span class="p">}</span>
        
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateValueFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateValueFor"</span><span class="p">)</span>

        <span class="c1">// We read</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="n">characteristic</span><span class="o">.</span><span class="n">value</span> <span class="p">{</span>

            <span class="k">do</span> <span class="p">{</span>

                <span class="k">let</span> <span class="nv">receivedData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">propertyList</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">format</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">as!</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span>

                <span class="nf">print</span><span class="p">(</span><span class="s">"Value read is: </span><span class="se">\(</span><span class="n">receivedData</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveData</span><span class="p">()</span>

            <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>

                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

            <span class="p">}</span>

        <span class="p">}</span>

        <span class="c1">// We write</span>
        <span class="k">do</span> <span class="p">{</span>

            <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Writing on peripheral."</span><span class="p">)</span>

            <span class="k">let</span> <span class="nv">dict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Yo"</span><span class="p">:</span> <span class="s">"Lo"</span><span class="p">]</span>
            <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">PropertyListSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">fromPropertyList</span><span class="p">:</span> <span class="n">dict</span><span class="p">,</span> <span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="nf">writeValue</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">characteristic</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="o">.</span><span class="n">withResponse</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">blueEar</span><span class="p">?</span><span class="o">.</span><span class="nf">didSendData</span><span class="p">()</span>
            
        <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            
        <span class="p">}</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralDidUpdateRSSI</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">peripheralDidUpdateRSSI"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">discoveredPeripheral</span><span class="p">?</span><span class="o">.</span><span class="n">rssi</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>
        
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheralDidUpdateName</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">peripheralDidUpdateName"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didWriteValueFor</span> <span class="nv">descriptor</span><span class="p">:</span> <span class="kt">CBDescriptor</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didWriteValueFor"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didModifyServices</span> <span class="nv">invalidatedServices</span><span class="p">:</span> <span class="p">[</span><span class="kt">CBService</span><span class="p">])</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didModifyServices"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateValueFor</span> <span class="nv">descriptor</span><span class="p">:</span> <span class="kt">CBDescriptor</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateValueFor"</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverIncludedServicesFor</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">CBService</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverIncludedServicesFor"</span><span class="p">)</span>

    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didDiscoverDescriptorsFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didDiscoverDescriptorsFor"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">peripheral</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="n">didUpdateNotificationStateFor</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CBCharacteristic</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">didUpdateNotificationStateFor"</span><span class="p">)</span>
        
    <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="viewcontroller-1">ViewController</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Cocoa</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">NSViewController</span> <span class="p">{</span>

    <span class="c1">// MARK: - IBOutlet</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">NSTextField</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">button</span><span class="p">:</span> <span class="kt">NSButton</span><span class="o">!</span>

    <span class="c1">// MARK: - Properties</span>
    <span class="k">var</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">BluetoothManager</span><span class="p">?</span>

    <span class="c1">// MARK: - Lifecyle</span>
    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">discover</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="kt">BluetoothManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">manager</span><span class="p">?</span><span class="o">.</span><span class="nf">scan</span><span class="p">()</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// MARK: - BlueEar</span>
<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">BlueEar</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">didStartConfiguration</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Start configuration üéõ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didStartScanningPeripherals</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Start scanning peripherals üëÄ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didConnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did connect to: </span><span class="se">\(</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s"> ü§úüèΩü§õüèΩ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didDisconnectPeripheral</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did disconnect: </span><span class="se">\(</span><span class="n">name</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s"> ü§úüèΩü§öüèΩ"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didSendData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did send data ‚¨ÜÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didReceiveData</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Did received data ‚¨áÔ∏è"</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didFailConnection</span><span class="p">()</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="s">"Connection failed ü§∑üèΩ‚Äç‚ôÇÔ∏è"</span> <span class="p">}</span>
    
<span class="p">}</span>

</code></pre></div></div>

<h4 id="view-1">View</h4>

<p><img src="/img/leonardocardoso/macOS.png" /></p>

<h4 id="notas-1">Notas:</h4>

<ul>
  <li>No nosso exemplo, a Central vai come√ßar a escanear por perif√©ricos quando clicarmor num bot√£o chamado <code class="language-plaintext highlighter-rouge">Tap</code>.</li>
  <li>Voc√™ s√≥ pode fazer alguma coisa com a central quando a fun√ß√£o <code class="language-plaintext highlighter-rouge">centralManagerDidUpdateState(: CBCentralManager)</code> for chamada e o estado do perif√©rico estiver <code class="language-plaintext highlighter-rouge">.poweredOn</code>.</li>
  <li>Note que o <code class="language-plaintext highlighter-rouge">CBPeripheralDelegate</code> √© diferente do <code class="language-plaintext highlighter-rouge">CBPeripheralManagerDelegate</code> usado no perif√©rico. Ambos s√£o relacionados ao perif√©rico, por√©m o <code class="language-plaintext highlighter-rouge">CBPeripheralDelegate</code> permite que a central escute eventos sobre o perif√©rico.</li>
  <li>Ao optar por ler resultados din√¢micos, a central se inscreve em caracter√≠sticas do perif√©rico, assim sendo alertada por meio de notifica√ß√µes se o perif√©rico alterar seu valor no qual ela esteja inscrita.</li>
  <li>Quando a central descobre um perif√©rico, devemos manter uma refer√™ncia para ele, ou seja, devemos ret√™-lo fazendo com que uma vari√°vel dentro do nosso c√≥digo o receba.</li>
  <li>Os dados s√£o trasmitidos em formato de <code class="language-plaintext highlighter-rouge">Data</code>, ent√£o voc√™ deve transformar o que quer transmitir neste tipo de dados para poder ser recebido corretamente no outro lado.</li>
</ul>

<h3 id="resultado">Resultado</h3>

<p>Na imagem, temos o respectivo: <em>Log</em> do perif√©rico, <em>iOS</em>, <em>macOS</em>, <em>Log</em> da central.</p>

<p><a href="/img/leonardocardoso/result.mp4" alt="Click to see a video smoother than this GIF" target="_blank">
<img src="/img/leonardocardoso/result.gif" />
</a></p>

<hr />

<h3 id="refer√™ncias">Refer√™ncias</h3>

<ul>
  <li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html" target="_blank">CoreBlueetooth</a></li>
</ul>

<hr />

<h3 id="agradecimentos">Agradecimentos</h3>

<p>Um agradecimento pra galera do <a href="http://iosdevbr.slack.com" target="_blank">Slack iOS Devs BR</a> pela oportunidade.</p>

<p>Um abra√ßo, e at√© pr√≥xima.</p>

<p>Leo</p>]]></content><author><name>Leonardo Cardoso</name></author><category term="bluetooth" /><summary type="html"><![CDATA[Leonardo Cardoso (@leocardz) come√ßou a trabalhar com mobile desde 2010 com a plataforma do robozinho verde, mas veio para a ma√ß√£ em 2014, atualmente lidera o time iOS da 1aim, em Berlim. √â tamb√©m um entusiasta open source e desenvolveu alguns projetos que podem ser acessados no seu perfil do GitHub. Intro √â muito comum hoje estarmos em contato com dispositivos sem fio no nosso dia-a-dia. Seja um headphone, um mouse, um teclado, ou o famigerado Apple Watch. A lista √© extensa‚Ä¶ Todos eles, por√©m, utilizam basicamente uma mesma tecnologia que os torna de fato wireless: Bluetooth¬Æ. Aqui vamos aprender brevemente os papeis executados e propriedades difundidas numa conex√£o via Bluetooth, e os modos de execu√ß√£o desses papeis utilizando o framework Core Bluetooth, que nos d√° o suporte √† vers√£o 4.0 (a.k.a smart, a.k.a. low-energy). Primeiramente vamos aos modos de execu√ß√£o. Modos de Execu√ß√£o O Core Bluetooth, ou CB, nos proporciona dois modos de execu√ß√£o, Foreground e Background. Assim, podemos definir bem se queremos nossos apps ‚Äúconect√°veis‚Äù apenas quando o usu√°rio estiver interagindo com ele ou n√£o. Alguns aspectos definem bem esses modos, s√£o eles: Foreground Se o app √© minimizado ou outro app se torna o principal utilizado pelo usu√°rio, nosso suporte Bluetooth vai junto. Assim, no estado suspenso, seu app n√£o √© capaz de realizar tarefas relacionadas a Bluetooth, nem fica ciente de eventos relacionados a Bluetooth. Por√©m a lista de eventos recebidos enquanto o app estava em background √© empilhada e esses eventos s√£o entregues quando o usu√°rio resumir o app, tornando-o ativo novamente. Explicaremos mais abaixo a diferen√ßa entre os papeis e as propriedades, mas nesse modo caso o aplicativo n√£o esteja ativo, o perif√©rico n√£o consegue enviar propagandas (advertising) e a central n√£o consegue difundir seu sinal (scanning), por√©m a execu√ß√£o de advertising e scanning s√£o respondidas sob demanda, praticamente sem atrasos. A vantagem de usarmos em Foreground √© que temos o todos os recursos do sistema ao nosso alcance, como por exemplo, atualiza√ß√£o de views e tarefas sem tempo limite de execu√ß√£o. Ainda nesse modo, nossa stack de dispositivos √© bem distrinchada, inclusive tendo a op√ß√£o de escolher se queremos escanear o mesmo perif√©rico por alguma raz√£o espec√≠fica. Isso √© feito atrav√©s de uma propriedade CBCentralManagerScanOptionAllowDuplicatesKey, o que no modo Background √© ignorada, assim como outras propriedades s√£o tratadas diferentes quando executadas em modos Foreground e Background e elas podem ser achadas nas Refer√™ncias. Background Aqui j√° come√ßamos dizendo que os recursos de sistemas s√£o limitados. Temos tamb√©m 10 segundos no m√°ximo para executar uma tarefa nesse modo. Mas creio que isso √© mais do que suficiente. O intervalo de execu√ß√£o de advertising e scanning pode ser mais demorado. Isso √© feito em prol de economizar bateria do seu dispositivo. Aqui, eventos do mesmo dispositivo s√£o combinados num √∫nico evento com seus servi√ßos e caracter√≠sticas, ou seja, a op√ß√£o de escanear o mesmo dispositivo mais de uma vez √© descartada. A vantagem desse modo √© permitir que nosso app n√£o precisa estar ativo para trocarmos dados entre centrais e perif√©ricos. Ent√£o, s√≥ para esclarecer, o sistema acorda nosso app de um estado suspenso, permitindo ler, escrever, inscrever em caracter√≠sticas, escutar eventos. Tudo em background. Mas mesmo que tenhamos permiss√£o de rodar em background, nosso app n√£o vai rodar sempre. Isso pode acontecer porque eventualmente o sistema pode finalizar nosso app para liberar mem√≥ria para o app que est√° no estado ativo. A partir do iOS7, √© permitido salvar os estados dos dispositivos, conex√µes pendentes, etc., antes de uma interrup√ß√£o e ent√£o restaur√°-los depois. Como um exemplo para essa restaura√ß√£o de estados, vamos imaginar que voc√™ tenha desenvolvido um dispositivo de seguran√ßa que se comunica com uma fechadura eletr√¥nica equipada com Bluetooth. O app e a fechadura podem interagir para que a fechadura se tranque automaticamente quando o usu√°rio saia da casa e destranque quando o usu√°rio voltar. Tudo isso com o iPhone no bolso. Quando o usu√°rio sair de casa, o iPhone pode eventualmente sair do alcance da fechadura e, ent√£o, perder conex√£o. Nesse caso, o usu√°rio pode simplesmente chamar a fun√ß√£o para conectar o dispositivo, mesmo n√£o estando no raio de alcance e, assim, a conex√£o ser√° refeita quando eles estiverem de novo ao alcance. Isso acontece porque a requisi√ß√£o de conex√£o de dispositivos n√£o expira. Agora imagina que o usu√°rio est√° fora de casa em uma viagem. Se o app √© finalizado pelo sistema enquanto o usu√°rio est√° fora, o app n√£o vai ser capaz de se reconectar com a fechadura quando o usu√°rio retornar. Assim, a fechadura n√£o vai destrancar. Para apps como estes, √© definitivamente necess√°rio usar a op√ß√£o de salvamento e restaura√ß√£o de estados. Observa√ß√£o: macOS e iOS funcionam um pouco diferente nos papeis de perif√©rico e central. Por exemplo, macOS n√£o aceita a flag CBCentralManagerOptionRestoreIdentifierKey, porque o background do macOS n√£o finaliza apps como o iOS faz, em teoria. Para usar o modo Background, precisamos ainda definir flags no Info.plist. bluetooth-peripheral: Se quisermos usar um perif√©rico em background bluetooth-central: Se quisermos usar uma central em background Se adicionarmos o suporte via Target &gt; Capabilities &gt; Background Modes, selecionando Uses Bluetooth LE accessories (central) e/ou Act as Bluetooth LE accessory (peripheral), elas s√£o adicionadas automaticamente no Info.plist. Importante: N√£o esque√ßa de adicionar a flag Privacy - Bluetooth Peripheral Usage Description para que o usu√°rio permita que esteja utilizando o dispositivo como perif√©rico, assim como fazemos quando queremos utilizar a c√¢mera ou localiza√ß√£o. Papeis Nesse jogo de conex√µes Bluetooth, n√≥s temos dois papeis distintos e bem especificados que funcionam como uma abordagem Client-Server. S√£o eles: Perif√©rico e Central. Perif√©rico Um perif√©rico √© o dispositivo que compartilha seus dados para a central. Nesse modo, o sistema acorda nosso app para processar tarefas de leitura, escrita, inscri√ß√µes de eventos vindos da central. √â o dispositivo que funciona como Server, ou seja, tem os dados que se desejam. Quando um perif√©rico est√° sendo executado em Background, seus servi√ßos s√£o realocados para uma √°rea de ‚Äúoverflow‚Äù especial, ou seja, todos os UUIDs dos servi√ßos contidos na valor da propriedade CBAdvertisementDataServiceUUIDsKey. Sendo assim, ele s√≥ pode ser descoberto por um dispositivo que esteja explicitamente escaneando por ele, procurando por alguma de sua caracter√≠stica, basicamente seu indentificador. Central Uma central √© o dispositivo que requer informa√ß√µes de dispositivos perif√©ricos. Nesse caso, ela escaneia, connecta, obt√©m dados e envia dados, os explora. O Client. O sistema acorda nossa central quando eventos de mudan√ßa de estado ocorrem com o perif√©rico, tais como conex√£o estabelecida ou cortada com o perif√©rico, quando perif√©rico atualiza informa√ß√µes de suas caract√©risticas, ou ainda quando nossa central est√° perto de ser finalizada e tamb√©m restaurada. Exemplo Imagina o funcionamento de um medidor de batimento card√≠aco de praticantes de esportes. Nesse caso, o perif√©rico seria o dispositivo medidor que est√° alocado abaixo do peito do corredor. E um app no iPhone poderia ler esse valor e mostrar para o usu√°rio em tempo real, fazendo o iPhone funcionar como central, numa a√ß√£o em Foreground. Agora imagina que o corredor n√£o vai querer ficar olhando para seu iPhone todo o tempo, ent√£o, no modo Background, o iPhone captura dados dos batimentos e guarda num log no qual o usu√°rio pode checar as varia√ß√µes quando terminar seu exerc√≠cio. Conex√£o A conex√£o entre uma central e um perif√©rico √© feita atrav√©s de escaneamento e propaganda. Basicamente esse √© o fluxo: Um perif√©rico difunde um sinal que pode ser conectado usando pacotes de propaganda; Enquanto a central difunde um sinal que est√° procurando por perif√©rico; Quando uma central encontra um perif√©rico, ele pode explorar primeiro requisitar a conex√£o, o que pode ser rejeitada pelo perif√©rico ou n√£o. Essa conex√£o pode ser encriptada com a encripta√ß√£o nativa que o Core Bluetooth nos prov√™. Se a conex√£o encriptada for desejada, ent√£o um c√≥digo aparece num dos dispositivos para ser digitado no outro e assim criar pares de criptografia administrados pelo pr√≥prio sistema, tornando-os dispositivos confi√°veis. Se nenhuma criptografia for requerida, ent√£o a conex√£o √© feita autom√°tica; Ap√≥s a conex√£o ser feita, a central pode ent√£o ordenar que o perif√©rico descubra servi√ßos, basicamente a central est√° explorando os servi√ßos do perif√©rico; Ap√≥s servi√ßos descobertos, a central pode ent√£o ordenar que o perif√©rico descubra caracter√≠sticas, basicamente a central est√° explorando as caracter√≠sticas de cada servi√ßo do perif√©rico; Descobertas as caracter√≠sticas, a central pode ent√£o ler valores das caracter√≠sticas estaticamente ou se increver naquela caracter√≠stica e caso o perif√©rico atualize o valor dela, a central ser√° notificada com o novo valor. A conex√£o pode ser finalizada, se for o caso. Servi√ßos e Caracter√≠sticas As trocas de dados feitas por dispositivos conectados s√£o atrav√©s de propriedades e elas s√£o servi√ßos e caracter√≠sticas j√° comentadas em algumas partes anteriormente. Um servi√ßo √© uma cole√ß√£o de dados e comportamentos associados para completar uma tarefa ou uma fun√ß√£o de um disposito, ou partes de um dispositivo. Esses comportamentos s√£o chamados de caracter√≠sticas. Uma caracter√≠stica prov√™ mais detalhes sobre um servi√ßo de um perif√©rico. Parece basicamente uma descri√ß√£o daqueles verbetes que voc√™ procura em um dicion√°rio. Uma defini√ß√£o te leva pra outra e voc√™ fica num eterno loop. Mas vamos tentar explicar melhor mais abaixo. Servi√ßos podem ter outros servi√ßos relacionados, como depend√™ncias, apontando para UUIDs de outros servi√ßos. Cada caracter√≠stica tamb√©m tem UUID que a possa indentificar. Ent√£o nesse exemplo n√≥s temos dois sensores que funcionam diferentes um do outro mas juntos eles produzem um servi√ßo, que √© o Batimento Card√≠aco. Para que ele funcione corretamente, o sensor card√≠aco deve estar posicionado no local ideal. Ainda utilizando o nosso exemplo anterior, suponha que no dispositivo de batimento card√≠aco poder√≠amos ter dois servi√ßos, um com duas caracter√≠cticas e outro com apenas uma: Servi√ßo 1: Batimentos Card√≠acos Caracter√≠stica 1: Medi√ß√£o dos Batimentos Card√≠acos Caracter√≠stica 2: Localiza√ß√£o Adequada do Dispositivo Servi√ßo 2: Status Caracter√≠stica 1: N√≠vel de Bateria Mas um perif√©rico √© nada se n√£o estiver enviando propagandas. Um pacote de propaganda √© relativamente um pequeno agrupamento de dados que tem informa√ß√µes sobre o que o dispositivo perif√©rico para um reconhecimento inicial. Dados como nome do dispositivo, UUID e RSSI, que √© uma informa√ß√£o de qu√£o forte √© o sinal do perif√©rico. Pra onde vamos n√≥s? N√≥s vamos exemplificar aqui o seguinte: Papeis iOS como Perif√©rico macOS como Central Modos Foreground Para conferir o modo background, confira no reposit√≥rio desse projeto no GitHub, no branch background. Code Snippets Devemos primeiro ligar nosso app com o CoreBluetooth. Ent√£o, v√° Project -&gt; Targets -&gt; Build Phases -&gt; Link Binary with Libraries -&gt; Procura por CoreBluetooth.framework e ent√£o o adiciona. Foreground Primeiro, vamos criar um protocolor para receber os eventos escutados do BluetoothManager e atualizar as views dos nossos ViewControllers. Vamos cham√°-lo de BlueEar. E tem uma vers√£o para a Central e outra pro Peripheral. Assim como o BlueEar, teremos uma classe que ser√° a administradora da nossa conex√£o Bluetooth e √© a BluetoothManager. iOS BlueEar protocol BlueEar { func didStartConfiguration() func didStartAdvertising() func didSendData() func didReceiveData() } BluetoothManager class BluetoothManager: NSObject { // MARK: - Properties let peripheralId: String = "62443cc7-15bc-4136-bf5d-0ad80c459215" let serviceUUID: String = "0cdbe648-eed0-11e6-bc64-92361f002671" let characteristicUUID: String = "199ab74c-eed0-11E6-BC64-92361F002672" let localName: String = "Peripheral - iOS" let properties: CBCharacteristicProperties = [.read, .notify, .writeWithoutResponse, .write] let permissions: CBAttributePermissions = [.readable, .writeable] var bluetoothMessaging: BlueEar? var peripheralManager: CBPeripheralManager? var serviceCBUUID: CBUUID? var characteristicCBUUID: CBUUID? var service: CBMutableService? var characterisctic: CBMutableCharacteristic? // MARK: - Initializers convenience init (delegate: BlueEar?) { self.init() self.bluetoothMessaging = delegate guard let serviceUUID: UUID = NSUUID(uuidString: self.serviceUUID) as UUID?, let characteristicUUID: UUID = NSUUID(uuidString: self.characteristicUUID) as UUID? else { return } self.serviceCBUUID = CBUUID(nsuuid: serviceUUID) self.characteristicCBUUID = CBUUID(nsuuid: characteristicUUID) guard let serviceCBUUID: CBUUID = self.serviceCBUUID, let characteristicCBUUID: CBUUID = self.characteristicCBUUID else { return } // Configuring service self.service = CBMutableService(type: serviceCBUUID, primary: true) // Configuring characteristic self.characterisctic = CBMutableCharacteristic(type: characteristicCBUUID, properties: self.properties, value: nil, permissions: self.permissions) guard let characterisctic: CBCharacteristic = self.characterisctic else { return } // Add characterisct to service self.service?.characteristics = [characterisctic] self.bluetoothMessaging?.didStartConfiguration() // Initiate peripheral and start advertising self.peripheralManager = CBPeripheralManager(delegate: self, queue: nil, options: nil) } } CBPeripheralManagerDelegate // MARK: - CBPeripheralManagerDelegate extension BluetoothManager: CBPeripheralManagerDelegate { func peripheralManagerDidUpdateState(_ peripheral: CBPeripheralManager) { print("peripheralManagerDidUpdateState") if peripheral.state == .poweredOn { guard let service: CBMutableService = self.service else { return } self.peripheralManager?.removeAllServices() self.peripheralManager?.add(service) } } func peripheralManager(_ peripheral: CBPeripheralManager, didAdd service: CBService, error: Error?) { print("\ndidAdd service") let advertisingData: [String: Any] = [ CBAdvertisementDataServiceUUIDsKey: [self.service?.uuid], CBAdvertisementDataLocalNameKey: "Peripheral - iOS" ] self.peripheralManager?.stopAdvertising() self.peripheralManager?.startAdvertising(advertisingData) } func peripheralManagerDidStartAdvertising(_ peripheral: CBPeripheralManager, error: Error?) { print("peripheralManagerDidStartAdvertising") self.bluetoothMessaging?.didStartAdvertising() } // Listen to dynamic values // Called when CBPeripheral .setNotifyValue(true, for: characteristic) is called from the central func peripheralManager(_ peripheral: CBPeripheralManager, central: CBCentral, didSubscribeTo characteristic: CBCharacteristic) { print("\ndidSubscribeTo characteristic") guard let characterisctic: CBMutableCharacteristic = self.characterisctic else { return } do { // Writing data to characteristics let dict: [String: String] = ["Hello": "Darkness"] let data: Data = try PropertyListSerialization.data(fromPropertyList: dict, format: .binary, options: 0) self.peripheralManager?.updateValue(data, for: characterisctic, onSubscribedCentrals: [central]) self.bluetoothMessaging?.didSendData() } catch let error { print(error) } } // Read static values // Called when CBPeripheral .readValue(for: characteristic) is called from the central func peripheralManager(_ peripheral: CBPeripheralManager, didReceiveRead request: CBATTRequest) { print("\ndidReceiveRead request") if let uuid: CBUUID = self.characterisctic?.uuid, request.characteristic.uuid == uuid { print("Match characteristic for static reading") } } // Called when receiving writing from Central. func peripheralManager(_ peripheral: CBPeripheralManager, didReceiveWrite requests: [CBATTRequest]) { print("\ndidReceiveWrite requests") guard let characteristicCBUUID: CBUUID = self.characteristicCBUUID, let request: CBATTRequest = requests.filter({ $0.characteristic.uuid == characteristicCBUUID }).first, let value: Data = request.value else { return } // Send response to central if this writing request asks for response [.withResponse] print("Sending response: Success") self.peripheralManager?.respond(to: request, withResult: .success) print("Match characteristic for writing") do { if let receivedData: [String : String] = try PropertyListSerialization.propertyList(from: value, options: [], format: nil) as? [String: String] { print("Written value is: \(receivedData)") self.bluetoothMessaging?.didReceiveData() } else { return } } catch let error { print(error) } } func peripheralManager(_ peripheral: CBPeripheralManager, central: CBCentral, didUnsubscribeFrom characteristic: CBCharacteristic) { print("\ndidUnsubscribeFrom characteristic") } func peripheralManager(_ peripheral: CBPeripheralManager, willRestoreState dict: [String : Any]) { print("willRestoreState") } func peripheralManagerIsReady(toUpdateSubscribers peripheral: CBPeripheralManager) { print("peripheralManagerIsReady") } } ViewController import UIKit class ViewController: UIViewController { // MARK: - IBOutlet @IBOutlet var label: UILabel! // MARK: - Lifecyle override var preferredStatusBarStyle: UIStatusBarStyle { return .lightContent } // MARK: - Properties var manager: BluetoothManager? override func viewDidAppear(_ animated: Bool) { super.viewDidAppear(animated) self.manager = BluetoothManager(delegate: self) } } // MARK: - BlueEar extension ViewController: BlueEar { func didStartConfiguration() { self.label.text = "Start configuration üéõ" } func didStartAdvertising() { self.label.text = "Start advertising üìª" } func didSendData() { self.label.text = "Did send data ‚¨ÜÔ∏è" } func didReceiveData() { self.label.text = "Did received data ‚¨áÔ∏è" } } View Notas: No nosso exemplo, o Perif√©rico vai come√ßar a fazer propaganda quando iniciar o app. Voc√™ s√≥ pode fazer alguma coisa com o perif√©rico quando a fun√ß√£o peripheralManagerDidUpdateState(: CBPeripheralManager) for chamada e o estado do perif√©rico estiver .poweredOn. Leituras de valores din√¢micos pela Central usando a fun√ß√£o .setNotifyValue(true, for: characteristic) disparam a fun√ß√£o peripheralManager(_: CBPeripheralManager, : CBCentral, : CBCharacteristic) do perif√©rico, j√° leituras de valores est√°ticos usando a fun√ß√£o .readValue(for: characteristic) pela Central, disparam peripheralManager(_: CBPeripheralManager, :CBATTRequest) do perif√©rico. macOS BlueEar protocol BlueEar { func didStartConfiguration() func didStartScanningPeripherals() func didConnectPeripheral(name: String?) func didDisconnectPeripheral(name: String?) func didSendData() func didReceiveData() func didFailConnection() } BluetoothManager class BluetoothManager: NSObject { // MARK: - Properties let serviceUUID: String = "0cdbe648-eed0-11e6-bc64-92361f002671" let characteristicUUID: String = "199ab74c-eed0-11e6-bc64-92361f002672" var serviceCBUUID: CBUUID? var characteristicCBUUID: CBUUID? var blueEar: BlueEar? var centralManager: CBCentralManager? var discoveredPeripheral: CBPeripheral? // MARK: - Initializers convenience init (delegate: BlueEar) { self.init() self.blueEar = delegate guard let serviceUUID: UUID = NSUUID(uuidString: self.serviceUUID) as UUID?, let characteristicUUID: UUID = NSUUID(uuidString: self.characteristicUUID) as UUID? else { return } self.serviceCBUUID = CBUUID(nsuuid: serviceUUID) self.characteristicCBUUID = CBUUID(nsuuid: characteristicUUID) } // MARK: - Functions func scan() { self.centralManager = CBCentralManager(delegate: self, queue: nil, options: nil) self.blueEar?.didStartConfiguration() } } CBCentralManagerDelegate // MARK: - CBCentralManagerDelegate extension BluetoothManager: CBCentralManagerDelegate { func centralManagerDidUpdateState(_ central: CBCentralManager) { print("\ncentralManagerDidUpdateState \(Date())") if central.state == .poweredOn { guard let serviceCBUUID: CBUUID = self.serviceCBUUID else { return } self.blueEar?.didStartScanningPeripherals() self.centralManager?.scanForPeripherals(withServices: [serviceCBUUID], options: nil) } } func centralManager(_ central: CBCentralManager, didDiscover peripheral: CBPeripheral, advertisementData: [String : Any], rssi RSSI: NSNumber) { // We must keep a reference to the new discovered peripheral, which means we must retain it. self.discoveredPeripheral = peripheral print("\ndidDiscover:", self.discoveredPeripheral?.name ?? "") self.discoveredPeripheral?.delegate = self guard let discoveredPeripheral: CBPeripheral = self.discoveredPeripheral else { return } self.centralManager?.connect(discoveredPeripheral, options: nil) } func centralManager(_ central: CBCentralManager, didConnect peripheral: CBPeripheral) { print("\ndidConnect", self.discoveredPeripheral?.name ?? "") self.blueEar?.didConnectPeripheral(name: peripheral.name ?? "") guard let serviceCBUUID: CBUUID = self.serviceCBUUID else { return } self.discoveredPeripheral?.discoverServices([serviceCBUUID]) } func centralManager(_ central: CBCentralManager, willRestoreState dict: [String : Any]) { print("willRestoreState") } func centralManager(_ central: CBCentralManager, didRetrievePeripherals peripherals: [CBPeripheral]) { print("\ndidRetrievePeripherals") } func centralManager(_ central: CBCentralManager, didFailToConnect peripheral: CBPeripheral, error: Error?) { print("\ndidFailToConnect") self.blueEar?.didFailConnection() } func centralManager(_ central: CBCentralManager, didRetrieveConnectedPeripherals peripherals: [CBPeripheral]) { print("\ndidRetrieveConnectedPeripherals") } func centralManager(_ central: CBCentralManager, didDisconnectPeripheral peripheral: CBPeripheral, error: Error?) { print("\ndidDisconnectPeripheral", self.discoveredPeripheral?.name ?? "") self.blueEar?.didDisconnectPeripheral(name: peripheral.name ?? "") } } CBPeripheralDelegate // MARK: - CBPeripheralDelegate extension BluetoothManager: CBPeripheralDelegate { func peripheral(_ peripheral: CBPeripheral, didDiscoverServices error: Error?) { print("\ndidDiscoverServices") if let service: CBService = self.discoveredPeripheral?.services?.filter({ $0.uuid == self.serviceCBUUID }).first { guard let characteristicCBUUID: CBUUID = self.characteristicCBUUID else { return } self.discoveredPeripheral?.discoverCharacteristics([characteristicCBUUID], for: service) } } func peripheral(_ peripheral: CBPeripheral, didWriteValueFor characteristic: CBCharacteristic, error: Error?) { print("\ndidWriteValueFor \(Date())") // After we write data on peripheral, we disconnect it. self.centralManager?.cancelPeripheralConnection(peripheral) // We stop scanning. self.centralManager?.stopScan() } func peripheral(_ peripheral: CBPeripheral, didDiscoverCharacteristicsFor service: CBService, error: Error?) { print("\ndidDiscoverCharacteristicsFor") if let characteristic: CBCharacteristic = service.characteristics?.filter({ $0.uuid == self.characteristicCBUUID }).first { print("Matching characteristic") // To listen and read dynamic values self.discoveredPeripheral?.setNotifyValue(true, for: characteristic) // To read static values // self.discoveredPeripheral?.readValue(for: characteristic) } } func peripheral(_ peripheral: CBPeripheral, didUpdateValueFor characteristic: CBCharacteristic, error: Error?) { print("\ndidUpdateValueFor") // We read if let value: Data = characteristic.value { do { let receivedData: [String: String] = try PropertyListSerialization.propertyList(from: value, options: [], format: nil) as! [String: String] print("Value read is: \(receivedData)") self.blueEar?.didReceiveData() } catch let error { print(error) } } // We write do { print("\nWriting on peripheral.") let dict: [String: String] = ["Yo": "Lo"] let data: Data = try PropertyListSerialization.data(fromPropertyList: dict, format: .binary, options: 0) self.discoveredPeripheral?.writeValue(data, for: characteristic, type: .withResponse) self.blueEar?.didSendData() } catch let error { print(error) } } func peripheralDidUpdateRSSI(_ peripheral: CBPeripheral, error: Error?) { print("\nperipheralDidUpdateRSSI") print(self.discoveredPeripheral?.rssi ?? "") } func peripheralDidUpdateName(_ peripheral: CBPeripheral) { print("\nperipheralDidUpdateName") } func peripheral(_ peripheral: CBPeripheral, didWriteValueFor descriptor: CBDescriptor, error: Error?) { print("\ndidWriteValueFor") } func peripheral(_ peripheral: CBPeripheral, didModifyServices invalidatedServices: [CBService]) { print("\ndidModifyServices") } func peripheral(_ peripheral: CBPeripheral, didUpdateValueFor descriptor: CBDescriptor, error: Error?) { print("\ndidUpdateValueFor") } func peripheral(_ peripheral: CBPeripheral, didDiscoverIncludedServicesFor service: CBService, error: Error?) { print("\ndidDiscoverIncludedServicesFor") } func peripheral(_ peripheral: CBPeripheral, didDiscoverDescriptorsFor characteristic: CBCharacteristic, error: Error?) { print("\ndidDiscoverDescriptorsFor") } func peripheral(_ peripheral: CBPeripheral, didUpdateNotificationStateFor characteristic: CBCharacteristic, error: Error?) { print("\ndidUpdateNotificationStateFor") } } ViewController import Foundation import Cocoa class ViewController: NSViewController { // MARK: - IBOutlet @IBOutlet weak var label: NSTextField! @IBOutlet weak var button: NSButton! // MARK: - Properties var manager: BluetoothManager? // MARK: - Lifecyle @IBAction func discover(_ sender: Any) { self.manager = BluetoothManager(delegate: self) self.manager?.scan() } } // MARK: - BlueEar extension ViewController: BlueEar { func didStartConfiguration() { self.label.stringValue = "Start configuration üéõ" } func didStartScanningPeripherals() { self.label.stringValue = "Start scanning peripherals üëÄ" } func didConnectPeripheral(name: String?) { self.label.stringValue = "Did connect to: \(name ?? "") ü§úüèΩü§õüèΩ" } func didDisconnectPeripheral(name: String?) { self.label.stringValue = "Did disconnect: \(name ?? "") ü§úüèΩü§öüèΩ" } func didSendData() { self.label.stringValue = "Did send data ‚¨ÜÔ∏è" } func didReceiveData() { self.label.stringValue = "Did received data ‚¨áÔ∏è" } func didFailConnection() { self.label.stringValue = "Connection failed ü§∑üèΩ‚Äç‚ôÇÔ∏è" } } View Notas: No nosso exemplo, a Central vai come√ßar a escanear por perif√©ricos quando clicarmor num bot√£o chamado Tap. Voc√™ s√≥ pode fazer alguma coisa com a central quando a fun√ß√£o centralManagerDidUpdateState(: CBCentralManager) for chamada e o estado do perif√©rico estiver .poweredOn. Note que o CBPeripheralDelegate √© diferente do CBPeripheralManagerDelegate usado no perif√©rico. Ambos s√£o relacionados ao perif√©rico, por√©m o CBPeripheralDelegate permite que a central escute eventos sobre o perif√©rico. Ao optar por ler resultados din√¢micos, a central se inscreve em caracter√≠sticas do perif√©rico, assim sendo alertada por meio de notifica√ß√µes se o perif√©rico alterar seu valor no qual ela esteja inscrita. Quando a central descobre um perif√©rico, devemos manter uma refer√™ncia para ele, ou seja, devemos ret√™-lo fazendo com que uma vari√°vel dentro do nosso c√≥digo o receba. Os dados s√£o trasmitidos em formato de Data, ent√£o voc√™ deve transformar o que quer transmitir neste tipo de dados para poder ser recebido corretamente no outro lado. Resultado Na imagem, temos o respectivo: Log do perif√©rico, iOS, macOS, Log da central. Refer√™ncias CoreBlueetooth Agradecimentos Um agradecimento pra galera do Slack iOS Devs BR pela oportunidade. Um abra√ßo, e at√© pr√≥xima. Leo]]></summary></entry><entry><title type="html">Integra√ß√£o Cont√≠nua com Travis-CI</title><link href="http://localhost:4000/ios/2017/03/26/integracao-continua-com-travis-ci/" rel="alternate" type="text/html" title="Integra√ß√£o Cont√≠nua com Travis-CI" /><published>2017-03-26T09:00:00-03:00</published><updated>2017-03-26T09:00:00-03:00</updated><id>http://localhost:4000/ios/2017/03/26/integracao-continua-com-travis-ci</id><content type="html" xml:base="http://localhost:4000/ios/2017/03/26/integracao-continua-com-travis-ci/"><![CDATA[<h1 id="integra√ß√£o-cont√≠nua-com-travisci">Integra√ß√£o Cont√≠nua com Travis¬†CI</h1>
<p>Integra√ß√£o Cont√≠nua √©, em outras palavras, a pr√°tica que busca manter o ambiente de desenvolvimento em pleno funcionamento ap√≥s itera√ß√µes feitas pelos devs do projeto. Para que isso ocorra, √© necess√°rio que a cada altera√ß√£o no reposit√≥rio, alguns itens do projeto sejam verificados, como a gera√ß√£o da <em>build</em> e execu√ß√£o de testes, por exemplo.</p>

<p>Voc√™ pode ler um pouco mais sobre o assunto <a href="https://martinfowler.com/articles/continuousIntegration.html">aqui (conte√∫do em ingl√™s)</a>.</p>

<h1 id="travis-ci">Travis CI</h1>

<p>O Travis CI √© um servi√ßo dedicado exclusivamente √† integra√ß√£o cont√≠nua. Ele opera integrado ao GitHub, assim, algumas tarefas s√£o simplificadas, como a automa√ß√£o da obten√ß√£o do <em>source</em> do projeto. Devido √† integra√ß√£o, √© necess√°rio que seu projeto esteja hospedado no GitHub.</p>

<p>O uso do Travis para projetos <em>open source</em> √© gratuito üéâ (isso sem d√∫vida ajudou a populariz√°-lo). Para utiliz√°-lo em projetos privados voc√™ ter√° que desembolsar alguns d√≥lares, o valor mensal* vai de $69 no plano <em>Bootstrap</em> at√© $489 üí∏ na op√ß√£o <em>Premium</em>.</p>

<p>Para come√ßar a utilizar basta acessar <a href="https://travis-ci.org">travis-ci.org</a> para projetos <em>open source</em> ou <a href="https://travis-ci.com">travis-ci.com</a> para projetos privados. O processo de <em>sign-up</em> √© bastante simples.</p>

<p>* Informa√ß√µes de mar√ßo, 2017</p>

<h1 id="benef√≠cios">Benef√≠cios</h1>

<p>Entre os benef√≠cios do uso do Travis (ou qualquer outra solu√ß√£o de integra√ß√£o cont√≠nua) destaco a velocidade em que os problemas corriqueiros s√£o encontrados, afinal, quanto mais r√°pido descobrirmos alguma adversidade, menor a chance de uma dor de cabe√ßa das grandes.¬†</p>

<p>Outro ponto interessante √© a integra√ß√£o realizada pelo Travis com o GitHub, onde a cada <em>commit</em> ou <em>pull request</em>, o Travis executa seu <em>job</em> e marca visualmente se o ambiente foi comprometido ou n√£o. Al√©m tamb√©m da gera√ß√£o dos tradicionais <em>badges</em> informando o <em>status</em> do projeto.</p>

<p><img src="/img/serralvo/commits-travis.png" alt="" /></p>

<p><em>Marca√ß√£o visual do status da build</em></p>

<h1 id="hora-doshow">Hora do¬†Show</h1>

<p>Para exemplificar o funcionamento do Travis criei um projeto para iOS em Swift 3. Nele, adicionei uma depend√™ncia que servir√° para demonstrar como obter as bibliotecas ou frameworks do projeto.</p>

<p>Esse projeto gerou tr√™s √≠tens para explorarmos:¬†</p>

<ul>
  <li>Ser√° necess√°rio gerenciar as depend√™ncias do projeto‚Ää‚Äî‚Ää sim, √© isso que voc√™ est√° pensando: CocoaPods.</li>
  <li>Execu√ß√£o da <em>build</em>.</li>
  <li>Por fim, notificaremos o time sobre o <em>status</em> do projeto.</li>
</ul>

<h1 id="arquivotravisyml">Arquivo¬†.travis.yml</h1>

<p>Para que essas tarefas listadas acima funcionem, n√≥s precisaremos criar um arquivo que fornecer√° instru√ß√µes para o Travis. A√≠ √© que entra o¬†<code class="language-plaintext highlighter-rouge">.travis.yml</code>.</p>

<p>Antes de come√ßarmos a escrever o arquivo de configura√ß√£o, precisamos entender como funciona o ciclo de vida do processo de <em>build</em> do Travis:</p>

<p>O Travis divide a execu√ß√£o do <em>job</em> em duas etapas, a primeira delas √© respons√°vel pela atualiza√ß√£o das depend√™ncias, seja do projeto, ou do ambiente. A segunda etapa √© voltada para a execu√ß√£o da <em>build</em> e outras tarefas relacionadas, como <em>tests</em>, <em>reports</em> e <em>deploy</em>. Nessas etapas podemos detectar eventos do ciclo de vida e incluir a√ß√µes de acordo com a necessidade do projeto.</p>

<p>Para come√ßarmos, o primeiro passo √© realizar o cadastro no Travis. Para reposit√≥rios p√∫blicos ou privados, o funcionamento ser√° o mesmo.</p>

<p><img src="/img/serralvo/travis-ci-org.png" alt="" /></p>

<p>O pr√≥ximo passo √© ‚Äúativar‚Äù o Travis para o reposit√≥rio desejado. Feito isso, no pr√≥ximo <em>commit</em> ou <em>pull request</em>, o <em>job</em> ser√° executado.</p>

<p><img src="/img/serralvo/start-travis.png" alt="" /></p>

<p>Ap√≥s o cadastro chegou a hora de criar o arquivo¬†<em>.travis.yml</em> na raiz do reposit√≥rio. Feito isso, vamos incluir duas linhas: A primeira √© usada para definir a linguagem do projeto (que √© um valor obrigat√≥rio). No caso adicionaremos <code class="language-plaintext highlighter-rouge">objective-c</code>. A segunda representa a imagem que ser√° usada para fazer a build do projeto, no caso, adicionaremos <code class="language-plaintext highlighter-rouge">xcode8.1</code>. Veja abaixo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>language: objective-c
osx_image: xcode8.1
</code></pre></div></div>

<p>Agora voc√™ pode estar assim: ü§î</p>

<p>U√©, <code class="language-plaintext highlighter-rouge">objective-c</code>?! Mas o projeto n√£o est√° escrito em Swift? Sim, isso mesmo, at√© o momento o Travis utiliza o valor <code class="language-plaintext highlighter-rouge">objective-c</code> para Swift e tamb√©m para Objective-C.</p>

<h2 id="baixando-as-depend√™ncias">Baixando as depend√™ncias</h2>

<p>Se voc√™ j√° usou CocoaPods ao menos uma vez, sabe que basta executar <code class="language-plaintext highlighter-rouge">pod install</code> para obter as depend√™ncias do projeto. No ambiente do Travis isso √© um pouco diferente: se o <code class="language-plaintext highlighter-rouge">Podfile</code> estiver na raiz do projeto, o Travis far√° o <em>fetch</em> automaticamente, caso contr√°rio, basta indicar no <code class="language-plaintext highlighter-rouge">.travis.yml</code> qual o local de tal arquivo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podfile: path/to/Podfile
</code></pre></div></div>

<p>Se o seu projeto usa outro gerenciador de depend√™ncias, √© poss√≠vel fazer <em>override</em> da etapa de <code class="language-plaintext highlighter-rouge">install</code> para realizar a instala√ß√£o de acordo com sua necessidade:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install: sh dependencies.sh
</code></pre></div></div>

<h2 id="build-e-sucesso">Build e Sucesso</h2>

<p>Ap√≥s obter as depend√™ncias do projeto, basta apenas configurar alguns par√¢metros para a execu√ß√£o da <em>build</em>. Esses par√¢metros envolvem alguns √≠tens necess√°rios para continuar o processo. S√£o eles:</p>

<ul>
  <li><em>Path</em> do <code class="language-plaintext highlighter-rouge">xcworkspace</code> ou <code class="language-plaintext highlighter-rouge">xcproject</code>.</li>
  <li>Algum <em>scheme</em> com a op√ß√£o <em>shared</em> ativada (<a href="http://help.apple.com/xcode/mac/8.0/#/dev5426ddfcf">saiba mais aqui</a>).</li>
  <li>SDK que ser√° usado (no caso estamos usando <code class="language-plaintext highlighter-rouge">iphonesimulator</code>).</li>
</ul>

<p>Conhecendo tais par√¢metros √© hora de realizar a <em>build</em> do projeto, para isso, vamos adicionar na etapa <code class="language-plaintext highlighter-rouge">script</code> a chamada do <code class="language-plaintext highlighter-rouge">xcodebuild</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script:
  - xcodebuild -workspace DemoTravisCI.xcworkspace -scheme 'DemoTravisCI' -sdk iphonesimulator build
</code></pre></div></div>

<p>Sendo assim, no momento o arquivo <code class="language-plaintext highlighter-rouge">.travis.yml</code> possui o seguinte conte√∫do:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>language: objective-c
osx_image: xcode8.1

script:
  - xcodebuild -workspace DemoTravisCI.xcworkspace  -scheme DemoTravisCI -sdk iphonesimulator build
</code></pre></div></div>

<h2 id="notifica√ß√µes">Notifica√ß√µes</h2>

<p>Para detectar poss√≠veis problemas com o projeto, √© interessante compartilhar o status da <em>build</em> com o time a cada itera√ß√£o. O Travis prov√™ diversas op√ß√µes para notifica√ß√µes, come√ßando pelo envio de e-mails e abrindo um leque de possibilidades gra√ßas √†s integra√ß√µes. No nosso caso, vamos ser avisados via Slack üì¢.</p>

<p>Para isso, o primeiro passo √© adicionar uma <a href="https://my.slack.com/services/new/travis">nova integra√ß√£o ao Slack</a>. Ap√≥s selecionar o time e as demais op√ß√µes, na pr√≥pria p√°gina do Slack voc√™ encontrar√° o conte√∫do que deve ser adicionado ao seu arquivo de configura√ß√£o.</p>

<p>Conclu√≠do tal passo, vamos incluir a chave <code class="language-plaintext highlighter-rouge">notifications</code> no arquivo <code class="language-plaintext highlighter-rouge">.travis.yml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>notifications:
  slack: yourteam:G1P621hDDwEH3pXeCcJpck8i
</code></pre></div></div>

<p>Importante: Caso seu projeto seja aberto, √© recomendado criptografar a chave. Esse √© um processo bastante simples e voc√™ pode saber mais <a href="https://docs.travis-ci.com/user/encryption-keys/">aqui</a>.</p>

<h1 id="considera√ß√µes-finais">Considera√ß√µes Finais</h1>

<p>Ferramentas de integra√ß√£o cont√≠nua s√£o realidade no mercado e fazem parte da rotina de qualquer grande projeto de software. Algumas demandam maior esfor√ßo para que sejam configuradas (principalmente ferramentas <em>self-hosted</em>), outras n√£o, como √© o caso do Travis, onde basta um arquivo de marca√ß√£o para que a m√°gica aconte√ßa.</p>

<p>Se voc√™ se interessou pelo assunto e deseja implantar tal processo em seus projetos, e por alguma limita√ß√£o n√£o ir√° conseguir utilizar o Travis, saiba que existem diversas op√ß√µes, como Jenkins, Xcode Server, CircleCI, entre outras.</p>

<p>Para finalizar, Integra√ß√£o Cont√≠nua √© um dos pilares do desenvolvimento √°gil, e podemos considerar que tamb√©m √© um passo para a Entrega Cont√≠nua, mas isso √© assunto para outro artigo üôÉ.</p>

<p>Um obrigado especial ao <a href="https://github.com/rogerluan">Roger Oba</a> e tamb√©m ao <a href="https://github.com/ciceroduarte">C√≠cero Duarte</a>.</p>

<h3 id="referencias">Referencias:</h3>

<ul>
  <li><a href="https://unsplash.com/photos/zlABb6Gke24">Imagem da Capa - Relax by Clem Onojeghuo</a></li>
  <li><a href="https://docs.travis-ci.com/user/getting-started/">Getting started</a></li>
  <li><a href="https://docs.travis-ci.com/user/languages/objective-c/">Building an Objective-C Project</a></li>
  <li><a href="https://docs.travis-ci.com/user/notifications/">Notifications</a></li>
</ul>]]></content><author><name>Fabricio Serralvo</name></author><category term="ios" /><summary type="html"><![CDATA[Integra√ß√£o Cont√≠nua com Travis¬†CI Integra√ß√£o Cont√≠nua √©, em outras palavras, a pr√°tica que busca manter o ambiente de desenvolvimento em pleno funcionamento ap√≥s itera√ß√µes feitas pelos devs do projeto. Para que isso ocorra, √© necess√°rio que a cada altera√ß√£o no reposit√≥rio, alguns itens do projeto sejam verificados, como a gera√ß√£o da build e execu√ß√£o de testes, por exemplo.]]></summary></entry><entry><title type="html">Gerenciando subscriptions com In-App Purchases</title><link href="http://localhost:4000/subscription/2017/03/25/Gerenciando-subscriptions-com-In-App-Purchases/" rel="alternate" type="text/html" title="Gerenciando subscriptions com In-App Purchases" /><published>2017-03-25T06:00:00-03:00</published><updated>2017-03-25T06:00:00-03:00</updated><id>http://localhost:4000/subscription/2017/03/25/Gerenciando-subscriptions-com-In-App-Purchases</id><content type="html" xml:base="http://localhost:4000/subscription/2017/03/25/Gerenciando-subscriptions-com-In-App-Purchases/"><![CDATA[<blockquote>
  <p>Renan Protector (<a href="https://twitter.com/reprotector" target="_blank">@reprotector</a>) √© desenvolvedor iOS desde 2009. Atualmente Indie Dev, √© Co-Founder do (<a href="https://getblogo.com" target="_blank">Blogo</a>) e do (<a href="https://spacecoworking.com" target="_blank">Space Coworking</a>).</p>
</blockquote>

<p>Em Junho de 2016 a Apple modificou sua pol√≠tica de subscriptions na App Store, permitindo que v√°rias categorias de aplicativos possam utilizar esse modelo de neg√≥cios. A assinatura funciona como um In-App Purchase e toda a parte de pagamento √© feito pela pr√≥pria App Store. O foco desse artigo est√° na gest√£o das assinaturas, por isso n√£o falaremos como implementar IAP (In-App Purchase) dentro do seu aplicativo. <a href="https://developer.apple.com/in-app-purchase/" target="_blank">Clique Aqui</a> para saber mais sobre IAP.</p>

<p>Iremos falar sobre duas possibilidades: <strong>Assinatura apenas no app</strong> e <strong>Assinatura em v√°rios ambientes</strong></p>

<h2 id="apenas-em-1-app">Apenas em 1 App</h2>
<p>Quando a assinatura √© apenas para um √∫nico app iOS, n√£o √© preciso fazer muita coisa. O pr√≥prio app deve gerenciar a assinatura do usu√°rio. Ap√≥s completar a compra do IAP, o m√©todo <code class="language-plaintext highlighter-rouge">- (void)completeTransaction:(SKPaymentTransaction *)transaction</code> ser√° chamado e a partir da√≠ as funcionalidades j√° podem ser liberadas para o usu√°rio.</p>

<p>Para verificar se o usu√°rio √© assinante e se a assinatura est√° em dia, basta verificar o receipt<a href="#what_is_receipt">*</a> do aplicativo. Recomendo a utiliza√ß√£o do <a href="https://github.com/rmaddy/VerifyStoreReceiptiOS" target="_blank">VerifyStoreReceiptiOS</a>, pois facilita muito a leitura dos campos do receipt dentro do aplicativo.</p>

<p>Para saber como validar um receipt, veja o item: <a href="#validate_receipt">O que verificar nesse receipt?</a></p>

<h2 id="m√∫ltiplos-apps-e-web">M√∫ltiplos apps e Web</h2>

<p>Quando a assinatura vai ser usada em v√°rios ambientes, √© necess√°rio que voc√™ sincronize os dados da App Store. Voc√™ precisar√° de um servi√ßo web para gerenciar as assinaturas e valid√°-las. Isso significa que seu aplicativo precisar√° de login para identificar seus usu√°rios e suas respectivas assinaturas.</p>

<h3 id="chega-de-papo-como-fa√ßo-isso-no-meu-app">Chega de papo, como fa√ßo isso no meu app?</h3>

<p>Ao finalizar a compra do IAP, o seguinte m√©todo ser√° chamado: <code class="language-plaintext highlighter-rouge">- (void)completeTransaction:(SKPaymentTransaction *)transaction</code>.</p>

<p>Nesse momento, o receipt do seu app j√° estar√° atualizado com os dados de compra do IAP e voc√™ dever√° envi√°-lo para sua API. Sua API deve validar os dados junto √† App Store para se certificar que o receipt √© verdadeiro e original. Para saber mais sobre a valida√ß√£o do receipt na App Store, <a href="https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html#//apple_ref/doc/uid/TP40010573-CH104-SW1" target="_blank">clique aqui.</a></p>

<p>Em Ruby, a valida√ß√£o pode ser feito com o c√≥digo abaixo, n√£o esque√ßa de adicionar seu Token no request:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">def</span> <span class="nf">validate_receipt_remote</span><span class="p">(</span><span class="n">receipt_base64</span><span class="p">)</span>  
	  <span class="n">receipt_base64</span><span class="p">.</span><span class="nf">gsub!</span> <span class="s1">' '</span><span class="p">,</span> <span class="s1">'+'</span>
	  <span class="n">params_json</span> <span class="o">=</span> <span class="s2">"{ </span><span class="se">\"</span><span class="s2">receipt-data</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">"</span><span class="o">+</span><span class="n">receipt_base64</span><span class="o">+</span><span class="s2">"</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">password</span><span class="se">\"</span><span class="s2">: </span><span class="se">\‚Äù</span><span class="s2">SEU TOKEN AQUI</span><span class="se">\‚Äù</span><span class="s2">}‚Äù
	  uri = URI("</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">buy</span><span class="p">.</span><span class="nf">itunes</span><span class="p">.</span><span class="nf">apple</span><span class="p">.</span><span class="nf">com</span><span class="s2">") # Use "</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">buy</span><span class="p">.</span><span class="nf">itunes</span><span class="p">.</span><span class="nf">apple</span><span class="p">.</span><span class="nf">com</span><span class="s2">" for production
	  Net::HTTP.start(uri.host, uri.port, :use_ssl =&gt; uri.scheme == 'https') do |http|
	    response = http.post('/verifyReceipt', params_json)	    
	    return JSON.parse(response.body)
	  end
	end
</span></code></pre></div></div>

<p>Um exemplo de resposta dessa requisi√ß√£o (mantive apenas os campos que considero importante):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ 
¬†¬†¬†"status"¬†¬†¬†=&gt;0,
¬†¬†¬†"environment"¬†¬†¬†=&gt;"Production",
¬†¬†¬†"receipt"¬†¬†¬†=&gt;¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†"receipt_type"¬†¬†¬†¬†¬†¬†=&gt;"Production",
¬†¬†¬†¬†¬†¬†"app_item_id"¬†¬†¬†¬†¬†¬†=&gt;977160124,
¬†¬†¬†¬†¬†¬†"bundle_id"¬†¬†¬†¬†¬†¬†=&gt;"com.Blogo.ios",
¬†¬†¬†¬†¬†¬†"application_version"¬†¬†¬†¬†¬†¬†=&gt;"251",
¬†¬†¬†¬†¬†¬†"receipt_creation_date"¬†¬†¬†¬†¬†¬†=&gt;"2017-03-12¬†11:22:41¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†"request_date"¬†¬†¬†¬†¬†¬†=&gt;"2017-03-24¬†17:22:53¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†03:54:25¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†"original_application_version"¬†¬†¬†¬†¬†¬†=&gt;"215",
¬†¬†¬†¬†¬†¬†"in_app"¬†¬†¬†¬†¬†¬†=&gt;¬†¬†¬†¬†¬†¬†[ ¬†¬†¬†¬†¬†¬†¬†¬†¬†
¬†¬†¬†¬†¬†¬†¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"product_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"com.blogo.pro.ios.month",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:24¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"expires_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-11-16¬†06:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†"is_trial_period"¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"true"
¬†¬†¬†¬†¬†¬†¬†¬†¬†}
¬†¬†¬†¬†¬†¬†]
¬†¬†¬†},
¬†¬†¬†"latest_receipt_info"¬†¬†¬†=&gt;¬†¬†¬†[ 
¬†¬†¬†¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†¬†¬†¬†"product_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"com.blogo.pro.ios.month",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:24¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"expires_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-11-16¬†06:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"is_trial_period"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"true"
¬†¬†¬†¬†¬†¬†}
¬†¬†¬†],
¬†¬†¬†"latest_receipt"¬†¬†¬†=&gt;"MIIXOwYJKoZIhvcNAQc‚Ä¶.‚Äù
}
</code></pre></div></div>

<h3 id="o-que-verificar-nesse-receipt"><a name="validate_receipt"></a>O que verificar nesse receipt?</h3>

<p>A primeira coisa que deve ser verificada √© se os campos <code class="language-plaintext highlighter-rouge">bundle_id</code> e <code class="language-plaintext highlighter-rouge">app_item_id</code> conferem com o do seu aplicativo.</p>

<p>Nos dados do IAP, voc√™ deve validar a data de expira√ß√£o e deve atrelar o <code class="language-plaintext highlighter-rouge">transaction_id</code> da assinatura com o usu√°rio. O <code class="language-plaintext highlighter-rouge">transaction_id</code> deve ser um dado √∫nico por assinatura, por usu√°rio. Por que isso? Se n√£o for salvo dessa forma, o usu√°rio pode dar logout no aplicativo, logar com outro usu√°rio e assinar o IAP novamente. Como j√° est√° pago na App Store, a Apple vai retornar para o m√©todo <code class="language-plaintext highlighter-rouge">completeTransaction</code> como se a transa√ß√£o tivesse sido bem sucedida. Isso √© <strong>MUITO IMPORTANTE</strong> para evitar fraudes no seu app.</p>

<p><strong>Importante!</strong> Sempre use os dados do <code class="language-plaintext highlighter-rouge">latest_receipt_info</code>. O receipt √© um arquivo local e os dados do <code class="language-plaintext highlighter-rouge">latest_receipt_info</code> s√£o os √∫ltimos dados encontrados no servi√ßo da Apple.</p>

<p>Depois de validado, voc√™ deve guardar o arquivo de receipt na sua nuvem. Ele ser√° usado para verificar se o usu√°rio renovou a assinatura.</p>

<h3 id="como-sei-se-o-usu√°rio-√©-um-assinante">Como sei se o usu√°rio √© um assinante?</h3>

<p>Seu app deve se comunicar com sua base de dados online, perguntando se ele √© um assinante ou n√£o. Lembre-se que o usu√°rio pode ter assinado em outro dispositivo, veja qual √© o momento ideal para perguntar pro seu servidor se ele est√° ativo ou n√£o. Em meus apps iOS, costumo verificar logo na abertura do app ou logo que o dispositivo tenha acesso a internet, caso estivesse sem interent no momento da abertura. Tamb√©m costumo verificar novamente antes de entrar no processo de assinatura.</p>

<h3 id="√≥timo-j√°-sei-que-o-usu√°rio-assinou-meu-iap-e-quando-acabar-o-per√≠odo-como-sei-que-ele-renovou">√ìtimo, j√° sei que o usu√°rio assinou meu IAP. E quando acabar o per√≠odo, como sei que ele renovou?</h3>

<p>As assinaturas s√£o renovadas 1 dia antes delas expirarem, mas pode ocorrer problemas no pagamento e o processo de renova√ß√£o pode levar mais tempo. Minha experi√™ncia mostra que assinaturas podem ser renovadas automaticamente at√© 1 dia depois dela expirar. Portanto, n√£o bloqueie as funcionalidades da assinatura assim que ela expirar. Espere pelo menos 1 dia pra ter certeza que ela n√£o foi renovada.</p>

<p>Para verificar se a assinatura foi renovada ou n√£o, devemos pegar o receipt que foi salvo no momento da assinatura e fazer o mesmo processo de valida√ß√£o. Fa√ßa a valida√ß√£o do receipt pelo link da Apple e verifique o <code class="language-plaintext highlighter-rouge">latest_receipt_info</code>.  Caso a assinatura tenha sido renovada, um novo item de IAP ter√° sido criado. Basta, ent√£o, adicionar o novo transaction_id no seu banco de dados e liberar o uso das funcionalidades no seu aplicativo.</p>

<p>Abaixo um exemplo de um receipt com assinaturas renovadas. Repare que o usu√°rio entrou em trial no dia 16/10/16, renovou automaticamente a assinatura em 16/11/16 e n√£o renovou no per√≠odo de Janeiro a Mar√ßo. Em 12/03/17 o usu√°rio se inscreveu novamente em uma assinatura.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"latest_receipt_info"¬†¬†¬†=&gt;¬†¬†¬†[ 
¬†¬†¬†¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†¬†¬†¬†"product_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"com.blogo.pro.ios.month",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:24¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"expires_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-11-16¬†06:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"is_trial_period"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"true"
¬†¬†¬†¬†¬†¬†},
¬†¬†¬†¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†¬†¬†¬†"product_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"com.blogo.pro.ios.month",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000269815092",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-11-16¬†06:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:24¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"expires_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-12-16¬†06:45:23¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"is_trial_period"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"false"
¬†¬†¬†¬†¬†¬†},
¬†¬†¬†¬†¬†¬†{ 
¬†¬†¬†¬†¬†¬†¬†¬†¬†"product_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"com.blogo.pro.ios.month",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000303300763",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_transaction_id"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"120000262038036",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2017-03-12¬†11:22:40¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"original_purchase_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2016-10-16¬†05:45:24¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"expires_date"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"2017-04-12¬†11:22:40¬†¬†¬†¬†¬†¬†¬†¬†¬†Etc/GMT",
¬†¬†¬†¬†¬†¬†¬†¬†¬†"is_trial_period"¬†¬†¬†¬†¬†¬†¬†¬†¬†=&gt;"false"
¬†¬†¬†¬†¬†¬†}
¬†¬†¬†]
</code></pre></div></div>

<h2 id="conclus√£o">Conclus√£o</h2>

<p>A gest√£o de subscriptions com a App Store n√£o √© t√£o complicada quanto parece ser. Quando a assinatura √© pra apenas um app, n√£o √© preciso fazer muitas coisa e o processo de valida√ß√£o √© bem simples. J√° para m√∫ltiplos ambientes, a documenta√ß√£o da Apple n√£o √© muito clara sobre como verificar se um usu√°rio renovou a assinatura ou n√£o. Esse artigo tenta ajudar a desvendar o mist√©rio do <code class="language-plaintext highlighter-rouge">latest_receipt_info</code> que n√£o √© muito claro na documenta√ß√£o da Apple. D√∫vidas e sugest√µes podem ser colocadas no Slack iOSDevBr, n√£o deixe de entrar l√°!</p>

<h4 id="notas-de-rodap√©">Notas de Rodap√©:</h4>

<p><a name="what_is_receipt"></a>
<strong>Receipt</strong>: Todo aplicativo, seja ele pago ou gratuito, possui um ‚Äúrecibo de compra‚Äù embutido. Esse arquivo cont√©m dados importantes que devem ser usados para evitar fraudes. <a href="https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1" target="_blank">Clique aqui</a> para saber mais sobre os campos de um receipt.</p>]]></content><author><name>Renan Protector</name></author><category term="subscription" /><summary type="html"><![CDATA[Renan Protector (@reprotector) √© desenvolvedor iOS desde 2009. Atualmente Indie Dev, √© Co-Founder do (Blogo) e do (Space Coworking).]]></summary></entry><entry><title type="html">Sincroniza√ß√£o de dados com CloudKit</title><link href="http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/" rel="alternate" type="text/html" title="Sincroniza√ß√£o de dados com CloudKit" /><published>2017-03-24T09:00:00-03:00</published><updated>2017-03-24T09:00:00-03:00</updated><id>http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit</id><content type="html" xml:base="http://localhost:4000/cloudkit/2017/03/24/Sincronizacao-de-dados-com-CloudKit/"><![CDATA[<blockquote>
  <p>Guilherme Rambo (<a href="https://twitter.com/_inside" target="_blank">@_inside</a>) √© desenvolvedor iOS na <a href="https://peixeurbano.com" target="_blank">Peixe Urbano</a>, criador do <a href="https://getbrowserfreedom.com">BrowserFreedom</a>, <a href="https://itunes.apple.com/app/chibistudio/id1135307199">ChibiStudio</a> e criador de diversos projetos open-source, incluindo o <a href="https://github.com/insidegui/WWDC">app da WWDC para macOS</a>.</p>
</blockquote>

<p>O CloudKit foi lan√ßado pela Apple em 2014 e desde ent√£o recebeu diversas melhorias, como a possibilidade de utiliz√°-lo fora das plataformas da Apple, a libera√ß√£o do seu uso em apps fora da App Store no macOS e a disponibilidade do framework no watchOS, completando o c√≠rculo de plataformas da Apple suportadas.</p>

<p>Acredito que a tecnologia ainda n√£o esteja sendo explorada em todo o seu potencial pelos desenvolvedores nas plataformas da Apple, seja por medo ou desconhecimento. Pretendo ajudar a mudar isso com este artigo.</p>

<h1 id="posso-usar-cloudkit">Posso usar CloudKit?</h1>

<p>Infelizmente, a primeira pergunta que todos se fazem quando juntamos as palavras ‚ÄúApple‚Äù e ‚Äúnuvem‚Äù na mesma frase √©: ‚Äúd√° pra usar sem medo?‚Äù. De fato, a Apple n√£o tem um hist√≥rico muito bom quando o assunto √© servi√ßos na nuvem, desde <a href="http://gizmodo.com/5033442/steve-jobss-entire-mobileme-is-fail-email">o fiasco do Mobile.me</a> at√© <a href="http://www.imore.com/debug-12-icloud-core-data-sync">o problema do iCloud Core Data</a>.</p>

<p>A boa not√≠cia √© que em se tratando de CloudKit, a coisa √© bem diferente. Eu arrisco afirmar que talvez seja a tecnologia da Apple na nuvem mais confi√°vel de todas. Mas como eu sei que apenas minhas palavras n√£o ser√£o o suficiente para convenc√™-lo de que uma tecnologia da Apple na nuvem √© confi√°vel, vou deixar que voc√™ mesmo decida. Se voc√™ usa o aplicativo Notas da Apple, saiba que ele usa CloudKit. Outros exemplos de uso do CloudKit pela pr√≥pria Apple s√£o o compartilhamento de atividades no Apple Watch, o app Fotos e o iCloud Drive.</p>

<p>Se os apps citados acima funcionam bem pra voc√™, ent√£o pode ficar tranquilo e usar o CloudKit sem medo. Se eles n√£o funcionam bem pra voc√™, eu n√£o vou conseguir convenc√™-lo de que a tecnologia √© confi√°vel üòÖ</p>

<p>Um detalhe importante a ser colocado √© que a confiabilidade do CloudKit tamb√©m depende muito da implementa√ß√£o. Como a API n√£o automatiza muita coisa, cabe a cada desenvolvedor us√°-la da melhor maneira para criar uma experi√™ncia agrad√°vel e confi√°vel ao usu√°rio, o que nos leva ao pr√≥ximo ponto:</p>

<h1 id="devo-usar-cloudkit">Devo usar CloudKit?</h1>

<p>Mesmo que voc√™ esteja convencido de que pode usar o CloudKit sem medo, isso n√£o significa que voc√™ deva us√°-lo, afinal existem aplica√ß√µes para as quais ele √© mais indicado e outras para as quais existem ferramentas melhores, n√£o estamos falando aqui de uma bala de prata.</p>

<h2 id="onde-usar-cloudkit">Onde usar CloudKit</h2>

<p>Estas s√£o as situa√ß√µes para as quais o CloudKit √© altamente indicado:</p>

<h3 id="sincronizar-dados-privados-dos-usu√°rios-entre-v√°rios-dispositivos">Sincronizar dados privados dos usu√°rios entre v√°rios dispositivos</h3>

<p>Este talvez seja o uso mais √≥bvio, que √© a sincroniza√ß√£o dos dados privados de um usu√°rio entre os v√°rios dispositivos daquele usu√°rio.</p>

<p><strong>Exemplo:</strong> um aplicativo de notas ou todo list onde o usu√°rio pode criar e ler notas em qualquer dispositivo que possua associado √† sua conta do iCloud (Mac, iPhone, iPad, Apple Watch, etc) ou at√© mesmo numa interface web.</p>

<p><em>Alternativas: Realm Mobile Platform, Firebase, iCloud KVS ou iCloud Documents (dependendo do caso)</em></p>

<h3 id="armazenar-configura√ß√µes-remotas-do-aplicativo">Armazenar configura√ß√µes remotas do aplicativo</h3>

<p>Utilizando o banco de dados p√∫blico do seu container √© poss√≠vel armazenar dados que s√£o compartilhados por todas as inst√¢ncias do seu app, por todos os usu√°rios, mesmo que n√£o estejam autenticados com uma conta do iCloud.</p>

<p><strong>Exemplo:</strong> um aplicativo que em √©pocas festivas (Carnaval, Natal, etc) muda as cores do seu tema poderia armazenar os c√≥digos das cores no banco de dados p√∫blico do CloudKit. Desta maneira, as cores poderiam ser alteradas remotamente sem a necessidade de um servidor pr√≥prio ou atualiza√ß√£o do app.</p>

<p><em>Alternativas: Realm Mobile Platform, Firebase ou servidor pr√≥prio</em></p>

<h3 id="sincronizar-dados-entre-v√°rios-apps-do-mesmo-desenvolvedor">Sincronizar dados entre v√°rios apps do mesmo desenvolvedor</h3>

<p>Se voc√™ tem uma fam√≠lia de apps e quer que os dados dos seus usu√°rios sejam acess√≠veis em todos os seus apps, √© poss√≠vel utilizar um container compartilhado entre todos os apps desta fam√≠lia de modo que os usu√°rios tenham acesso aos mesmos dados em todos os apps. Isto tamb√©m se aplica a configura√ß√µes (item acima), poderiam ser compartilhadas por todos os apps que utilizam o mesmo container.</p>

<p><em>Alternativas: servidor pr√≥prio (devem existir outros servi√ßos que suportem isto, mas n√£o tenho conhecimento para indicar algum)</em></p>

<h3 id="utilizar-a-conta-do-icloud-do-usu√°rio-como-forma-de-autentica√ß√£o">Utilizar a conta do iCloud do usu√°rio como forma de autentica√ß√£o</h3>

<p>Voc√™ pode utilizar a conta do iCloud do usu√°rio apenas como meio de autentica√ß√£o para algum outro app ou servi√ßo</p>

<h3 id="enviar-notifica√ß√µes">Enviar notifica√ß√µes</h3>

<p>Sim, √© poss√≠vel enviar notifica√ß√µes usando o CloudKit, eliminando a necessidade de utilizar um servi√ßo terceirizado ou um servidor pr√≥prio para este fim.</p>

<p><em>Alternativas: Firebase ou servidor pr√≥prio</em></p>

<h2 id="onde-n√£o-usar-cloudkit">Onde N√ÉO usar CloudKit</h2>

<p>Agora que j√° vimos alguns exemplos de onde o CloudKit √© extremamente indicado, vamos a dois exemplos de onde ele √© altamente contra-indicado:</p>

<h3 id="n√£o-armazenamento-e-sincroniza√ß√£o-de-documentos">N√ÉO: Armazenamento e sincroniza√ß√£o de documentos</h3>

<p>Se o seu app trabalha primariamente com documentos, o CloudKit n√£o √© a ferramenta mais indicada para armazenamento e sincroniza√ß√£o dos mesmos. Neste caso o ideal seria usar iCloud Drive, Dropbox ou outros servi√ßos similares. √â poss√≠vel armazenar arquivos grandes como fotos e v√≠deos no CloudKit, mas ele pode n√£o ser a melhor solu√ß√£o se a fun√ß√£o principal do seu app √© lidar com documentos.</p>

<p><strong>Exemplo:</strong> editores de texto estilo Pages, editores de imagens estilo Pixelmator, Sketch, etc</p>

<h3 id="n√£o-sincroniza√ß√£o-de-prefer√™ncias-do-usu√°rio">N√ÉO: Sincroniza√ß√£o de prefer√™ncias do usu√°rio</h3>

<p>Para armazenar simples prefer√™ncias do usu√°rio ou quantidades muito pequenas de informa√ß√£o, utilize <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/iCloudDesignGuide/Chapters/DesigningForKey-ValueDataIniCloud.html">iCloud KVS</a> (<code class="language-plaintext highlighter-rouge">NSUbiquitousKeyValueStore</code>).</p>

<p><strong>Exemplo:</strong> seu app tem uma op√ß√£o para mostrar ou esconder uma barra de ferramentas e voc√™ quer que esta configura√ß√£o seja propagada para todos os dispositivos do usu√°rio</p>

<h2 id="por-que-n√£o-usar-alguma-alternativa">Por que n√£o usar alguma alternativa?</h2>

<p>O CloudKit √© uma tecnologia da pr√≥pria Apple que j√° vem instalada em todos os dispositivos, n√£o requer uma autentica√ß√£o al√©m da conta do iCloud que os usu√°rios j√° possuem, tem funcionalidades muito poderosas e tem uma grande chance de continuar existindo por um bom tempo. Estes s√£o os principais motivos que me fazem preferir o CloudKit em vez de solu√ß√µes de terceiros.</p>

<h1 id="quanto-custa">Quanto custa?</h1>

<p><img src="/img/insidegui/cloudkit/free-with-limits.gif" /></p>

<p>Esta √© uma d√∫vida comum quando estamos falando de servi√ßos de sincroniza√ß√£o e com o CloudKit n√£o √© diferente. Esta quest√£o do pre√ßo √© comumente confundida pelos desenvolvedores, ent√£o vou explicar aqui da forma mais simples poss√≠vel.</p>

<p><a href="https://www.youtube.com/watch?v=w87fOAG8fjk&amp;t=1h36m36s">Como disse Craig Federighi na introdu√ß√£o do CloudKit</a>:</p>

<blockquote>
  <p>O CloudKit √© gr√°tis‚Ä¶ (cof cof) com limites (cof cof) üôä</p>
</blockquote>

<p>Mas o que isso significa?</p>

<p>Colocando de forma simples: <strong>O CLOUDKIT √â GR√ÅTIS, PONTO</strong></p>

<p>O que a Apple fez foi criar um sistema que previna abusos, dessa forma, se voc√™ fizer um uso ‚Äònormal‚Äô do servi√ßo, ele ser√° sempre gr√°tis.</p>

<p>Conforme foi dito na session 231 da WWDC de 2014 (tradu√ß√£o livre):</p>

<blockquote>
  <p>N√≥s n√£o queremos previnir uso leg√≠timo</p>

  <p>N√≥s s√≥ queremos evitar que algu√©m abuse do CloudKit</p>

  <p>Os n√∫meros que n√≥s informamos aqui aumentam com o n√∫mero de usu√°rios que voc√™ tem</p>
</blockquote>

<p>E tem mais: se voc√™ utiliza apenas o <strong>banco de dados privado</strong> do CloudKit (que √© o uso mais comum), o uso dele conta para a cota do usu√°rio, ou seja, quem paga √© o usu√°rio e n√£o voc√™.</p>

<p>Os limites para uso do banco de dados p√∫blico do CloudKit aumentam com o n√∫mero de usu√°rios do seu app, conforme pode ser visto na simula√ß√£o abaixo que fiz no site da Apple:</p>

<p><img src="/img/insidegui/cloudkit/quota.png" /></p>

<p>Lembrando que estes limites s√£o para o banco de dados p√∫blico, que √© compartilhado por todos os usu√°rios do seu app, o uso do banco de dados privado de cada usu√°rio conta para a cota daquele usu√°rio no iCloud, ou seja, jamais ter√° custo algum para voc√™.</p>

<h1 id="m√£o-na-massa">M√£o na massa</h1>

<p>Passada esta introdu√ß√£o, hora de colocarmos a m√£o na massa. Vou explicar v√°rios conceitos sobre o CloudKit e ao mesmo tempo apresentar pequenos exemplos de como s√£o usados na pr√°tica üòâ</p>

<h2 style="color:#C86D6C">Ativando o CloudKit no seu projeto</h2>

<p>O primeiro passo para usarmos o CloudKit √© habilitar ele no painel Capabilities do Xcode.</p>

<p><img src="/img/insidegui/cloudkit/cloudkit-enable.gif" /></p>

<p>Ao habilitarmos o CloudKit no projeto, o Xcode se comunica com os servidores da Apple para atualizar o nosso provisioning profile e tamb√©m para criar o container padr√£o para o app.</p>

<p>Perceba que ao ativar o CloudKit, o Xcode ativou automaticamente Push Notifications, porque as subscriptions do CloudKit utilizam push notifications (falarei mais sobre isso depois).</p>

<h2 id="container">Container</h2>

<p>Um container nada mais √© do que uma caixinha onde voc√™ coloca os dados dos seus usu√°rios. O container √© o pai de todos os dados e geralmente ser√° diferente para cada aplicativo seu, embora seja poss√≠vel compartilhar um container entre v√°rios apps. Por padr√£o, quando voc√™ habilita CloudKit no seu projeto, o Xcode cria um container com o bundle identifier do seu app. Outro detalhe a ser apontado √© que um √∫nico app pode acessar v√°rios containers.</p>

<p>Containers s√£o representados por objetos do tipo <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 style="color:#C86D6C">Acessando o container padr√£o</h3>

<p>Acessar o container padr√£o do app √© bem f√°cil: basta utilizar o m√©todo <code class="language-plaintext highlighter-rouge">default</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="o">.</span><span class="nf">default</span><span class="p">()</span>
</code></pre></div></div>

<h3 style="color:#C86D6C">Criando e acessando um container personalizado</h3>

<p>Se voc√™ pretende compartilhar dados no CloudKit com outros apps desenvolvidos por voc√™ ou por vers√µes para diferentes plataformas do mesmo app (ex: entre macOS e iOS), voc√™ deve criar um container pr√≥prio para isso.</p>

<p>O nome do container deve seguir o mesmo esquema dos bundle identifiers: DNS reverso. No meu caso, criei um container chamado <code class="language-plaintext highlighter-rouge">iCloud.br.com.guilhermerambo.KitchenContainer</code>.</p>

<p><img src="/img/insidegui/cloudkit/custom-container.gif" /></p>

<p>Com o container criado, basta usar o inicializador de <code class="language-plaintext highlighter-rouge">CKContainer</code> que aceita um <code class="language-plaintext highlighter-rouge">identifier</code> como par√¢metro e passar o nome que demos ao nosso container.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">containerIdentifier</span> <span class="o">=</span> <span class="s">"iCloud.br.com.guilhermerambo.KitchenContainer"</span>
<span class="k">let</span> <span class="nv">secondContainer</span> <span class="o">=</span> <span class="kt">CKContainer</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="n">containerIdentifier</span><span class="p">)</span>
</code></pre></div></div>

<p>Se voc√™ for usar somente o container padr√£o do app, basta usar <code class="language-plaintext highlighter-rouge">CKContainer.default()</code>, nos demais exemplos deste artigo utilizarei o container default para que o c√≥digo fique mais breve.</p>

<h2 id="database">Database</h2>

<p>Database √© o banco de dados onde voc√™ ir√° armazenar os registros que seu app usa. Bancos de dados s√£o representados  por objetos do tipo <code class="language-plaintext highlighter-rouge">CKDatabase</code>.</p>

<p>Todo container do CloudKit cont√©m tr√™s bancos de dados:</p>

<h3 id="private-database">Private database</h3>

<p>Este √© o banco de dados privado, onde os dados privados dos seus usu√°rios ficar√£o armazenados. Somente um dispositivo do usu√°rio autenticado na conta do iCloud consegue ter acesso aos registros armazenados neste banco de dados.</p>

<p>Sendo assim, voc√™ como desenvolvedor do app n√£o consegue ver os dados dos seus usu√°rios. O dashboard do CloudKit apenas informa o n√∫mero de registros para cada tipo e voc√™ consegue ver os dados da sua pr√≥pria conta, mas n√£o dos outros.</p>

<p>Para acessar o banco de dados privado do usu√°rio, utilizamos a propriedade <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 id="public-database">Public database</h3>

<p>Este √© o banco de dados p√∫blico, onde voc√™ pode armazenar dados globais do seu app ou dados criados pelos usu√°rios que devem ser acess√≠veis pelos outros usu√°rios.</p>

<p>Apesar do banco de dados ser p√∫blico, √© poss√≠vel restringir quem tem acesso aos registros armazenados nele utilizando Security Roles, mas n√£o falarei sobre elas neste artigo.</p>

<p>Para acessar o banco de dados p√∫blico, utilizamos a propriedade <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 id="shared-database">Shared database</h3>

<p>Este √© o banco de dados de compartilhamento. Com o lan√ßamento do iOS 10 e do macOS Sierra a Apple liberou tamb√©m a fun√ß√£o de compartilhamento do CloudKit, pela qual usu√°rios podem compartilhar registros espec√≠ficos nos seus bancos de dados privados com contatos, permitindo com que ambos vejam e editem os registros simultaneamente. O banco de dados compartilhado √© usado para armazenar esses registros, mas seu app n√£o ir√° lidar com ele diretamente.</p>

<h2 id="zone">Zone</h2>

<p>Uma zona dentro do CloudKit √© como se fosse uma pasta onde voc√™ salva seus registros. Todo banco de dados do CloudKit tem uma zona padr√£o, a <code class="language-plaintext highlighter-rouge">Default Zone</code>. Voc√™ pode utilizar a zona padr√£o ou criar zonas novas para organizar seus registros. S√≥ √© poss√≠vel criar zonas no banco de dados privado, o banco de dados p√∫blico s√≥ permite o uso da zona padr√£o.</p>

<p>Algumas funcionalidades do CloudKit s√≥ s√£o poss√≠veis em zonas customizadas. Se voc√™ quiser salvar v√°rios objetos relacionados ao mesmo tempo e precisa que a opera√ß√£o falhe caso algum deles n√£o possa ser salvo, precisa usar uma zona customizada. O novo recurso de compartilhamento tamb√©m requer a utiliza√ß√£o de uma zona customizada.</p>

<p>Zonas s√£o representadas por objetos do tipo <code class="language-plaintext highlighter-rouge">CKZone</code>.</p>

<h3 style="color:#C86D6C">Obtendo uma lista de zonas</h3>

<p>Para listar a zonas dispon√≠veis em um banco de dados, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">fetchAllRecordZones</code> de <code class="language-plaintext highlighter-rouge">CKDatabase</code>.</p>

<script src="https://gist.github.com/insidegui/f27e48e6eda5bf53d993e67d3fbfaa92.js"></script>

<h2 id="record">Record</h2>

<p>Records s√£o os registros que est√£o salvos no banco de dados do CloudKit. Registros s√£o representados por objetos do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code>, que s√£o basicamente dicion√°rios onde podemos adicionar as chaves que quisermos, que se tornar√£o campos nas ‚Äútabelas‚Äù do servidor.</p>

<p>√â importante ressaltar que, apesar do banco de dados do CloudKit ser schemaless (voc√™ n√£o precisa definir os campos previamente), isso s√≥ √© verdade no ambiente de desenvolvimento, ap√≥s colocar seu app em produ√ß√£o voc√™ ter√° que fazer altera√ß√µes no seu schema no dashboard ou atrav√©s do seu app em ambiente de desenvolvimento e depois exportar essas altera√ß√µes para o ambiente de produ√ß√£o.</p>

<h3 id="tipos-de-dados-aceitos">Tipos de dados aceitos</h3>

<p>Embora <code class="language-plaintext highlighter-rouge">CKRecord</code> seja basicamente um dicion√°rio, n√£o significa que possamos salvar qualquer tipo de dado no CloudKit. Estes s√£o os tipos de dados que podemos colocar nas chaves de um <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">String</code>: a Apple recomenda <code class="language-plaintext highlighter-rouge">String</code> para pequenas quantidades de texto</li>
  <li><code class="language-plaintext highlighter-rouge">NSNumber</code>: tipos num√©ricos do Swift s√£o convertidos automaticamente</li>
  <li><code class="language-plaintext highlighter-rouge">Data</code>: um exemplo de uso para um campo tipo <code class="language-plaintext highlighter-rouge">Data</code> seria armazenar objetos pr√≥prios, codificados usando <code class="language-plaintext highlighter-rouge">NSCoding</code></li>
  <li><code class="language-plaintext highlighter-rouge">Date</code>: datas e horas podem ser armazenadas diretamente no CloudKit</li>
  <li><code class="language-plaintext highlighter-rouge">CLLocation</code>: muito √∫til para apps que trabalham com localiza√ß√£o, at√© porque √© poss√≠vel fazer queries com base em localiza√ß√£o (mais sobre isso depois)</li>
  <li><code class="language-plaintext highlighter-rouge">CKAsset</code>: este objeto do CloudKit representa um arquivo que pode conter uma grande quantidade de dados (fotos e v√≠deos, por exemplo)</li>
  <li><code class="language-plaintext highlighter-rouge">CKReference</code>: este objeto do CloudKit representa uma refer√™ncia que aponta para outro <code class="language-plaintext highlighter-rouge">CKRecord</code> no banco de dados</li>
</ul>

<p>Al√©m de poder utilizar os tipos citados acima por si s√≥, qualquer chave em um <code class="language-plaintext highlighter-rouge">CKRecord</code> pode conter tamb√©m um array desses tipos, desde que o array contenha objetos de um √∫nico tipo.</p>

<h3 style="color:#C86D6C">Criando um registro</h3>

<p>Vamos supor que estamos criando um aplicativo onde usu√°rios podem cadastrar filmes, provavelmente ter√≠amos um registro chamado <code class="language-plaintext highlighter-rouge">Movie</code>. Neste caso, <code class="language-plaintext highlighter-rouge">Movie</code> √© o nosso <code class="language-plaintext highlighter-rouge">recordType</code>.</p>

<p>Para criar um registro de um filme, inicializamos um <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">record</span> <span class="o">=</span> <span class="kt">CKRecord</span><span class="p">(</span><span class="nv">recordType</span><span class="p">:</span> <span class="s">"Movie"</span><span class="p">)</span>
</code></pre></div></div>

<p>Com o objeto criado, basta come√ßar a setar as propriedades. Dentro do view controller do app onde o usu√°rio entra com os dados do filme, poder√≠amos atualizar o record na action de um <code class="language-plaintext highlighter-rouge">UITextField</code>, por exemplo:</p>

<script src="https://gist.github.com/insidegui/399eb8f10315b8c87ee1926e3ccd9807.js"></script>

<p>Agora voc√™ deve estar se perguntando: ‚Äúo que diabos √© <code class="language-plaintext highlighter-rouge">CKRecordValue</code>? ü§î‚Äù.</p>

<p><code class="language-plaintext highlighter-rouge">CKRecordValue</code> √© um protocolo adotado por objetos suportados pelo CloudKit. O problema √© que, usando Swift, o compilador n√£o compreende que <code class="language-plaintext highlighter-rouge">String</code> adota <code class="language-plaintext highlighter-rouge">CKRecordValue</code> e por isso temos que fazer esse casting feio.</p>

<h3 style="color:#C86D6C">Melhorando nosso c√≥digo: custom subscript</h3>

<p>Para melhorar essa situa√ß√£o, sempre que trabalho com CloudKit eu crio enums com os campos dos meus registros e adiciono uma extens√£o em <code class="language-plaintext highlighter-rouge">CKRecord</code> com um custom subscript que aceita esse enum. Explicando assim parece complicado, mas no c√≥digo √© bem simples.</p>

<p>Primeiro, o enum dos campos do nosso registro:</p>

<script src="https://gist.github.com/insidegui/a66fd48d4e27a737718e9ddcd3b10fb9.js"></script>

<p>Agora podemos criar a extens√£o em <code class="language-plaintext highlighter-rouge">CKRecord</code>:</p>

<script src="https://gist.github.com/insidegui/7c862fa6226d8ecac72a4f137f699c46.js"></script>

<p>Agora, para modificar os valores dos nossos registros, nosso c√≥digo fica bem mais limpo, podemos fazer simplesmente assim:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
<span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">releaseDate</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<span class="n">record</span><span class="p">[</span><span class="o">.</span><span class="n">rating</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating</span>
<span class="c1">// e assim por diante...</span>
</code></pre></div></div>

<p>Vale ressaltar que com este subscript customizado, continuamos s√≥ podendo colocar no nosso registro valores suportados pelo CloudKit. Se tentarmos colocar algum valor n√£o suportado, o campo ficar√° nulo.</p>

<p>Outro detalhe importante: <code class="language-plaintext highlighter-rouge">CKRecord</code> <strong>n√£o</strong> √© um value type, ent√£o quando voc√™ passa objetos do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code> voc√™ est√° passando uma refer√™ncia e, caso tenha <code class="language-plaintext highlighter-rouge">didSet</code> em propriedades do tipo <code class="language-plaintext highlighter-rouge">CKRecord</code>, o <code class="language-plaintext highlighter-rouge">didSet</code> n√£o ser√° chamado quando algum campo do registro for alterado üòâ</p>

<p>Na ‚Äúvida real‚Äù, voc√™ deve utilizar seus pr√≥prios models (provavelmente value types) e convert√™-los de/para <code class="language-plaintext highlighter-rouge">CKRecord</code> quando estiver lidando com o CloudKit.</p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/SimpleRecordTableViewController.swift">arquivo SimpleRecordTableViewController.swift do projeto de exemplo</a>.</p>

<h2 id="cloudkit-dashboard">CloudKit Dashboard</h2>

<p>Agora que j√° sabemos como criar registros no CloudKit, seria interessante termos uma forma de ver o que est√° acontecendo no servidor quando salvamos nossos registros.</p>

<p>A Apple criou uma ferramenta para isto, o CloudKit Dashboard. No dashboard n√≥s temos acesso a todos os nossos containers, bancos de dados, tipos de registros e muito mais.</p>

<p>Primeiramente, usando o app de exemplo, vamos criar um registro:</p>

<p><img src="/img/insidegui/cloudkit/simple-record.gif" /></p>

<p>Agora que temos um registro criado, vamos acessar o dashboard. O primeiro passo √© selecionar no menu do canto superior esquerdo com qual container queremos trabalhar.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-container-menu.png" /></p>

<p>Com o container selecionado, vemos inicialmente uma lista dos tipos de registro que temos. Todo banco de dados do CloudKit j√° vem por padr√£o com um tipo <code class="language-plaintext highlighter-rouge">User</code>, que armazena informa√ß√µes sobre usu√°rios.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-record-types.png" /></p>

<p>Para visualizarmos o registro salvo no banco de dados p√∫blico, selecionamos a op√ß√£o ‚ÄúDefault Zone‚Äù em ‚ÄúPublic Data‚Äù. Se tiv√©ssemos outras zonas, elas apareceriam nesta mesma lista.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-records.png" /></p>

<p>Agora o dashboard est√° nos avisando que ele precisa de um index no ID do registro para fazer uma listagem deles. Basta clicar em ‚ÄúAdd Record ID Query Index‚Äù e o dashboard ir√° ent√£o mostrar o registro que criamos usando o app.</p>

<p><img src="/img/insidegui/cloudkit/dashboard-records-2.png" /></p>

<p>Note que, al√©m dos dados que n√≥s inserimos, o registro cont√©m alguns metadados que o CloudKit adiciona automaticamente:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Record Name</code>: este √© o ID √∫nico do registro, usado para localizar registros no banco de dados. N√≥s podemos definir este ID ou deixar que o CloudKit defina um automaticamente, neste caso ele usa um <code class="language-plaintext highlighter-rouge">UUID</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Created</code>: a data de cria√ß√£o do registro. Pode ser acessada atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">creationDate</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Created By</code>: o ID do usu√°rio que criou o registro. Pode ser acessado atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">creatorUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Modified</code>: a data da √∫ltima altera√ß√£o do registro. Pode ser acessada atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">modificationDate</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Modified By</code>: o ID do usu√°rio que realizou a √∫ltima altera√ß√£o no registro. Pode ser acessado atrav√©s da propriedade <code class="language-plaintext highlighter-rouge">lastModifiedUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKRecord</code>.</li>
</ul>

<h2 id="user-records">User Records</h2>

<p>Como vimos na se√ß√£o sobre o dashboard, o CloudKit cria automaticamente registros para os usu√°rios do nosso app. Esses registros s√£o do tipo <code class="language-plaintext highlighter-rouge">User</code> e cont√©m por padr√£o somente um identificador √∫nico do usu√°rio. Esse identificador √© √∫nico por container, quer dizer que um usu√°rio ter√° o mesmo identificador √∫nico em todos os bancos de dados e zonas dentro do seu container, mas se voc√™ utilizar mais de um container, ver√° IDs diferentes para o mesmo usu√°rio em cada um deles.</p>

<p>O CloudKit nos permite fazer diversas coisas com o registro do usu√°rio:</p>

<ul>
  <li>Descobrir se o usu√°rio est√° logado no iCloud ou n√£o</li>
  <li>Obter o registro do usu√°rio no container</li>
  <li>Obter o nome completo do usu√°rio</li>
  <li>Obter os identificadores dos contatos do usu√°rio que possuem registros correspondentes no mesmo container</li>
  <li>Atualizar o registro com dados √∫teis para o nosso app</li>
  <li>Ser notificado de mudan√ßas no status da conta do iCloud</li>
</ul>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">Todos os exemplos desta parte voc√™ encontra na √≠ntegra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/UserViewController.swift">arquivo UserViewController.swift do projeto de exemplo</a>.</p>

<h3 style="color:#C86D6C">Descobrindo se o usu√°rio est√° logado</h3>

<p>Em muitos casos √© importante sabermos se o usu√°rio est√° logado no iCloud no dispositivo atual para decidirmos se ativamos determinada funcionalidade do app ou at√© mesmo para impedir que o usu√°rio utilize o app at√© que esteja logado.</p>

<p><strong>Importante:</strong> caso voc√™ decida n√£o permitir com que o usu√°rio utilize o app sem estar logado no iCloud, lembre-se que poder√° ter que prestar esclarecimentos para o time de review da Apple, afinal eles n√£o gostam de apps que exigem algum tipo de login sem uma boa justificativa. Seu app precisa ter um bom motivo para exigir o login, do contr√°rio poder√° ser rejeitado.</p>

<p>Para obter o status da conta do iCloud, usamos o m√©todo <code class="language-plaintext highlighter-rouge">accountStatus</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/5523796b377133a637855e837acfbb7d.js"></script>

<h3 style="color:#C86D6C">Obtendo o ID do registro do usu√°rio</h3>

<p>Para obter o registro do usu√°rio do CloudKit, primeiro precisamos saber o ID dele. Para isso, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">fetchUserRecordID</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/f0140a3255a6a033d84cf4417998b6f9.js"></script>

<p><a name="user-record-fetch"></a>
Agora que n√≥s temos um <code class="language-plaintext highlighter-rouge">CKRecordID</code> referente ao registro do usu√°rio, podemos usar o m√©todo <code class="language-plaintext highlighter-rouge">fetch</code> de <code class="language-plaintext highlighter-rouge">CKDatabase</code> no banco de dados p√∫blico para baixar o registro completo do usu√°rio.</p>

<script src="https://gist.github.com/insidegui/42787a138c7213dd18e23b0ad633150c.js"></script>

<p>No exemplo eu estou usando <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code>, mas poderia usar <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code>. Qual banco de dados usar aqui vai depender da sua aplica√ß√£o, como o app de exemplo usa somente o banco de dados p√∫blico, optei por usar este.</p>

<p>√â poss√≠vel ter dois registros diferentes para o mesmo usu√°rio: um no banco de dados p√∫blico e outro no banco de dados privado, embora ambos tenham o mesmo identificador, os dados contidos em cada um deles podem ser diferentes. Voc√™ pode por exemplo utilizar o registro do usu√°rio no banco de dados p√∫blico para salvar informa√ß√µes como avatar e apelido e usar o registro no banco de dados privado para e-mail, endere√ßo e outros dados sigilosos.</p>

<h3 style="color:#C86D6C">Obtendo o nome completo do usu√°rio</h3>

<p>Podemos obter o nome completo do usu√°rio autenticado, mas isso requer a permiss√£o do mesmo.</p>

<p>Para solicitar essa permiss√£o, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">requestApplicationPermission</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>, passando o par√¢metro <code class="language-plaintext highlighter-rouge">.userDiscoverability</code>. Aparecer√° um alert para o usu√°rio solicitando permiss√£o.</p>

<p>Ap√≥s obtermos permiss√£o, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">discoverUserIdentity</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code> para obter a identidade do usu√°rio, que cont√©m o seu nome completo na forma de <code class="language-plaintext highlighter-rouge">PersonNameComponents</code> que podemos formatar atrav√©s de um <code class="language-plaintext highlighter-rouge">PersonNameComponentsFormatter</code>.</p>

<script src="https://gist.github.com/insidegui/4a282db0d8843b1503087f85fe8c3039.js"></script>

<h3 style="color:#C86D6C">Descobrindo contatos do usu√°rio que utilizam o mesmo app</h3>

<p>Para obter uma lista de registros dos amigos do usu√°rio que utilizam o app, ou seja, que tem registro no mesmo container, utilizamos o m√©todo <code class="language-plaintext highlighter-rouge">discoverAllIdentities</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<script src="https://gist.github.com/insidegui/63ad1684f37b2dc3701029d17d625313.js"></script>

<h3 style="color:#C86D6C">Inserindo dados adicionais no registro do usu√°rio</h3>

<p>No nosso app de exemplo, vamos supor que n√≥s queremos listar os filmes cadastrados e junto ao filme exibir o nome e avatar do usu√°rio que cadastrou aquele filme. Infelizmente a Apple n√£o fornece uma op√ß√£o para obter o avatar do usu√°rio do iCloud, mas n√≥s podemos oferecer esta funcionalidade no nosso pr√≥prio app, utilizando um campo no user record.</p>

<p>Para isto, vamos aprender tamb√©m sobre uma nova classe: <code class="language-plaintext highlighter-rouge">CKAsset</code>.</p>

<p><code class="language-plaintext highlighter-rouge">CKAsset</code> √© um objeto usado para armazenar arquivos grandes no CloudKit. A Apple recomenda que qualquer campo que seja maior do que alguns kilobytes seja armazenado usando <code class="language-plaintext highlighter-rouge">CKAsset</code>.</p>

<p>Trabalhar com <code class="language-plaintext highlighter-rouge">CKAsset</code> √© muito simples: basta inicializ√°-lo com a URL para um arquivo que queremos armazenar no CloudKit e apontar um campo de um <code class="language-plaintext highlighter-rouge">CKRecord</code> para o <code class="language-plaintext highlighter-rouge">CKAsset</code> criado.</p>

<p>Quando o registro for salvo, o CloudKit cuidar√° de enviar o arquivo junto dele. No caso do nosso app estamos enviando imagens para serem usadas como avatar, no meu c√≥digo de exemplo n√£o h√° nenhum tipo de tratamento quanto ao tipo de imagem ou tamanho do arquivo, mas se fosse um app real eu provavelmente iria validar e redimensionar a imagem para evitar desperd√≠cio de espa√ßo no iCloud e consumo de banda desnecess√°rio.</p>

<p>Eu adicionei um bot√£o na interface que abre um <code class="language-plaintext highlighter-rouge">UIImagePickerController</code> para que o usu√°rio possa selecionar uma foto da biblioteca para servir de avatar. O exemplo abaixo mostra a implementa√ß√£o do que acontece ap√≥s o usu√°rio selecionar uma imagem:</p>

<script src="https://gist.github.com/insidegui/8c960b15f65aa123fe9e20fe2ee07226.js"></script>

<p>No exemplo acima, <code class="language-plaintext highlighter-rouge">imageURL</code> √© uma <code class="language-plaintext highlighter-rouge">URL</code> para um arquivo salvo localmente, se voc√™ tentar inicializar um <code class="language-plaintext highlighter-rouge">CKAsset</code> com algum outro tipo de <code class="language-plaintext highlighter-rouge">URL</code> haver√° uma exception e seu app ir√° travar.</p>

<p>O m√©todo <code class="language-plaintext highlighter-rouge">save</code> √© usado tanto para criar quanto para atualizar registros. Ao passar um registro com um ID que j√° existe no servidor, o CloudKit ir√° atualizar por padr√£o apenas os campos que foram alterados desde o √∫ltimo salvamento.</p>

<p>Como podem ver, √© muito simples adicionar um campo personalizado ao registro do usu√°rio e enviar arquivos para o CloudKit.</p>

<p><img src="/img/insidegui/cloudkit/avatar.gif" /></p>

<h3 style="color:#C86D6C">Observando mudan√ßas no status da conta do iCloud</h3>

<p>Algo que pode acontecer enquanto seu app est√° rodando √© que o usu√°rio pode abrir as prefer√™ncias do iCloud e trocar de conta, n√£o estar logado e ent√£o logar ou estar logado e fazer logoff.</p>

<p>Em qualquer um desses casos, se o seu app varia de acordo com a conta do iCloud ativa, voc√™ precisa atualizar o estado do app para refletir esta mudan√ßa.</p>

<p>Para ser notificado de mudan√ßas na conta do iCloud, basta registrar um observer para a notifica√ß√£o <code class="language-plaintext highlighter-rouge">.CKAccountChanged</code>:</p>

<script src="https://gist.github.com/insidegui/0868e826fb781a07958963802c069e44.js"></script>

<p>No meu exemplo, ao receber esta notifica√ß√£o, estou chamando o m√©todo do view controller que faz o processo de descoberta de todos os dados do usu√°rio. Assim, a interface ficar√° sempre em sincronia com o status do iCloud no dispositivo.</p>

<p><img src="/img/insidegui/cloudkit/account.gif" /></p>

<h2 id="queries">Queries</h2>

<p>Agora que j√° vimos como salvar informa√ß√µes no CloudKit, vamos ver como fazemos para buscar essas informa√ß√µes. A forma mais simples de obter um registro do CloudKit √© atrav√©s de uma simples busca com base em um ID, <a href="#user-record-fetch">como j√° vimos antes</a>.</p>

<p>Se quisermos fazer buscas mais avan√ßadas, filtradas com base em outros campos do registro, precisaremos utilizar a classe <code class="language-plaintext highlighter-rouge">CKQuery</code>. Com ela, podemos especificar um predicate que ir√° definir um filtro para a busca.</p>

<p>Se voc√™ n√£o tem familiaridade com <code class="language-plaintext highlighter-rouge">NSPredicate</code>, recomendo que <a href="https://developer.apple.com/reference/foundation/nspredicate">d√™ uma lida na documenta√ß√£o</a>, pois trata-se de uma classe muito poderosa e que √© usada em diversas APIs da Apple.</p>

<p>Para rodarmos uma query no CloudKit, iremos utilizar uma <code class="language-plaintext highlighter-rouge">CKQueryOperation</code>. Realizar queries √© apenas uma dentre muitas funcionalidades do CloudKit que s√£o expostas na forma de operations.</p>

<h3 style="color:#C86D6C">Obtendo todos os registros de um determinado tipo</h3>

<p>Este √© o exemplo mais simples. Vamos executar uma query para obter todos os filmes que temos registrados no nosso banco de dados p√∫blico. O primeiro passo √© construir uma query com um tipo de registro e um predicate, como queremos todos os registros, basta criarmos uma query especificando o tipo <code class="language-plaintext highlighter-rouge">Movie</code> e um predicate com o valor <code class="language-plaintext highlighter-rouge">true</code>:</p>

<script src="https://gist.github.com/insidegui/839813b1754e31b648aaf47c50ae636a.js"></script>

<p>Agora que temos uma opera√ß√£o, antes de execut√°-la, precisamos definir os callbacks que ser√£o chamados para que sejamos informados de novos resultados e poss√≠veis erros na opera√ß√£o:</p>

<script src="https://gist.github.com/insidegui/c3338649c87ae8535294dfa710532928.js"></script>

<p><code class="language-plaintext highlighter-rouge">CKQueryOperation</code> tem dois callbacks: um que √© chamado para cada registro obtido do CloudKit e outro que √© chamado no final da opera√ß√£o, ap√≥s todos os registros terem sido baixados.</p>

<p>H√° dois par√¢metros neste √∫ltimo callback que merecem coment√°rio: <code class="language-plaintext highlighter-rouge">cursor</code> √© um objeto do tipo <code class="language-plaintext highlighter-rouge">CKCursor</code> que poder√° estar presente ao final da opera√ß√£o caso haja mais resultados a serem obtidos. Se sua query for retornar uma quantidade muito grande de registros, voc√™ ter√° que executar v√°rias <code class="language-plaintext highlighter-rouge">CKQueryOperation</code>s para conseguir obter todos eles, passando o <code class="language-plaintext highlighter-rouge">cursor</code> nas queries subsequentes.</p>

<p>O par√¢metro <code class="language-plaintext highlighter-rouge">error</code> tamb√©m √© important√≠ssimo, a partir dele √© poss√≠vel saber se houve um erro na opera√ß√£o e qual a natureza do erro. Alguns erros no CloudKit s√£o recuper√°veis, isso significa que n√£o basta simplesmente exibir um alerta ao usu√°rio no primeiro erro encontrado, voc√™ precisa lidar com o erro. Dependendo de qual foi o erro, o CloudKit ir√° informar at√© mesmo em quantos segundos √© recomendado que a opera√ß√£o seja tentada novamente (e voc√™ deve definitivamente seguir essa recomenda√ß√£o).</p>

<p>Finalmente, ap√≥s configurarmos nossa opera√ß√£o, basta execut√°-la, adicionando-a ao banco de dados:</p>

<script src="https://gist.github.com/insidegui/e2834c0cb17d19a405a538ef2829683b.js"></script>

<p>Se quis√©ssemos executar a opera√ß√£o no banco de dados privado, bastaria substituir <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code> por <code class="language-plaintext highlighter-rouge">privateCloudDatabase</code>. Existem algumas outras opera√ß√µes do CloudKit que s√£o executadas no n√≠vel do container, nesses casos voc√™ chamaria o m√©todo <code class="language-plaintext highlighter-rouge">add</code> de <code class="language-plaintext highlighter-rouge">CKContainer</code>.</p>

<h3 style="color:#C86D6C">Realizando uma busca textual</h3>

<p>Outro tipo de query muito comum de se fazer √© a busca textual. No nosso exemplo, usu√°rios podem querer buscar filmes pelo t√≠tulo. Felizmente o CloudKit sabe lidar muito bem com isso e podemos construir um predicate simples que d√° conta do recado:</p>

<script src="https://gist.github.com/insidegui/5806c2078648de7425b1e59d6d2c49fb.js"></script>

<p>O predicate <code class="language-plaintext highlighter-rouge">self contains %@</code> significa ‚Äúbusque este valor em todos os par√¢metros do registro que contenham texto‚Äù.</p>

<h3 style="color:#C86D6C">Realizando uma busca por localiza√ß√£o geogr√°fica</h3>

<p>Parece mesmo que a Apple pensou em tudo, afinal podemos fazer at√© mesmo queries baseadas em localiza√ß√£o usando o CloudKit. No meu exemplo utilizei a localiza√ß√£o atual do dispositivo para buscar filmes que tenham sido gravados em loca√ß√µes num raio de 500km.</p>

<p>Para fazermos uma query baseada em localiza√ß√£o, o predicate fica desta forma:</p>

<script src="https://gist.github.com/insidegui/23d254910cc315d70143db0f8dfd232d.js"></script>

<p>Onde <code class="language-plaintext highlighter-rouge">location</code> dentro da string se refere √† chave no nosso registro, <code class="language-plaintext highlighter-rouge">currentLocation</code> √© um objeto <code class="language-plaintext highlighter-rouge">CLLocation</code> com a localiza√ß√£o atual e <code class="language-plaintext highlighter-rouge">radius</code> √© um <code class="language-plaintext highlighter-rouge">Float</code> contendo o tamanho do raio inclu√≠do na pesquisa (em quil√¥metros).</p>

<p>Aqui est√° uma demonstra√ß√£o dos tr√™s tipos de query explicados acima:</p>

<p><img src="/img/insidegui/cloudkit/queries.gif" /></p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/QueryTableViewController.swift">arquivo QueryTableViewController.swift do projeto de exemplo</a>.</p>

<p>Fazer queries no banco de dados nos d√° total flexibilidade para obtermos apenas as informa√ß√µes mais relevantes ao contexto do nosso app, mas o CloudKit tem algo ainda mais legal que isso. Com ele n√≥s podemos criar queries persistentes, executadas a cada altera√ß√£o no banco de dados e que notificam nosso app via push. Essas queries persistentes s√£o chamadas de subscriptions.</p>

<h2 id="subscriptions">Subscriptions</h2>

<p>Lembram que eu falei anteriormente sobre enviar notifica√ß√µes usando o CloudKit? √â exatamente isso que subscriptions nos permitem fazer.</p>

<p>Atrav√©s de subscriptions, n√≥s registramos o interesse de um determinado dispositivo ser notificado toda vez que alguma altera√ß√£o ocorrer no banco de dados. Ent√£o, se um novo registro for inserido, o CloudKit ir√° enviar uma notifica√ß√£o para aquele dispositivo. Essas notifica√ß√µes podem ser apenas de <code class="language-plaintext highlighter-rouge">content-available</code> (silenciosas), ou notifica√ß√µes normais que mostram um alerta no dispositivo e/ou colocam n√∫meros no badge do app.</p>

<p>Atrav√©s de notifica√ß√µes silenciosas, podemos garantir um update imediato em todos os dispositivos do usu√°rio sempre que o mesmo fizer alguma altera√ß√£o em outro dispositivo, afinal este tipo de notifica√ß√£o d√° ao nosso app a oportunidade de efetuar um background fetch.</p>

<h3 style="color:#C86D6C">Criando subscription para envio de notifica√ß√µes</h3>

<p>Para criar uma subscription que envia notifica√ß√µes, primeiro precisamos obter permiss√£o do usu√°rio para que ele receba as notifica√ß√µes do nosso app e dizer para o sistema que queremos utilizar notifica√ß√µes remotas.</p>

<script src="https://gist.github.com/insidegui/d9510bb2b567b3f01552bfd303fa0a04.js"></script>

<p>Se voc√™ for usar somente notifica√ß√µes silenciosas (<code class="language-plaintext highlighter-rouge">content-available</code>), s√≥ precisa fazer a √∫ltima chamada (<code class="language-plaintext highlighter-rouge">registerForRemoteNotifications</code>). No app de exemplo estamos usando notifica√ß√µes de alerta com som, por isso precisamos solicitar permiss√£o atrav√©s do <code class="language-plaintext highlighter-rouge">UNUserNotificationCenter</code>.</p>

<p>Tendo permiss√£o do usu√°rio para enviar notifica√ß√µes, podemos criar nossa subscription com o CloudKit. A subscription √© um objeto <code class="language-plaintext highlighter-rouge">CKSubscription</code>, que criamos desta forma:</p>

<script src="https://gist.github.com/insidegui/3228e3d30cd257f3cc2b27dfc824016d.js"></script>

<p>Vamos ver o que cada coisa significa:</p>

<h4 id="recordtype"><code class="language-plaintext highlighter-rouge">recordType</code></h4>

<p>O tipo de registro para o qual queremos receber notifica√ß√µes.</p>

<h4 id="predicate"><code class="language-plaintext highlighter-rouge">predicate</code></h4>

<p>Qual query ser√° executada para determinar se uma notifica√ß√£o ser√° disparada ou n√£o (neste exemplo, qualquer registro). Como mencionei na parte anterior, subscriptions s√£o como queries persistentes que ficam rodando no servidor a cada altera√ß√£o no banco de dados, √© atrav√©s deste par√¢metro que n√≥s determinamos que query ser√° essa.</p>

<p>Lembram da query com localiza√ß√£o que fizemos no exemplo anterior? Poder√≠amos registrar uma subscription com aquela query, fazendo com que o usu√°rio seja notificado sempre que um filme gravado perto da sua cidade for registrado no sistema.</p>

<h4 id="options"><code class="language-plaintext highlighter-rouge">options</code></h4>

<p>Uma lista definindo em quais circunst√¢ncias a notifica√ß√£o ser√° disparada. Podemos pedir para que a notifica√ß√£o seja disparada quando um novo registro for criado, um registro existente for alterado ou exclu√≠do (ou as tr√™s op√ß√µes ao mesmo tempo).</p>

<h4 style="color:#C86D6C">Definindo como ser√° a notifica√ß√£o</h4>

<p>Com nossa subscription criada, precisamos definir como ser√° a notifica√ß√£o que essa subscription ir√° gerar. Para isso, vamos criar um objeto <code class="language-plaintext highlighter-rouge">CKNotificationInfo</code>:</p>

<script src="https://gist.github.com/insidegui/d607ab29d2c60ddb6b297d51bbfa1265.js"></script>

<h4 id="alertlocalizationkey"><code class="language-plaintext highlighter-rouge">alertLocalizationKey</code></h4>

<p>Este par√¢metro √© uma chave no nosso <code class="language-plaintext highlighter-rouge">Localizable.strings</code> que ser√° o formato do alerta. √â necess√°rio usar este par√¢metro quando voc√™ precisa incluir dados do registro no texto do alerta. No meu caso eu estou incluindo o t√≠tulo do filme que foi criado:</p>

<p><code class="language-plaintext highlighter-rouge">"movie_registered_alert" = "%@ has been registered, check it out!";</code></p>

<h4 id="alertlocalizationargs"><code class="language-plaintext highlighter-rouge">alertLocalizationArgs</code></h4>

<p>As chaves do registro que ser√£o usadas para popular os placeholders no texto do alerta. No exemplo estou usando a chave <code class="language-plaintext highlighter-rouge">title</code>, que √© o t√≠tulo do filme.</p>

<h4 id="desiredkeys"><code class="language-plaintext highlighter-rouge">desiredKeys</code></h4>

<p>As chaves do registro que ser√£o enviadas junto da notifica√ß√£o, que podemos usar no app para fazer uma query e localizar o registro.</p>

<h4 style="color:#C86D6C">Salvando a subscription</h4>

<p>Agora que criamos a subscription e definimos como ser√£o as notifica√ß√µes, basta salv√°-la como se fosse um registro qualquer:</p>

<script src="https://gist.github.com/insidegui/84c92632f108899c84e1de8d56df9654.js"></script>

<p>Lembrando que a subscription dever√° ser salva no banco de dados para o qual voc√™ deseja ser notificado. Como o app de exemplo usa o banco de dados p√∫blico, estou usando <code class="language-plaintext highlighter-rouge">publicCloudDatabase</code>.</p>

<p>Com a configura√ß√£o acima, ao criar um registro em outro dispositivo, meu iPhone e meu Apple Watch receberam a seguinte notifica√ß√£o:</p>

<p><img src="/img/insidegui/cloudkit/notification_watch.png" /></p>

<p><img src="/img/insidegui/cloudkit/notification_phone.png" /></p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/CloudKitchenSink/blob/master/CloudKitchenSink/SubscriptionViewController.swift">arquivo SubscriptionViewController.swift do projeto de exemplo</a>.</p>

<h1 id="arquitetura-para-sincroniza√ß√£o">Arquitetura para sincroniza√ß√£o</h1>

<p>O que n√≥s vimos at√© agora no artigo foram apenas os conceitos b√°sicos de como utilizar as funcionalidades do CloudKit. Para criar um app que sincroniza de forma eficiente e correta os dados do usu√°rio, h√° muito mais a ser feito.</p>

<p>Para tentar ajudar quem precisa dessa funcionalidade, criei um simples app para cria√ß√£o de notas (estilo Notes da Apple) que usa uma arquitetura offline-first para sincroniza√ß√£o.</p>

<p>O fluxo do app √© mais ou menos assim:</p>

<p><img src="/img/insidegui/cloudkit/sync_flow.gif" /></p>

<p>As notas s√£o salvas localmente num banco de dados <a href="https://realm.io">Realm</a>. Atrav√©s de <a href="https://realm.io/docs/swift/latest/#notifications">Realm Notifications</a>, o motor de sincroniza√ß√£o sabe sempre que uma nota √© adicionada, alterada ou removida no banco de dados local. Essas altera√ß√µes s√£o reconhecidas pelo motor de sincroniza√ß√£o, que transforma os models em <code class="language-plaintext highlighter-rouge">CKRecord</code>s e envia para o CloudKit.</p>

<p>O mesmo processo acontece inverso quando a altera√ß√£o ocorre no CloudKit: o app recebe uma notifica√ß√£o remota, pega as informa√ß√µes sobre quais registros foram adicionados/alterados/removidos e replica essas altera√ß√µes no banco de dados local. A altera√ß√£o no banco de dados local causa um update na interface.</p>

<p>Um cuidado que precisa ser tomado neste caso √© no sentido de evitar loops de sincroniza√ß√£o. Se uma altera√ß√£o no Realm provoca um salvamento no CloudKit e uma altera√ß√£o no CloudKit provoca um download e altera√ß√£o no Realm, temos um loop. Para evitar este problema, o motor de sincroniza√ß√£o registra um notification token com o Realm para que as altera√ß√µes provocadas por ele n√£o fa√ßam com que as notifica√ß√µes sejam enviadas para ele mesmo.</p>

<h2 id="tratamento-de-erros">Tratamento de erros</h2>

<p>√â muito importante observar a ocorr√™ncia de erros nas opera√ß√µes do CloudKit e tentar lidar com eles da melhor forma poss√≠vel. Muitos desenvolvedores est√£o acostumados a simplesmente colocar um <code class="language-plaintext highlighter-rouge">print</code> quando ocorre um erro ou mostrar um alerta para o usu√°rio, mas nem sempre esta √© a melhor alternativa.</p>

<p>A primeira coisa que voc√™ deve fazer √© verificar se o erro √© recuper√°vel. Existem dois casos muito comuns que causam erros recuper√°veis quando estamos trabalhando com CloudKit:</p>

<h3 id="erro-tempor√°rio--timeout--internet-ruim--rate-limit">Erro tempor√°rio / timeout / internet ruim / rate limit</h3>

<p>√Äs vezes pode ocorrer um pequeno <em>glitch</em> na conex√£o ou nos servidores da Apple que causa um erro tempor√°rio. Tamb√©m pode acontecer do seu app estar chamando o CloudKit com muita frequ√™ncia, neste caso o servidor ir√° recusar alguns requests para aliviar o excesso de carga. Nesses casos, o <code class="language-plaintext highlighter-rouge">error</code> retornado no callback da opera√ß√£o ser√° do tipo <code class="language-plaintext highlighter-rouge">CKError</code>, que cont√©m uma propriedade <code class="language-plaintext highlighter-rouge">retryAfterSeconds</code>. Se esta propriedade n√£o for <code class="language-plaintext highlighter-rouge">nil</code>, use o valor contido nela como um delay para tentar novamente a opera√ß√£o que falhou.</p>

<p>Nos meus projetos com CloudKit eu sempre tenho uma fun√ß√£o mais ou menos assim:</p>

<script src="https://gist.github.com/insidegui/8c726b4b705ddfe2fe01f24672c9a792.js"></script>

<p>Esta fun√ß√£o facilita o tratamento de erros recuper√°veis do CloudKit. Ela recebe um erro retornado de uma opera√ß√£o do CloudKit, um bloco a ser executado caso o erro seja recuper√°vel e retorna um erro caso a opera√ß√£o n√£o possa ser tentada novamente.</p>

<h3 id="conflitos">Conflitos</h3>

<p>Outro caso que pode acontecer √© um conflito entre duas altera√ß√µes no banco de dados. O usu√°rio pode ter modificado um registro em um dispositivo enquanto o mesmo estava offline e depois fez uma altera√ß√£o diferente em outro dispositivo. Neste caso, o salvamento ir√° falhar e o CloudKit ir√° retornar um erro do tipo <code class="language-plaintext highlighter-rouge">server‚ÄãRecord‚ÄãChanged</code>.</p>

<p>O <code class="language-plaintext highlighter-rouge">userInfo</code> desse erro ir√° conter o registro original antes da modifica√ß√£o, o registro atual no servidor e o registro atual no cliente. Com estas informa√ß√µes, cabe ao seu app decidir o que fazer para solucionar o conflito. Alguns apps exibem um painel para que o usu√°rio decida o que fazer, outros fazem um merge do conte√∫do automaticamente e outros apenas salvam o registro que foi modificado mais recentemente.</p>

<p style="background-color:#f5f5f5;border-left:5px solid #3461A6;padding:10px">O c√≥digo completo desta parte voc√™ encontra no <a href="https://github.com/insidegui/NoteTaker">projeto NoteTaker, no meu Github</a>.</p>

<h1 id="conclus√£o">Conclus√£o</h1>

<p>Com isto, chegamos ao fim deste <strike>pequeno</strike> artigo sobre CloudKit. Espero que este artigo tenha te ajudado a entender melhor o que √© o CloudKit e tenha te dado ideias de como poder√° utiliz√°-lo em seus projetos.</p>

<h1 id="sugest√µes-de-estudo">Sugest√µes de estudo</h1>

<ul>
  <li><a href="https://developer.apple.com/reference/cloudkit">Documenta√ß√£o da Apple sobre o CloudKit</a></li>
  <li><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/iCloudDesignGuide/DesigningforCloudKit/DesigningforCloudKit.html">Designing for CloudKit</a></li>
  <li><a href="https://medium.com/@kwylez/cloudkit-sharing-series-creating-the-ckshare-40e420b94ee8#.7snggpqs1">CloudKit Sharing</a></li>
  <li><a href="https://developer.apple.com/search/?type=Videos&amp;q=CloudKit">Todas as sessions da WWDC sobre CloudKit</a></li>
</ul>]]></content><author><name>Guilherme Rambo</name></author><category term="cloudkit" /><summary type="html"><![CDATA[Guilherme Rambo (@_inside) √© desenvolvedor iOS na Peixe Urbano, criador do BrowserFreedom, ChibiStudio e criador de diversos projetos open-source, incluindo o app da WWDC para macOS.]]></summary></entry><entry><title type="html">Swift &amp;amp; Machine Learning</title><link href="http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/" rel="alternate" type="text/html" title="Swift &amp;amp; Machine Learning" /><published>2017-03-22T21:10:00-03:00</published><updated>2017-03-22T21:10:00-03:00</updated><id>http://localhost:4000/tutorial/2017/03/22/swift-machine-learning</id><content type="html" xml:base="http://localhost:4000/tutorial/2017/03/22/swift-machine-learning/"><![CDATA[<blockquote>
  <p>Geralmente, quando se fala em aprendizado de m√°quina para mobile, √© mais comum ver c√≥digos escritos em Python ou R, rodando do lado do servidor. No entanto, h√° casos em que compensa mais fazer o processamento localmente (por poder ser feito offline, e n√£o sobrecarregar o server). Por isso o uso de Swift √© justific√°vel. Uns 4 anos atr√°s, eu falaria pra usar o OpenCV rodando nativo em C++, mas os tempos s√£o outros.</p>

  <p>Se voc√™, caro leitor, nunca teve contato com intelig√™ncia artificial, n√£o tema; este artigo n√£o assume que voc√™ conhe√ßa previamente nada sobre.</p>
</blockquote>

<ol>
  <li>
    <h3 id="resumo">Resumo</h3>

    <p>Vamos juntos, neste artigo, estudar a base de dados sobre Recursos Humanos do <em>Kaggle</em>, e criar uma nova implementa√ß√£o do algoritmo Random Forest na linguagem <em>Swift</em>. Em termos da linguagem <em>Swift</em>, discutiremos <em>generics</em>, ponteiros e paraleliza√ß√£o. De Aprendizado de M√°quina, vamos falar de engenharia de features, dados, par√¢metros e valida√ß√£o. Sobre engenharia de algoritmos, vamos ver complexidade, otimiza√ß√£o e estruturas de dados.</p>
  </li>
  <li>
    <h3 id="introdu√ß√£o">Introdu√ß√£o</h3>

    <p>Em termos de frameworks para ML (<em>machine learning</em>), o Swift n√£o est√° muito bem. Existem <a href="https://github.com/josephmisiti/awesome-machine-learning#swift-general-purpose">alguns projetos</a> isolados, mas todos s√£o promessas inacabadas, e nenhum tinha o algoritmo que eu queria usar (<em>Random Forest</em>). Logo, como eu n√£o queria incentivar o <em>black-box</em> <a href="http://www.ic.unicamp.br/~rocha/pub/papers/2010-sibgrapi-ml-black-boxes.pdf">que j√° rola na √°rea</a>, surgiu este artigo: escrever o algoritmo. Eu n√£o tenho como ressaltar isso o suficiente:</p>

    <blockquote>
      <p>E S C R E V A      S E U S      A L G O R I T M O S</p>
    </blockquote>

    <p>Pra quem quer se aprofundar na √°rea, recomento o livro cl√°ssico <a href="http://aima.cs.berkeley.edu/">Intelig√™ncia Artificial: uma abordagem moderna</a> e o <a href="https://www.coursera.org/learn/machine-learning">curso de Stanford</a> (os dois rolavam soltos em pendrives quando eu cursei essa disciplina na universidade).</p>

    <p>Neste artigo, vamos falar sobre Recursos Humanos, e como identificar funcion√°rios que v√£o pedir demiss√£o.</p>
  </li>
  <li>
    <h3 id="sobre-homens-e-dados">Sobre homens e dados</h3>

    <p>Primeiramente, vamos falar dos nossos dados. A <a href="https://www.kaggle.com/ludobenistant/hr-analytics">base de recursos humanos</a> √© atualmente (Fev. 2017) a terceira mais votada no Kaggle. Ela tem um sutil <em>disclaimer</em>: <code class="language-plaintext highlighter-rouge">This dataset is simulated</code>. Logo, qualquer informa√ß√£o que tirarmos daqui n√£o deve ser levada muito a s√©rio.</p>

    <p>Antes de qualquer coisa, vamos dar uma limpada na base de dados, uma <em>engenharia de features</em>. Isso geralmente consiste em descartar dados menos relevantes, e realizar opera√ß√µes nos dados restantes.</p>

    <blockquote>
      <p>Um exemplo maravilhoso de engenharia de <em>features</em> est√° <a href="https://www.kaggle.com/c/titanic">nos dados dos passageiros do Titanic</a>. Ao correlacionar as entradas com a sa√≠da, o fator <code class="language-plaintext highlighter-rouge">sobreviveu? Sim ou n√£o</code>, vemos que as tr√™s informa√ß√µes claramente mais importantes s√£o [Idade, Sexo, Classe]. Mulhers com mais de trinta anos, meninos com menos de dez anos, e passageiros da primeira classe, tem muito mais chances de sobreviver. Todavia, olhando cuidadosamente os nomes dos passageiros, podemos extrair o t√≠tulo dele (ex: Mr., Miss., Mrs.) que se torna uma feature poderos√≠ssima.</p>
    </blockquote>

    <p>Escrevi um pequeno trecho de c√≥digo em <code class="language-plaintext highlighter-rouge">Python</code> pra fazer esse trabalho por n√≥s:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'HR.csv'</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c1">#kill uninteresting rows
</span><span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">().</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'database.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>As colunas <code class="language-plaintext highlighter-rouge">[Satisfa√ß√£o do funcion√°rio, acidentes no trabalho, se foram promovidos recentemente, departamento, sal√°rio]</code> cont√©m os dados menos <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.corr.html">correlacionados</a> com a sa√≠da dos funcion√°rios. Isso nos deixa com os seguintes:</p>

    <table>
      <thead>
        <tr>
          <th>Vari√°vel</th>
          <th>Correla√ß√£o com Y</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Anos na empresa</td>
          <td>0.144822</td>
        </tr>
        <tr>
          <td>M√©dia de horas por m√™s</td>
          <td>0.071287</td>
        </tr>
        <tr>
          <td>N√∫mero de projetos realizados</td>
          <td>0.023787</td>
        </tr>
        <tr>
          <td>√öltima avalia√ß√£o do funcion√°rio pela empresa</td>
          <td>0.006567</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <h3 id="florestal-rand√¥mico">‚ÄòFlorestal Rand√¥mico‚Äô</h3>

    <p>O algoritmo <em>Random Forest</em>, ou como eu o apelido carinhosamente, <em>Mata Atl√¢ntica</em>, √© um classificador supervisionado. Em outras palavras, ele divide dados em classes, e precisa saber previamente a classe dos seus dados para aprender a classificar outros. <em>Classe</em> √© o tipo do dado, no nosso caso, se o funcion√°rio pediu ou n√£o demiss√£o.</p>

    <p>Em termos simples, ele cria m√∫ltiplas <a href="https://en.wikipedia.org/wiki/Decision_tree">√°rvores de decis√£o</a>, s√≥ que cada √°rvore usa um subconjunto aleat√≥rio de <em>features</em>, e depois usamos <em><a href="https://en.wikipedia.org/wiki/Bootstrap_aggregating">BAgging</a></em> para decidir entre as √°rvores. Uma verdadeira sacada (<em>migu√©</em>) que performa, pasme, impressionantemente bem e r√°pido. Na nossa implementa√ß√£o, vamos dar suporte aos seguintes par√¢metros:</p>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Tipo</th>
          <th>Descri√ß√£o</th>
          <th>Padr√£o</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Profundidade M√°xima</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code> (1,‚àû)</td>
          <td>Altura m√°xima de cada √°rvore, ou seja, m√°xima dist√¢ncia entre a raiz e as folhas. Aumentar esse n√∫mero deixa o algoritmo mais r√°pido e menos preciso</td>
          <td><code class="language-plaintext highlighter-rouge">10</code></td>
        </tr>
        <tr>
          <td>Tamanho M√≠nimo do N√≥</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code> (1,‚àû)</td>
          <td>Tamanho m√≠nimo do subconjunto do <code class="language-plaintext highlighter-rouge">dataset</code> no qual cada n√≥ √© dividido. Aumentar esse n√∫mero deixa o algoritmo mais r√°pido e menos preciso</td>
          <td><code class="language-plaintext highlighter-rouge">50</code></td>
        </tr>
        <tr>
          <td>Tamanho de <code class="language-plaintext highlighter-rouge">Sample</code></td>
          <td><code class="language-plaintext highlighter-rouge">Double</code>(0,1)</td>
          <td>Porcentagem do <code class="language-plaintext highlighter-rouge">dataset</code> a ser <em>‚Äúsampleada‚Äù</em> em cada √°rvore. Ajuda a deixar cada √°rvore diferente entre si</td>
          <td><code class="language-plaintext highlighter-rouge">0.1</code></td>
        </tr>
        <tr>
          <td>N√∫mero de √Årvores</td>
          <td><code class="language-plaintext highlighter-rouge">Int</code>(1,‚àû)</td>
          <td>N√∫mero de √°rvores constru√≠das</td>
          <td><code class="language-plaintext highlighter-rouge">10</code></td>
        </tr>
        <tr>
          <td><em>Seed</em></td>
          <td><code class="language-plaintext highlighter-rouge">String</code></td>
          <td>Semente do gerador de n√∫meros aleat√≥rios</td>
          <td><code class="language-plaintext highlighter-rouge">"Seed"</code></td>
        </tr>
        <tr>
          <td>Tipo de Split</td>
          <td><code class="language-plaintext highlighter-rouge">[All, Sqrt, Log2]</code></td>
          <td>N√∫mero de features usado em cada split. Ajuda a deixar cada √°rvore diferente entre si</td>
          <td><code class="language-plaintext highlighter-rouge">Sqrt</code></td>
        </tr>
      </tbody>
    </table>

    <p>√Årvores diferentes entre si s√£o o charme do <code class="language-plaintext highlighter-rouge">Random Forest</code>. Vamos entender isso logo. Eis o pseudo-c√≥digo que vamos implementar:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>randomForest:
  Seja D o nosso dataset
  Para cada √°rvore a ser constru√≠da:
      seja S um subconjunto de D
      seja A(S) uma raiz de √°rvore
      A.M = obterSplit ( A )
      split ( A )

obterSplit ( Raiz de √°rvore A ):
	seja M o melhor split encontrado at√© o momento
	para cada feature F do split:
		para cada F[N] a feature de cada linha N de A.S:
			seja D,E subconjuntos de A.S
			para cada G[N] a feature de cada linha N de A.S:
				se G[N]&gt;F[N] adicione G[N] a D
				caso contr√°rio adicione a E
			se M'(D,E) for um split melhor que M, M recebe M'(D,E)
	retorna M

split  ( N√≥ de √°rvore A ):
	Se a direita, ou esqurerda do split de A for vazia, retorne n√≥ folha (A.M)
	Se chegamos na profundidade m√°xima da √°rvore, retorne n√≥ folha (A.M)
	Se a esquerda do split for menor que o tamanho m√≠nimo:
		A.N√≥_Esquerda = n√≥ folha (A.M.E)
	Caso contr√°rio:
		A.N√≥_Esquerda = obterSplit(A.M.E)
		split (A.N√≥_Esquerda)
	Se a direita do split for menor que o tamanho m√≠nimo:
		A.N√≥_Direita = n√≥ folha (A.M.D)
	Caso contr√°rio:
		A.N√≥_Direita = obterSplit(A.M.D)
		split (A.N√≥_Direita)
</code></pre></div>    </div>

    <p>Qual √© a complexidade deste algoritmo? Digamos que <code class="language-plaintext highlighter-rouge">L</code> √© o n√∫mero de linhas do dataset, <code class="language-plaintext highlighter-rouge">C</code> o total de <em>features</em>, <code class="language-plaintext highlighter-rouge">K</code> o n√∫mero de classes diferentes, e  <code class="language-plaintext highlighter-rouge">T</code> o total de √°rvores constru√≠das. Supondo que para determinar se um <em>Split</em> √© melhor do que outro, usamos o <a href="https://en.wikipedia.org/wiki/Gini_coefficient"><em>coeficiente Gini</em></a>, que tem complexidade <code class="language-plaintext highlighter-rouge">O(L * K)</code>, a complexidade do algoritmo seria:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compl. de construir a √°rvore: N log( N )
Compl. de cada n√≥: C * L * ( L + L * K ) ‚âÉ C * L¬≤ * K
Resultado: O(CL¬≤K log( CL¬≤K ))
</code></pre></div>    </div>

    <p>Note que estamos olhando de maneira quadr√°tica pro <em>dataset</em>.</p>
  </li>
  <li>
    <h3 id="implementa√ß√£o-em-swift">Implementa√ß√£o em Swift</h3>

    <h4 id="51-arrays-vs-ponteiros">5.1 Arrays vs Ponteiros</h4>

    <p>A estrutura de dados <code class="language-plaintext highlighter-rouge">Array</code>, em Swift √© muito conveniente, mas muito lenta. Vamos fazer um <em>benchmark</em>?</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let bm = BenchmarkTest.init(count: 1000000)
bm.begin()
</code></pre></div>    </div>

    <p>Vamos conferir os n√∫meros de acesso:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Array Access: 			0.0430499911308289 s
NSMutableArray Access: 	0.519761979579926 s
Pointer Access: 		0.0407860279083252 s
</code></pre></div>    </div>

    <p>E os tempos de <em>alloc/dealloc</em>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Array Alloc: 				0.01119 s
NSMutableArray Alloc: 		2.32907 s
UnsafeMutablePointer Alloc: 0.00043 s
</code></pre></div>    </div>

    <p>Claro que usando ponteiros INSEGUROS, temos que tomar conta da nossa pr√≥pria mem√≥ria. Mas o ganho de desempenho deve compensar esse pre√ßo. Como usar arrays de ponteiros? Vamos ver:</p>

    <pre><code class="language-Swift">// Em vez disso
let a:Array&lt;Int&gt; = Array(repeating:Int(0), count:10)
// faremos isso
let b:UnsafeMutablePointer&lt;Int&gt; = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 10 * MemoryLayout&lt;Int&gt;.size)
// e para mudar o tamanho do array
b = realloc(b, 20*MemoryLayout&lt;Int&gt;.size).assumingMemoryBound(to: Int.self)
// e depois de usar
b.deallocate(capacity: 10 * MemoryLayout&lt;Int&gt;.size)

// Para pegar referencias de structs sem copiar valores nativos, em vez disso
let a_copy = test
// Faremos isso
let b_copy = UnsafeRawPointer(Unmanaged.passUnretained(test).toOpaque())
// E para acessar
Unmanaged&lt;Int&gt;.fromOpaque(b_copy).takeUnretainedValue()
</code></pre>

    <p>Lembre-se que <code class="language-plaintext highlighter-rouge">realloc</code> √© uma opera√ß√£o cara. A implementa√ß√£o de <code class="language-plaintext highlighter-rouge">Array</code>, por exemplo, dobra o tamanho quando chegamos no limite. A regra de ouro √© sempre que poss√≠vel fazer um <code class="language-plaintext highlighter-rouge">loop</code> e calcular o tamanho novo do array, em vez de realocar a cada novo <em>append</em>.</p>

    <h4 id="52-tipos-gen√©ricos">5.2 Tipos gen√©ricos</h4>

    <p>Outro detalhe importante quando trabalhamos com dados √© o tipo. Como o Random Forest n√£o √© um cara de grandes opera√ß√µes matem√°ticas, isso n√£o vai importar muito pro nosso caso, e podemos usar <code class="language-plaintext highlighter-rouge">Double</code> sem dor no peito. De qualquer modo, √© muito interessante que implementa√ß√µes de estruturas de dados para Aprendizado de M√°quina sejam gen√©ricas. <a href="http://stackoverflow.com/questions/42696579/">Apanhei um pouco</a> pra deixar tudo gen√©rico, mas considero que o resultado ficou bem interessante. Veja exemplos das declara√ß√µes:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Numeric</span><span class="p">:</span><span class="kt">Hashable</span><span class="p">,</span> <span class="kt">Comparable</span>
<span class="kd">class</span> <span class="kt">Matrix</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span>
<span class="kd">class</span> <span class="kt">TreeNode</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span>
<span class="kd">protocol</span> <span class="kt">ClassifierAlgorithm</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">NumericType</span><span class="p">:</span><span class="kt">Numeric</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">RandomForest</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">ClassifierAlgorithm</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">NumericType</span> <span class="o">=</span> <span class="kt">T</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">CrossValidation</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span><span class="kt">Numeric</span><span class="p">,</span> <span class="kt">U</span><span class="p">:</span><span class="kt">ClassifierAlgorithm</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="k">where</span> <span class="kt">U</span><span class="o">.</span><span class="kt">NumericType</span> <span class="o">==</span> <span class="kt">T</span>
</code></pre></div>    </div>

    <h4 id="53-opera√ß√µes-paralelas-com-operation">5.3 Opera√ß√µes paralelas com <code class="language-plaintext highlighter-rouge">Operation</code></h4>

    <p>No nosso algoritmo, nada impede que as √°rvores sejam constru√≠das paralelamente. Em termos de performance, com testes rasos usando <code class="language-plaintext highlighter-rouge">Operation</code>, o tempo de construir nove √°rvores de tr√™s em tr√™s √© um ter√ßo de construir de uma em uma. Pois, vamos ao que interessa, come√ßamos com um gerenciador de oper√°rios, tamb√©m conhecido como sindicato üòÇ:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">PendingOperations</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">queueName</span><span class="p">:</span><span class="kt">String</span>
    <span class="k">var</span> <span class="nv">concurrentOperations</span><span class="p">:</span><span class="kt">Int</span>
    <span class="nf">init</span> <span class="p">(</span><span class="nv">queueName</span><span class="p">:</span><span class="kt">String</span><span class="p">,</span> <span class="nv">concurrentOperations</span><span class="p">:</span><span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">queueName</span> <span class="o">=</span> <span class="n">queueName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">concurrentOperations</span> <span class="o">=</span> <span class="n">concurrentOperations</span>
    <span class="p">}</span>
    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">buildsInProgress</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSIndexPath</span><span class="p">:</span><span class="kt">Operation</span><span class="p">]()</span>
    <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">buildQueue</span><span class="p">:</span><span class="kt">OperationQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">OperationQueue</span><span class="p">()</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">queueName</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">concurrentOperations</span>
        <span class="k">return</span> <span class="n">queue</span>
    <span class="p">}()</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>Uma classe oper√°ria oprimida pelo sistema:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TreeBuilder</span><span class="p">:</span><span class="kt">Operation</span> <span class="p">{</span>    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
		<span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>E para convocar uma greve:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for _ in 0..&lt;self.treesCount {
	let treeBuilder = TreeBuilder.init()
	treeBuilder.completionBlock = {...}
	self.pendingOperations.buildQueue.addOperation(treeBuilder)
}
</code></pre></div>    </div>
  </li>
  <li>
    <h3 id="valida√ß√£o-cruzada-e-overfitting">Valida√ß√£o Cruzada e <em>Overfitting</em></h3>

    <p>Como validar o nosso modelo na pr√°tica? √â comum ver em artigos da √°rea frases como <code class="language-plaintext highlighter-rouge">to evaluate our accuracy we used 10-fold cross-validation [...] </code>. Vamos explicar:</p>

    <p><strong>Acur√°cia</strong> √© uma m√©trica comum para algoritmos de ML, basicamente, previs√µes corretas/n√∫mero de testes. Entenda:</p>

    <pre><code class="language-Swift">private func accuracy(actual:Array&lt;T&gt;, predicted:Array&lt;T&gt;) -&gt; Double {
	let correct = zip(actual, predicted).reduce(0){ (a: Int, element) in
		var accumulator = a
		if element.0 == element.1 { accumulator += 1 }
		return accumulator
	}
	return Double(correct)/Double(actual.count)
}
</code></pre>

    <p><strong>Overfitting</strong> √© o fen√¥meno que ocorre quando um modelo performa muito bem para para os dados de treino, e muito mal para os dados de teste. Veja um exemplo na seguinte imagem:</p>

    <p><img src="/img/farris/2017/overfitting.jpg" alt="" /></p>

    <p>A linha verde √© a fun√ß√£o que gerou os dados. A linha azul √© uma fun√ß√£o criada por uma regress√£o. Dado um novo ponto da linha verde, ser√° que o modelo azul vai predizer corretamente? <em>N√£o</em>.</p>

    <p>A criptonita do <em>overfitting</em> √© ter muitos dados. Quanto mais dados, melhor. <em>Sempre</em>.</p>

    <p><strong>Valida√ß√£o Cruzada (K-fold Cross Validation)</strong> √© o conceito de dividir aleatoriamente o dataset em K subconjuntos de tamanho igual, e para cada subconjunto, usar ele de valida√ß√£o e os demais como teste. Entenda:</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">dataset</span><span class="p">:</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nf">getDataset</span><span class="p">(),</span> <span class="n">foldCount</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">let</span> <span class="nv">folds</span><span class="p">:</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">Array</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nf">crossValidationSplit</span><span class="p">(</span><span class="nv">dataset</span><span class="p">:</span> <span class="n">dataset</span><span class="p">,</span> <span class="nv">folds</span><span class="p">:</span> <span class="n">foldCount</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fold</span> <span class="k">in</span> <span class="n">folds</span> <span class="p">{</span>
	<span class="k">let</span> <span class="nv">trainData</span> <span class="o">=</span> <span class="nf">datasetByRemovingFold</span><span class="p">(</span><span class="n">fold</span><span class="p">)</span>
	<span class="k">let</span> <span class="nv">testData</span> <span class="o">=</span> <span class="n">fold</span>
	<span class="n">algorithm</span><span class="o">.</span><span class="nf">runClassifier</span><span class="p">(</span><span class="n">trainData</span><span class="p">,</span><span class="n">testData</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>Valida√ß√£o cruzada ajuda tamb√©m a reduzir um fantasma chamado <em>overfitting</em>.</p>

    <p>Vamos avaliar nosso algoritmo? Usando os par√¢metros padr√£o, com 10 <em>folds</em>, temos:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Fold 0 had accuracy 0.887876025524157
Fold 1 had accuracy 0.906107566089335
Fold 2 had accuracy 0.880583409298086
Fold 3 had accuracy 0.86873290793072
Fold 4 had accuracy 0.886052871467639
Fold 5 had accuracy 0.896991795806746
Fold 6 had accuracy 0.886052871467639
Fold 7 had accuracy 0.864175022789426
Fold 8 had accuracy 0.877848678213309
Fold 9 had accuracy 0.88514129443938
</code></pre></div>    </div>

    <p>A acur√°cia m√©dia √© <code class="language-plaintext highlighter-rouge">0,883</code>. Ou seja, estamos predizento,em m√©dia, corretamente se 88% dos funcion√°rios se demitiram ou n√£o. Interessante n√©? Vamos olhar uma √°rvore constru√≠da:</p>

    <p><img src="/img/farris/2017/tree.png" alt="" /></p>

    <p>Vamos olhar mais de perto nossa classifica√ß√£o:</p>

    <table>
      <thead>
        <tr>
          <th>¬†</th>
          <th>N√£o se demitiu</th>
          <th>Demitiu</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Achamos que n√£o se demitiu</td>
          <td>85%</td>
          <td>12%</td>
        </tr>
        <tr>
          <td>Achamos que se demitiu</td>
          <td>0%</td>
          <td>3%</td>
        </tr>
      </tbody>
    </table>

    <p><em>Opa</em>. Parece que nosso classificador tem um vi√©s. Isso est√° acontecendo porque o dataset √© muito desbalanceado, ou seja, apenas 15% dos dados s√£o de funcion√°rios que pediram demiss√£o. Vamos mudar nosso sampling para usar mais esta classe (<em>subsampling</em>), ponderar as vari√°veis na hora de calcular o √≠ndice gini e na hora de predizer com o bagging, e mudar nossa m√©trica pra um indicador que lide melhor com os dados desbalanceados (<a href="https://en.wikipedia.org/wiki/Cohen%27s_kappa">kappa</a>), como sugerido <a href="http://statistics.berkeley.edu/sites/default/files/tech-reports/666.pdf">no famoso artigo 666 de Berkeley</a>:</p>

    <blockquote>
      <p>For each iteration in random forest, draw a bootstrap sample from the minority class. Randomly draw
the same number of cases, with replacement, from the majority class [‚Ä¶] Since the RF classifier tends to be biased towards the majority class, we shall place a heavier penalty on misclassifying the minority class. We assign a weight to each class, with the minority class given larger weight</p>
    </blockquote>
  </li>
  <li>
    <h3 id="conclus√£o">Conclus√£o</h3>

    <p>Nessa nossa breve jornada juntos, implementamos um classificador altamente pr√°tico, com um desempenho aceit√°vel. Entendemos como lidar com dados, e a avaliar nossos modelos. Vimos como usar ponteiros, generics, e paralelizar opera√ß√µes em Swift 3. Descobrimos o poss√≠vel perfil de quem pede demiss√£o. Aprendemos como examinar o resultado do classificador.
Obrigado pela leitura. At√© a pr√≥xima!
O c√≥digo deste artigo pode ser encontrado <a href="https://github.com/luksfarris/SwiftRandomForest">neste reposit√≥rio</a>.</p>
  </li>
</ol>

<blockquote>
  <p>Lucas Farris come√ßou com programa√ß√£o em 2006, entrou no mercado mobile em 2011, em 2014 se formou em Ci√™ncia da Computa√ß√£o na Unicamp. Atualmente trabalha na Pol√¥nia, onde cuida de uma planta robo chamada <em>–°–∞—à–∞</em>.</p>
</blockquote>]]></content><author><name>Lucas Farris</name></author><category term="Tutorial" /><summary type="html"><![CDATA[Geralmente, quando se fala em aprendizado de m√°quina para mobile, √© mais comum ver c√≥digos escritos em Python ou R, rodando do lado do servidor. No entanto, h√° casos em que compensa mais fazer o processamento localmente (por poder ser feito offline, e n√£o sobrecarregar o server). Por isso o uso de Swift √© justific√°vel. Uns 4 anos atr√°s, eu falaria pra usar o OpenCV rodando nativo em C++, mas os tempos s√£o outros. Se voc√™, caro leitor, nunca teve contato com intelig√™ncia artificial, n√£o tema; este artigo n√£o assume que voc√™ conhe√ßa previamente nada sobre.]]></summary></entry><entry><title type="html">Desmistificando o Core Animation</title><link href="http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/" rel="alternate" type="text/html" title="Desmistificando o Core Animation" /><published>2017-03-19T21:13:00-03:00</published><updated>2017-03-19T21:13:00-03:00</updated><id>http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator</id><content type="html" xml:base="http://localhost:4000/animations/2017/03/19/desmistificando-o-core-animator/"><![CDATA[<p>Fala galera! Bem vindos a mais uma rodada do EquinociOS! Espero que estejam aproveitando e absorvendo tudo =D</p>

<p>Bem, o artigo de hoje introduz um assunto que eu particularmente sempre corri dele e tentei ao m√°ximo evit√°-lo. At√© que chegou o dia em que eu n√£o tive como escapar e precisei encarar o ‚Äúbixo‚Äù: <code class="language-plaintext highlighter-rouge">CORE Animation</code>.
Vou falar que foi uma das batalhas mais satisfat√≥rias que eu j√° enfrentei nesse mundo de desenvolvimento mobile, pois al√©m de eu conseguir trabalhar minhas anima√ß√µes de uma forma muito melhor, abriu minha mente para detalhes que sempre passaram desapercebidos e que mudou muito a minha forma de encarar uma - at√© ent√£o - simples estrutura de tela/layout.</p>

<h3 id="lets-talk">LETS TALK!</h3>

<p>‚Äì</p>

<h1 id="core-animation">Core Animation</h1>

<p>Infraestrutura de renderiza√ß√£o gr√°fica e anima√ß√£o, dispon√≠vel para iOS e OS X, que voc√™ utiliza para animar as views e outros elementos visuais de sua aplica√ß√£o.
(Sim, copiei do guide da Apple).
A prop√≥sito, vou pular esta parte introdut√≥ria (chata) que todo mundo est√° cansado de ver e pular pra parte ‚Äúcool‚Äù da baga√ßa hehehe.</p>

<blockquote>
  <p>Sempre leiam o guide da Apple ;) (https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html)</p>
</blockquote>

<p>Certo, acredito que todos voc√™s em algum momento j√° se depararam com uns m√©todos de classe chamados:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">animate</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="nf">animateKeyframes</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">animateWith</span><span class="p">...</span>
<span class="n">animateKeyframesWith</span><span class="p">...</span>
</code></pre></div></div>

<p>Estes, s√£o m√©todos, ou melhor, <code class="language-plaintext highlighter-rouge">big helpers</code> que encapsulam todo o processo de cria√ß√£o de um <code class="language-plaintext highlighter-rouge">CABasicAnimation</code> ou de um <code class="language-plaintext highlighter-rouge">CAKeyframeAnimation</code> por exemplo. Estes m√©todos s√£o muito √∫teis, desde que usados com modera√ß√£o e um certo bom senso, mas ap√≥s nossa introdu√ß√£o voc√™ vai notar que pode ter um resultado mais apropriado utilizando o <code class="language-plaintext highlighter-rouge">Core Animation</code>, dependendo da complexidade de suas anima√ß√µes.</p>

<p>Antes de come√ßar a ver como as anima√ß√µes acontecem na tela, precisamos entender um elemento bem importante: O <code class="language-plaintext highlighter-rouge">CALayer</code>, que √© de fato, onde as anima√ß√µes acontecem.</p>

<p>Certo, vamos voltar mais um passo e entender um pouco do comportamento de uma <code class="language-plaintext highlighter-rouge">UIView</code> em rela√ß√£o √† anima√ß√£o.
Uma <code class="language-plaintext highlighter-rouge">inst√¢ncia do UIView</code> modifica sua layer para delegar a renderiza√ß√£o √† estrutura de anima√ß√£o principal. Entretanto, as anima√ß√µes, quando adicionadas a uma layer, n√£o modificam suas propriedades. A anima√ß√£o principal, mant√©m duas <code class="language-plaintext highlighter-rouge">hierarquias</code> de layers: <code class="language-plaintext highlighter-rouge">model</code> e <code class="language-plaintext highlighter-rouge">presentation layers</code>.
Por exemplo, considerando uma anima√ß√£o de fade out, se em qualquer momento da anima√ß√£o voc√™ verificar o valor da opacidade da camada (<code class="language-plaintext highlighter-rouge">model layer</code>), este valor ser√° diferente do valor que est√° sendo apresentado na tela (<code class="language-plaintext highlighter-rouge">presentation layer</code>).</p>

<p>Como falado anteriormente, n√£o √© poss√≠vel definir as propriedades na presentation layer, mas voc√™ pode utilizar os valores para criar novas anima√ß√µes, ou interagir com outras camadas enquanto a anima√ß√£o acontece.</p>

<p>√â poss√≠vel acessar qualquer uma dessas camadas utilizando os m√©todos <code class="language-plaintext highlighter-rouge">[CALayer presentationLayer]</code> e <code class="language-plaintext highlighter-rouge">[CALayer modelLayer]</code>.</p>

<blockquote>
  <p>Certo, vamos ver como tudo isso acontece na pr√°tica.</p>
</blockquote>

<h2 id="cabasicanimation">CABasicAnimation</h2>

<p>Vamos pensar em uma anima√ß√£o bem b√°sica. A primeira que vem √† minha mente √© deslocar um quadrado de um lado para outro. Logicamente, quando eu configurar meu <code class="language-plaintext highlighter-rouge">CABasicAnimation</code>, vou passar para ele a propriedade que eu quero alterar, o valor inicial, o valor final e a dura√ß√£o:</p>

<script src="https://gist.github.com/renatosarro/4753b9eb2dd7e22aa1383000514c4c1a.js"></script>

<p><code class="language-plaintext highlighter-rouge">keyPath</code>: KVC (Key value code) ‚Äúposition.x‚Äù, cont√©m um membro CGPoint armazenada na propriedade position :)</p>

<p><code class="language-plaintext highlighter-rouge">fromValue</code>: Posi√ß√£o Inicial</p>

<p><code class="language-plaintext highlighter-rouge">toValue</code>: Posi√ß√£o Final</p>

<p><code class="language-plaintext highlighter-rouge">duration</code>: Dura√ß√£o da anima√ß√£o</p>

<blockquote>
  <p>Ao rodar a anima√ß√£o, observamos que ao terminar a anima√ß√£o, nosso quadrado pula da posi√ß√£o final para a posi√ß√£o inicial. Isto ocorre, pois como falado anteriormente, as anima√ß√µes n√£o modificam as propriedades na presentation layer. Ent√£o, ao terminar a anima√ß√£o, a posi√ß√£o padr√£o continua sendo a inicial.
Podemos contornar isso, modificando a propriedade position, diretamente na layer:</p>
</blockquote>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">view</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="o">:</span> <span class="s">"basicAnimation"</span><span class="p">)</span>

<span class="n">view</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">CGPoint</span><span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="mi">320</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p>Desta forma, ao terminar a anima√ß√£o, a posi√ß√£o do elemento (<code class="language-plaintext highlighter-rouge">presentation layer</code>) ser√° correspondente √† posi√ß√£o final da anima√ß√£o (<code class="language-plaintext highlighter-rouge">model layer</code>).</p>

<p>Uma outra abordagem √© configurar duas propriedades do <code class="language-plaintext highlighter-rouge">CABasicAnimation</code>.</p>

<p>Este objeto possui uma propriedade chamada <code class="language-plaintext highlighter-rouge">fillMode</code> que determina o que vai acontecer ao final da anima√ß√£o. Vamos configurar esta propriedade com a string <code class="language-plaintext highlighter-rouge">kCAFillModeForwards</code> que vai dizer para a anima√ß√£o permanecer em seu estado final.
Vamos tamb√©m configurar a propriedade <code class="language-plaintext highlighter-rouge">isRemovedOnCompletion</code> com o boolean false. Isto vai garantir que o objeto n√£o seja removido automaticamente. Desta forma, nosso c√≥digo ficar√° assim:</p>

<script src="https://gist.github.com/renatosarro/396251ef6307475353b2ce3f718a58ee.js"></script>

<blockquote>
  <p>Utilize estas duas propriedades com muita parcim√¥nia e as modifique apenas se houver uma real necessidade, pois quando trabalhamos com anima√ß√µes, √© de estrema import√¢ncia que as layers model e presentation estejam sincronizadas.
√â importante ressaltar tamb√©m, que o objeto da anima√ß√£o criada √© copiado assim que adicionamos a alguma layer. Isto √© bem interessante, pois podemos reutilizar o objeto em outras layers como por exemplo:</p>
</blockquote>

<script src="https://gist.github.com/renatosarro/c5d8881d055ad76b546e26ece695bec8.js"></script>

<p>Observe que, como a anima√ß√£o foi copiada para a layer da primeira view, ao configurarmos a propriedade beginTime para come√ßar meio segundo depois, apenas a anima√ß√£o da layer da <code class="language-plaintext highlighter-rouge">view2</code> √© afetada, pois como falado, ao adicionar a anima√ß√£o √† layer, √© gerado uma c√≥pia dela.</p>

<p>PS: Podemos gastar mais um artigo inteiro falando s√≥ sobre como gerenciar o tempo de nossas anima√ß√µes. Acredite, estamos apenas come√ßando e o <code class="language-plaintext highlighter-rouge">Core Animation</code> possui uma infinidade de possibilidades para trabalhar as anima√ß√µes. Com certeza mais posts vir√£o =D</p>

<p>‚Äì</p>

<h3 id="agora-como-seria-esta-mesma-anima√ß√£o-sem-o-uso-do-core-animation">Agora, como seria esta mesma anima√ß√£o sem o uso do Core Animation?</h3>

<script src="https://gist.github.com/renatosarro/dcc083ec91dfee76c46b5c48c56fd048.js"></script>

<blockquote>

  <ul>
    <li>Desta forma, a anima√ß√£o impacta diretamente na posi√ß√£o real do elemento (<code class="language-plaintext highlighter-rouge">presentation layer</code>);</li>
    <li>Vale ressaltar que se tratando de anima√ß√µes, o mais indicado √© trabalhar sempre na model layer. Altera√ß√µes na presentation layer precisam ser feitas com muito cuidado para evitar memory leak e uma anima√ß√£o n√£o muito flu√≠da.</li>
    <li>Estar√≠amos limitados a anima√ß√µes simples, como um fade out. Mas vamos pensar em um cen√°rio onde nosso elemento passe por v√°rios estados at√© chegar em sua posi√ß√£o final. Utilizar essa abstra√ß√£o oferecida pela <code class="language-plaintext highlighter-rouge">UIView</code> j√° n√£o seria muito indicado.</li>
  </ul>
</blockquote>

<p>J√° que falamos sobre v√°rios estados, vou aproveitar o gancho para puxar um outro elemento bem bacana presente no Core <code class="language-plaintext highlighter-rouge">Animation</code>:</p>

<h1 id="cakeyframeanimation">CAKeyframeAnimation</h1>

<p>N√£o sei quantos vieram desta √©poca, mas minha primeira experi√™ncia como desenvolvedor foi com Action Script. Era o boom do Flash. Fant√°stico, brilhante, inovador, perfeito para ter experi√™ncias mais interativas e claro, animadas.</p>

<p>Bem, o conceito b√°sico para qualquer anima√ß√£o √© pensar nela em forma de <code class="language-plaintext highlighter-rouge">Key frames</code>. J√° ouviram falar de Foliosc√≥pio, ou Flipbook?</p>

<p>√â exatamente assim que uma anima√ß√£o funciona. Cada quadro (frame) possui o elemento em um estado diferente, onde colocando todos os quadros para passar de forma cont√≠nua, forma um desenho animado.</p>

<p>Sim, posso <code class="language-plaintext highlighter-rouge">e devo</code> utilizar o mesmo conceito ao elaborar minha anima√ß√£o.</p>

<p>Imagine que nossa view em vez de apenas se deslocar para a direta, ela v√° at√© o centro, volte para o in√≠cio e depois v√° para o fim da tela.</p>

<p>O primeiro passo, √© fazer um array de valores.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">320</span><span class="p">]</span>
</code></pre></div></div>

<p>Depois disso, vamos criar um array de <code class="language-plaintext highlighter-rouge">timming</code>, que vai ser relativo aos itens de estado. Ou seja, para cada posi√ß√£o, teremos um tempo que ir√° dizer quanto vai levar para a nossa view estar naquela posi√ß√£o.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">times</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<p>Perceba que esta lista diz que minha view come√ßa na posi√ß√£o 20. Ap√≥s 0,5 segundo, ela estar√° na posi√ß√£o 160. Ap√≥s 1 segundo, na posi√ß√£o 20 e ap√≥s 2 segundos, na posi√ß√£o 320. Ou seja, minha anima√ß√£o ter√° a dura√ß√£o de 2 segundos.</p>

<p>Vamos ent√£o criar nosso objeto <code class="language-plaintext highlighter-rouge">CAKeyframeAnimation</code>.</p>

<script src="https://gist.github.com/renatosarro/7dd14ca9892d894653f8f185d18f6409.js"></script>

<p>Podemos notar uma propriedade nova. A <code class="language-plaintext highlighter-rouge">isAdditive</code>. Configurando esta propriedade como verdadeiro, significa que o valor especificado pela anima√ß√£o, ser√° adicionado √† √°rvore de renderiza√ß√£o atual. Isso nos permite reutilizar a mesma anima√ß√£o para qualquer elemento que precise ter o mesmo comportamento.</p>

<p>‚Äì</p>

<p>Olhando assim, o Core Animation n√£o parece t√£o monstruoso hehe‚Ä¶ Na verdade ele pode e vai auxiliar muito quando precisar trabalhar mais com o lado animado da coisa =D</p>

<p>Claro, esta, √© apenas uma introdu√ß√£o. Com isso podemos ir brincando com keyPahts, keyFrames e ver o que podemos fazer de mais complexo exercitando muito estas propriedades b√°sicas, mas t√£o importantes se tratando de anima√ß√£o.</p>

<p>H√° uma infinidade de possibilidades quando falamos de anima√ß√µes e com certeza falaremos mais sobre isso.</p>

<h1 id="carry-on">Carry on!</h1>]]></content><author><name>Renato Sarro Matos</name></author><category term="animations" /><summary type="html"><![CDATA[Fala galera! Bem vindos a mais uma rodada do EquinociOS! Espero que estejam aproveitando e absorvendo tudo =D]]></summary></entry><entry><title type="html">Server-side: caracter√≠sticas de um servidor</title><link href="http://localhost:4000/server/2017/03/18/server-side-caracteristicas-de-um-servidor/" rel="alternate" type="text/html" title="Server-side: caracter√≠sticas de um servidor" /><published>2017-03-18T21:00:00-03:00</published><updated>2017-03-18T21:00:00-03:00</updated><id>http://localhost:4000/server/2017/03/18/server-side-caracteristicas-de-um-servidor</id><content type="html" xml:base="http://localhost:4000/server/2017/03/18/server-side-caracteristicas-de-um-servidor/"><![CDATA[<h1 id="antes-de-come√ßar">Antes de come√ßar</h1>

<p>Este artigo trata, basicamente, de caracter√≠sticas do sistema operacional. Pode
parecer um pouco fora dos assuntos do EquinociOS, mas √© algo bastante
relevante. Desde que a Apple liberou a linguagem Swift como um projeto de
c√≥digo-aberto, muita gente vem usando a linguagem para desenvolver software do
lado do servidor. Assim, torna-se bastante relevante o conhecimento que √©
apresentado neste artigo pois o software servidor executa em um ambiente que
far√° algumas exig√™ncias para o seu correto funcionamento.</p>

<p>√â importante ter em mente que o ambiente no qual seu software executa precisa
ser respeitado. Este ambiente proporcionar√° vantagens, e tamb√©m desvantagens,
que precisam ser entendidas e avaliadas. O intuito √© integrar bem o seu software
com este ambiente e tirar proveito das vantagens evitando-se as desvantagens.</p>

<p>Considerando-se que o software do lado do servidor normalmente funciona em
esquema 24 x 7 x 365, a boa integra√ß√£o com o ambiente aumenta bastante a
confiabilidade e a robustez. Portanto, √© importante conhecer, mesmo que
superficialmente, o ambiente de execu√ß√£o do seu servidor.</p>

<h1 id="o-que-√©-o-servidor">O que √© o servidor?</h1>

<p>O conceito de servidor n√£o √© novo. Apareceu na s√©rie 360 da IBM em 1964. Desde
ent√£o vem sofrendo transforma√ß√µes at√© chegar no modelo em nuvem conforme temos
hoje. Mas, o que raios √© o servidor?</p>

<p>Olhando pela √≥tica do software, que √© a premissa deste artigo, o servidor √© um
artefato de software cuja fun√ß√£o √© prover servi√ßos √† outros artefatos de
software, chamados de <em>clientes</em>. Esta n√£o √© uma defini√ß√£o formal nem muito
menos precisa. A inten√ß√£o √© partirmos desta defini√ß√£o para entender como
projetar um servidor de software de maneira a usar as principais caracter√≠sticas
do sistema operacional no qual estar√° hospedado.</p>

<p>Hoje em dia o papel principal do servidor √© prover servi√ßos a clientes leves, ou
<em>thin clients</em>, normalmente aplicativos para celulares. Todo o processamento
pesado e o armazenamento fica por conta do servidor, deixando o cliente com a
tarefa de organizar, logicamente, os fluxos de trabalho dispon√≠veis para que o
usu√°io seja atendido em determinada funcionalidade.</p>

<p>O servidor pode ser uma ou mais pe√ßas de software trabalhando em conjunto,
formando um sistema que pode ser agregado ou distribu√≠do. Para o cliente, o
servidor √© um s√≥, mesmo que sejam v√°rias m√°quinas f√≠sicas diferentes, v√°rios
sistemas de software criados por v√°rias linguagens diferentes, interagindo entre
si atrav√©s das mais diversas formas de integra√ß√£o.</p>

<h1 id="linux-e-unix">Linux e Unix</h1>

<p>Nos dias de hoje o sistema operacional mais popular para <em>back-end</em> √©, sem
d√∫vida, o Linux. O Unix √© um sistema muito popular no ambiente corporativo,
apesar das vendas deste sistema decrescer ano ap√≥s ano. Sendo rigoroso, o Unix
n√£o √© Linux e Linux n√£o √© Unix. S√£o sistemas completamente diferentes, apesar
das suas similaridades.</p>

<p>Apesar do foco deste artigo ser o Linux, os princ√≠pios e conceitos aqui
apresentados valem para o Unix. Vale lembrar que o FreeBSD √© um Unix e n√£o
Linux. A camada de compatibilidade entre o BSD e o Linux √© t√£o boa e
transparente que ela faz com que praticamente tudo o que executa em um sistema
seja executado em outro.</p>

<p>De toda forma vou intercambiar os termos Unix e Linux ao longo do texto,
tratando tudo como se fosse Unix por quest√£o de simplicidade. Se houver algo que
seja inerente a um sistema, deixarei expl√≠cito para que n√£o haja confus√µes.</p>

<p>Vamos come√ßar por alguns conceitos b√°sicos que ser√£o usados atrav√©s do restante
do texto. Com o intuito de equalizar o conhecimento, apresento de forma bastante
r√°pida estes conceitos.</p>

<h2 id="daemon">Daemon</h2>

<p>Apesar do termo lembrar os dem√¥nios crist√£os, ou seja, entidades mal√©volas, o
termo <em>daemon</em> foi emprestado do termo grego <em>daimon</em> que refere-se a entidades
naturais benignas e que est√£o sempre presentes em nossas vidas.</p>

<p>A despeito da quest√£o religiosa, um <em>daemon</em> √©, na verdade, um processo aut√¥nomo
que √© executado em segundo plano, fornecendo ou executando algum tipo de
servi√ßo. Normalmente os daemons no Unix/Linux s√£o processos iniciados durante a
carga do sistema, atrav√©s de um sistema de inicializa√ß√£o como o System V ou o
upstart do Ubuntu.</p>

<p>Uma vez iniciados, estes processos normalmente terminam quando o sistema √©
reiniciado, ou seja, s√£o processos de execu√ß√£o longa, projetados para
permanecerem funcionando por longos per√≠odos de tempo.</p>

<h2 id="ipc">IPC</h2>

<p>IPC √© uma sigla que significa <em>Inter-Process Communication</em>. Tanto o Unix quanto
o Linux implementam v√°rias formas de comunica√ß√£o inter-processo:</p>

<ul>
  <li><em>pipes</em> para escrita e leitura s√≠ncrona de dados;</li>
  <li><em>message queues</em> para escrita e leitura ass√≠ncrona de dados;</li>
  <li><em>sem√°foros</em> para o controle at√¥mico de recursos compartilhados;</li>
  <li><em>shared memory</em> para compartilhamento de arenas de mem√≥ria;</li>
  <li><em>sockets</em>, em particular os sockets Unix, para troca ass√≠ncrona de dados
arbitr√°rios;</li>
  <li><em>sinaliza√ß√£o</em>, usado para entregar eventos a processos arbitr√°rios.</li>
</ul>

<p>Muitos autores n√£o consideram a sinaliza√ß√£o como parte do IPC. No entanto, √© uma
caracter√≠stica importante do sistema operacional pois √© atrav√©s dos sinais que o
sistema de inicializa√ß√£o comunica-se com os deamons.</p>

<p>Os sinais s√£o eventos ass√≠ncronos que podem, ou n√£o, ser capturados e tratados
por um processo. Apesar dos sinais serem n√∫meros inteiros, eles s√£o limitados
pelo sistema operacional. Os sinais s√£o definidos no arquivo de cabe√ßalho
<em>signal.h</em>, que normalmente est√° no diret√≥rio <code class="language-plaintext highlighter-rouge">/usr/include</code>.</p>

<h2 id="system-calls">System Calls</h2>

<p>Sempre que seu programa precisa interagir com o sistema operacional ele far√° uma
chamada de sistema, ou <em>system call</em>. Mesmo que voc√™ n√£o o fa√ßa diretamente,
algumas opera√ß√µes sempre terminam em uma chamada de sistema, como aloca√ß√£o de
mem√≥ria, abertura e escrita em arquivos, comunica√ß√£o por rede e por a√≠ vai.</p>

<p>As chamadas de sistema s√£o muito importantes pois permitem que o seu software
interaja com o kernel do sistema operacional, trazendo uma s√©rie de vantagens
importantes no que tange a integra√ß√£o de sistemas.</p>

<h2 id="linguagem-c">Linguagem C</h2>

<p>Por que coloco a linguagem C na lista de defini√ß√µes? A resposta √© muito simples:
tanto o Unix quanto o Linux s√£o sistemas operacionais escritos em C. Os <em>system
calls</em> s√£o todos escritos em C e s√£o acessados atrav√©s de bibliotecas escritas
em C do pr√≥prio sistema operacional. Assim, √© imposs√≠vel falar em Linux e Unix
sem mencionar esta linguagem.</p>

<p>Para quem programa em Swift e deseja criar software do lado do servidor aqui vai
a primeira dica: se voc√™ n√£o sabe C, procure aprender. Infelizmente Swift n√£o
possui, nativamente, uma forma de realizar chamadas de sistema. A captura de
sinais, cria√ß√£o de processos-filhos e outras caracter√≠sticas do sistema
operacional s√≥ s√£o conseguidas se voc√™ interfacear seu c√≥digo Swift com wrappers
escritos em C.</p>

<p>Na plataforma Apple a integra√ß√£o √© quase <em>out-of-the-box</em> ao importar-se o
m√≥dulo <em>Darwin</em>. Por√©m, muita coisa importante fica de fora. Al√©m disso, as
bibliotecas da Apple acabam se tornando um estorvo. Por exemplo, a fun√ß√£o
<em>sigaction</em> usa uma estrutura como um dos par√¢metros para instala√ß√£o de handlers
de sinal. No caso da Apple, esta estrutura cont√©m uma uni√£o que √© mascarada por
macros. Para a linguagem C isso √© irrelevante, mas para o Swift, faz toda a
diferen√ßa. O c√≥digo Swift neste caso, compilar√° para a plataforma Apple se a
estrutura for usada conforme definida, e falhar√° para o Linux. A rec√≠proca √©
totalmente verdadeira, ou seja, o c√≥digo feito para Linux n√£o compilar√° na
plataforma Apple. √â necess√°rio, portanto, fazer um wrapper em C para permitir o
funcionamento <em>cross platform</em>.</p>

<h2 id="processo">Processo</h2>

<p>Sempre que um execut√°vel entra em execu√ß√£o no Unix e no Linux, ele cria um
<em>processo</em>. O processo √© uma inst√¢ncia de execu√ß√£o do seu execut√°vel. Em linhas
gerais, o mesmo execut√°vel pode ter diversas inst√¢ncias de execu√ß√£o, podendo ser
chamado quantas vezes o usu√°rio bem desejar. A cada inst√¢ncia de execu√ß√£o √©
asssociado um n√∫mero inteiro que identifica este processo para o sistema
operacional. Este n√∫mero √© chamado de <em>PID</em>, de <em>process identification</em>. A
estrutura de numera√ß√£o de processos nos sistemas operacionais Unix e Linux √© uma
lista circular. Isto √© feito para que os n√∫meros de processo sejam
reaproveitados. Assim, o processo criado para um determinado execut√°vel pode ter
atribu√≠do um n√∫mero inteiro qualquer, repetindo-se ou n√£o.</p>

<p>Normalmente o processo cujo PID √© 1 √© o processo de inicializa√ß√£o do sistema, o
processo que √© pai de todo mundo, chamado de <em>init</em>. Tudo no Unix e Linux √©
iniciado pelo <em>init</em>. Os usu√°rios, quando autenticados e conectados a estes
sistemas utilizam processos que foram inicialmente criados pelo init, mas que
deram origem a outros processos.</p>

<h3 id="processo-filho">Processo-filho</h3>

<p>O processo-filho √© um processo que √© criado por outro processo. O processo-filho
tem como caracter√≠stica um n√∫mero inteiro chamado de <em>PPID</em>, ou <em>parent process
ID</em>. O processo-pai pode ser um processo-filho de outro processo e este fato
implica na cria√ß√£o de uma √°rvore de processos.</p>

<p>As implica√ß√µes disso s√£o importantes para o correto design de um software do
lado do servidor, conforme veremos a seguir.</p>

<h1 id="daemons-e-o-init">Daemons e o init</h1>

<p>Um daemon √© um programa comum, como qualquer outro, por√©m com ciclo longo de
execu√ß√£o. Normalmente, o daemon executa apenas uma √∫nica inst√¢ncia na m√°quina
onde est√° hospedado. Via de regra, os daemons s√£o iniciados pelo sistema de
inicializa√ß√£o do Unix, podendo ser um sistema baseado no System V ou em outra
forma de inicializa√ß√£o. Normalmente os sistemas Linux t√™m maneiras um pouco
diferentes de inicializa√ß√£o, como o ubuntu que est√° movendo-se para o <em>upstart</em>,
um sistema de inicializa√ß√£o um pouco mais eficiente e mais flex√≠vel que o antigo
System V.</p>

<p>O sistema de inicializa√ß√£o n√£o √©, na verdade, importante para os prop√≥sitos
deste texto. O fato √© que todo daemon pode ser iniciado pelo init e a
inicializa√ß√£o garante que o processo iniciado n√£o estar√° associado a nenhum
terminal. E aqui come√ßamos a ver o que √© realmente importante ter no seu
processo do lado do servidor para que ele intereja de forma adequada com o
sistema operacional.</p>

<h2 id="sinaliza√ß√£o">Sinaliza√ß√£o</h2>

<p>Uma das formas que o sistema de inicializa√ß√£o tem de comunicar-se com o seu
software √© atrav√©s do envio de sinais. Os sinais s√£o n√∫meros inteiros e cada
n√∫mero tem seu significado. A listagem de sinais normalmente √© compilada atrav√©s
de um conjunto de macros declarados em <em>signal.h</em>. Este arquivo normalmente
reside no diret√≥rio <code class="language-plaintext highlighter-rouge">/usr/include</code>.</p>

<p>A sinaliza√ß√£o ocorre de maneira ass√≠ncrona e interrompe qualquer que seja o
fluxo em execu√ß√£o no seu programa, retomando ao ponto de interrup√ß√£o t√£o logo o
sinal seja tratado ou ignorado. √â importante ter em mente, no entanto, que nem
todo sinal pode ser tratado. Alguns sinais, em especial <code class="language-plaintext highlighter-rouge">SIGKILL</code>, n√£o podem ser
capturados nem tratados pelo seu software. O seu comportamento acaba sendo
definido pelo sistema operacional. Por exemplo, <code class="language-plaintext highlighter-rouge">SIGKILL</code> elimina o processo que
executa o seu software da mem√≥ria, n√£o importa o que o seu software esteja
fazendo. Este √© um dos sinais que n√£o podem ser nem capturados nem tratados.</p>

<h3 id="sinais-not√°veis">Sinais not√°veis</h3>

<p>Alguns sinais s√£o importantes pois s√£o usados com frequ√™ncia pelos sistemas de
inicializa√ß√£o e controle de processos. Em particular os sinais <code class="language-plaintext highlighter-rouge">SIGTERM</code> e
<code class="language-plaintext highlighter-rouge">SIGHUP</code> s√£o usados para terminar ou reiniciar um daemon, respectivamente. Assim
√© importante capturar e tratar <code class="language-plaintext highlighter-rouge">SIGTERM</code>para que seu daemon seja finalizado de
forma graciosa; e <code class="language-plaintext highlighter-rouge">SIGHUP</code> para que seu processo possa reiniciar-se, ou seja,
recarregar a configura√ß√£o e iniciar do zero, como se estivesse sendo carregado
pela primeira vez.</p>

<p>Ao capturar e tratar os sinais <em>not√°veis</em> voc√™ estar√° melhorando a integra√ß√£o do
seu software com sistemas Unix, tornando-o mais adequado para uso com os
sistemas de inicializa√ß√£o, seja System V ou seja via upstart.</p>

<h2 id="daemoniza√ß√£o">Daemoniza√ß√£o</h2>

<p>Se voc√™ abrir um terminal, seja um Xterm, ou um terminal de texto pendurado a
uma linha serial, qualquer processo que voc√™ iniciar manualmente estar√°
associado ao seu terminal. Este √© um trabalho que o kernel faz no intuito de
finalizar qualquer processo caso seu terminal seja desconectado. Esta
caracter√≠stica √© boa e n√£o √©.</p>

<p>O fato √© que pode ser necess√°rio reiniciar um daemon manualmente. Digamos que
seja necess√°rio realizar uma manuten√ß√£o no servidor, por algum motivo. Portanto,
√© imperativo que seu daemon n√£o esteja associado com o seu terminal pois, se
estiver, ao fechar o seu terminal o processo cai.</p>

<p>Os sistemas de inicializa√ß√£o j√° garantem que o seu daemon seja executado
dissociado de um terminal. Por√©m, a daemoniza√ß√£o pode auxili√°-no no design do
seu daemon simplificando uma s√©rie de coisas, como a reinicializa√ß√£o <em>a quente</em>
do seu processo, conforme expliquei na se√ß√£o sobre sinais not√°veis.</p>

<p>Normalmente voc√™ vai iniciar o seu daemon atrav√©s do sistema de inicializa√ß√£o,
via <em>start</em>, <em>initctl</em> ou algum comando especial que reside no <em>/sbin</em> ou
<em>/usr/sbin</em> dependendo do seu Unix ou Linux.</p>

<p>A daemoniza√ß√£o consiste em dissociar seu processo do seu terminal ativo. Isto √©
algo muito simples de ser feito, na realidade. A ideia por tr√°s disso √© criar um
processo-filho e o processo-filho criar outro processo-filho que, em √∫ltima
inst√¢ncia, executar√° o c√≥digo do seu daemon, tomando-se o cuidado de terminar os
processos-pai sem aguardar o retorno dos processos-filhos.</p>

<p>Neste cen√°rio o processo neto √© adotado pelo sistema de inicializa√ß√£o e
torna-se, efetivamente, dissociado do seu terminal. Isto √© t√£o simples de ser
realizado que d√° para fazer num shell script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ { a=0; while [ $a -lt 10 ]; do sleep 10; a=$((a+1)); echo "Executado $a vezes" &gt;&gt; $HOME/output.txt; done }&amp; }&amp;
</code></pre></div></div>

<p>Este comando meio esquisito inicia um contador que escreve um arquivo texto a
cada 10 segundos, durante 100 segundos. Se antes de finalizar o script voc√™
fechar o seu terminal o arquivo <em>output.txt</em> continuar√° a crescer.</p>

<p>O truque √© bem simples: cria-se um processo-filho e dentro deste processo-filho
cria-se outro processo-filho. Em C, ter√≠amos algo assim usando a forma cl√°ssica
de cria√ß√£o de processos-filho:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (fork() == 0) {
    if (fork() == 0) {
        /* Aqui vai o seu processo. Este √© o processo-neto */
    } else {
        /* Termina o processo-fiho sem esperar o sincronismo */
        exit(0);
    }
} else {
    /* Termina o processo-pai sem esperar para sincronizar. */
    exit(0);
}
</code></pre></div></div>

<p>Trabalhar com multi-processos no Unix sempre foi um assunto confuso. A chamada
de sistema <em>fork</em> retorna ao processo-pai o PID do processo-filho. Para o
processo-filho, o retorno do system call √© zero. O que n√£o fica expl√≠cito no
c√≥digo √© que ao chamar o <em>fork</em>, o seu processo se divide em dois. O que est√° no
<code class="language-plaintext highlighter-rouge">else</code> do <code class="language-plaintext highlighter-rouge">if (fork() == 0)</code> √© o processo-pai. O que est√° no <code class="language-plaintext highlighter-rouge">then</code> √© o
processo-filho.</p>

<p>As chamadas ao system call <code class="language-plaintext highlighter-rouge">exit</code> faz com que o processo seja finalizado
imediatamente. No caso do exemplo, os processos-pai ser√£o finalizados sem
aguardar os processos-filho retornarem. Como dito, em uma situa√ß√£o como esta, o
processo-filho n√£o tem com quem sincronizar para retornar pois os processos-pai
j√° foram reciclados pelo sistema. Assim, o processo <em>init</em> assume o processo
√≥rf√£o e este fica dissociado de um terminal, passando a rodar em segundo plano.</p>

<p>De uma forma mais moderna, pode-se usar a fun√ß√£o <code class="language-plaintext highlighter-rouge">posix_spawn</code> para carregar
novamente o seu processo em outro espa√ßo de endere√ßamento. A diferen√ßa entre
usar isto e a chamada <code class="language-plaintext highlighter-rouge">fork</code> √© que esta √∫ltima pode gerar problemas com os
frameworks da Apple, em particular se voc√™ estiver programando em Swift.</p>

<p>A chamada a <code class="language-plaintext highlighter-rouge">posix_spawn</code> gera um pouco mais de trabalho. Esta fun√ß√£o cria um
processo-filho de forma diferente, iniciando o novo processo literalmente do
zero. Voc√™ precisa informar a <code class="language-plaintext highlighter-rouge">posix_spawn</code> qual o caminho completo do
execut√°vel, ou seja, esta fun√ß√£o cria um processo arbitr√°rio totalmente novo que
pode, ou n√£o, ser igual ao processo em execu√ß√£o.</p>

<p>O trabalho extra √© que ser√° necess√°rio processar a linha de comando para que seu
programa saiba que est√° executando como um <em>child process</em>. Este √© o m√©todo
preferido se voc√™ escrever seu c√≥digo em Swift. O compilador LLVM sequer gera
execut√°vel se voc√™ tentar usar o <code class="language-plaintext highlighter-rouge">fork</code> justamente porque este system call √©
danoso para os frameworks da Apple.</p>

<p>Como o system call <code class="language-plaintext highlighter-rouge">fork</code> √© mais simples, achei melhor us√°-lo para explicar o
princ√≠pio, que continua rigorosamente o mesmo se voc√™ usar <code class="language-plaintext highlighter-rouge">posix_spawn</code>.</p>

<h2 id="syslog-e-o-logging-do-seu-daemon">Syslog e o logging do seu daemon</h2>

<p>Existem diversas bibliotecas de logging por a√≠ afora, que trabalham com n√≠veis
de logging e mais uma penca de coisas. Tanto o Linux quanto o Unix oferecem um
sistema completo de logging que normalmente √© ignorado pelos desenvolvedores:
<em>syslog</em>.</p>

<p>O <em>syslog</em> tem diversas vantagens que sobrepujam qualquer outro sistema de
logging:</p>

<ul>
  <li>se o seu processo morre inesperadamente, o log √© preservado. Se alguma
informa√ß√£o ficou pendente, ela √© salva no log pois a comunica√ß√£o com o
<em>syslog</em> n√£o √© bufferizada.</li>
  <li>o logging √© feito por um daemon, <em>syslogd</em> normalmente. A comunica√ß√£o √© feita
via pipes ou Unix sockets e √© extremamente r√°pida.</li>
  <li>o <em>syslog</em> faz rota√ß√£o de log, compactando arquivos antigos e eliminando
arquivos muito antigos.</li>
</ul>

<p>Normalmente o <em>syslog</em> salva as informa√ß√µes de logging no diret√≥rio
<code class="language-plaintext highlighter-rouge">/var/log</code>. Este diret√≥rio pode variar de acordo com a sua distribui√ß√£o de Linux
ou sabor de Unix. Algumas distros salvam os logs em <code class="language-plaintext highlighter-rouge">/var/spool/log</code>.</p>

<p>Fazer sa√≠das para <em>stdout</em> ou <em>stderr</em> normalmente n√£o √© uma boa ideia. Alguns
sistemas de inicializa√ß√£o fazem o redirecionamento destes streams para arquivos
de log, mas isto n√£o √© garantido. Se voc√™ gosta de prints da vida, uma dica √©:
n√£o fa√ßa isso. Use o <em>syslog</em>.</p>

<h2 id="scheduling">Scheduling</h2>

<p>Este √© um assunto muito mais voltado √† administra√ß√£o do sistema do que
efetivamente ao seu processo. Mas vale a pena passar o olho nisto pois √©
poss√≠vel para um processo alterar a sua pr√≥pria prioridade.</p>

<p><em>Scheduling</em> tem a ver com a forma como o seu processo ser√° executado dentro do
Linux/Unix. O sistema operacional divide um <em>quantum</em> arbitr√°rio de tempo com
base na prioridade de cada processo, dando a cada processo a oportunidade de
executar. Quanto maior a prioridade de um processo, mais tempo ele ter√° dentro
da CPU.</p>

<p>Como o Unix √© um sistema operacional multi-processo, o <em>scheduling</em> foi a forma
encontrada para compartilhar a CPU com os diversos processos que executam ao
mesmo tempo pois a CPU √© uma s√≥. Se h√° 4 cores, at√© 4 processos executam
realmente em paralelo. Os demais precisam aguardar para executar.</p>

<p>O <em>scheduling</em> implica na performance da sua aplica√ß√£o. Quanto maior for a
prioridade, mais r√°pido √© a execu√ß√£o de um processo. A prioridade permite que
seu processo possa, automaticamente, escalar-se para usar mais e mais CPU √†
medida em que a demanda aumenta. Assim, o seu processo come√ßa a usar mais CPU e
torna-se mais eficiente.</p>

<h2 id="multi-processos">Multi-processos</h2>

<p>N√£o √© incomum um daemon ser arquitetado para usar diversos processos, cada um
com uma finalidade bem determinada. Um <em>pattern</em> muito comum √© o <em>pipeline</em>. A
ideia do pipeline √© implementar um workflow usando v√°rios processos. Cada passo
do workflow √© realizado por um processo que, ao finalizar, passa para o processo
subsequente a requisi√ß√£o com o resultado do seu processamento.</p>

<p>Este tipo de design √© muito usado para permitir o processamento paralelo e exige
alguma forma de comunica√ß√£o entre os processos. Ao inv√©s de inventar moda, use
alguma forma de IPC: pipes, message queues, sem√°foros, etc. Tudo isto est√°
presente e dispon√≠vel no seu Linux ou Unix h√° anos, sendo uma maneira muito
eficiente e est√°vel de permitir que v√°rios processos troquem informa√ß√µes entre
si.</p>

<p>Assim, quando v√°rios processos est√£o na mesma m√°quina, n√£o h√° a necessidade de
usar sistemas de mensagens distribu√≠das, como o MQ Series ou o Rabbit MQ. O
pr√≥prio Linux/Unix j√° lhe d√° as message queues prontas para uso.</p>

<h1 id="swift-server-side">Swift Server-side</h1>

<p>A linguagem Swift tem ganhado destaque no desenvolvimento de aplica√ß√µes do lado
do servidor. Por√©m, Swift n√£o tem wrappers nativos para integrar chamadas de
sistema com a linguagem. Assim, a forma de realizar isto √© importar c√≥digo C
para o seu software, o que muitas vezes exige a necessidade de escrever wrappers
em C antes de import√°-los para o seu c√≥digo em Swift.</p>

<p>Por exemplo, a fun√ß√£o <code class="language-plaintext highlighter-rouge">sigaction</code> tem uma implementa√ß√£o no macOS que exige
que um wrapper C seja criado no intuito de manter o c√≥digo port√°vel para o
Linux. Assim, cedo ou tarde ser√° necess√°rio escrever algum c√≥digo em C para que
voc√™ integre, adequadamente, o seu servidor Swift no Linux ou Unix.</p>

<h1 id="conclus√£o">Conclus√£o</h1>

<p>A correta integra√ß√£o do software server-side com o sistema operacional traz
benef√≠cios in√∫meros, tornando seu software mais robusto e usando as
caracter√≠sticas do sistema operacional como o <em>syslog</em>. A integra√ß√£o com o
sistema de inicializa√ß√£o tamb√©m √© importante para garantir a correta
inicializa√ß√£o/t√©rmino da sua aplica√ß√£o.</p>

<p>Como os sistemas Unix foram escritos basicamente em C, cedo ou tarde ser√°
necess√°rio escrever algum c√≥digo para que seja poss√≠vel integrar-se o seu
servidor Swift ao sistema operacional.</p>]]></content><author><name>Ronaldo Faria Lima</name></author><category term="server" /><summary type="html"><![CDATA[Antes de come√ßar]]></summary></entry></feed>