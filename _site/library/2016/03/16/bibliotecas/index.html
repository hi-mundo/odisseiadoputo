<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blog de tecnologia e desenvolvimento ‚Äî artigos, tutoriais e opini√£o.">

    <title>Bibliotecas üìö - A odisseia do puto</title>

    <link rel="canonical" href="http://localhost:4000/library/2016/03/16/bibliotecas/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">
    <link rel="stylesheet" href="/css/odisseia.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    
    <!-- Share CSS -->
    <link rel="stylesheet" href="/css/share.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="A odisseia do puto" />

    

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A odisseia do puto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
				
                <li>
                    <a href="/about/">Sobre</a>
                </li>
				
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header">
    <div class="intro-header-overlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Bibliotecas üìö</h1>
                        
                        <span class="meta">Postado por Igor Ferreira em 16/03/2016</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="share">
  <li><a href="https://twitter.com/intent/tweet?text=Bibliotecas üìö&url=http://localhost:4000/library/2016/03/16/bibliotecas/" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square"></i></a></li>
  <li><a href="https://facebook.com/sharer.php?u=http://localhost:4000/library/2016/03/16/bibliotecas/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square"></i></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/library/2016/03/16/bibliotecas/" rel="nofollow" target="_blank" title="Share on Linkedlin"><i class="fa fa-linkedin-square"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://localhost:4000/library/2016/03/16/bibliotecas/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square"></i></a></li>
</ul>

				<blockquote>
  <p>Eu (<a href="https://twitter.com/icastanheda">@icastanheda</a>) sou desenvolvedor mobile desde de 2012, quando ARC, storyboard e o Ice Cream Sandwich eram recentes no mundo.
Alguns de voc√™s j√° deve ter ouvido minha voz em um dos epis√≥dios do <a href="http://soundcloud.com/cocoaheadsbr">Podcast do CocoaHeads Brasil</a>.</p>
</blockquote>

<p><br /></p>

<h3 id="pref√°cio">Pref√°cio</h3>

<p>Eu sempre trabalhei com o desenvolvimento de apps para o usu√°rio final do produto, os famosos <em>ipas</em> que v√£o para a loja. Mas, recentemente mudei meu trabalho para uma empresa que desenvolve bibliotecas para outras empresas.</p>

<p><br /></p>

<center>
<img alt="I'm going on an adventure" src="https://45.media.tumblr.com/3ad2585f368bd07136af9d01aa285906/tumblr_n7y9otYV1i1s9t7xfo1_500.gif" />
</center>

<p><br /></p>

<p>Mesmo tendo conhecimento sobre as defini√ß√µes e paradigmas de <em>libraries</em> e <em>frameworks</em>, eu enfrentei alguns problemas que nunca tinha enfrentado e precisei rever alguns pontos e detalhes da plataforma Apple. Especialmente o processo de distribui√ß√£o de bin√°rios.</p>

<p>Minha inten√ß√£o, aqui, √© trazer alguns conceitos que permeiam as bibliotecas, mesmo que superficialmente!</p>

<p><br /></p>

<h3 id="library">Library?</h3>

<p>Mesmo que voc√™ nunca tenha desenvolvido esse tipo de distribui√ß√£o, bibliotecas fazem parte do seu dia-a-dia de desenvolvimento. Seja com c√≥digo de terceiros como <em>AFNetworking</em> (ou <em>AlamoFire</em>), <em>OCMock</em>, <em>Realm</em>, entre muitos outros, ou com o <em>Foundation</em>, <em>UIKit</em> e os mais diversos m√≥dulos da SDK do iOS e do OS X.</p>

<p>S√£o formas de reutilizar seu c√≥digo em m√∫ltiplos projetos! Voc√™ poderia copiar e colar os arquivos para cada novo app, mas, al√©m disso n√£o ser pr√°tico, dificulta, e muito, a manuten√ß√£o e integra√ß√£o.</p>

<p>Al√©m disso, s√£o formas de produ√ß√£o e distribui√ß√£o de c√≥digo que n√£o s√£o atrelados a um produto espec√≠fico. Como, por exemplo, um set de l√≥gica para tratar de um protocolo de serializa√ß√£o, ou reconhecimento de forma em vis√£o computacional.</p>

<p><br /></p>

<h3 id="library-x-framework">Library x Framework</h3>

<center><img alt="Static library e framework" src="/img/igorcferreira/library_types.jpg" /></center>

<p>A√≠ est√° a primeira coisa que gostaria de trazer a tona: A diferen√ßa entre <strong>Library</strong> e <strong>Framework</strong>! S√≥ que para explicar melhor a diferen√ßa temos que, primeiro, declarar a diferen√ßa entre <strong>static link</strong> e <strong>dynamic link</strong>.</p>

<p><strong>Static &amp; Dynamic</strong></p>

<p>A diferen√ßa entre uma <em>static linked library</em> e <em>dynamic linked library</em> √© a forma como o c√≥digo ser√° usado pela aplica√ß√£o.</p>

<p>O c√≥digo <strong>static linked</strong> em sua aplica√ß√£o √© adicionado ao bin√°rio da aplica√ß√£o. Assim, faz parte do produto final, portanto √© carregado em mem√≥ria junto com o resto da aplica√ß√£o e caso haja uma atualiza√ß√£o na biblioteca, o produto precisa ser recompilado. At√© recentemente, por conta do modelo de assinatura de bin√°rios e a estrutura do sistema operacional, essa era a √∫nica forma poss√≠vel de biblioteca para iOS.</p>

<p>Por sua vez, o c√≥digo <strong>dynamic linked</strong> n√£o √© associado diretamente ao bin√°rio da aplica√ß√£o. √â algo separado do produto final e seu carregamento de mem√≥ria acontece antes que seus <em>symbols</em> sejam resolvidos. Al√©m disso, j√° que √© algo separado, seu c√≥digo pode ser alterado sem precisar recompilar a aplica√ß√£o. Este modelo j√° est√° presente nos aplicativos para OS X <a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/DynamicLibraries/000-Introduction/Introduction.html">h√° bastante tempo (arquivos <em>dylib</em>)</a>.</p>

<p>At√© o iOS 8, o √∫nico modelo de projeto dispon√≠vel para bibliotecas era a <em><a href="https://developer.apple.com/library/ios/technotes/iOSStaticLibraries/Articles/creating.html">Static Library</a></em>, que resulta na compila√ß√£o de um arquivo <em>.a</em>. Um arquivo com a compacta√ß√£o dos m√∫ltiplos pr√© compilados (<em>.o</em>) das classes da biblioteca.</p>

<center><img alt="T√° me zoando?" src="/img/igorcferreira/are_you_kidding_me.jpg" /></center>

<p>Mas, relaxe, agora j√° √© poss√≠vel criar <em><a href="https://developer.apple.com/library/mac/documentation/MacOSX/Conceptual/BPFrameworks/Concepts/WhatAreFrameworks.html">Frameworks</a></em>!</p>

<p>Para entender um pouco:</p>

<p><strong>Library</strong></p>

<p>Como eu mencionei logo acima, uma <em>static library</em> √© um arquivo compactado de todos os pr√© compilados de suas classes. Incluindo todas as arquiteturas de seu produto (armv7 e arm64, por exemplo). Depois, quem for usar basta importar este arquivo .a e avisar o Xcode que a biblioteca precisa ser linkada ao seu produto.</p>

<p>O desenvolvimento √© bem simples: Basta criar as classes e compilar tudo! Sem segredo e sem dificuldade.</p>

<center><img alt="Arquivos de uma static lib" src="/img/igorcferreira/library_structure.jpg" /></center>

<p>Algo muito lindo, muito simp√°tico e funcional!</p>

<p>Mas, digamos que sua biblioteca tenha alguns arquivos <em>xib</em> para a constru√ß√£o de uma view. E, uma vez que tenho uma view, tenho arquivos <em>string</em> de localiza√ß√£o. Esses arquivos, mesmo que associados √† sua biblioteca n√£o s√£o compactados no .a final.</p>

<p>Assim, junto com o .a, voc√™ precisa enviar todo e qualquer <em>resource</em> que sua biblioteca usar. O mesmo vale para os <em>headers</em> p√∫blicos.</p>

<p>Se voc√™ usa o <a href="http://cocoapods.org/">CocoaPods</a>, j√° deve ter visto o <em>Build Phase</em> <em>Copy Pods Resources</em> e o script <em>Pods-resources.sh</em>. Eles servem para, justamente, garantir que o seu app carregar√° todos os arquivos necess√°rios, sem que voc√™ precise lidar com isso.</p>

<center>üéâ</center>

<p>A√≠ temos um segundo problema, j√° que a biblioteca √© agregada ao bin√°rio do app, toda biblioteca √© carregada em mem√≥ria por todo aplicativo que a usar.</p>

<p>Isso significa que todos os aplicativos que usam o <em>AFNetworking</em> como biblioteca est√°tica carregam o c√≥digo em mem√≥ria?</p>

<center><img alt="Sim :(" src="/img/igorcferreira/yes.jpg" /></center>

<p>Agora imagine se todos os aplicativos carregassem o <em>UIKit</em> ou o <em>Foundation</em>!? E qual a solu√ß√£o para esse problema?</p>

<p><strong>Framework</strong></p>

<p>Em uma tradu√ß√£o livre da documenta√ß√£o da Apple:</p>

<blockquote>
  <p>Uma <em>framework</em> √© um diret√≥rio estruturado que encapsula <em>resources</em> compartilhados, como bibliotecas din√¢micas, arquivos <em>nib</em>, imagens, <em>localized strings</em>, <em>headers</em> e documenta√ß√£o em uma distribui√ß√£o √∫nica. Mais de um aplicativo pode utilizar do mesmo recurso simultaneamente. O sistema carrega os itens em mem√≥ria conforme o necess√°rio e compartilha uma c√≥pia entre todas as aplica√ß√µes.</p>
</blockquote>

<p>E, olhando para a estrutura de uma framework, percebe-se que √© poss√≠vel encapsular diferentes vers√µes da mesma biblioteca no mesmo arquivo de distribui√ß√£o:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MyFramework.framework/
    MyFramework  -&gt; Versions/Current/MyFramework
    Resources    -&gt; Versions/Current/Resources
    Versions/
        A/
            MyFramework
            Resources/
                English.lproj/
                    InfoPlist.strings
                Info.plist
        Current  -&gt; A
</code></pre></div></div>
<p><span class="caption text-muted">O current √© um link para a vers√£o A</span></p>

<p>Assim, caso diferentes apps estejam usando diferentes vers√µes da <em>framework</em>, isso n√£o se torna um problema.</p>

<p>E a chave √© a <em>dynamic library</em>!</p>

<p>O c√≥digo que voc√™ utiliza da SDK, √© um conjunto de <em>frameworks</em> que sabem lidar com o sistema operacional. Assim, o <em>UIKit</em>, por exemplo, √© carregado em mem√≥ria uma √∫nica vez e usado por todos os aplicativos. Al√©m disso, a biblioteca pode ser atualizada sem precisar recompilar todos os aplicativos que est√£o na loja.</p>

<p>Inclusive, voc√™ pode ver as frameworks que s√£o carregadas nos simuladores no path</p>

<p><code class="language-plaintext highlighter-rouge">/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS 9.0.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/</code></p>

<hr />

<p>At√© a oitava vers√£o do sistema operacional <em>mobile</em>, n√£o havia uma forma simples de criar frameworks. Isso era uma exclusividade do OS X.</p>

<p>Alguns, para criar essa estrutura criaram um script para compilar a biblioteca e criar o diret√≥rio da forma correta. Mesmo assim, s√≥ era poss√≠vel criar uma <strong>static framework</strong>, j√° que n√£o √© poss√≠vel criar uma <em>dynamic library</em> para iOS.</p>

<p>Agora, o Xcode disp√µe de um modelo de projeto do tipo <em>Cocoa Touch Framework</em> onde a estrutura√ß√£o da pasta √© controlada por scripts do sistema e o desenvolvimento √© semelhante ao desenvolvimento de uma biblioteca est√°tica ou de um aplicativo:</p>

<center><img src="/img/igorcferreira/framework_structure.jpg" alt="Estrutura de uma framework" /></center>

<p>Olhando para o c√≥digo (em um projeto come√ßado do zero), a framework tem 2 arquivos a mais do que uma static library:</p>

<ul>
  <li>
    <p><em>Info.plist</em>: O arquivo .framework precisa de um arquivo de informa√ß√µes sobre o bin√°rio. Nele cont√©m nome, l√≠ngua, vers√£o e outras coisas b√°sicas.</p>
  </li>
  <li>
    <p><em><a href="https://developer.apple.com/library/mac/documentation/MacOSX/Conceptual/BPFrameworks/Tasks/IncludingFrameworks.html">Umbrella header</a></em>: O umbrella header √© um arquivo .h que importa, ou inclui, todos os demais headers da biblioteca. Assim, √© poss√≠vel apenas usar <code class="language-plaintext highlighter-rouge">#import &lt;TestFramework/TestFramework.h&gt;</code> em vez de importar cada arquivo individualmente.</p>
  </li>
</ul>

<p>No seu umbrella header, voc√™ encontrar√° a exporta√ß√£o de duas constantes:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//! Project version number for TestFramework.</span>
<span class="n">FOUNDATION_EXPORT</span> <span class="kt">double</span> <span class="n">TestFrameworkVersionNumber</span><span class="p">;</span>

<span class="c1">//! Project version string for TestFramework.</span>
<span class="n">FOUNDATION_EXPORT</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TestFrameworkVersionString</span><span class="p">[];</span>
</code></pre></div></div>

<p>Eles s√£o respons√°veis por exteriorizar a vers√£o  e o nome da biblioteca, muito √∫teis para controle de c√≥digo e link correto do bin√°rio pelo sistema.</p>

<p>Al√©m disso, a IDE vai te permitir, atrav√©s do <code class="language-plaintext highlighter-rouge">Build Phases</code>, separar seus headers em <em>Public</em>, <em>Private</em> e <em>Project</em>.</p>

<center><img src="/img/igorcferreira/framework_header.jpg" alt="Estrutura dos headers" /></center>

<p>Nessa divis√£o tem se que:</p>

<ul>
  <li>Public headers estar√£o vis√≠veis para quem importar a framework</li>
  <li>Private headers ser√£o inclu√≠dos no .framework dentro de uma pasta /Private, assim poder√£o ser usados, apenas de n√£o serem mostrados pelo autocomplete da IDE, por exemplo.</li>
  <li>Project headers s√£o vis√≠veis durante o desenvolvimento da biblioteca mas n√£o s√£o exportados para o arquivo .framework.</li>
</ul>

<p><br /></p>

<h3 id="formas-de-distribui√ß√£o">Formas de distribui√ß√£o</h3>

<p>O mais diferente no desenvolvimento de uma biblioteca para um aplicativo (e o mais chato) √© a forma de distribui√ß√£o.</p>

<p>√â poss√≠vel utilizar ferramentas como CocoaPods ou <a href="https://github.com/Carthage/Carthage">Carthage</a> para isso, especialmente para projetos open source ou bibliotecas internas. Estas, s√£o conjuntos de scripts para lidar com o processo de compila√ß√£o e refer√™ncia da biblioteca. Mas, nem sempre voc√™ pode fazer a distribui√ß√£o dessa forma.</p>

<p>O CocoaPods pode ser usado tanto para <em>static libraries</em> (sua origem) quanto para frameworks e ele, usa seu <em>Podspec</em> para especificar a forma de compila√ß√£o. Assim, n√£o √© nem necess√°rio um .xcodeproj, apenas os arquivos fonte e <em>resources</em>.</p>

<p>J√° o Carthage, utiliza os <em>shared schemes</em> de um projeto para compilar a framework e, depois, se preocupa em referenci√°-las no seu aplicativo.</p>

<p>Os dois abordam a compila√ß√£o de formas bem diferentes, mas, depois, o processo de refer√™ncia da framework tem pontos comuns, que servem para lidar com as chatices disso.</p>

<p>Caso voc√™ esteja simplesmente mandando os arquivos compilados para um cliente ou outro dev, as coisas ficam um pouco mais complicadas.</p>

<hr />

<p>No caso de uma <em>static library</em>, basta copiar o arquivo .a e os <em>resources</em> para seu projeto, adicionar a refer√™ncia do bin√°rio em <code class="language-plaintext highlighter-rouge">Link Binary With Libraries</code>, o path dos headers em <code class="language-plaintext highlighter-rouge">HEADER_SEARCH_PATHS</code> e, caso seja necess√°rio, as demais flags.</p>

<p>Caso voc√™ esque√ßa de algum desses passos seu c√≥digo, simplesmente, n√£o compila e voc√™ consegue identificar qual dos pontos esqueceu. üòÑ</p>

<hr />

<p>Para frameworks, arrasta os arquivos para <code class="language-plaintext highlighter-rouge">Linked Frameworks and Libraries</code>, configura as demais flags e √© isso, certo? N√£o. Isso funciona apenas para frameworks do sistema!</p>

<p>Frameworks podem ser um pouco mais complicadas, especialmente quando se tratar de uma <em>universal framework</em> (trato disso mais abaixo). Sendo muito comum acabar com os error:</p>

<p><strong>Library not loaded</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dyld: Library not loaded: @TestFramework
  Referenced from: /var/mobile/Applications/App.app/TestFramework
  Reason: image not found
</code></pre></div></div>
<p><span class="caption text-muted">Xcode: N√£o achei essa biblioteca, #tryagain</span></p>

<p>O primeiro problema mais comum na importa√ß√£o de uma biblioteca, que n√£o √© nativo do sistema, √© que os arquivos precisam ser inclu√≠dos em <code class="language-plaintext highlighter-rouge">Embedded Binaries</code>. Assim, eles ser√£o adicionados ao seu <code class="language-plaintext highlighter-rouge">.ipa</code>, na pasta <code class="language-plaintext highlighter-rouge">Frameworks</code>. Quando o aplicativo for instalado, o iOS ir√° usar o diret√≥rio <code class="language-plaintext highlighter-rouge">Frameworks</code> para procurar por algo que n√£o est√° no sistema (tanto por nome, quanto por vers√£o).</p>

<center><img alt="Frameworks usadas pelo WWDC" src="/img/igorcferreira/imported_framework.jpg" /></center>

<blockquote>
  <p>Aqui, o seu ambiente de desenvolvimento pode ser seu inimigo! Digamos que voc√™ tenha a framework em um app A. Come√ßou a desenvolver o app B, mas esqueceu de embedar os bin√°rios. No seu device, ir√° funcionar lindamente, porque ele j√° tem uma vers√£o v√°lida instalada por conta do app A!</p>
</blockquote>

<p><strong>Could not load library</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dyld: could not load inserted library '/TestFramework.framework/TestFramework' because no suitable image found.  
  Did find: /private/var/mobile/Containers/Data/Application/TestFramework.framework/TestFramework
</code></pre></div></div>
<p><span class="caption text-muted">Xcode: Achei!! Mas n√£o posso ussar essa, #sorrynotsorry</span></p>

<p>O segundo erro muito comum √© n√£o ter a vers√£o correta da framework no sistema. Isso pode acontecer por X motivos, mas, para citar alguns:</p>

<ul>
  <li><em><code class="language-plaintext highlighter-rouge">Framework</code> n√£o foi assinada</em>: Assim como seu .ipa, seu arquivo .framework tamb√©m tem que ser assinado antes de ser enviado para a loja</li>
  <li><em>Vers√£o da framework</em>: A vers√£o da framework foi atualizada, mas a compila√ß√£o n√£o est√° dentro da pasta .framework</li>
  <li><em>Arquitetura errada</em>: Voc√™ est√° embarcando uma framework compilada para uma arquitetura diferente do que se quer executar. Por exemplo, uma framework de simulador em um device e vice-versa.</li>
</ul>

<hr />

<p>Para evitar esses problemas que o Carthage tem o <a href="https://github.com/Carthage/Carthage/blob/master/Source/carthage/CopyFrameworks.swift">CopyFrameworks.swift</a> e o CocoaPods tem o <a href="https://github.com/CocoaPods/CocoaPods/blob/5d0c4c7a47925a15a7bd80fd46b0233a8f670f98/lib/cocoapods/generator/embed_frameworks_script.rb#L46">Pods-frameworks.sh</a>! S√£o scripts que, em uma explica√ß√£o superficial, s√£o respons√°veis por:</p>

<ul>
  <li>
    <p><em>Remover arquivos indevidos</em>: A framework gerada pelo Xcode mant√©m os headers privados em uma pasta <code class="language-plaintext highlighter-rouge">Private</code>, al√©m de alguns outros arquivos que n√£o precisam, necessariamente, ser inclu√≠dos no produto final.</p>
  </li>
  <li>
    <p><em>Copiar os <code class="language-plaintext highlighter-rouge">debug symbols</code> para a framework</em>: Como a biblioteca √© compilada antes de ser inclu√≠da no diret√≥rio, pode-se perder os s√≠mbolos de <em>debug</em>, o que pode ser bem ruim, caso se use uma ferramenta como <code class="language-plaintext highlighter-rouge">Crashlytics</code> ou <code class="language-plaintext highlighter-rouge">HockeyApp</code> (al√©m de alguns bugs no App Store). Esse step √© mais v√°lido em bibliotecas open-source, onde se tem acesso ao c√≥digo para <em>breakpoint</em> e demais.</p>
  </li>
  <li>
    <p><em>Strip a framework para que seja mantido apenas as arquiteturas v√°lidas</em>: Em uma <em>universal framework</em>, ou em uma <em>fat</em> framework, pode conter a mesma biblioteca compilada para as diversas arquiteturas. √â importante remover todas as arquiteturas que n√£o s√£o relevantes ao aplicativo.</p>
  </li>
  <li>
    <p><em>Copiar as bibliotecas Swift</em>: Para bibliotecas feitas em Swift e compiladas em uma vers√£o do Xcode anterior ao 7, √© necess√°rio copiar algumas libs do Swift para o seu aplicativo</p>
  </li>
  <li>
    <p><em>Re-assinar as frameworks</em>: Por fim, mas n√£o menos importante, reassinar os arquivos .framework com o mesmo certificado que assina a aplica√ß√£o. Assim, podendo ser enviado para a loja.</p>
  </li>
</ul>

<hr />

<p>Ent√£o, em um resumo, se lembrar de seguir os processos acima e associar seu arquivo .framework no <code class="language-plaintext highlighter-rouge">Embedded Binaries</code>, sua framework estar√° funcionando lindamente!</p>

<p><br /></p>

<h3 id="universal-framework">Universal Framework</h3>

<p>Mas, um conceito importante para a distribui√ß√£o de uma framework √©: <em>universa framework</em>.</p>

<p>Imagine uma biblioteca como o <a href="https://github.com/Alamofire/Alamofire">Alamofire</a> ou <a href="https://github.com/AFNetworking/AFNetworking">AFNetorking</a>, onde o mesmo c√≥digo pode ser usado em iOS, OS X, watchOS e tvOS. No <code class="language-plaintext highlighter-rouge">xcodeproj</code> dessas bibliotecas h√° um target para cada uma dessas plataformas. Assim, voc√™ acaba compilando 8 frameworks diferentes (1 para cada sistema e 1 para os respectivos simuladores).</p>

<p>Seria um empecilho muito grande ter de lidar com 8 bin√°rios. Principalmente no switch entre desenvolvimento e archive!</p>

<p>Para solucionar esse problema, √© feita uma <em>universal framework</em>. Onde, usando <code class="language-plaintext highlighter-rouge">lipo</code>, agrega-se os m√∫ltiplos bin√°rios das bibliotecas em um √∫nico arquivo.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$lipo -create -output MyFramework.framework/MyFramework MyFramework-iphonesimulator.framework/MyFramework MyFramework-iphoneos.framework/MyFramework MyFramework-watchos.framework/MyFramework
$lipo MyFramework.framework/MyFramework
Architectures in the fat file: MyFramework.framework/MyFramework are: i386 x86_64 armv7 armv7s arm64 armv7k
</code></pre></div></div>

<p>Depois, refaz a estrutura do diret√≥rio .framework para conter os headers e assets de cada vers√£o da biblioteca separados em subdiret√≥rios.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MyFramework.framework/
	MyFramework
	Resources/
		English.lproj/
			InfoPlist.strings
		Info.plist
	Headers/
		MyFramework.h
		iphoneos/
			OtherHeader.h
       watchos/
	       OtherHeader.h
</code></pre></div></div>

<p>E, como j√° expliquei no item anterior, se faz necess√°rio remover os arquivos inv√°lidos no momento da instala√ß√£o. Por exemplo, remover a pasta <code class="language-plaintext highlighter-rouge">watchos</code> quando gerar um app para <code class="language-plaintext highlighter-rouge">iphoneos</code>.</p>

<p>O mesmo vale para o arquivo pr√© compilado. Sendo necess√°rio executar um <code class="language-plaintext highlighter-rouge">lipo</code> para remover as arquiteturas n√£o suportadas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$lipo remove armv7k -output MyFramework.framework/MyFramework MyFramework.framework/MyFramework
$lipo remove i386 -output MyFramework.framework/MyFramework MyFramework.framework/MyFramework
$lipo remove x86_64 -output MyFramework.framework/MyFramework MyFramework.framework/MyFramework
</code></pre></div></div>

<p><br /></p>

<h3 id="swift">Swift</h3>

<p>Estamos em um per√≠odo de transi√ß√£o entre o Objective-C e o Swift (pelo menos para muitos). E, igual √† linguagem, s√£o dois mundos diferentes quando se fala de bibliotecas.</p>

<p>1 - O Swift n√£o permite o uso de <em>static library</em>! Dado todos os detalhes envolvendo o runtime do Swift, compatibilidade de vers√µes e otimiza√ß√µes de compila√ß√£o, n√£o faz sentido fazer um link est√°tico.</p>

<p>2 - Mesmo que Swift n√£o tenha headers, a framework ainda tem um umbrella header para exteriorizar vers√£o e nome da biblioteca. Al√©m de permitir a importa√ß√£o da mesma no Objective-C.</p>

<p>3 - Caso voc√™ esteja usando uma biblioteca feita em Swift em um projeto Objective-C (independente se app ou outra biblioteca), √© preciso setar <code class="language-plaintext highlighter-rouge">YES</code> para a flag <code class="language-plaintext highlighter-rouge">EMBEDDED_CONTENT_CONTAINS_SWIFT</code>. Isso faz com que o Xcode saiba lidar com as bibliotecas de runtime do Swift.</p>

<p>4 - Caso voc√™ esteja criando uma biblioteca em Objective-C, √© importante configurar um  <em>module map</em> e habilitar <code class="language-plaintext highlighter-rouge">DEFINES_MODULE</code>. Assim, voc√™ poder√° usar <code class="language-plaintext highlighter-rouge">import MyFramework</code>, n√£o precisar√° de um bridge header e evita conflito de nomenclaturas.</p>

<center><img src="/img/igorcferreira/module_map.jpg" alt="Module map" /></center>

<p><br /></p>

<h3 id="arquitetura">Arquitetura</h3>

<p>Agora que o conceito e detalhamento de frameworks e static library foi feito, √© importante saber que a arquitetura de uma boa biblioteca inclui, tamb√©m, a simplicidade de uso, prote√ß√£o de entrada (<code class="language-plaintext highlighter-rouge">NSAssert</code>) e design da camada p√∫blica da sua API. √â isso que o cliente ir√° ver e usar!</p>

<p>N√£o vou entrar em detalhes sobre isso aqui porque esse post j√° est√° gigante. Talvez outro dia.</p>

<h3 id="testes">Testes</h3>

<p>O √∫ltimo ponto t√©cnico que gostaria de levantar aqui √© em rela√ß√£o ao testes.</p>

<p>Al√©m dos testes unit√°rios, de integra√ß√£o e de UI, √© importante incluir um <em>sample app</em>. Ele servir√° como um teste de que a framework pode ser importada em um projeto sem problemas e que a interface p√∫blica faz sentido!</p>

<p><br /></p>

<h3 id="um-produto-maior-que-o-c√≥digo">Um produto maior que o c√≥digo</h3>

<p>Se voc√™ aguentou at√© aqui, lembre-se: <strong>Bibliotecas n√£o s√£o apenas c√≥digo!</strong></p>

<p>√â importante criar uma boa documenta√ß√£o, guideline de implementa√ß√£o, taggear e versionar corretamente seus releases, c√≥digos de exemplo, pensar em manuten√ß√£o e evolu√ß√£o‚Ä¶</p>

<p>Seu cliente √© o desenvolvedor que vai usar o seu c√≥digo. Assim como uma boa UI/UX √© vital na reten√ß√£o de usu√°rios, a camada p√∫blica e documenta√ß√£o da sua API pode atrair ou afugentar usu√°rios!</p>

<p><br /></p>

<blockquote>
  <p>Por fim, como diria um bom Youtuber, deixe seus coment√°rios e compartilhe esse post com sua fam√≠lia, amigos e pets. Ah, n√£o esque√ßa de nos seguir nas redes sociais! Tchau! üëã</p>
</blockquote>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/ios/2016/03/15/protocol-oriented-programming/" data-toggle="tooltip" data-placement="top" title="Protocol-Oriented Programming">&larr; Post Anterior</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/ibeacon/2016/03/17/ibeacon/" data-toggle="tooltip" data-placement="top" title="iBeacon">Pr√≥ximo Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Disqus Content -->

                <div id="disqus_thread">
                    <script>
                        /**
                        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                        */

                        /*
                        var disqus_config = function () {
                            this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                        };
                        */

                        (function() { // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');

                        s.src = '//equinocios.disqus.com/embed.js';

                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                </ul>
                <p class="copyright text-muted">A odisseia do puto ‚Äî Raimundo Pessoa & Frederico Do</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
